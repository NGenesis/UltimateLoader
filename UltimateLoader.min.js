var UltimateLoader=UltimateLoader||{};!function(e){"use strict";function t(e,t){v.push([e,t])}function r(){if(g>v.length-1)return v=[],void(g=0);var e=v[g];g++,i(e)}function a(){0==g&&r()}function i(e){var t=e[0],a=e[1],i=s(t);i.url=t,i.callback=a,E=!0,f=a;var u=i.name;if(m[u])i.callback(m[u].clone()),console.log("Ultimate Loader: Object is already loaded ... cloning!");else switch(i.ext){case"obj":n(i);break;case"json":o(i);break;case"dae":l(i);break;case"gltf":h(i);break;case"png":c(i);break;case"jpg":c(i);break;case"jpeg":c(i);break;default:console.log("UltimateLoader: File extension -"+i.ext+"- not recognized! Object -"+i.name+"- did not load."),r()}}function s(e){var t=e.slice(0,e.lastIndexOf("/")+1);(""!==t||null!==t)&&(y=t);var r=e.substr(e.lastIndexOf("/")+1),a=r.split("."),i={name:a[0],ext:a[1],baseUrl:t};return i}function n(e){var t=e.name+".obj",r=e.name+".mtl",a=new THREE.MTLLoader;a.setPath(e.baseUrl),a.setBaseUrl(e.baseUrl),a.setCrossOrigin=b,a.load(r,function(r){r.preload();var a=new THREE.OBJLoader;a.setMaterials(r),a.setPath(e.baseUrl),a.setCrossOrigin=b,a.load(t,function(t){console.log("UltimateLoader: Object "+e.name+" loaded!"),p(t,e)},u,d)})}function o(e){var t=new THREE.ObjectLoader;t.load(e.url,function(t){console.log("UltimateLoader: Object "+e.name+" loaded!"),p(t,e)},u,d)}function l(e){var t=new THREE.ColladaLoader;t.load(e.url,function(t){var r=t.scene;console.log("UltimateLoader: Object "+e.name+" loaded!"),p(r,e)},u,d)}function h(e){var t=new THREE.glTFLoader;t.load(e.url,function(t){var r=t.scene;console.log("UltimateLoader: Object "+e.name+" loaded!"),p(r,e)},u,d)}function c(e){var t=new THREE.TextureLoader;t.load(e.url,function(t){var r=new THREE.PlaneGeometry(32,20,32),a=new THREE.MeshBasicMaterial({map:t,side:THREE.DoubleSide}),i=new THREE.Mesh(r,a);console.log("UltimateLoader: Object "+e.name+" loaded!"),p(i,e)},u,d)}function u(e){}function d(e){}function p(t,a){m[a.name]=t,a.callback(t),e.queue&&r()}var f,m={},v=[],g=0,E=!1,b="anonymous",y="";e.queue=!1,e.load=function(r,s){if(e.queue)t(r,s),a();else{var n=[r,s];i(n)}},e.multiload=function(r,s){for(var n=[],o=0,l=function(e){n.push(e),o++,o>=r.length&&s(n)},h=0;h<r.length;h++)if(e.queue)t(r[h],l);else{var c=[r[h],l];i(c)}a()}}(UltimateLoader),THREE.MTLLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.MTLLoader.prototype={constructor:THREE.MTLLoader,load:function(e,t,r,a){var i=this,s=new THREE.XHRLoader(this.manager);s.setPath(this.path),s.load(e,function(e){t(i.parse(e))},r,a)},setPath:function(e){this.path=e},setBaseUrl:function(e){this.baseUrl=e},setCrossOrigin:function(e){this.crossOrigin=e},setMaterialOptions:function(e){this.materialOptions=e},parse:function(e){for(var t=e.split("\n"),r={},a=/\s+/,i={},s=0;s<t.length;s++){var n=t[s];if(n=n.trim(),0!==n.length&&"#"!==n.charAt(0)){var o=n.indexOf(" "),l=o>=0?n.substring(0,o):n;l=l.toLowerCase();var h=o>=0?n.substring(o+1):"";if(h=h.trim(),"newmtl"===l)r={name:h},i[h]=r;else if(r)if("ka"===l||"kd"===l||"ks"===l){var c=h.split(a,3);r[l]=[parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2])]}else r[l]=h}}var u=new THREE.MTLLoader.MaterialCreator(this.baseUrl,this.materialOptions);return u.setCrossOrigin(this.crossOrigin),u.setManager(this.manager),u.setMaterials(i),u}},THREE.MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e,this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping},THREE.MTLLoader.MaterialCreator.prototype={constructor:THREE.MTLLoader.MaterialCreator,setCrossOrigin:function(e){this.crossOrigin=e},setManager:function(e){this.manager=e},setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var r in e){var a=e[r],i={};t[r]=i;for(var s in a){var n=!0,o=a[s],l=s.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(o=[o[0]/255,o[1]/255,o[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===o[0]&&0===o[1]&&0===o[1]&&(n=!1)}n&&(i[l]=o)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var t=this.materialsInfo[e],r={name:e,side:this.side};for(var a in t){var i=t[a];if(""!==i)switch(a.toLowerCase()){case"kd":r.color=(new THREE.Color).fromArray(i);break;case"ks":r.specular=(new THREE.Color).fromArray(i);break;case"map_kd":r.map=this.loadTexture(this.baseUrl+i),r.map.wrapS=this.wrap,r.map.wrapT=this.wrap;break;case"ns":r.shininess=parseFloat(i);break;case"d":1>i&&(r.opacity=i,r.transparent=!0);break;case"Tr":i>0&&(r.opacity=1-i,r.transparent=!0);break;case"map_bump":case"bump":if(r.bumpMap)break;r.bumpMap=this.loadTexture(this.baseUrl+i),r.bumpMap.wrapS=this.wrap,r.bumpMap.wrapT=this.wrap}}return this.materials[e]=new THREE.MeshPhongMaterial(r),this.materials[e]},loadTexture:function(e,t,r,a,i){var s,n=THREE.Loader.Handlers.get(e),o=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;return null===n&&(n=new THREE.TextureLoader(o)),n.setCrossOrigin&&n.setCrossOrigin(this.crossOrigin),s=n.load(e,r,a,i),void 0!==t&&(s.mapping=t),s}},THREE.EventDispatcher.prototype.apply(THREE.MTLLoader.prototype),THREE.OBJLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.materials=null},THREE.OBJLoader.prototype={constructor:THREE.OBJLoader,load:function(e,t,r,a){var i=this,s=new THREE.XHRLoader(i.manager);s.setPath(this.path),s.load(e,function(e){t(i.parse(e))},r,a)},setPath:function(e){this.path=e},setMaterials:function(e){this.materials=e},parse:function(e){function t(e){var t={vertices:[],normals:[],uvs:[]},r={name:"",smooth:!0};h={name:e,geometry:t,material:r},c.push(h)}function r(e){var t=parseInt(e);return 3*(t>=0?t-1:t+d.length/3)}function a(e){var t=parseInt(e);return 3*(t>=0?t-1:t+p.length/3)}function i(e){var t=parseInt(e);return 2*(t>=0?t-1:t+f.length/2)}function s(e,t,r){h.geometry.vertices.push(d[e],d[e+1],d[e+2],d[t],d[t+1],d[t+2],d[r],d[r+1],d[r+2])}function n(e,t,r){h.geometry.normals.push(p[e],p[e+1],p[e+2],p[t],p[t+1],p[t+2],p[r],p[r+1],p[r+2])}function o(e,t,r){h.geometry.uvs.push(f[e],f[e+1],f[t],f[t+1],f[r],f[r+1])}function l(e,t,l,h,c,u,d,p,f,m,v,g){var E,b=r(e),y=r(t),T=r(l);void 0===h?s(b,y,T):(E=r(h),s(b,y,E),s(y,T,E)),void 0!==c&&(b=i(c),y=i(u),T=i(d),void 0===h?o(b,y,T):(E=i(p),o(b,y,E),o(y,T,E))),void 0!==f&&(b=a(f),y=a(m),T=a(v),void 0===h?n(b,y,T):(E=a(g),n(b,y,E),n(y,T,E)))}console.time("OBJLoader");var h,c=[],u=!1,d=[],p=[],f=[];t("");for(var m=/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,v=/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,g=/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,E=/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,b=/^f\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)))?/,y=/^f\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)\/(-?\d+)))?/,T=/^f\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))(?:\s+((-?\d+)\/\/(-?\d+)))?/,w=/^[og]\s+(.+)/,R=/^s\s+(\d+|on|off)/,x=e.split("\n"),k=0;k<x.length;k++){var A=x[k];A=A.trim();var N;if(0!==A.length&&"#"!==A.charAt(0))if(null!==(N=m.exec(A)))d.push(parseFloat(N[1]),parseFloat(N[2]),parseFloat(N[3]));else if(null!==(N=v.exec(A)))p.push(parseFloat(N[1]),parseFloat(N[2]),parseFloat(N[3]));else if(null!==(N=g.exec(A)))f.push(parseFloat(N[1]),parseFloat(N[2]));else if(null!==(N=E.exec(A)))l(N[1],N[2],N[3],N[4]);else if(null!==(N=b.exec(A)))l(N[2],N[5],N[8],N[11],N[3],N[6],N[9],N[12]);else if(null!==(N=y.exec(A)))l(N[2],N[6],N[10],N[14],N[3],N[7],N[11],N[15],N[4],N[8],N[12],N[16]);else if(null!==(N=T.exec(A)))l(N[2],N[5],N[8],N[11],void 0,void 0,void 0,void 0,N[3],N[6],N[9],N[12]);else if(null!==(N=w.exec(A))){var H=N[1].trim();u===!1?(u=!0,h.name=H):t(H)}else if(/^usemtl /.test(A))h.material.name=A.substring(7).trim();else if(/^mtllib /.test(A));else{if(null===(N=R.exec(A)))throw new Error("Unexpected line: "+A);h.material.smooth="1"===N[1]||"on"===N[1]}}for(var _=new THREE.Group,k=0,L=c.length;L>k;k++){h=c[k];var C=h.geometry,M=new THREE.BufferGeometry;M.addAttribute("position",new THREE.BufferAttribute(new Float32Array(C.vertices),3)),C.normals.length>0?M.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(C.normals),3)):M.computeVertexNormals(),C.uvs.length>0&&M.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(C.uvs),2));var S;null!==this.materials&&(S=this.materials.create(h.material.name)),S||(S=new THREE.MeshPhongMaterial,S.name=h.material.name),S.shading=h.material.smooth?THREE.SmoothShading:THREE.FlatShading;var O=new THREE.Mesh(M,S);O.name=h.name,_.add(O)}return console.timeEnd("OBJLoader"),_}},THREE.ColladaLoader=function(){function e(e,r,a,i){var s=0;if(document.implementation&&document.implementation.createDocument){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState?(0===n.status||200===n.status)&&(n.response?(Fe=r,t(n.response,void 0,e)):i?i():console.error("ColladaLoader: Empty or non-existing file ("+e+")")):3===n.readyState&&a&&(0===s&&(s=n.getResponseHeader("Content-Length")),a({total:s,loaded:n.responseText.length}))},n.open("GET",e,!0),n.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,r){if(Ie=(new DOMParser).parseFromString(e,"text/xml"),t=t||Fe,void 0!==r){var l=r.split("/");l.pop(),Se=(l.length<1?".":l.join("/"))+"/"}a(),ye(),Ve=i("library_images image",A,"image"),Ue=i("library_materials material",W,"material"),Xe=i("library_effects effect",Q,"effect"),qe=i("library_geometries geometry",I,"geometry"),We=i("library_cameras camera",ae,"camera"),ze=i("library_lights light",se,"light"),Be=i("library_controllers controller",N,"controller"),Ge=i("library_animations animation",$,"animation"),Ce=i("library_visual_scenes visual_scene",L,"visual_scene"),Me=i("library_kinematics_models kinematics_model",oe,"kinematics_model"),Oe=[],je=[],Ne=s(),De=new THREE.Group;for(var h=0;h<Ne.nodes.length;h++)De.add(g(Ne.nodes[h]));De.scale.multiplyScalar(Ze),o(),He=n(),v();var c={scene:De,morphs:Oe,skins:je,animations:_e,kinematics:Le,dae:{images:Ve,materials:Ue,cameras:We,lights:ze,effects:Xe,geometries:qe,controllers:Be,animations:Ge,visualScenes:Ce,visualScene:Ne,scene:Ne,kinematicsModels:Me,kinematicsModel:He}};return t&&t(c),c}function r(e){Ye=e}function a(){var e=Ie.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var r=0;r<t.childNodes.length;r++){var a=t.childNodes[r];switch(a.nodeName){case"unit":var i=a.getAttribute("meter");i&&(Ze=parseFloat(i));break;case"up_axis":Qe=a.textContent.charAt(0)}}}function i(e,t,r){for(var a=Ie.querySelectorAll(e),i={},s=0,n=a.length,o=0;n>o;o++){var l=a[o],h=(new t).parse(l);h.id&&0!==h.id.length||(h.id=r+s++),i[h.id]=h}return i}function s(){var e=Ie.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Ce[t.length>0?t:"visual_scene0"]}return null}function n(){var e=Ie.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Me[t.length>0?t:"kinematics_model0"]}return null}function o(){_e=[],l(De)}function l(e){var t=Ne.getChildById(e.colladaId,!0),r=null;if(t&&t.keys){r={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},_e.push(r);for(var a=0,i=t.keys.length;i>a;a++)r.length=Math.max(r.length,t.keys[a].time)}else r={hierarchy:[{keys:[],sids:[]}]};for(var a=0,i=e.children.length;i>a;a++)for(var s=l(e.children[a]),n=0,o=s.hierarchy.length;o>n;n++)r.hierarchy.push({keys:[],sids:[]});return r}function h(){var e,t=1e6,r=-t,a=0;for(var i in Ge){var s=Ge[i];e=e||s.id;for(var n=0;n<s.sampler.length;n++){var o=s.sampler[n];o.create(),t=Math.min(t,o.startTime),r=Math.max(r,o.endTime),a=Math.max(a,o.input.length)}}return{start:t,end:r,frames:a,ID:e}}function c(e,t){var r=t instanceof S?Be[t.url]:t;if(!r||!r.morph)return void console.log("could not find morph controller!");for(var a=r.morph,i=0;i<a.targets.length;i++){var s=a.targets[i],n=qe[s];if(n.mesh&&n.mesh.primitives&&n.mesh.primitives.length){var o=n.mesh.primitives[0].geometry;o.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:o.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function u(e,t,r,a){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var i=e.channels[0],s=i.sampler.output[r];s instanceof THREE.Matrix4&&(e.world.copy(s),e.localworld.copy(s),0===r&&e.matrix.copy(s))}a&&e.world.multiplyMatrices(a,e.world),t.push(e);for(var n=0;n<e.nodes.length;n++)u(e.nodes[n],t,r,e.world)}function d(e,t){for(var r=0;r<e.length;r++){var a=e[r],i=-1;if("JOINT"==a.type){for(var s=0;s<t.joints.length;s++)if(a.sid===t.joints[s]){i=s;break}if(i>=0){var n=t.invBindMatrices[i];a.invBindMatrix=n,a.skinningMatrix=new THREE.Matrix4,a.skinningMatrix.multiplyMatrices(a.world,n),a.animatrix=new THREE.Matrix4,a.animatrix.copy(a.localworld),a.weights=[];for(var s=0;s<t.weights.length;s++)for(var o=0;o<t.weights[s].length;o++){var l=t.weights[s][o];l.joint===i&&a.weights.push(l)}}else console.warn("ColladaLoader: Could not find joint '"+a.sid+"'."),a.skinningMatrix=new THREE.Matrix4,a.weights=[]}}}function p(e){var t=[],r=function(e,t,a){var i={};i.name=t.sid,i.parent=e,i.matrix=t.matrix;var s=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];i.matrix.decompose(s[0],s[1],s[2]),i.pos=[s[0].x,s[0].y,s[0].z],i.scl=[s[2].x,s[2].y,s[2].z],i.rotq=[s[1].x,s[1].y,s[1].z,s[1].w],a.push(i);for(var n in t.nodes)r(t.sid,t.nodes[n],a)};return r(-1,e,t),t}function f(e,t,r){var a=[];u(t,a,-1),d(a,r.skin);for(var i=new THREE.Vector3,s=[],n=0;n<e.vertices.length;n++)s.push(new THREE.Vector3);for(n=0;n<a.length;n++)if("JOINT"==a[n].type)for(var o=0;o<a[n].weights.length;o++){var l=a[n].weights[o],h=l.index,c=l.weight,p=e.vertices[h],f=s[h];i.x=p.x,i.y=p.y,i.z=p.z,i.applyMatrix4(a[n].skinningMatrix),f.x+=i.x*c,f.y+=i.y*c,f.z+=i.z*c}for(var n=0;n<e.vertices.length;n++)e.vertices[n]=s[n]}function m(e,t,r){var a=Be[t.url];if(r=void 0!==r?r:40,!a||!a.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var i=h(),s=Ne.getChildById(t.skeleton[0],!0)||Ne.getChildBySid(t.skeleton[0],!0),n=p(s),o=a.skin.joints,l=[],c=0;c<o.length;c++)for(var m=0;m<n.length;m++)n[m].name===o[c]&&(l[c]=n[m]);for(var c=0;c<l.length;c++)for(var m=0;m<l.length;m++)l[c].parent===l[m].name&&(l[c].parent=m);var c,m,v;new THREE.Vector3;for(c=0;c<e.vertices.length;c++)e.vertices[c].applyMatrix4(a.skin.bindShapeMatrix);for(var g=[],E=[],b=a.skin.weights,c=0;c<b.length;c++){var y=new THREE.Vector4(b[c][0]?b[c][0].joint:0,b[c][1]?b[c][1].joint:0,b[c][2]?b[c][2].joint:0,b[c][3]?b[c][3].joint:0),v=new THREE.Vector4(b[c][0]?b[c][0].weight:0,b[c][1]?b[c][1].weight:0,b[c][2]?b[c][2].weight:0,b[c][3]?b[c][3].weight:0);g.push(y),E.push(v)}e.skinIndices=g,e.skinWeights=E,e.bones=l;for(var T={name:i.ID,fps:30,length:i.frames/30,hierarchy:[]},m=0;m<l.length;m++)T.hierarchy.push({parent:l[m].parent,name:l[m].name,keys:[]});for(console.log("ColladaLoader:",i.ID+" has "+l.length+" bones."),f(e,s,a),r=0;r<i.frames;r++){var w=[];u(s,w,r),d(w,a.skin);for(var c=0;c<w.length;c++)for(var m=0;m<T.hierarchy.length;m++)if(T.hierarchy[m].name===w[c].sid){var R={};R.time=r/30,R.matrix=w[c].animatrix,0===r&&(w[c].matrix=R.matrix);var x=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];R.matrix.decompose(x[0],x[1],x[2]),R.pos=[x[0].x,x[0].y,x[0].z],R.scl=[x[2].x,x[2].y,x[2].z],R.rot=x[1],T.hierarchy[m].keys.push(R)}e.animation=T}}function v(){if(He&&0===He.joints.length)return void(Le=void 0);var e={},t=function(t,r){var a=r.getAttribute("id"),i=Ne.getChildById(a,!0),s=He.joints[t];De.traverse(function(r){r.colladaId==a&&(e[t]={node:r,transforms:i.transforms,joint:s,position:s.zeroPosition})})};Le={joints:He&&He.joints,getJointValue:function(t){var r=e[t];return r?r.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,r){var i=e[t];if(i){var s=i.joint;if(r>s.limits.max||r<s.limits.min)console.log("setJointValue: joint "+t+" value "+r+" outside of limits (min: "+s.limits.min+", max: "+s.limits.max+")");else if(s["static"])console.log("setJointValue: joint "+t+" is static");else{var n=i.node,o=s.axis,l=i.transforms,h=new THREE.Matrix4;for(a=0;a<l.length;a++){var c=l[a];if(c.sid&&-1!==c.sid.indexOf("joint"+t))switch(s.type){case"revolute":h.multiply(u.makeRotationAxis(o,THREE.Math.degToRad(r)));break;case"prismatic":h.multiply(u.makeTranslation(o.x*r,o.y*r,o.z*r));break;default:console.warn("setJointValue: unknown joint type: "+s.type)}else{var u=new THREE.Matrix4;switch(c.type){case"matrix":h.multiply(c.obj);break;case"translate":h.multiply(u.makeTranslation(c.obj.x,c.obj.y,c.obj.z));break;case"rotate":h.multiply(u.makeRotationAxis(c.obj,c.angle))}}}var d=h.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];n.matrix.set.apply(n.matrix,f),n.matrix.decompose(n.position,n.quaternion,n.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var r=Ie.querySelector("scene instance_kinematics_scene");if(r)for(var a=0;a<r.childNodes.length;a++){var i=r.childNodes[a];if(1==i.nodeType)switch(i.nodeName){case"bind_joint_axis":var s=i.getAttribute("target").split("/").pop(),n=i.querySelector("axis param").textContent,o=parseInt(n.split("joint").pop().split(".")[0]),l=Ie.querySelector('[sid="'+s+'"]');if(l){var h=l.parentElement;t(o,h)}}}}function g(e,t){var r,a,i,s,n=new THREE.Object3D,o=!1;for(i=0;i<e.controllers.length;i++){var l=Be[e.controllers[i].url];switch(l.type){case"skin":if(qe[l.skin.source]){var h=new j;h.url=l.skin.source,h.instance_material=e.controllers[i].instance_material,e.geometries.push(h),o=!0,r=e.controllers[i]}else if(Be[l.skin.source]){var u=Be[l.skin.source];if(a=u,u.morph&&qe[u.morph.source]){var h=new j;h.url=u.morph.source,h.instance_material=e.controllers[i].instance_material,e.geometries.push(h)}}break;case"morph":if(qe[l.morph.source]){var h=new j;h.url=l.morph.source,h.instance_material=e.controllers[i].instance_material,e.geometries.push(h),a=e.controllers[i]}console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(i=0;i<e.geometries.length;i++){var p,f=e.geometries[i],v=f.instance_material,E=qe[f.url],b={},y=[],T=0;if(E){if(!E.mesh||!E.mesh.primitives)continue;if(0===n.name.length&&(n.name=E.id),v)for(s=0;s<v.length;s++){var w=v[s],R=Ue[w.target],x=R.instance_effect.url,k=Xe[x].shader,A=k.material;if(E.doubleSided){if(!(w.symbol in d)){var N=A.clone();N.side=THREE.DoubleSide,d[w.symbol]=N}A=d[w.symbol]}A.opacity=A.opacity?A.opacity:1,b[w.symbol]=T,y.push(A),p=A,p.name=null===R.name||""===R.name?R.id:R.name,T++}var H,_=p||new THREE.MeshLambertMaterial({color:14540253,side:E.doubleSided?THREE.DoubleSide:THREE.FrontSide}),L=E.mesh.geometry3js;T>1&&(_=new THREE.MultiMaterial(y)),void 0!==r?(m(L,r),L.morphTargets.length>0?(_.morphTargets=!0,_.skinning=!1):(_.morphTargets=!1,_.skinning=!0),H=new THREE.SkinnedMesh(L,_,!1),H.name="skin_"+je.length,je.push(H)):void 0!==a?(c(L,a),_.morphTargets=!0,H=new THREE.Mesh(L,_),H.name="morph_"+Oe.length,Oe.push(H)):H=L.isLineStrip===!0?new THREE.Line(L):new THREE.Mesh(L,_),n.add(H)}}for(i=0;i<e.cameras.length;i++){var C=e.cameras[i],M=We[C.url],S=new THREE.PerspectiveCamera(M.yfov,parseFloat(M.aspect_ratio),parseFloat(M.znear),parseFloat(M.zfar));n.add(S)}for(i=0;i<e.lights.length;i++){var O=null,I=e.lights[i],D=ze[I.url];if(D&&D.technique){var F=D.color.getHex(),P=D.intensity,V=D.distance,G=D.falloff_angle;switch(D.technique){case"directional":O=new THREE.DirectionalLight(F,P,V),O.position.set(0,0,1);break;case"point":O=new THREE.PointLight(F,P,V);break;case"spot":O=new THREE.SpotLight(F,P,V,G),O.position.set(0,0,1);break;case"ambient":O=new THREE.AmbientLight(F)}}O&&n.add(O)}if(n.name=e.name||e.id||"",n.colladaId=e.id||"",n.layer=e.layer||"",n.matrix=e.matrix,n.matrix.decompose(n.position,n.quaternion,n.scale),Je.centerGeometry&&n.geometry){var B=n.geometry.center();B.multiply(n.scale),B.applyQuaternion(n.quaternion),n.position.sub(B)}for(i=0;i<e.nodes.length;i++)n.add(g(e.nodes[i],e));return n}function E(e){for(var t=Ie.querySelectorAll("library_nodes node"),r=0;r<t.length;r++){var a=t[r].attributes.getNamedItem("id");if(a&&a.value===e)return t[r]}return void 0}function b(e){var t=[],r=1e6,a=-1e6;for(var i in Ge)for(var s=Ge[i],n=0;n<s.channel.length;n++){var o=s.channel[n],l=s.sampler[n],i=o.target.split("/")[0];i==e.id&&(l.create(),o.sampler=l,r=Math.min(r,l.startTime),a=Math.max(a,l.endTime),t.push(o))}return t.length&&(e.startTime=r,e.endTime=a),t}function y(e){if(e.channels&&e.channels.length){for(var t=[],r=[],a=0,i=e.channels.length;i>a;a++){var s,n=e.channels[a],o=n.fullSid,l=n.sampler,h=l.input,c=e.getTransformBySid(n.sid);if(n.arrIndices){s=[];for(var u=0,d=n.arrIndices.length;d>u;u++)s[u]=ke(n.arrIndices[u])}else s=Ae(n.member);if(c){-1===r.indexOf(o)&&r.push(o);for(var u=0,d=h.length;d>u;u++){var p=h[u],f=l.getData(c.type,u,s),m=T(t,p);if(!m){m=new re(p);var v=w(t,p);t.splice(-1===v?t.length:v,0,m)}m.addTarget(o,c,s,f)}}else console.log('Could not find transform "'+n.sid+'" in node '+e.id)}for(var a=0;a<r.length;a++)for(var g=r[a],u=0;u<t.length;u++){var m=t[u];m.hasTarget(g)||R(t,m,u,g)}e.keys=t,e.sids=r}}function T(e,t){for(var r=null,a=0,i=e.length;i>a&&null===r;a++){var s=e[a];if(s.time===t)r=s;else if(s.time>t)break}return r}function w(e,t){for(var r=-1,a=0,i=e.length;i>a&&-1===r;a++){var s=e[a];s.time>=t&&(r=a)}return r}function R(e,t,r,a){var i=k(e,a,r?r-1:0),s=x(e,a,r+1);if(i&&s){var n,o=(t.time-i.time)/(s.time-i.time),l=i.getTarget(a),h=s.getTarget(a).data,c=l.data;if("matrix"===l.type)n=c;else if(c.length){n=[];for(var u=0;u<c.length;++u)n[u]=c[u]+(h[u]-c[u])*o}else n=c+(h-c)*o;t.addTarget(a,l.transform,l.member,n)}}function x(e,t,r){for(;r<e.length;r++){var a=e[r];if(a.hasTarget(t))return a}return null}function k(e,t,r){for(r=r>=0?r:r+e.length;r>=0;r--){var a=e[r];if(a.hasTarget(t))return a}return null}function A(){this.id="",this.init_from=""}function N(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function H(){this.method=null,this.source=null,this.targets=null,this.weights=null}function _(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function L(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function C(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function M(){this.sid="",this.type="",this.data=[],this.obj=null}function S(){this.url="",this.skeleton=[],this.instance_material=[]}function O(){this.symbol="",this.target=""}function j(){this.url="",this.instance_material=[]}function I(){this.id="",this.mesh=null}function D(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function F(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function P(){F.call(this),this.vcount=[]}function V(){F.call(this),this.vcount=1}function G(){F.call(this),this.vcount=3}function B(){this.source="",this.count=0,this.stride=0,this.params=[]}function q(){this.input={}}function U(){this.semantic="",this.offset=0,this.source="",this.set=0}function X(e){this.id=e,this.type=null}function W(){this.id="",this.name="",this.instance_effect=null}function z(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function Y(e,t){this.type=e,this.effect=t,this.material=null}function J(e){this.effect=e,this.init_from=null,this.format=null}function Z(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Q(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function K(){this.url=""}function $(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ee(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function te(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function re(e){this.targets=[],this.time=e}function ae(){this.id="",this.name="",this.technique=""}function ie(){this.url=""}function se(){this.id="",this.name="",this.technique=""}function ne(){this.url=""}function oe(){this.id="",this.name="",this.joints=[],this.links=[]}function le(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0}function he(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ce(){this.joint="",this.transforms=[],this.links=[]}function ue(e){var t=e.getAttribute("id");return void 0!=Pe[t]?Pe[t]:(Pe[t]=new X(t).parse(e),Pe[t])}function de(e){for(var t=me(e),r=[],a=0,i=t.length;i>a;a++)r.push("true"===t[a]||"1"===t[a]?!0:!1);return r}function pe(e){for(var t=me(e),r=[],a=0,i=t.length;i>a;a++)r.push(parseFloat(t[a]));return r}function fe(e){for(var t=me(e),r=[],a=0,i=t.length;i>a;a++)r.push(parseInt(t[a],10));return r}function me(e){return e.length>0?ve(e).split(/\s+/):[]}function ve(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function ge(e,t,r){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):r}function Ee(e,t){var r=new THREE.ImageLoader;r.load(t,function(t){e.image=t,e.needsUpdate=!0})}function be(e,t){e.doubleSided=!1;var r=t.querySelectorAll("extra double_sided")[0];r&&r&&1===parseInt(r.textContent,10)&&(e.doubleSided=!0)}function ye(){if(Je.convertUpAxis!==!0||Qe===Je.upAxis)Ke=null;else switch(Qe){case"X":Ke="Y"===Je.upAxis?"XtoY":"XtoZ";break;case"Y":Ke="X"===Je.upAxis?"YtoX":"YtoZ";break;case"Z":Ke="X"===Je.upAxis?"ZtoX":"ZtoY"}}function Te(e,t){if(Je.convertUpAxis===!0&&Qe!==Je.upAxis)switch(Ke){case"XtoY":var r=e[0];e[0]=t*e[1],e[1]=r;break;case"XtoZ":var r=e[2];e[2]=e[1],e[1]=e[0],e[0]=r;break;case"YtoX":var r=e[0];e[0]=e[1],e[1]=t*r;break;case"YtoZ":var r=e[1];e[1]=t*e[2],e[2]=r;break;case"ZtoX":var r=e[0];e[0]=e[1],e[1]=e[2],e[2]=r;break;case"ZtoY":var r=e[1];e[1]=e[2],e[2]=t*r}}function we(e,t){if(Je.convertUpAxis!==!0||Qe===Je.upAxis)return t;switch(e){case"X":t="XtoY"===Ke?-1*t:t;break;case"Y":t="YtoZ"===Ke||"YtoX"===Ke?-1*t:t;break;case"Z":t="ZtoY"===Ke?-1*t:t}return t}function Re(e,t){var r=[e[t],e[t+1],e[t+2]];return Te(r,-1),new THREE.Vector3(r[0],r[1],r[2])}function xe(e){if(Je.convertUpAxis){var t=[e[0],e[4],e[8]];Te(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],Te(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],Te(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],Te(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],Te(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],Te(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],Te(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function ke(e){if(e>-1&&3>e){var t=["X","Y","Z"],r={X:0,Y:1,Z:2};e=Ae(t[e]),e=r[e]}return e}function Ae(e){if(Je.convertUpAxis)switch(e){case"X":switch(Ke){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(Ke){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(Ke){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var Ne,He,_e,Le,Ce,Me,Se,Oe,je,Ie=null,De=null,Fe=null,Pe={},Ve={},Ge={},Be={},qe={},Ue={},Xe={},We={},ze={},Ye=THREE.SmoothShading,Je={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Ze=1,Qe="Y",Ke=null;return A.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];"init_from"===r.nodeName&&(this.init_from=r.textContent)}return this},N.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"skin":this.skin=(new _).parse(r),this.type=r.nodeName;break;case"morph":this.morph=(new H).parse(r),this.type=r.nodeName}}return this},H.prototype.parse=function(e){var t,r={},a=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":var s=(new X).parse(i);r[s.id]=s;break;case"targets":a=this.parseInputs(i);break;default:console.log(i.nodeName)}}for(t=0;t<a.length;t++){var n=a[t],s=r[n.source];switch(n.semantic){case"MORPH_TARGET":this.targets=s.read();break;case"MORPH_WEIGHT":this.weights=s.read()}}return this},H.prototype.parseInputs=function(e){for(var t=[],r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"input":t.push((new U).parse(a))}}return t},_.prototype.parse=function(e){var t,r,a={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1==s.nodeType)switch(s.nodeName){case"bind_shape_matrix":var n=pe(s.textContent);this.bindShapeMatrix=xe(n);break;case"source":var o=(new X).parse(s);a[o.id]=o;break;case"joints":t=s;break;case"vertex_weights":r=s;break;default:console.log(s.nodeName)}}return this.parseJoints(t,a),this.parseWeights(r,a),this},_.prototype.parseJoints=function(e,t){for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"input":var i=(new U).parse(a),s=t[i.source];"JOINT"===i.semantic?this.joints=s.read():"INV_BIND_MATRIX"===i.semantic&&(this.invBindMatrices=s.read())}}},_.prototype.parseWeights=function(e,t){for(var r,a,i=[],s=0;s<e.childNodes.length;s++){var n=e.childNodes[s];if(1==n.nodeType)switch(n.nodeName){case"input":i.push((new U).parse(n));break;case"v":r=fe(n.textContent);break;case"vcount":a=fe(n.textContent)}}for(var o=0,s=0;s<a.length;s++){for(var l=a[s],h=[],c=0;l>c;c++){for(var u={},d=0;d<i.length;d++){var p=i[d],f=r[o+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f]}}h.push(u),o+=i.length}for(var c=0;c<h.length;c++)h[c].index=s;this.weights.push(h)}},L.prototype.getChildById=function(e,t){for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildById(e,t);if(a)return a}return null},L.prototype.getChildBySid=function(e,t){for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildBySid(e,t);if(a)return a}return null},L.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"node":this.nodes.push((new C).parse(r))}}return this},C.prototype.getChannelForTransform=function(e){
for(var t=0;t<this.channels.length;t++){var r,a,i=this.channels[t],s=i.target.split("/"),n=(s.shift(),s.shift()),o=n.indexOf(".")>=0,l=n.indexOf("(")>=0;if(o)s=n.split("."),n=s.shift(),a=s.shift();else if(l){r=n.split("("),n=r.shift();for(var h=0;h<r.length;h++)r[h]=parseInt(r[h].replace(/\)/,""))}if(n===e)return i.info={sid:n,dotSyntax:o,arrSyntax:l,arrIndices:r},i}return null},C.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildById(e,t);if(a)return a}return null},C.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var a=this.nodes[r].getChildBySid(e,t);if(a)return a}return null},C.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},C.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"node":this.nodes.push((new C).parse(a));break;case"instance_camera":this.cameras.push((new ie).parse(a));break;case"instance_controller":this.controllers.push((new S).parse(a));break;case"instance_geometry":this.geometries.push((new j).parse(a));break;case"instance_light":this.lights.push((new ne).parse(a));break;case"instance_node":t=a.getAttribute("url").replace(/^#/,"");var i=E(t);i&&this.nodes.push((new C).parse(i));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new M).parse(a));break;case"extra":break;default:console.log(a.nodeName)}}return this.channels=b(this),y(this),this.updateMatrix(),this},C.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},M.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=pe(e.textContent),this.convert(),this},M.prototype.convert=function(){switch(this.type){case"matrix":this.obj=xe(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":Te(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Te(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},M.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),M.prototype.update=function(e,t){var r=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var a="n"+(t[0]+1)+(t[1]+1);this.obj[a]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},S.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1===r.nodeType)switch(r.nodeName){case"skeleton":this.skeleton.push(r.textContent.replace(/^#/,""));break;case"bind_material":for(var a=r.querySelectorAll("instance_material"),i=0;i<a.length;i++){var s=a[i];this.instance_material.push((new O).parse(s))}break;case"extra":}}return this},O.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},j.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType&&"bind_material"===r.nodeName){for(var a=r.querySelectorAll("instance_material"),i=0;i<a.length;i++){var s=a[i];this.instance_material.push((new O).parse(s))}break}}return this},I.prototype.parse=function(e){this.id=e.getAttribute("id"),be(this,e);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"mesh":this.mesh=new D(this).parse(r);break;case"extra":}}return this},D.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"source":ue(r);break;case"vertices":this.vertices=(new q).parse(r);break;case"linestrips":this.primitives.push((new V).parse(r));break;case"triangles":this.primitives.push((new G).parse(r));break;case"polygons":this.primitives.push((new F).parse(r));break;case"polylist":this.primitives.push((new P).parse(r))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var a=Pe[this.vertices.input.POSITION.source].data,t=0;t<a.length;t+=3)this.geometry3js.vertices.push(Re(a,t).clone());for(var t=0;t<this.primitives.length;t++){var i=this.primitives[t];i.setVertices(this.vertices),this.handlePrimitive(i,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},D.prototype.handlePrimitive=function(e,t){if(e instanceof V)return void(t.isLineStrip=!0);var r,a,i,s,n,o,l,h=e.p,c=e.inputs,u=0,d=3,p=0,f=[];for(r=0;r<c.length;r++){i=c[r];var m=i.offset+1;switch(p=m>p?m:p,i.semantic){case"TEXCOORD":f.push(i.set)}}for(var v=0;v<h.length;++v)for(var g=h[v],E=0;E<g.length;){var b=[],y=[],T=null,w=[];for(d=e.vcount?e.vcount.length?e.vcount[u++]:e.vcount:g.length/p,r=0;d>r;r++)for(a=0;a<c.length;a++)switch(i=c[a],o=Pe[i.source],s=g[E+r*p+i.offset],l=o.accessor.params.length,n=s*l,i.semantic){case"VERTEX":b.push(s);break;case"NORMAL":y.push(Re(o.data,n));break;case"TEXCOORD":T=T||{},void 0===T[i.set]&&(T[i.set]=[]),T[i.set].push(new THREE.Vector2(o.data[n],o.data[n+1]));break;case"COLOR":w.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}if(0===y.length)if(i=this.vertices.input.NORMAL){o=Pe[i.source],l=o.accessor.params.length;for(var R=0,x=b.length;x>R;R++)y.push(Re(o.data,b[R]*l))}else t.calcNormals=!0;if(!T&&(T={},i=this.vertices.input.TEXCOORD)){f.push(i.set),o=Pe[i.source],l=o.accessor.params.length;for(var R=0,x=b.length;x>R;R++)n=b[R]*l,void 0===T[i.set]&&(T[i.set]=[]),T[i.set].push(new THREE.Vector2(o.data[n],1-o.data[n+1]))}if(0===w.length&&(i=this.vertices.input.COLOR)){o=Pe[i.source],l=o.accessor.params.length;for(var R=0,x=b.length;x>R;R++)n=b[R]*l,w.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}var k,A,N=null,H=[];if(3===d)H.push(new THREE.Face3(b[0],b[1],b[2],y,w.length?w:new THREE.Color));else if(4===d)H.push(new THREE.Face3(b[0],b[1],b[3],y.length?[y[0].clone(),y[1].clone(),y[3].clone()]:[],w.length?[w[0],w[1],w[3]]:new THREE.Color)),H.push(new THREE.Face3(b[1],b[2],b[3],y.length?[y[1].clone(),y[2].clone(),y[3].clone()]:[],w.length?[w[1],w[2],w[3]]:new THREE.Color));else if(d>4&&Je.subdivideFaces){var _=w.length?w:new THREE.Color;for(a=1;d-1>a;)H.push(new THREE.Face3(b[0],b[a],b[a+1],y.length?[y[0].clone(),y[a++].clone(),y[a].clone()]:[],_))}if(H.length)for(var R=0,x=H.length;x>R;R++)for(N=H[R],N.daeMaterial=e.material,t.faces.push(N),a=0;a<f.length;a++)k=T[f[a]],A=d>4?[k[0],k[R+1],k[R+2]]:4===d?0===R?[k[0],k[1],k[3]]:[k[1].clone(),k[2],k[3].clone()]:[k[0],k[1],k[2]],void 0===t.faceVertexUvs[a]&&(t.faceVertexUvs[a]=[]),t.faceVertexUvs[a].push(A);else console.log("dropped face with vcount "+d+" for geometry with id: "+t.id);E+=p*d}},F.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},F.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=ge(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"input":this.inputs.push((new U).parse(e.childNodes[t]));break;case"vcount":this.vcount=fe(r.textContent);break;case"p":this.p.push(fe(r.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},P.prototype=Object.create(F.prototype),P.prototype.constructor=P,V.prototype=Object.create(F.prototype),V.prototype.constructor=V,G.prototype=Object.create(F.prototype),G.prototype.constructor=G,B.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=ge(e,"count",0),this.stride=ge(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if("param"===r.nodeName){var a={};a.name=r.getAttribute("name"),a.type=r.getAttribute("type"),this.params.push(a)}}return this},q.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var r=(new U).parse(e.childNodes[t]);this.input[r.semantic]=r}return this},U.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=ge(e,"set",-1),this.offset=ge(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},X.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"bool_array":this.data=de(r.textContent),this.type=r.nodeName;break;case"float_array":this.data=pe(r.textContent),this.type=r.nodeName;break;case"int_array":this.data=fe(r.textContent),this.type=r.nodeName;break;case"IDREF_array":case"Name_array":this.data=me(r.textContent),this.type=r.nodeName;break;case"technique_common":for(var a=0;a<r.childNodes.length;a++)if("accessor"===r.childNodes[a].nodeName){this.accessor=(new B).parse(r.childNodes[a]);break}}}return this},X.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var r=0;r<this.data.length;r+=16){var a=this.data.slice(r,r+16),i=xe(a);e.push(i)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},W.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new K).parse(e.childNodes[t]);break}return this},z.prototype.isColor=function(){return null===this.texture},z.prototype.isTexture=function(){return null!=this.texture},z.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"color":var a=pe(r.textContent);this.color=new THREE.Color,this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"texture":this.texture=r.getAttribute("texture"),this.texcoord=r.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(r)}}return this},z.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[r.nodeName]=parseFloat(r.textContent);break;case"wrapU":case"wrapV":"TRUE"===r.textContent.toUpperCase()?this.texOpts[r.nodeName]=1:this.texOpts[r.nodeName]=parseInt(r.textContent);break;default:this.texOpts[r.nodeName]=r.textContent}}return this},Y.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[r.nodeName]=(new z).parse(r);break;case"bump":var a=r.getAttribute("bumptype");a?"heightfield"===a.toLowerCase()?this.bump=(new z).parse(r):"normalmap"===a.toLowerCase()?this.normal=(new z).parse(r):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+a+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new z).parse(r)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new z).parse(r));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var i=r.querySelectorAll("float");i.length>0&&(this[r.nodeName]=parseFloat(i[0].textContent))}}return this.create(),this},Y.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var r=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);r>0&&(t=!0,e.transparent=!0,e.opacity=1-r)}var a={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var i in this)switch(i){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var s=this[i];if(s instanceof z)if(s.isTexture()){var n=s.texture,o=this.effect.sampler[n];if(void 0!==o&&void 0!==o.source){var l=this.effect.surface[o.source];if(void 0!==l){var h=Ve[l.init_from];if(h){var c,u=Se+h.init_from,d=THREE.Loader.Handlers.get(u);null!==d?c=d.load(u):(c=new THREE.Texture,Ee(c,u)),c.wrapS=s.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,c.wrapT=s.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,c.offset.x=s.texOpts.offsetU,c.offset.y=s.texOpts.offsetV,c.repeat.x=s.texOpts.repeatU,c.repeat.y=s.texOpts.repeatV,e[a[i]]=c,"emission"===i&&(e.emissive=16777215)}}}}else"diffuse"!==i&&t||("emission"===i?e.emissive=s.color.getHex():e[i]=s.color.getHex());break;case"shininess":e[i]=this[i];break;case"reflectivity":e[i]=this[i],e[i]>0&&(e.envMap=Je.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[i],1!==this[i]&&(e.envMap=Je.defaultEnvMap);break;case"transparency":}switch(e.shading=Ye,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},J.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"init_from":this.init_from=r.textContent;break;case"format":this.format=r.textContent;break;default:console.log("unhandled Surface prop: "+r.nodeName)}}return this},Z.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":this.source=r.textContent;break;case"minfilter":this.minfilter=r.textContent;break;case"magfilter":this.magfilter=r.textContent;break;case"mipfilter":this.mipfilter=r.textContent;break;case"wrap_s":this.wrap_s=r.textContent;break;case"wrap_t":this.wrap_t=r.textContent;break;default:console.log("unhandled Sampler2D prop: "+r.nodeName)}}return this},Q.prototype.create=function(){return null===this.shader?null:void 0},Q.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),be(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(r))}}return this},Q.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"surface":this.surface[t]=new J(this).parse(a);break;case"sampler2D":this.sampler[t]=new Z(this).parse(a);break;case"extra":break;default:console.log(a.nodeName)}}},Q.prototype.parseProfileCOMMON=function(e){for(var t,r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"profile_COMMON":this.parseProfileCOMMON(a);break;case"technique":t=a;break;case"newparam":this.parseNewparam(a);break;case"image":var i=(new A).parse(a);Ve[i.id]=i;break;case"extra":break;default:console.log(a.nodeName)}}return t},Q.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new Y(r.nodeName,this).parse(r);break;case"extra":this.parseExtra(r)}}},Q.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique":this.parseExtraTechnique(r)}}},Q.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"bump":this.shader.parse(e)}}},K.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},$.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"animation":var a=(new $).parse(r);for(var i in a.source)this.source[i]=a.source[i];for(var s=0;s<a.channel.length;s++)this.channel.push(a.channel[s]),this.sampler.push(a.sampler[s]);break;case"source":var i=(new X).parse(r);this.source[i.id]=i;break;case"sampler":this.sampler.push(new te(this).parse(r));break;case"channel":this.channel.push(new ee(this).parse(r))}}return this},ee.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),r=(t.shift(),t.shift()),a=r.indexOf(".")>=0,i=r.indexOf("(")>=0;if(a)t=r.split("."),this.sid=t.shift(),this.member=t.shift();else if(i){var s=r.split("(");this.sid=s.shift();for(var n=0;n<s.length;n++)s[n]=parseInt(s[n].replace(/\)/,""));this.arrIndices=s}else this.sid=r;return this.fullSid=r,this.dotSyntax=a,this.arrSyntax=i,this},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"input":this.inputs.push((new U).parse(r))}}return this},te.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],r=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=r.read();break;case"OUTPUT":this.output=r.read(),this.strideOut=r.accessor.stride;break;case"INTERPOLATION":this.interpolation=r.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},te.prototype.getData=function(e,t,r){var a;if("matrix"===e&&16===this.strideOut)a=this.output[t];else if(this.strideOut>1){a=[],t*=this.strideOut;for(var i=0;i<this.strideOut;++i)a[i]=this.output[t+i];if(3===this.strideOut)switch(e){case"rotate":case"translate":Te(a,-1);break;case"scale":Te(a,1)}else 4===this.strideOut&&"matrix"===e&&Te(a,-1)}else a=this.output[t],r&&"translate"===e&&(a=we(r,a));return a},re.prototype.addTarget=function(e,t,r,a){this.targets.push({sid:e,member:r,transform:t,data:a})},re.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var r=this.targets[t];e&&r.sid!==e||r.transform.update(r.data,r.member)}},re.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},re.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},re.prototype.interpolate=function(e,t){for(var r=0,a=this.targets.length;a>r;r++){var i,s=this.targets[r],n=e.getTarget(s.sid);if("matrix"!==s.transform.type&&n){var o=(t-this.time)/(e.time-this.time),l=n.data,h=s.data;if(0>o&&(o=0),o>1&&(o=1),h.length){i=[];for(var c=0;c<h.length;++c)i[c]=h[c]+(l[c]-h[c])*o}else i=h+(l-h)*o}else i=s.data;s.transform.update(i,s.member)}},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"optics":this.parseOptics(r)}}return this},ae.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var r=e.childNodes[t],a=0;a<r.childNodes.length;a++)if(this.technique=r.childNodes[a].nodeName,"perspective"===this.technique)for(var i=r.childNodes[a],s=0;s<i.childNodes.length;s++){var n=i.childNodes[s];switch(n.nodeName){case"yfov":this.yfov=n.textContent;break;case"xfov":this.xfov=n.textContent;break;case"znear":this.znear=n.textContent;break;case"zfar":this.zfar=n.textContent;break;case"aspect_ratio":this.aspect_ratio=n.textContent}}else if("orthographic"===this.technique)for(var o=r.childNodes[a],s=0;s<o.childNodes.length;s++){var n=o.childNodes[s];switch(n.nodeName){case"xmag":this.xmag=n.textContent;break;case"ymag":this.ymag=n.textContent;break;case"znear":this.znear=n.textContent;break;case"zfar":this.zfar=n.textContent;break;case"aspect_ratio":this.aspect_ratio=n.textContent}}return this},ie.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r);break;case"technique":this.parseTechnique(r)}}return this},se.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var r=e.childNodes[t],a=0;a<r.childNodes.length;a++){var i=r.childNodes[a];switch(i.nodeName){case"color":var s=pe(i.textContent);this.color=new THREE.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(i.textContent);break;case"quadratic_attenuation":var n=parseFloat(i.textContent);this.distance=n?Math.sqrt(1/n):0}}}return this},se.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"intensity":this.intensity=parseFloat(r.textContent)}}return this},ne.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},oe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r)}}return this},oe.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new le).parse(r));break;case"link":this.links.push((new he).parse(r))}}return this},le.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),r=pe(t.textContent);this.axis=Re(r,0);var a=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,i=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:a,max:i};for(var s=["prismatic","revolute"],n=0;n<s.length;n++){var o=s[n],l=e.querySelector(o);l&&(this.type=o)}return this.limits.min>=this.limits.max&&(this["static"]=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},he.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"attachment_full":this.attachments.push((new ce).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new M).parse(r))}}return this},ce.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"link":this.links.push((new he).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new M).parse(r))}}return this},{load:e,parse:t,setPreferredShading:r,applySkin:m,geometries:qe,options:Je}};var global=window;!function(e,t){"object"==typeof exports?t(module.exports):"function"==typeof define&&define.amd?define([],function(){return t(e)}):t(e)}(this,function(e){"use strict";var t=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","animations","scenes"],r=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(e){this._rootDescription=e},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(e){var t=new RegExp("^"+window.location.protocol,"i");return e.match(t)?!0:!1}},resolvePathIfNeeded:{value:function(e){if(this._isAbsolutePath(e))return e;var t=/^data:/;return t.test(e)?e:this.baseURL+e}},_resolvePathsForCategories:{value:function(e){e.forEach(function(e){var t=this.json[e];if(t){var r=Object.keys(t);r.forEach(function(e){var r=t[e];r.uri=this.resolvePathIfNeeded(r.uri)},this)}},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(e){this._json!==e&&(this._json=e,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(e,t){var r=null,a=t;return r=this.rootDescription[a],r?r?r[e]:null:(console.log("ERROR:CANNOT find expected category named:"+a),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),-1!==this._state.categoryIndex?(this._state.categoryState.index=0,!0):!1}},_stepToNextDescription:{enumerable:!1,value:function(){var e=this._state.categoryState,t=e.keys;return t?(e.index++,e.keys=null,e.index>=t.length?this._stepToNextCategory():!1):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(e){return this.rootDescription[e]?!0:!1}},_handleState:{value:function(){for(var e={buffers:this.handleBuffer,bufferViews:this.handleBufferView,shaders:this.handleShader,programs:this.handleProgram,techniques:this.handleTechnique,materials:this.handleMaterial,meshes:this.handleMesh,cameras:this.handleCamera,lights:this.handleLight,nodes:this.handleNode,scenes:this.handleScene,images:this.handleImage,animations:this.handleAnimation,accessors:this.handleAccessor,skins:this.handleSkin,samplers:this.handleSampler,textures:this.handleTexture,videos:this.handleVideo,extensions:this.handleExtension},r=!0;-1!==this._state.categoryIndex;){var a=t[this._state.categoryIndex],i=this._state.categoryState,s=i.keys;if(s||(i.keys=s=Object.keys(this.rootDescription[a]),!s||0!=s.length)){var n=a,o=s[i.index],l=this.getEntryDescription(o,n);if(l){if(e[n]&&e[n].call(this,o,l,this._state.userInfo)===!1){r=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+o),r=!1;break}}else this._stepToNextDescription()}this.handleLoadCompleted&&this.handleLoadCompleted(r)}},_loadJSONIfNeeded:{enumerable:!0,value:function(e){var t=this;if(this._json)e&&e(this.json);else{var r=this._path,a=r.lastIndexOf("/");this.baseURL=0!==a?r.substring(0,a+1):"";var i=new XMLHttpRequest;i.open("GET",r,!0),i.onreadystatechange=function(){4==i.readyState&&200==i.status&&(t.json=JSON.parse(i.responseText),e&&e(t.json))},i.send(null)}}},_buildLoader:{value:function(e){function t(t){r.rootDescription=t,e&&e(this)}var r=this;this._loadJSONIfNeeded(t)}},_state:{value:null,writable:!0},_getEntryType:{value:function(e){for(var r=t,a=0;a<r.length;a++){var i=this.rootDescription[r[a]];if(i)return r[a]}return null}},getNextCategoryIndex:{value:function(e){for(var r=e;r<t.length;r++)if(this.hasCategory(t[r]))return r;return-1}},load:{enumerable:!0,value:function(e,t){var r=this;this._buildLoader(function(a){var i=r.getNextCategoryIndex.call(r,0);-1!==i&&(r._state={userInfo:e,options:t,categoryIndex:i,categoryState:{index:"0"}},r._handleState())})}},initWithPath:{value:function(e){return this._path=e,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return"undefined"==typeof this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(e,t){return this.json=e,this.baseURL=t,t||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}});return e&&(e.glTFParser=r),r}),THREE.glTFLoader=function(){this.meshesRequested=0,this.meshesLoaded=0,this.pendingMeshes=[],this.animationsRequested=0,this.animationsLoaded=0,this.animations=[],this.shadersRequested=0,this.shadersLoaded=0,this.shaders={},this.loadRequests=[],THREE.glTFShaders.removeAll(),THREE.Loader.call(this)},THREE.glTFLoader.prototype=new THREE.Loader,THREE.glTFLoader.prototype.constructor=THREE.glTFLoader,THREE.glTFLoader.prototype.load=function(url,callback){function RgbArraytoHex(e){if(!e)return 4294967295;var t=Math.floor(255*e[0]),r=Math.floor(255*e[1]),a=Math.floor(255*e[2]),i=255,s=(i<<24)+(t<<16)+(r<<8)+a;return s}function componentsPerElementForGLType(e){switch(e){case"SCALAR":nElements=1;break;case"VEC2":nElements=2;break;case"VEC3":nElements=3;break;case"VEC4":nElements=4;break;case"MAT2":nElements=4;break;case"MAT3":nElements=9;break;case"MAT4":nElements=16}return nElements}function replaceShaderDefinitions(shader,material){var program=material.params.program,shaderParams=material.params.technique.parameters,shaderAttributes=material.params.technique.attributes,params={};for(var attribute in material.params.attributes){var pname=shaderAttributes[attribute],shaderParam=shaderParams[pname],semantic=shaderParam.semantic;semantic&&(params[attribute]=shaderParam)}var s=shader,r="";for(var pname in params){var param=params[pname],semantic=param.semantic;switch(r=eval("/"+pname+"/g"),semantic){case"POSITION":s=s.replace(r,"position");break;case"NORMAL":s=s.replace(r,"normal");break;case"TEXCOORD_0":s=s.replace(r,"uv");break;case"WEIGHT":s=s.replace(r,"skinWeight");break;case"JOINT":
s=s.replace(r,"skinIndex")}}return s}function replaceShaderSemantics(e){var t=theLoader.shaders[e.params.vertexShader];t&&(t=replaceShaderDefinitions(t,e),theLoader.shaders[e.params.vertexShader]=t)}function createShaderMaterial(e){replaceShaderSemantics(e);var t=theLoader.shaders[e.params.fragmentShader];if(!t)return console.log("ERROR: Missing fragment shader definition:",e.params.fragmentShader),new THREE.MeshPhongMaterial;var r=theLoader.shaders[e.params.vertexShader];if(!r)return console.log("ERROR: Missing vertex shader definition:",e.params.vertexShader),new THREE.MeshPhongMaterial;var a=THREE.UniformsUtils.clone(e.params.uniforms);for(uniform in e.params.uniforms){var i=e.params.uniforms[uniform],s=a[uniform];"t"==s.type&&(s.value=i.value)}var n=new THREE.RawShaderMaterial({fragmentShader:t,vertexShader:r,uniforms:a,transparent:e.params.transparent});return n}function LoadTexture(e){function t(e,t){var r=decodeURIComponent(t);return e?atob(r):r}function r(e,r){for(var a=t(e,r),i=new ArrayBuffer(a.length),s=new Uint8Array(i),n=0;n<a.length;n++)s[n]=a.charCodeAt(n);return i}function a(e,a){a="undefined"!=typeof a?a:"";var i=e[1],s=!!e[2],n=e[3];switch(a){case"":case"text":return t(s,n);case"ArrayBuffer":return r(s,n);case"blob":var o=r(s,n);return new Blob([o],{type:i});case"document":var l=new DOMParser;return l.parseFromString(t(s,n),i);case"json":return JSON.parse(t(s,n));default:throw"Unhandled responseType: "+a}}if(!e)return null;var i=function(e,t,r){var a=new Image;a.onload=function(){t(a)},"undefined"!=typeof r&&(a.onerror=r),a.src=e},s=/^data:(.*?)(;base64)?,(.*)$/,n=s.exec(e);if(null!==n){var o=new THREE.Texture,l=a(n,"blob"),h=window.URL.createObjectURL(l);return i(h,function(e){o.image=e,o.needsUpdate=!0}),o}return(new THREE.TextureLoader).load(e)}function CreateTexture(e,t){var r=null,a=null;if(t){var i=t;if(i){var s=e.getEntry(i);if(s){var n=e.getEntry(s.description.source);n&&(r=n.description.uri);var o=e.getEntry(s.description.sampler);o&&(a=o.description)}}}var i=LoadTexture(r);return i&&a&&(a.wrapS==WebGLRenderingContext.REPEAT&&(i.wrapS=THREE.RepeatWrapping),a.wrapT==WebGLRenderingContext.REPEAT&&(i.wrapT=THREE.RepeatWrapping),a.magFilter==WebGLRenderingContext.LINEAR&&(i.magFilter=THREE.LinearFilter)),i}var theLoader=this,ClassicGeometry=function(){this.geometry=new THREE.BufferGeometry,this.totalAttributes=0,this.loadedAttributes=0,this.indicesLoaded=!1,this.finished=!1,this.onload=null,this.uvs=null,this.indexArray=null};ClassicGeometry.prototype.constructor=ClassicGeometry,ClassicGeometry.prototype.buildBufferGeometry=function(){var e=this.geometry;e.setIndex(new THREE.BufferAttribute(this.indexArray,1));var t={start:0,index:0,count:this.indexArray.length};e.groups.push(t),e.computeBoundingSphere()},ClassicGeometry.prototype.checkFinished=function(){this.indexArray&&this.loadedAttributes===this.totalAttributes&&(this.buildBufferGeometry(),this.finished=!0,this.onload&&this.onload())};var IndicesDelegate=function(){};IndicesDelegate.prototype.handleError=function(e,t){console.log("ERROR(IndicesDelegate):"+e+":"+t)},IndicesDelegate.prototype.convert=function(e,t){return new Uint16Array(e,0,t.indices.count)},IndicesDelegate.prototype.resourceAvailable=function(e,t){var r=t.geometry;return r.indexArray=e,r.checkFinished(),!0};var indicesDelegate=new IndicesDelegate,IndicesContext=function(e,t){this.indices=e,this.geometry=t},VertexAttributeDelegate=function(){};VertexAttributeDelegate.prototype.handleError=function(e,t){console.log("ERROR(VertexAttributeDelegate):"+e+":"+t)},VertexAttributeDelegate.prototype.convert=function(e,t){return e},VertexAttributeDelegate.prototype.bufferResourceAvailable=function(e,t){var r,a,i,s=t.geometry,n=t.attribute,o=t.semantic;if("POSITION"==o)r=new Float32Array(e,0,n.count*componentsPerElementForGLType(n.type)),s.geometry.addAttribute("position",new THREE.BufferAttribute(r,3));else if("NORMAL"==o)i=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*i),s.geometry.addAttribute("normal",new THREE.BufferAttribute(r,3));else if("TEXCOORD_0"==o||"TEXCOORD"==o){for(i=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*i),a=0;a<r.length/2;a++)r[2*a+1]=1-r[2*a+1];s.geometry.addAttribute("uv",new THREE.BufferAttribute(r,i))}else"WEIGHT"==o?(i=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*i),s.geometry.addAttribute("skinWeight",new THREE.BufferAttribute(r,i))):"JOINT"==o&&(i=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*i),s.geometry.addAttribute("skinIndex",new THREE.BufferAttribute(r,i)))},VertexAttributeDelegate.prototype.resourceAvailable=function(e,t){this.bufferResourceAvailable(e,t);var r=t.geometry;return r.loadedAttributes++,r.checkFinished(),!0};var vertexAttributeDelegate=new VertexAttributeDelegate,VertexAttributeContext=function(e,t,r){this.attribute=e,this.semantic=t,this.geometry=r},Mesh=function(){this.primitives=[],this.materialsPending=[],this.loadedGeometry=0,this.onCompleteCallbacks=[]};Mesh.prototype.addPrimitive=function(e,t){var r=this;e.onload=function(){r.loadedGeometry++,r.checkComplete()},this.primitives.push({geometry:e,material:t,mesh:null})},Mesh.prototype.onComplete=function(e){this.onCompleteCallbacks.push(e)},Mesh.prototype.checkComplete=function(){var e=this;this.onCompleteCallbacks.length&&this.primitives.length==this.loadedGeometry&&(this.onCompleteCallbacks.forEach(function(t){t(e)}),this.onCompleteCallbacks=[])},Mesh.prototype.attachToNode=function(e){var t=this;this.primitives.forEach(function(r){var a=r.material,i=a.params;if(a instanceof THREE.Material||(a=createShaderMaterial(a)),!t.skin){var s=new THREE.Mesh(r.geometry.geometry,a);if(s.castShadow=!0,e.add(s),a instanceof THREE.ShaderMaterial){var n=new THREE.glTFShader(a,i,s,theLoader.rootObj);THREE.glTFShaders.add(n)}}})};var Material=function(e){this.params=e},AnimationParameterDelegate=function(){};AnimationParameterDelegate.prototype.handleError=function(e,t){console.log("ERROR(AnimationParameterDelegate):"+e+":"+t)},AnimationParameterDelegate.prototype.convert=function(e,t){var r=t.parameter,a=null;switch(r.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":a=new Float32Array(e,0,r.count*componentsPerElementForGLType(r.type))}return a},AnimationParameterDelegate.prototype.resourceAvailable=function(e,t){var r=t.animation,a=t.parameter;return a.data=e,r.handleParameterLoaded(a),!0};var animationParameterDelegate=new AnimationParameterDelegate,AnimationParameterContext=function(e,t){this.parameter=e,this.animation=t},Animation=function(){this.totalParameters=0,this.loadedParameters=0,this.parameters={},this.finishedLoading=!1,this.onload=null};Animation.prototype.constructor=Animation,Animation.prototype.handleParameterLoaded=function(e){this.parameters[e.name]=e,this.loadedParameters++,this.checkFinished()},Animation.prototype.checkFinished=function(){this.loadedParameters===this.totalParameters&&(this.finishedLoading=!0,this.onload&&this.onload())};var InverseBindMatricesDelegate=function(){};InverseBindMatricesDelegate.prototype.handleError=function(e,t){console.log("ERROR(InverseBindMatricesDelegate):"+e+":"+t)},InverseBindMatricesDelegate.prototype.convert=function(e,t){var r=t.parameter,a=null;switch(r.type){case"MAT4":a=new Float32Array(e,0,r.count*componentsPerElementForGLType(r.type))}return a},InverseBindMatricesDelegate.prototype.resourceAvailable=function(e,t){var r=t.skin;return r.inverseBindMatrices=e,!0};var inverseBindMatricesDelegate=new InverseBindMatricesDelegate,InverseBindMatricesContext=function(e,t){this.parameter=e,this.skin=t},ShaderDelegate=function(){};ShaderDelegate.prototype.handleError=function(e,t){console.log("ERROR(ShaderDelegate):"+e+":"+t)},ShaderDelegate.prototype.convert=function(e,t){return e},ShaderDelegate.prototype.resourceAvailable=function(e,t){return theLoader.shadersLoaded++,theLoader.shaders[t.id]=e,!0};var shaderDelegate=new ShaderDelegate,ShaderContext=function(e,t){this.id=e,this.uri=t},ResourceEntry=function(e,t,r){this.entryID=e,this.object=t,this.description=r},Resources=function(){this._entries={}};Resources.prototype.setEntry=function(e,t,r){return e?(this._entries[e]&&console.warn("entry["+e+"] is being overwritten"),void(this._entries[e]=new ResourceEntry(e,t,r))):void console.error("No EntryID provided, cannot store",r)},Resources.prototype.getEntry=function(e){return this._entries[e]},Resources.prototype.clearEntries=function(){this._entries={}},LoadDelegate=function(){},LoadDelegate.prototype.loadCompleted=function(e,t){e.call(Window,t)};var ThreeGLTFLoader=Object.create(glTFParser,{load:{enumerable:!0,value:function(e,t){this.resources=new Resources,this.cameras=[],this.lights=[],this.animations=[],this.joints={},THREE.GLTFLoaderUtils.init(),glTFParser.load.call(this,e,t)}},cameras:{enumerable:!0,writable:!0,value:[]},lights:{enumerable:!0,writable:!0,value:[]},animations:{enumerable:!0,writable:!0,value:[]},handleBuffer:{value:function(e,t,r){return this.resources.setEntry(e,null,t),t.type="ArrayBuffer",!0}},handleBufferView:{value:function(e,t,r){this.resources.setEntry(e,null,t);var a=this.resources.getEntry(t.buffer);t.type="ArrayBufferView";var i=this.resources.getEntry(e);return i.buffer=a,!0}},handleShader:{value:function(e,t,r){this.resources.setEntry(e,null,t);var a={id:e,uri:t.uri},i=new ShaderContext(e,t.uri);return theLoader.shadersRequested++,THREE.GLTFLoaderUtils.getFile(a,shaderDelegate,i),!0}},handleProgram:{value:function(e,t,r){return this.resources.setEntry(e,null,t),!0}},handleTechnique:{value:function(e,t,r){return t.refCount=0,this.resources.setEntry(e,null,t),!0}},createShaderParams:{value:function(e,t,r,a,i){var s=this.resources.getEntry(a);if(r.uniforms={},r.attributes={},r.program=s,r.technique=i,s){r.fragmentShader=s.description.fragmentShader,r.vertexShader=s.description.vertexShader;for(var n in i.uniforms){var o,l,h=i.uniforms[n],c=i.parameters[h],u=c.type,d=c.count,p=t[h],f="";switch(u){case WebGLRenderingContext.FLOAT:if(f="f",o=c.value,"transparency"==h){var m=!0,v=m?p:1-p;o=v,r.transparent=!0}break;case WebGLRenderingContext.FLOAT_VEC2:if(f="v2",o=new THREE.Vector2,c&&c.value){var g=c.value;o.fromArray(g)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_VEC3:if(f="v3",o=new THREE.Vector3,c&&c.value){var E=c.value;o.fromArray(E)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_VEC4:if(f="v4",o=new THREE.Vector4,c&&c.value){var b=c.value;o.fromArray(b)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_MAT2:console.log("Warning: FLOAT_MAT2");break;case WebGLRenderingContext.FLOAT_MAT3:if(f="m3",o=new THREE.Matrix3,c&&c.value){var y=c.value;o.fromArray(y)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_MAT4:if(void 0!==d){f="m4v",o=new Array(d);for(var T=0;d>T;T++)o[T]=new THREE.Matrix4;if(l=d,c&&c.value){var w=c.value;o.fromArray(w)}p&&o.fromArray(p)}else{if(f="m4",o=new THREE.Matrix4,c&&c.value){var R=c.value;o.fromArray(R)}p&&o.fromArray(p)}break;case WebGLRenderingContext.SAMPLER_2D:f="t",o=p?CreateTexture(this.resources,p):null;break;default:throw new Error("Unknown shader uniform param type: "+u+" - "+theLoader.idx[u])}var x={type:f,value:o,length:l};r.uniforms[n]=x}for(var k in i.attributes){var h=i.attributes[k],A=i.parameters[h],N=A.type,H=A.semantic,_={type:N,semantic:H};r.attributes[k]=_}}}},threeJSMaterialType:{value:function(e,t,r){var a,i=t.extensions,s=i?i.KHR_materials_common:null,n=null;if(s){switch(s.technique){case"BLINN":case"PHONG":n=THREE.MeshPhongMaterial;break;case"LAMBERT":n=THREE.MeshLambertMaterial;break;case"CONSTANT":default:n=THREE.MeshBasicMaterial}s.doubleSided&&(r.side=THREE.DoubleSide),s.transparent&&(r.transparent=!0),a={};for(prop in s.values)a[prop]=s.values[prop]}else{var o=t.technique?this.resources.getEntry(t.technique):null;a=t.values;var l=o.description;++l.refCount>1;var h=l.program;this.createShaderParams(e,a,r,h,l);var c=!0;c&&(n=Material)}a.diffuse&&"string"==typeof a.diffuse&&(r.map=CreateTexture(this.resources,a.diffuse)),a.reflective&&"string"==typeof a.reflective&&(r.envMap=CreateTexture(this.resources,a.reflective));var u=a.shininesss||a.shininess;u&&(u=u);var d=null;r.map||(d=a.diffuse);var p=1;if(a.hasOwnProperty("transparency")){var f=!0;p=f?a.transparency:1-a.transparency}return r.color=RgbArraytoHex(d),r.opacity=p,r.transparent=1>p,r.map&&-1!=r.map.sourceFile.toLowerCase().indexOf(".png")&&(r.transparent=!0),void 0!==u&&(r.shininess=Math.max(u,1e-4)),delete r.ambient,void 0!==a.ambient&&"string"!=typeof a.ambient,void 0!==a.emission&&(r.emissive=RgbArraytoHex(a.emission)),void 0!==a.specular&&(r.specular=RgbArraytoHex(a.specular)),n}},handleMaterial:{value:function(e,t,r){var a={},i=this.threeJSMaterialType(e,t,a),s=new i(a);return this.resources.setEntry(e,s,t),!0}},handleMesh:{value:function(e,t,r){var a=new Mesh;this.resources.setEntry(e,a,t);var i=t.primitives;if(!i)return console.log("MISSING_PRIMITIVES for mesh:"+e),!1;for(var s=0;s<i.length;s++){var n=i[s];if(n.mode===WebGLRenderingContext.TRIANGLES){var o=new ClassicGeometry,l=this.resources.getEntry(n.material);a.addPrimitive(o,l.object);var h=Object.keys(n.attributes);h.forEach(function(e){o.totalAttributes++},this);var c=this.resources.getEntry(n.indices),u=this.resources.getEntry(c.description.bufferView),d={bufferView:u,byteOffset:c.description.byteOffset,count:c.description.count,id:c.entryID,componentType:c.description.componentType,type:c.description.type},p=new IndicesContext(d,o),f={indicesObject:d,indicesDelegate:indicesDelegate,indicesContext:p};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.indicesObject,e.indicesDelegate,e.indicesContext);t&&e.indicesDelegate.resourceAvailable(t,e.indicesContext)},f),h.forEach(function(e){var r,a=n.attributes[e],i=this.resources.getEntry(a);if(i){r=i.object,r.id=a;var s=this.resources.getEntry(r.bufferView)}else{r=t.attributes[a],r.id=a,this.resources.setEntry(a,r,r);var s=this.resources.getEntry(r.bufferView);i=this.resources.getEntry(a)}var l={bufferView:s,byteOffset:r.byteOffset,byteStride:r.byteStride,count:r.count,max:r.max,min:r.min,componentType:r.componentType,type:r.type,id:a},h=new VertexAttributeContext(l,e,o),c={attributeObject:l,vertexAttributeDelegate:vertexAttributeDelegate,attribContext:h};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.attributeObject,e.vertexAttributeDelegate,e.attribContext);t&&e.vertexAttributeDelegate.resourceAvailable(t,e.attribContext)},c)},this)}}return!0}},handleCamera:{value:function(e,t,r){var a;if("perspective"==t.type){var i=t.perspective.znear,s=t.perspective.zfar,n=t.perspective.yfov,o=t.perspective.xfov,l=t.perspective.aspect_ratio;l||(l=1),void 0===o&&n&&(o=n*l),void 0===n&&o&&(n=o/l),o&&(o=THREE.Math.radToDeg(o),a=new THREE.PerspectiveCamera(o,l,i,s))}else a=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,i,s);return a&&this.resources.setEntry(e,a,t),!0}},handleLight:{value:function(e,t,r){var a=null,i=t.type;if(i&&t[i]){var s=t[i],n=RgbArraytoHex(s.color);switch(i){case"directional":a=new THREE.DirectionalLight(n),a.position.set(0,0,1);break;case"point":a=new THREE.PointLight(n);break;case"spot ":a=new THREE.SpotLight(n),a.position.set(0,0,1);break;case"ambient":a=new THREE.AmbientLight(n)}}return a&&this.resources.setEntry(e,a,t),!0}},addPendingMesh:{value:function(e,t){theLoader.pendingMeshes.push({mesh:e,node:t})}},handleNode:{value:function(e,t,r){var a=null;t.jointName?(a=new THREE.Bone,a.jointName=t.jointName,this.joints[t.jointName]=e):a=new THREE.Object3D,a.name=t.name,a.glTFID=e,a.glTF=t,this.resources.setEntry(e,a,t);var i=t.matrix;if(i)a.matrixAutoUpdate=!1,a.applyMatrix((new THREE.Matrix4).set(i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14],i[3],i[7],i[11],i[15]));else{var s=t.translation,n=t.rotation,o=t.scale,l=s?new THREE.Vector3(s[0],s[1],s[2]):new THREE.Vector3,h=n?new THREE.Quaternion(n[0],n[1],n[2],n[3]):new THREE.Quaternion,c=o?new THREE.Vector3(o[0],o[1],o[2]):new THREE.Vector3(1,1,1),u=new THREE.Matrix4;u.compose(l,h,c),a.matrixAutoUpdate=!1,a.applyMatrix(u)}var d=this;if(t.meshes){t.meshInstances={};var p;t.skin&&(p=this.resources.getEntry(t.skin)),t.meshes.forEach(function(e){meshEntry=this.resources.getEntry(e),theLoader.meshesRequested++,meshEntry.object.onComplete(function(r){d.addPendingMesh(r,a),t.meshInstances[e]=meshEntry.object,p&&(r.skin=p,t.instanceSkin=p.object),theLoader.meshesLoaded++,theLoader.checkComplete()})},this)}if(t.camera){var f=this.resources.getEntry(t.camera);f&&(a.add(f.object),this.cameras.push(f.object))}if(t.extensions&&t.extensions.KHR_materials_common&&t.extensions.KHR_materials_common.light){var m=t.extensions.KHR_materials_common.light,v=this.resources.getEntry(m);v&&(a.add(v.object),this.lights.push(v.object))}return!0}},handleExtension:{value:function(e,t,r){switch(e){case"KHR_materials_common":var a=t.lights;for(lightID in a){var i=a[lightID];this.handleLight(lightID,i)}}return!0}},buildNodeHirerachy:{value:function(e,t){var r=this.resources.getEntry(e),a=r.object;t.add(a);var i=r.description.children;return i&&i.forEach(function(e){this.buildNodeHirerachy(e,a)},this),a}},buildSkin:{value:function(e){var t=e.glTF,r=t.instanceSkin,a=t.skeletons;r&&a.forEach(function(a){var i=this.resources.getEntry(a);if(i){var s=i.object;e.add(s);var n=!0;for(meshID in t.meshInstances){var o=t.meshInstances[meshID],l=null;o.primitives.forEach(function(t){var i=t.material,s=i.params;i instanceof THREE.Material||(i=createShaderMaterial(i)),l=new THREE.SkinnedMesh(t.geometry.geometry,i,!1);t.geometry.geometry;if(l&&n){i.skinning=!0;var o,h=r.jointNames,c=[],u=[],d=[],p=h.length;for(o=0;p>o;o++){var f=h[o],m=this.joints[f],v=this.resources.getEntry(m).object;if(v){v.skin=l,c.push(v),u.push(v);var g=r.inverseBindMatrices,E=(new THREE.Matrix4).set(g[16*o+0],g[16*o+4],g[16*o+8],g[16*o+12],g[16*o+1],g[16*o+5],g[16*o+9],g[16*o+13],g[16*o+2],g[16*o+6],g[16*o+10],g[16*o+14],g[16*o+3],g[16*o+7],g[16*o+11],g[16*o+15]);d.push(E)}else console.log("WARNING: jointName:"+f+" cannot be found in skeleton:"+a)}l.bind(new THREE.Skeleton(u,d,!1),r.bindShapeMatrix)}if(l&&(l.castShadow=!0,e.add(l),i instanceof THREE.ShaderMaterial)){s.joints=c;var b=new THREE.glTFShader(i,s,l,theLoader.rootObj);THREE.glTFShaders.add(b)}},this)}}},this)}},buildSkins:{value:function(e){e.glTF&&e.glTF.instanceSkin&&this.buildSkin(e);var t=e.children;t&&t.forEach(function(e){this.buildSkins(e)},this)}},createMeshAnimations:{value:function(e){this.buildSkins(e)}},handleScene:{value:function(e,t,r){return t.nodes?(t.nodes.forEach(function(e){this.buildNodeHirerachy(e,r.rootObj)},this),this.delegate&&this.delegate.loadCompleted(r.callback,r.rootObj),theLoader.loadAllAssets(),!0):(console.log("ERROR: invalid file required nodes property is missing from scene"),!1)}},handleImage:{value:function(e,t,r){return this.resources.setEntry(e,null,t),!0}},addNodeAnimationChannel:{value:function(e,t,r){this.nodeAnimationChannels||(this.nodeAnimationChannels={}),this.nodeAnimationChannels[e]||(this.nodeAnimationChannels[e]=[]),this.nodeAnimationChannels[e].push(r)}},createAnimations:{value:function(){for(var e in this.nodeAnimationChannels){var t=this.nodeAnimationChannels[e],r=(t.length,new THREE.glTFAnimation(t));r.name="animation_"+e,this.animations.push(r)}}},buildAnimation:{value:function(e){var t,r=[],a=e.channels.length;for(t=0;a>t;t++){var i=e.channels[t],s=e.samplers[i.sampler];if(s){var n=e.parameters[s.input];if(n&&n.data){var o=e.parameters[s.output];if(o&&o.data){var l=i.target,h=this.resources.getEntry(l.id);if(h){var c=l.path,u={keys:n.data,values:o.data,count:n.count,target:h.object,path:c,type:s.interpolation};this.addNodeAnimationChannel(l.id,i,u),r.push(u)}}}}}}},handleAnimation:{value:function(e,t,r){theLoader.animationsRequested++;var a=new Animation;a.name=e,a.onload=function(){theLoader.animationsLoaded++,theLoader.animations.push(a),theLoader.checkComplete()},a.channels=t.channels,a.samplers=t.samplers,this.resources.setEntry(e,a,t);var i=t.parameters;if(!i)return console.log("MISSING_PARAMETERS for animation:"+e),!1;var s=Object.keys(i);s.forEach(function(e){a.totalParameters++},this);var s=Object.keys(i);return s.forEach(function(e){var t=i[e],r=this.resources.getEntry(t);r=r.object;var s=this.resources.getEntry(r.bufferView),n={bufferView:s,byteOffset:r.byteOffset,count:r.count,componentType:r.componentType,type:r.type,id:r.bufferView,name:e},o=new AnimationParameterContext(n,a),l={paramObject:n,animationParameterDelegate:animationParameterDelegate,paramContext:o};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.paramObject,e.animationParameterDelegate,e.paramContext);t&&e.animationParameterDelegate.resourceAvailable(t,e.paramContext)},l)},this),!0}},handleAccessor:{value:function(e,t,r){return this.resources.setEntry(e,t,t),!0}},handleSkin:{value:function(e,t,r){var a={},i=t.bindShapeMatrix;a.bindShapeMatrix=(new THREE.Matrix4).set(i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14],i[3],i[7],i[11],i[15]),a.jointNames=t.jointNames;var s=this.resources.getEntry(t.inverseBindMatrices);s=s.description,a.inverseBindMatricesDescription=s,a.inverseBindMatricesDescription.id=t.inverseBindMatrices;var n=this.resources.getEntry(s.bufferView),o={bufferView:n,byteOffset:s.byteOffset,count:s.count,componentType:s.componentType,type:s.type,id:s.bufferView,name:a.inverseBindMatricesDescription.id},l=new InverseBindMatricesContext(o,a),h={paramObject:o,inverseBindMatricesDelegate:inverseBindMatricesDelegate,context:l};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.paramObject,e.inverseBindMatricesDelegate,e.context);t&&e.inverseBindMatricesDelegate.resourceAvailable(t,e.context)},h);var c=this.resources.getEntry(a.inverseBindMatricesDescription.bufferView);return a.inverseBindMatricesDescription.bufferView=c.object,this.resources.setEntry(e,a,t),!0}},handleSampler:{value:function(e,t,r){return this.resources.setEntry(e,t,t),!0}},handleTexture:{value:function(e,t,r){return this.resources.setEntry(e,null,t),!0}},handleError:{value:function(e){throw new Error(e)}},_delegate:{value:new LoadDelegate,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(e){this._delegate=e}}}),Context=function(e,t){this.rootObj=e,this.callback=t},rootObj=new THREE.Object3D,self=this,loader=Object.create(ThreeGLTFLoader);return loader.initWithPath(url),loader.load(new Context(rootObj,function(e){}),null),this.loader=loader,this.callback=callback,this.rootObj=rootObj,rootObj},THREE.glTFLoader.prototype.scheduleLoad=function(e,t){this.loadRequests.push({fn:e,data:t})},THREE.glTFLoader.prototype.loadAllAssets=function(){for(var e=0,t=this.loadRequests.length;t>e;e++){var r=this.loadRequests[e];r.fn(r.data)}},THREE.glTFLoader.prototype.callLoadedCallback=function(){var e={scene:this.rootObj,cameras:this.loader.cameras,animations:this.loader.animations,shaders:this.loader.shaders};this.callback(e)},THREE.glTFLoader.prototype.checkComplete=function(){if(this.meshesLoaded==this.meshesRequested&&this.shadersLoaded==this.shadersRequested&&this.animationsLoaded==this.animationsRequested){for(var e=0;e<this.pendingMeshes.length;e++){var t=this.pendingMeshes[e];t.mesh.attachToNode(t.node)}for(var e=0;e<this.animationsLoaded;e++){var r=this.animations[e];this.loader.buildAnimation(r)}this.loader.createAnimations(),this.loader.createMeshAnimations(this.rootObj),THREE.glTFShaders.bindShaderParameters(this.rootObj),this.callLoadedCallback()}},THREE.GLTFLoaderUtils=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(e){return this._resources[e]?!0:!1}},_storeResource:{enumerable:!1,value:function(e,t){return e?(this._containsResource[e]&&console.log("WARNING: resource:"+e+" is already stored, overriding"),void(this._resources[e]=t)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(e){return this._resources[e]}},_loadStream:{value:function(e,t,r){function a(e,t){var r=decodeURIComponent(t);return e?atob(r):r}function i(e,t){for(var r=a(e,t),i=new ArrayBuffer(r.length),s=new Uint8Array(i),n=0;n<r.length;n++)s[n]=r.charCodeAt(n);return i}function s(e,t){t="undefined"!=typeof t?t:"";var r=e[1],s=!!e[2],n=e[3];switch(t){case"":case"text":return a(s,n);case"ArrayBuffer":return i(s,n);case"blob":var o=i(s,n);return new Blob([o],{type:r});case"document":var l=new DOMParser;return l.parseFromString(a(s,n),r);case"json":return JSON.parse(a(s,n));default:throw"Unhandled responseType: "+t}}var n=/^data:(.*?)(;base64)?,(.*)$/,o=n.exec(e);if(null!==o)return void r.streamAvailable(e,s(o,t));if(!t)return void r.handleError(THREE.GLTFLoaderUtils.INVALID_TYPE,null);if(!e)return void r.handleError(THREE.GLTFLoaderUtils.INVALID_PATH);var l=new XMLHttpRequest;l.open("GET",e,!0),l.responseType=t===this.ARRAY_BUFFER?"arraybuffer":"text",l.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),l.onload=function(t){200==l.status||206==l.status?r.streamAvailable(e,l.response):r.handleError(THREE.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},l.send(null)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(e){var t=this._resourcesStatus[e.id];t?this._resourcesStatus[e.id]++:this._resourcesStatus[e.id]=1;var r=this._streamsStatus[e.uri];if(r&&"loading"===r.status)return void r.requests.push(e);this._streamsStatus[e.uri]={status:"loading",requests:[e]};var a=this,i={};i.streamAvailable=function(e,t){var r=a._streamsStatus[e],i=r.requests;i.forEach(function(e){var r=t.slice(e.range[0],e.range[1]),i=e.delegate.convert(r,e.ctx);a._storeResource(e.id,i),e.delegate.resourceAvailable(i,e.ctx),--a._resourcesStatus[e.id]},this),delete a._streamsStatus[e]},i.handleError=function(t,r){e.delegate.handleError(t,r)},this._loadStream(e.uri,e.type,i)}},_elementSizeForGLType:{value:function(e,t){var r=0;switch(t){case"SCALAR":r=1;break;case"VEC2":r=2;break;case"VEC3":r=3;break;case"VEC4":r=4;break;case"MAT2":r=4;break;case"MAT3":r=9;break;case"MAT4":r=16}switch(e){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*r;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*r;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*r;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(e,t,r){var a=e.bufferView,i=a.buffer,s=e.byteOffset+a.description.byteOffset,n=[s,this._elementSizeForGLType(e.componentType,e.type)*e.count+s];this._handleRequest({id:e.id,range:n,type:i.description.type,uri:i.description.uri,delegate:t,ctx:r},null)}},getBuffer:{value:function(e,t,r){this._getResource(e.id);return this._handleWrappedBufferViewResourceLoading(e,t,r),null}},getFile:{value:function(e,t,r){return e.delegate=t,e.ctx=r,this._handleRequest({id:e.id,uri:e.uri,range:[0],type:"text",delegate:t,ctx:r},null),null}}}),THREE.glTFAnimator=function(){var e=[];return{add:function(t){e.push(t)},remove:function(t){var r=e.indexOf(t);-1!==r&&e.splice(r,1)},update:function(){for(i=0;i<e.length;i++)e[i].update()}}}(),THREE.glTFAnimation=function(e){this.running=!1,this.loop=!1,this.duration=0,this.startTime=0,this.interps=[],e&&this.createInterpolators(e)},THREE.glTFAnimation.prototype.createInterpolators=function(e){var t,r=e.length;for(t=0;r>t;t++){var a=new THREE.glTFInterpolator(e[t]);this.interps.push(a),this.duration=Math.max(this.duration,a.duration)}},THREE.glTFAnimation.prototype.play=function(){this.running||(this.startTime=Date.now(),this.running=!0,THREE.glTFAnimator.add(this))},THREE.glTFAnimation.prototype.stop=function(){this.running=!1,THREE.glTFAnimator.remove(this)},THREE.glTFAnimation.prototype.update=function(){if(this.running){var e=Date.now(),t=(e-this.startTime)/1e3,r=t%this.duration,a=Math.floor(t/this.duration);if(a>=1&&!this.loop){this.running=!1;var i,s=this.interps.length;for(i=0;s>i;i++)this.interps[i].interp(this.duration);return void this.stop()}var i,s=this.interps.length;for(i=0;s>i;i++)this.interps[i].interp(r)}},THREE.glTFInterpolator=function(e){this.keys=e.keys,this.values=e.values,this.count=e.count,this.type=e.type,this.path=e.path,this.isRot=!1;var t=e.target;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,this.targetNode=t,e.path){case"translation":this.target=t.position,this.originalValue=t.position.clone();break;case"rotation":this.target=t.quaternion,this.originalValue=t.quaternion.clone(),this.isRot=!0;break;case"scale":this.target=t.scale,this.originalValue=t.scale.clone()}this.duration=this.keys[this.count-1],this.vec1=new THREE.Vector3,this.vec2=new THREE.Vector3,this.vec3=new THREE.Vector3,this.quat1=new THREE.Quaternion,this.quat2=new THREE.Quaternion,this.quat3=new THREE.Quaternion},THREE.glTFInterpolator.prototype.interp=function(e){var t;if(e==this.keys[0])this.isRot?this.quat3.set(this.values[0],this.values[1],this.values[2],this.values[3]):this.vec3.set(this.values[0],this.values[1],this.values[2]);else if(e<this.keys[0])this.isRot?(this.quat1.set(this.originalValue.x,this.originalValue.y,this.originalValue.z,this.originalValue.w),this.quat2.set(this.values[0],this.values[1],this.values[2],this.values[3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,e/this.keys[0])):(this.vec3.set(this.originalValue.x,this.originalValue.y,this.originalValue.z),this.vec2.set(this.values[0],this.values[1],this.values[2]),this.vec3.lerp(this.vec2,e/this.keys[0]));else if(e>=this.keys[this.count-1])this.isRot?this.quat3.set(this.values[4*(this.count-1)],this.values[4*(this.count-1)+1],this.values[4*(this.count-1)+2],this.values[4*(this.count-1)+3]):this.vec3.set(this.values[3*(this.count-1)],this.values[3*(this.count-1)+1],this.values[3*(this.count-1)+2]);else for(t=0;t<this.count-1;t++){var r=this.keys[t],a=this.keys[t+1];e>=r&&a>=e&&(this.isRot?(this.quat1.set(this.values[4*t],this.values[4*t+1],this.values[4*t+2],this.values[4*t+3]),this.quat2.set(this.values[4*(t+1)],this.values[4*(t+1)+1],this.values[4*(t+1)+2],this.values[4*(t+1)+3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,(e-r)/(a-r))):(this.vec3.set(this.values[3*t],this.values[3*t+1],this.values[3*t+2]),this.vec2.set(this.values[3*(t+1)],this.values[3*(t+1)+1],this.values[3*(t+1)+2]),this.vec3.lerp(this.vec2,(e-r)/(a-r))))}this.target&&this.copyValue(this.target)},THREE.glTFInterpolator.prototype.copyValue=function(e){this.isRot?e.copy(this.quat3):e.copy(this.vec3)},THREE.glTFShaders=function(){var e=[];return{add:function(t){e.push(t)},remove:function(t){var r=e.indexOf(t);-1!==r&&e.splice(r,1)},removeAll:function(t){e=[]},bindShaderParameters:function(t){for(i=0;i<e.length;i++)e[i].bindParameters(t)},update:function(t,r){for(i=0;i<e.length;i++)e[i].update(t,r)}}}(),THREE.glTFShader=function(e,t,r,a){this.material=e,this.parameters=t.technique.parameters,this.uniforms=t.technique.uniforms,this.joints=t.joints,this.object=r,this.semantics={},this.m4=new THREE.Matrix4},THREE.glTFShader.prototype.bindParameters=function(e){function t(e,t){e.glTFID==i.node&&(t.sourceObject=e)}for(var r in this.uniforms){var a=this.uniforms[r],i=this.parameters[a];if(i.semantic){var s={semantic:i.semantic,uniform:this.material.uniforms[r]};i.node?e.traverse(function(e){t(e,s)}):s.sourceObject=this.object,this.semantics[a]=s}}},THREE.glTFShader.prototype.update=function(e,t){e.updateMatrixWorld(),
t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld);for(var r in this.semantics){var a=this.semantics[r];if(a)switch(a.semantic){case"MODELVIEW":var i=a.uniform.value;i.multiplyMatrices(t.matrixWorldInverse,a.sourceObject.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var s=a.uniform.value;this.m4.multiplyMatrices(t.matrixWorldInverse,a.sourceObject.matrixWorld),s.getNormalMatrix(this.m4);break;case"PROJECTION":var i=a.uniform.value;i.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var n=a.uniform.value,o=0;o<n.length;o++)n[o].getInverse(a.sourceObject.matrixWorld).multiply(this.joints[o].matrixWorld).multiply(this.object.skeleton.boneInverses[o]);break;default:throw new Error("Unhandled shader semantic"+a)}}},THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(e,t){function r(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function a(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}function i(e,t,r,a){for(var i=r*a*4,s=new Uint8Array(e,t,i),n=new Uint8Array(i),o=0,l=0,h=0;a>h;h++)for(var c=0;r>c;c++){var u=s[l];l++;var d=s[l];l++;var p=s[l];l++;var f=s[l];l++,n[o]=p,o++,n[o]=d,o++,n[o]=u,o++,n[o]=f,o++}return n}var s={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},n=542327876,o=131072,l=512,h=1024,c=2048,u=4096,d=8192,p=16384,f=32768,m=4,v=r("DXT1"),g=r("DXT3"),E=r("DXT5"),b=r("ETC1"),y=31,T=0,w=1,R=2,x=3,k=4,A=7,N=20,H=21,_=22,L=23,C=24,M=25,S=26,O=28,j=new Int32Array(e,0,y);if(j[T]!==n)return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),s;if(!j[N]&m)return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),s;var I,D=j[H],F=!1;switch(D){case v:I=8,s.format=THREE.RGB_S3TC_DXT1_Format;break;case g:I=16,s.format=THREE.RGBA_S3TC_DXT3_Format;break;case E:I=16,s.format=THREE.RGBA_S3TC_DXT5_Format;break;case b:I=8,s.format=THREE.RGB_ETC1_Format;break;default:if(!(32===j[_]&&16711680&j[L]&&65280&j[C]&&255&j[M]&&4278190080&j[S]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",a(D)),s;F=!0,I=64,s.format=THREE.RGBAFormat}s.mipmapCount=1,j[R]&o&&t!==!1&&(s.mipmapCount=Math.max(1,j[A]));var P=j[O];if(s.isCubemap=P&l?!0:!1,s.isCubemap&&(!(P&h)||!(P&c)||!(P&u)||!(P&d)||!(P&p)||!(P&f)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),s;s.width=j[k],s.height=j[x];for(var V=j[w]+4,G=s.isCubemap?6:1,B=0;G>B;B++)for(var q=s.width,U=s.height,X=0;X<s.mipmapCount;X++){if(F)var W=i(e,V,q,U),z=W.length;else var z=Math.max(4,q)/4*Math.max(4,U)/4*I,W=new Uint8Array(e,V,z);var Y={data:W,width:q,height:U};s.mipmaps.push(Y),V+=z,q=Math.max(q>>1,1),U=Math.max(U>>1,1)}return s},THREE.TGALoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.TGALoader.prototype.load=function(e,t,r,a){var i=this,s=new THREE.Texture,n=new THREE.XHRLoader(this.manager);return n.setResponseType("arraybuffer"),n.load(e,function(e){s.image=i.parse(e),s.needsUpdate=!0,void 0!==t&&t(s)},r,a),s},THREE.TGALoader.prototype.parse=function(e){function t(e){switch(e.image_type){case u:case f:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case d:case p:case m:case v:e.colormap_type&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case c:console.error("THREE.TGALoader.parse.tgaCheckHeader: No data");default:console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid type " '+e.image_type+'"')}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid image size"),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid pixel size "'+e.pixel_size+'"')}function r(e,t,r,a,i){var s,n,o,l;if(n=r.pixel_size>>3,o=r.width*r.height*n,t&&(l=i.subarray(a,a+=r.colormap_length*(r.colormap_size>>3))),e){s=new Uint8Array(o);for(var h,c,u,d=0,p=new Uint8Array(n);o>d;)if(h=i[a++],c=(127&h)+1,128&h){for(u=0;n>u;++u)p[u]=i[a++];for(u=0;c>u;++u)s.set(p,d+u*n);d+=n*c}else{for(c*=n,u=0;c>u;++u)s[d+u]=i[a++];d+=c}}else s=i.subarray(a,a+=t?r.width*r.height:o);return{pixel_data:s,palettes:l}}function a(e,t,r,a,i,s,n,o,l){var h,c,u,d=l,p=0,f=k.width;for(u=t;u!==a;u+=r)for(c=i;c!==n;c+=s,p++)h=o[p],e[4*(c+f*u)+3]=255,e[4*(c+f*u)+2]=d[3*h+0],e[4*(c+f*u)+1]=d[3*h+1],e[4*(c+f*u)+0]=d[3*h+2];return e}function i(e,t,r,a,i,s,n,o){var l,h,c,u=0,d=k.width;for(c=t;c!==a;c+=r)for(h=i;h!==n;h+=s,u+=2)l=o[u+0]+(o[u+1]<<8),e[4*(h+d*c)+0]=(31744&l)>>7,e[4*(h+d*c)+1]=(992&l)>>2,e[4*(h+d*c)+2]=(31&l)>>3,e[4*(h+d*c)+3]=32768&l?0:255;return e}function s(e,t,r,a,i,s,n,o){var l,h,c=0,u=k.width;for(h=t;h!==a;h+=r)for(l=i;l!==n;l+=s,c+=3)e[4*(l+u*h)+3]=255,e[4*(l+u*h)+2]=o[c+0],e[4*(l+u*h)+1]=o[c+1],e[4*(l+u*h)+0]=o[c+2];return e}function n(e,t,r,a,i,s,n,o){var l,h,c=0,u=k.width;for(h=t;h!==a;h+=r)for(l=i;l!==n;l+=s,c+=4)e[4*(l+u*h)+2]=o[c+0],e[4*(l+u*h)+1]=o[c+1],e[4*(l+u*h)+0]=o[c+2],e[4*(l+u*h)+3]=o[c+3];return e}function o(e,t,r,a,i,s,n,o){var l,h,c,u=0,d=k.width;for(c=t;c!==a;c+=r)for(h=i;h!==n;h+=s,u++)l=o[u],e[4*(h+d*c)+0]=l,e[4*(h+d*c)+1]=l,e[4*(h+d*c)+2]=l,e[4*(h+d*c)+3]=255;return e}function l(e,t,r,a,i,s,n,o){var l,h,c=0,u=k.width;for(h=t;h!==a;h+=r)for(l=i;l!==n;l+=s,c+=2)e[4*(l+u*h)+0]=o[c+0],e[4*(l+u*h)+1]=o[c+0],e[4*(l+u*h)+2]=o[c+0],e[4*(l+u*h)+3]=o[c+1];return e}function h(e,t,r,h,c){var u,d,p,f,m,v;switch((k.flags&g)>>E){default:case T:u=0,p=1,m=t,d=0,f=1,v=r;break;case b:u=0,p=1,m=t,d=r-1,f=-1,v=-1;break;case w:u=t-1,p=-1,m=-1,d=0,f=1,v=r;break;case y:u=t-1,p=-1,m=-1,d=r-1,f=-1,v=-1}if(H)switch(k.pixel_size){case 8:o(e,d,f,v,u,p,m,h);break;case 16:l(e,d,f,v,u,p,m,h);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}else switch(k.pixel_size){case 8:a(e,d,f,v,u,p,m,h,c);break;case 16:i(e,d,f,v,u,p,m,h);break;case 24:s(e,d,f,v,u,p,m,h);break;case 32:n(e,d,f,v,u,p,m,h);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}return e}var c=0,u=1,d=2,p=3,f=9,m=10,v=11,g=48,E=4,b=0,y=1,T=2,w=3;e.length<19&&console.error("THREE.TGALoader.parse: Not enough data to contain header.");var R=new Uint8Array(e),x=0,k={id_length:R[x++],colormap_type:R[x++],image_type:R[x++],colormap_index:R[x++]|R[x++]<<8,colormap_length:R[x++]|R[x++]<<8,colormap_size:R[x++],origin:[R[x++]|R[x++]<<8,R[x++]|R[x++]<<8],width:R[x++]|R[x++]<<8,height:R[x++]|R[x++]<<8,pixel_size:R[x++],flags:R[x++]};t(k),k.id_length+x>e.length&&console.error("THREE.TGALoader.parse: No data"),x+=k.id_length;var A=!1,N=!1,H=!1;switch(k.image_type){case f:A=!0,N=!0;break;case u:N=!0;break;case m:A=!0;break;case d:break;case v:A=!0,H=!0;break;case p:H=!0}var _=document.createElement("canvas");_.width=k.width,_.height=k.height;var L=_.getContext("2d"),C=L.createImageData(k.width,k.height),M=r(A,N,k,x,R);h(C.data,k.width,k.height,M.pixel_data,M.palettes);return L.putImageData(C,0,0),_};