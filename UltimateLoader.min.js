var UltimateLoader=UltimateLoader||{};!function(a){"use strict";function h(a,b){c.push([a,b])}function i(){if(d>c.length-1)return c=[],void(d=0);var a=c[d];d++,k(a)}function j(){0==d&&i()}function k(a){var b=a[0],c=a[1],d=l(b);switch(d.url=b,d.callback=c,null!=a[2]&&(d.i=a[2]),d.ext){case"obj":m(d);break;case"json":n(d);break;case"dae":o(d);break;case"gltf":p(d);break;case"png":q(d);break;case"jpg":q(d);break;case"jpeg":q(d);break;default:console.log("UltimateLoader: File extension -"+d.ext+"- not recognized! Object -"+d.name+"- did not load."),i()}}function l(a){var b=a.slice(0,a.lastIndexOf("/")+1);""===b&&null===b||(g=b);var c=a.substr(a.lastIndexOf("/")+1),d=c.split("."),e={name:d[0],ext:d[1],baseUrl:b};return e}function m(a){var b=a.name+".obj",c=a.name+".mtl",d=new THREE.MTLLoader;d.setPath(a.baseUrl),d.setBaseUrl(a.baseUrl),d.setCrossOrigin=f,d.load(c,function(c){c.preload();var d=new THREE.OBJLoader;d.setMaterials(c),d.setPath(a.baseUrl),d.setCrossOrigin=f,d.load(b,function(b){b.traverse(function(a){a instanceof THREE.Mesh&&(a.material.side=THREE.DoubleSide)}),a.object=b,t(a)},r,s)})}function n(a){var b=new THREE.ObjectLoader;b.load(a.url,function(b){a.object=b,t(a)},r,s)}function o(a){var b=new THREE.ColladaLoader;b.load(a.url,function(b){var c=b.scene;a.object=c,t(a)},r,s)}function p(a){var b=new THREE.glTFLoader;b.load(a.url,function(b){var c=b.scene;a.object=c,t(a)},r,s)}function q(a){var b=new THREE.TextureLoader;b.load(a.url,function(b){var c=new THREE.PlaneGeometry(32,20,32),d=new THREE.MeshBasicMaterial({map:b,side:THREE.DoubleSide}),e=new THREE.Mesh(c,d);a.object=e,t(a)},r,s)}function r(a){}function s(a){}function t(c){b[c.name]=c.object,null!=c.i?c.callback(c):c.callback(c.object),a.queue&&i(),console.log("UltimateLoader: Object "+c.name+" loaded!")}var b={},c=[],d=0,f="anonymous",g="";a.queue=!1,a.load=function(b,c){if(a.queue)h(b,c),j();else{var d=[b,c];k(d)}},a.multiload=function(b,c){for(var d=[],e=0,f=function(a){d[a.i]=a.object,e++,e==b.length&&c(d)},g=0;g<b.length;g++)if(a.queue)h(b[g],f,g),j();else{var i=[b[g],f,g];k(i)}j()}}(UltimateLoader),THREE.MTLLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.MTLLoader.prototype={constructor:THREE.MTLLoader,load:function(a,b,c,d){var e=this,f=new THREE.XHRLoader(this.manager);f.setPath(this.path),f.load(a,function(a){b(e.parse(a))},c,d)},setPath:function(a){this.path=a},setBaseUrl:function(a){this.baseUrl=a},setCrossOrigin:function(a){this.crossOrigin=a},setMaterialOptions:function(a){this.materialOptions=a},parse:function(a){for(var b=a.split("\n"),c={},d=/\s+/,e={},f=0;f<b.length;f++){var g=b[f];if(g=g.trim(),0!==g.length&&"#"!==g.charAt(0)){var h=g.indexOf(" "),i=h>=0?g.substring(0,h):g;i=i.toLowerCase();var j=h>=0?g.substring(h+1):"";if(j=j.trim(),"newmtl"===i)c={name:j},e[j]=c;else if(c)if("ka"===i||"kd"===i||"ks"===i){var k=j.split(d,3);c[i]=[parseFloat(k[0]),parseFloat(k[1]),parseFloat(k[2])]}else c[i]=j}}var l=new THREE.MTLLoader.MaterialCreator(this.baseUrl,this.materialOptions);return l.setCrossOrigin(this.crossOrigin),l.setManager(this.manager),l.setMaterials(e),l}},THREE.MTLLoader.MaterialCreator=function(a,b){this.baseUrl=a,this.options=b,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping},THREE.MTLLoader.MaterialCreator.prototype={constructor:THREE.MTLLoader.MaterialCreator,setCrossOrigin:function(a){this.crossOrigin=a},setManager:function(a){this.manager=a},setMaterials:function(a){this.materialsInfo=this.convert(a),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(a){if(!this.options)return a;var b={};for(var c in a){var d=a[c],e={};b[c]=e;for(var f in d){var g=!0,h=d[f],i=f.toLowerCase();switch(i){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(h=[h[0]/255,h[1]/255,h[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===h[0]&&0===h[1]&&0===h[1]&&(g=!1)}g&&(e[i]=h)}}return b},preload:function(){for(var a in this.materialsInfo)this.create(a)},getIndex:function(a){return this.nameLookup[a]},getAsArray:function(){var a=0;for(var b in this.materialsInfo)this.materialsArray[a]=this.create(b),this.nameLookup[b]=a,a++;return this.materialsArray},create:function(a){return void 0===this.materials[a]&&this.createMaterial_(a),this.materials[a]},createMaterial_:function(a){var b=this.materialsInfo[a],c={name:a,side:this.side};for(var d in b){var e=b[d];if(""!==e)switch(d.toLowerCase()){case"kd":c.color=(new THREE.Color).fromArray(e);break;case"ks":c.specular=(new THREE.Color).fromArray(e);break;case"map_kd":c.map=this.loadTexture(this.baseUrl+e),c.map.wrapS=this.wrap,c.map.wrapT=this.wrap;break;case"ns":c.shininess=parseFloat(e);break;case"d":e<1&&(c.opacity=e,c.transparent=!0);break;case"Tr":e>0&&(c.opacity=1-e,c.transparent=!0);break;case"map_bump":case"bump":if(c.bumpMap)break;c.bumpMap=this.loadTexture(this.baseUrl+e),c.bumpMap.wrapS=this.wrap,c.bumpMap.wrapT=this.wrap}}return this.materials[a]=new THREE.MeshPhongMaterial(c),this.materials[a]},loadTexture:function(a,b,c,d,e){var f,g=THREE.Loader.Handlers.get(a),h=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;return null===g&&(g=new THREE.TextureLoader(h)),g.setCrossOrigin&&g.setCrossOrigin(this.crossOrigin),f=g.load(a,c,d,e),void 0!==b&&(f.mapping=b),f}},THREE.EventDispatcher.prototype.apply(THREE.MTLLoader.prototype),THREE.OBJLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager,this.materials=null},THREE.OBJLoader.prototype={constructor:THREE.OBJLoader,load:function(a,b,c,d){var e=this,f=new THREE.XHRLoader(e.manager);f.setPath(this.path),f.load(a,function(a){b(e.parse(a))},c,d)},setPath:function(a){this.path=a},setMaterials:function(a){this.materials=a},parse:function(a){function h(a){var d={vertices:[],normals:[],uvs:[]},e={name:"",smooth:!0};c={name:a,geometry:d,material:e},b.push(c)}function i(a){var b=parseInt(a);return 3*(b>=0?b-1:b+e.length/3)}function j(a){var b=parseInt(a);return 3*(b>=0?b-1:b+f.length/3)}function k(a){var b=parseInt(a);return 2*(b>=0?b-1:b+g.length/2)}function l(a,b,d){c.geometry.vertices.push(e[a],e[a+1],e[a+2],e[b],e[b+1],e[b+2],e[d],e[d+1],e[d+2])}function m(a,b,d){c.geometry.normals.push(f[a],f[a+1],f[a+2],f[b],f[b+1],f[b+2],f[d],f[d+1],f[d+2])}function n(a,b,d){c.geometry.uvs.push(g[a],g[a+1],g[b],g[b+1],g[d],g[d+1])}function o(a,b,c,d,e,f,g,h,o,p,q,r){var v,s=i(a),t=i(b),u=i(c);void 0===d?l(s,t,u):(v=i(d),l(s,t,v),l(t,u,v)),void 0!==e&&(s=k(e),t=k(f),u=k(g),void 0===d?n(s,t,u):(v=k(h),n(s,t,v),n(t,u,v))),void 0!==o&&(s=j(o),t=j(p),u=j(q),void 0===d?m(s,t,u):(v=j(r),m(s,t,v),m(t,u,v)))}console.time("OBJLoader");var c,b=[],d=!1,e=[],f=[],g=[];h("");for(var p=/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,q=/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,r=/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,s=/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,t=/^f\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)))?/,u=/^f\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)\/(-?\d+)))?/,v=/^f\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))(?:\s+((-?\d+)\/\/(-?\d+)))?/,w=/^[og]\s+(.+)/,x=/^s\s+(\d+|on|off)/,y=a.split("\n"),z=0;z<y.length;z++){var A=y[z];A=A.trim();var B;if(0!==A.length&&"#"!==A.charAt(0))if(null!==(B=p.exec(A)))e.push(parseFloat(B[1]),parseFloat(B[2]),parseFloat(B[3]));else if(null!==(B=q.exec(A)))f.push(parseFloat(B[1]),parseFloat(B[2]),parseFloat(B[3]));else if(null!==(B=r.exec(A)))g.push(parseFloat(B[1]),parseFloat(B[2]));else if(null!==(B=s.exec(A)))o(B[1],B[2],B[3],B[4]);else if(null!==(B=t.exec(A)))o(B[2],B[5],B[8],B[11],B[3],B[6],B[9],B[12]);else if(null!==(B=u.exec(A)))o(B[2],B[6],B[10],B[14],B[3],B[7],B[11],B[15],B[4],B[8],B[12],B[16]);else if(null!==(B=v.exec(A)))o(B[2],B[5],B[8],B[11],void 0,void 0,void 0,void 0,B[3],B[6],B[9],B[12]);else if(null!==(B=w.exec(A))){var C=B[1].trim();d===!1?(d=!0,c.name=C):h(C)}else if(/^usemtl /.test(A))c.material.name=A.substring(7).trim();else if(/^mtllib /.test(A));else{if(null===(B=x.exec(A)))throw new Error("Unexpected line: "+A);c.material.smooth="1"===B[1]||"on"===B[1]}}for(var D=new THREE.Group,z=0,E=b.length;z<E;z++){c=b[z];var F=c.geometry,G=new THREE.BufferGeometry;G.addAttribute("position",new THREE.BufferAttribute(new Float32Array(F.vertices),3)),F.normals.length>0?G.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(F.normals),3)):G.computeVertexNormals(),F.uvs.length>0&&G.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(F.uvs),2));var H;null!==this.materials&&(H=this.materials.create(c.material.name)),H||(H=new THREE.MeshPhongMaterial,H.name=c.material.name),H.shading=c.material.smooth?THREE.SmoothShading:THREE.FlatShading;var I=new THREE.Mesh(G,H);I.name=c.name,D.add(I)}return console.timeEnd("OBJLoader"),D}},THREE.ColladaLoader=function(){function B(a,b,c,d){var f=0;if(document.implementation&&document.implementation.createDocument){var g=new XMLHttpRequest;g.onreadystatechange=function(){4===g.readyState?0!==g.status&&200!==g.status||(g.response?(e=b,C(g.response,void 0,a)):d?d():console.error("ColladaLoader: Empty or non-existing file ("+a+")")):3===g.readyState&&c&&(0===f&&(f=g.getResponseHeader("Content-Length")),c({total:f,loaded:g.responseText.length}))},g.open("GET",a,!0),g.send(null)}else alert("Don't know how to parse XML!")}function C(f,v,w){if(a=(new DOMParser).parseFromString(f,"text/xml"),v=v||e,void 0!==w){var x=w.split("/");x.pop(),s=(x.length<1?".":x.join("/"))+"/"}E(),bb(),g=F("library_images image",da,"image"),k=F("library_materials material",xa,"material"),l=F("library_effects effect",Ca,"effect"),j=F("library_geometries geometry",na,"geometry"),m=F("library_cameras camera",Ia,"camera"),n=F("library_lights light",Ka,"light"),i=F("library_controllers controller",ea,"controller"),h=F("library_animations animation",Ea,"animation"),q=F("library_visual_scenes visual_scene",ha,"visual_scene"),r=F("library_kinematics_models kinematics_model",Ma,"kinematics_model"),t=[],u=[],c=G(),b=new THREE.Group;for(var z=0;z<c.nodes.length;z++)b.add(T(c.nodes[z]));b.scale.multiplyScalar(y),I(),d=H(),S();var A={scene:b,morphs:t,skins:u,animations:o,kinematics:p,dae:{images:g,materials:k,cameras:m,lights:n,effects:l,geometries:j,controllers:i,animations:h,visualScenes:q,visualScene:c,scene:c,kinematicsModels:r,kinematicsModel:d}};return v&&v(A),A}function D(a){w=a}function E(){var b=a.querySelectorAll("asset"),c=b[0];if(c&&c.childNodes)for(var d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];switch(e.nodeName){case"unit":var f=e.getAttribute("meter");f&&(y=parseFloat(f));break;case"up_axis":z=e.textContent.charAt(0)}}}function F(b,c,d){for(var e=a.querySelectorAll(b),f={},g=0,h=e.length,i=0;i<h;i++){var j=e[i],k=(new c).parse(j);k.id&&0!==k.id.length||(k.id=d+g++),f[k.id]=k}return f}function G(){var b=a.querySelectorAll("scene instance_visual_scene")[0];if(b){var c=b.getAttribute("url").replace(/^#/,"");return q[c.length>0?c:"visual_scene0"]}return null}function H(){var b=a.querySelectorAll("instance_kinematics_model")[0];if(b){var c=b.getAttribute("url").replace(/^#/,"");return r[c.length>0?c:"kinematics_model0"]}return null}function I(){o=[],J(b)}function J(a){var b=c.getChildById(a.colladaId,!0),d=null;if(b&&b.keys){d={fps:60,hierarchy:[{node:b,keys:b.keys,sids:b.sids}],node:a,name:"animation_"+a.name,length:0},o.push(d);for(var e=0,f=b.keys.length;e<f;e++)d.length=Math.max(d.length,b.keys[e].time)}else d={hierarchy:[{keys:[],sids:[]}]};for(var e=0,f=a.children.length;e<f;e++)for(var g=J(a.children[e]),h=0,i=g.hierarchy.length;h<i;h++)d.hierarchy.push({keys:[],sids:[]});return d}function K(){var d,a=1e6,b=-a,c=0;for(var e in h){var f=h[e];d=d||f.id;for(var g=0;g<f.sampler.length;g++){var i=f.sampler[g];i.create(),a=Math.min(a,i.startTime),b=Math.max(b,i.endTime),c=Math.max(c,i.input.length)}}return{start:a,end:b,frames:c,ID:d}}function L(a,b){var c=b instanceof ka?i[b.url]:b;if(!c||!c.morph)return void console.log("could not find morph controller!");for(var d=c.morph,e=0;e<d.targets.length;e++){var f=d.targets[e],g=j[f];if(g.mesh&&g.mesh.primitives&&g.mesh.primitives.length){var h=g.mesh.primitives[0].geometry;h.vertices.length===a.vertices.length&&a.morphTargets.push({name:"target_1",vertices:h.vertices})}}a.morphTargets.push({name:"target_Z",vertices:a.vertices})}function N(a,b,c,d){if(a.world=a.world||new THREE.Matrix4,a.localworld=a.localworld||new THREE.Matrix4,a.world.copy(a.matrix),a.localworld.copy(a.matrix),a.channels&&a.channels.length){var e=a.channels[0],f=e.sampler.output[c];f instanceof THREE.Matrix4&&(a.world.copy(f),a.localworld.copy(f),0===c&&a.matrix.copy(f))}d&&a.world.multiplyMatrices(d,a.world),b.push(a);for(var g=0;g<a.nodes.length;g++)N(a.nodes[g],b,c,a.world)}function O(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=-1;if("JOINT"==d.type){for(var f=0;f<b.joints.length;f++)if(d.sid===b.joints[f]){e=f;break}if(e>=0){var g=b.invBindMatrices[e];d.invBindMatrix=g,d.skinningMatrix=new THREE.Matrix4,d.skinningMatrix.multiplyMatrices(d.world,g),d.animatrix=new THREE.Matrix4,d.animatrix.copy(d.localworld),d.weights=[];for(var f=0;f<b.weights.length;f++)for(var h=0;h<b.weights[f].length;h++){var i=b.weights[f][h];i.joint===e&&d.weights.push(i)}}else console.warn("ColladaLoader: Could not find joint '"+d.sid+"'."),d.skinningMatrix=new THREE.Matrix4,d.weights=[]}}}function P(a){var b=[],c=function(a,b,d){var e={};e.name=b.sid,e.parent=a,e.matrix=b.matrix;var f=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];e.matrix.decompose(f[0],f[1],f[2]),e.pos=[f[0].x,f[0].y,f[0].z],e.scl=[f[2].x,f[2].y,f[2].z],e.rotq=[f[1].x,f[1].y,f[1].z,f[1].w],d.push(e);for(var g in b.nodes)c(b.sid,b.nodes[g],d)};return c(-1,a,b),b}function Q(a,b,c){var d=[];N(b,d,-1),O(d,c.skin);for(var e=new THREE.Vector3,f=[],g=0;g<a.vertices.length;g++)f.push(new THREE.Vector3);for(g=0;g<d.length;g++)if("JOINT"==d[g].type)for(var h=0;h<d[g].weights.length;h++){var i=d[g].weights[h],j=i.index,k=i.weight,l=a.vertices[j],m=f[j];e.x=l.x,e.y=l.y,e.z=l.z,e.applyMatrix4(d[g].skinningMatrix),m.x+=e.x*k,m.y+=e.y*k,m.z+=e.z*k}for(var g=0;g<a.vertices.length;g++)a.vertices[g]=f[g]}function R(a,b,d){var e=i[b.url];if(d=void 0!==d?d:40,!e||!e.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!b.skeleton||!b.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var f=K(),g=c.getChildById(b.skeleton[0],!0)||c.getChildBySid(b.skeleton[0],!0),h=P(g),j=e.skin.joints,k=[],l=0;l<j.length;l++)for(var m=0;m<h.length;m++)h[m].name===j[l]&&(k[l]=h[m]);for(var l=0;l<k.length;l++)for(var m=0;m<k.length;m++)k[l].parent===k[m].name&&(k[l].parent=m);var l,m,p;new THREE.Vector3;for(l=0;l<a.vertices.length;l++)a.vertices[l].applyMatrix4(e.skin.bindShapeMatrix);for(var t=[],u=[],v=e.skin.weights,l=0;l<v.length;l++){var w=new THREE.Vector4(v[l][0]?v[l][0].joint:0,v[l][1]?v[l][1].joint:0,v[l][2]?v[l][2].joint:0,v[l][3]?v[l][3].joint:0),p=new THREE.Vector4(v[l][0]?v[l][0].weight:0,v[l][1]?v[l][1].weight:0,v[l][2]?v[l][2].weight:0,v[l][3]?v[l][3].weight:0);t.push(w),u.push(p)}a.skinIndices=t,a.skinWeights=u,a.bones=k;for(var x={name:f.ID,fps:30,length:f.frames/30,hierarchy:[]},m=0;m<k.length;m++)x.hierarchy.push({parent:k[m].parent,name:k[m].name,keys:[]});for(console.log("ColladaLoader:",f.ID+" has "+k.length+" bones."),Q(a,g,e),d=0;d<f.frames;d++){var y=[];N(g,y,d),O(y,e.skin);for(var l=0;l<y.length;l++)for(var m=0;m<x.hierarchy.length;m++)if(x.hierarchy[m].name===y[l].sid){var A={};A.time=d/30,A.matrix=y[l].animatrix,0===d&&(y[l].matrix=A.matrix);var B=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];A.matrix.decompose(B[0],B[1],B[2]),A.pos=[B[0].x,B[0].y,B[0].z],A.scl=[B[2].x,B[2].y,B[2].z],A.rot=B[1],x.hierarchy[m].keys.push(A)}a.animation=x}}function S(){if(d&&0===d.joints.length)return void(p=void 0);var e={},f=function(a,f){var g=f.getAttribute("id"),h=c.getChildById(g,!0),i=d.joints[a];b.traverse(function(b){b.colladaId==g&&(e[a]={node:b,transforms:h.transforms,joint:i,position:i.zeroPosition})})};p={joints:d&&d.joints,getJointValue:function(a){var b=e[a];return b?b.position:void console.log("getJointValue: joint "+a+" doesn't exist")},setJointValue:function(a,b){var c=e[a];if(c){var d=c.joint;if(b>d.limits.max||b<d.limits.min)console.log("setJointValue: joint "+a+" value "+b+" outside of limits (min: "+d.limits.min+", max: "+d.limits.max+")");else if(d.static)console.log("setJointValue: joint "+a+" is static");else{var f=c.node,g=d.axis,i=c.transforms,j=new THREE.Matrix4;for(h=0;h<i.length;h++){var k=i[h];if(k.sid&&k.sid.indexOf("joint"+a)!==-1)switch(d.type){case"revolute":j.multiply(l.makeRotationAxis(g,THREE.Math.degToRad(b)));break;case"prismatic":j.multiply(l.makeTranslation(g.x*b,g.y*b,g.z*b));break;default:console.warn("setJointValue: unknown joint type: "+d.type)}else{var l=new THREE.Matrix4;switch(k.type){case"matrix":j.multiply(k.obj);break;case"translate":j.multiply(l.makeTranslation(k.obj.x,k.obj.y,k.obj.z));break;case"rotate":j.multiply(l.makeRotationAxis(k.obj,k.angle))}}}var m=j.elements,n=Array.prototype.slice.call(m),o=[n[0],n[4],n[8],n[12],n[1],n[5],n[9],n[13],n[2],n[6],n[10],n[14],n[3],n[7],n[11],n[15]];f.matrix.set.apply(f.matrix,o),f.matrix.decompose(f.position,f.quaternion,f.scale)}}else console.log("setJointValue: joint "+a+" doesn't exist")}};var g=a.querySelector("scene instance_kinematics_scene");if(g)for(var h=0;h<g.childNodes.length;h++){var i=g.childNodes[h];if(1==i.nodeType)switch(i.nodeName){case"bind_joint_axis":var j=i.getAttribute("target").split("/").pop(),k=i.querySelector("axis param").textContent,l=parseInt(k.split("joint").pop().split(".")[0]),m=a.querySelector('[sid="'+j+'"]');if(m){var n=m.parentElement;f(l,n)}}}}function T(a,b){var e,f,g,h,c=new THREE.Object3D,d=!1;for(g=0;g<a.controllers.length;g++){var o=i[a.controllers[g].url];switch(o.type){case"skin":if(j[o.skin.source]){var p=new ma;p.url=o.skin.source,p.instance_material=a.controllers[g].instance_material,a.geometries.push(p),d=!0,e=a.controllers[g]}else if(i[o.skin.source]){var q=i[o.skin.source];if(f=q,q.morph&&j[q.morph.source]){var p=new ma;p.url=q.morph.source,p.instance_material=a.controllers[g].instance_material,a.geometries.push(p)}}break;case"morph":if(j[o.morph.source]){var p=new ma;p.url=o.morph.source,p.instance_material=a.controllers[g].instance_material,a.geometries.push(p),f=a.controllers[g]}console.log("ColladaLoader: Morph-controller partially supported.")}}var r={};for(g=0;g<a.geometries.length;g++){var B,s=a.geometries[g],v=s.instance_material,w=j[s.url],y={},z=[],A=0;if(w){if(!w.mesh||!w.mesh.primitives)continue;if(0===c.name.length&&(c.name=w.id),v)for(h=0;h<v.length;h++){var C=v[h],D=k[C.target],E=D.instance_effect.url,F=l[E].shader,G=F.material;if(w.doubleSided){if(!(C.symbol in r)){var H=G.clone();H.side=THREE.DoubleSide,r[C.symbol]=H}G=r[C.symbol]}G.opacity=G.opacity?G.opacity:1,y[C.symbol]=A,z.push(G),B=G,B.name=null===D.name||""===D.name?D.id:D.name,A++}var I,J=B||new THREE.MeshLambertMaterial({color:14540253,side:w.doubleSided?THREE.DoubleSide:THREE.FrontSide}),K=w.mesh.geometry3js;A>1&&(J=new THREE.MultiMaterial(z)),void 0!==e?(R(K,e),K.morphTargets.length>0?(J.morphTargets=!0,J.skinning=!1):(J.morphTargets=!1,J.skinning=!0),I=new THREE.SkinnedMesh(K,J,!1),I.name="skin_"+u.length,u.push(I)):void 0!==f?(L(K,f),J.morphTargets=!0,I=new THREE.Mesh(K,J),I.name="morph_"+t.length,t.push(I)):I=K.isLineStrip===!0?new THREE.Line(K):new THREE.Mesh(K,J),c.add(I)}}for(g=0;g<a.cameras.length;g++){var M=a.cameras[g],N=m[M.url],O=new THREE.PerspectiveCamera(N.yfov,parseFloat(N.aspect_ratio),parseFloat(N.znear),parseFloat(N.zfar));c.add(O)}for(g=0;g<a.lights.length;g++){var P=null,Q=a.lights[g],S=n[Q.url];if(S&&S.technique){var U=S.color.getHex(),V=S.intensity,W=S.distance,X=S.falloff_angle;switch(S.technique){case"directional":P=new THREE.DirectionalLight(U,V,W),P.position.set(0,0,1);break;case"point":P=new THREE.PointLight(U,V,W);break;case"spot":P=new THREE.SpotLight(U,V,W,X),P.position.set(0,0,1);break;case"ambient":P=new THREE.AmbientLight(U)}}P&&c.add(P)}if(c.name=a.name||a.id||"",c.colladaId=a.id||"",c.layer=a.layer||"",c.matrix=a.matrix,c.matrix.decompose(c.position,c.quaternion,c.scale),x.centerGeometry&&c.geometry){var Y=c.geometry.center();Y.multiply(c.scale),Y.applyQuaternion(c.quaternion),c.position.sub(Y)}for(g=0;g<a.nodes.length;g++)c.add(T(a.nodes[g],a));return c}function V(b){for(var c=a.querySelectorAll("library_nodes node"),d=0;d<c.length;d++){var e=c[d].attributes.getNamedItem("id");if(e&&e.value===b)return c[d]}}function W(a){var b=[],c=1e6,d=-1e6;for(var e in h)for(var f=h[e],g=0;g<f.channel.length;g++){var i=f.channel[g],j=f.sampler[g],e=i.target.split("/")[0];e==a.id&&(j.create(),i.sampler=j,c=Math.min(c,j.startTime),d=Math.max(d,j.endTime),b.push(i))}return b.length&&(a.startTime=c,a.endTime=d),b}function Z(a){if(a.channels&&a.channels.length){for(var b=[],c=[],d=0,e=a.channels.length;d<e;d++){var k,f=a.channels[d],g=f.fullSid,h=f.sampler,i=h.input,j=a.getTransformBySid(f.sid);if(f.arrIndices){k=[];for(var l=0,m=f.arrIndices.length;l<m;l++)k[l]=gb(f.arrIndices[l])}else k=hb(f.member);if(j){c.indexOf(g)===-1&&c.push(g);for(var l=0,m=i.length;l<m;l++){var n=i[l],o=h.getData(j.type,l,k),p=$(b,n);if(!p){p=new Ha(n);var q=_(b,n);b.splice(q===-1?b.length:q,0,p)}p.addTarget(g,j,k,o)}}else console.log('Could not find transform "'+f.sid+'" in node '+a.id)}for(var d=0;d<c.length;d++)for(var r=c[d],l=0;l<b.length;l++){var p=b[l];p.hasTarget(r)||aa(b,p,l,r)}a.keys=b,a.sids=c}}function $(a,b){for(var c=null,d=0,e=a.length;d<e&&null===c;d++){var f=a[d];if(f.time===b)c=f;else if(f.time>b)break}return c}function _(a,b){for(var c=-1,d=0,e=a.length;d<e&&c===-1;d++){var f=a[d];f.time>=b&&(c=d)}return c}function aa(a,b,c,d){var e=ca(a,d,c?c-1:0),f=ba(a,d,c+1);if(e&&f){var k,g=(b.time-e.time)/(f.time-e.time),h=e.getTarget(d),i=f.getTarget(d).data,j=h.data;if("matrix"===h.type)k=j;else if(j.length){k=[];for(var l=0;l<j.length;++l)k[l]=j[l]+(i[l]-j[l])*g}else k=j+(i-j)*g;b.addTarget(d,h.transform,h.member,k)}}function ba(a,b,c){for(;c<a.length;c++){var d=a[c];if(d.hasTarget(b))return d}return null}function ca(a,b,c){for(c=c>=0?c:c+a.length;c>=0;c--){var d=a[c];if(d.hasTarget(b))return d}return null}function da(){this.id="",this.init_from=""}function ea(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function fa(){this.method=null,this.source=null,this.targets=null,this.weights=null}function ga(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function ha(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function ia(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function ja(){this.sid="",this.type="",this.data=[],this.obj=null}function ka(){this.url="",this.skeleton=[],this.instance_material=[]}function la(){this.symbol="",this.target=""}function ma(){this.url="",this.instance_material=[]}function na(){this.id="",this.mesh=null}function oa(a){this.geometry=a.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function pa(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function qa(){pa.call(this),this.vcount=[]}function ra(){pa.call(this),this.vcount=1}function sa(){pa.call(this),this.vcount=3}function ta(){this.source="",this.count=0,this.stride=0,this.params=[]}function ua(){this.input={}}function va(){this.semantic="",this.offset=0,this.source="",this.set=0}function wa(a){this.id=a,this.type=null}function xa(){this.id="",this.name="",this.instance_effect=null}function ya(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function za(a,b){this.type=a,this.effect=b,this.material=null}function Aa(a){this.effect=a,this.init_from=null,this.format=null}function Ba(a){this.effect=a,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Ca(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function Da(){this.url=""}function Ea(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function Fa(a){this.animation=a,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function Ga(a){this.id="",this.animation=a,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function Ha(a){this.targets=[],this.time=a}function Ia(){this.id="",this.name="",this.technique=""}function Ja(){this.url=""}function Ka(){this.id="",this.name="",this.technique=""}function La(){this.url=""}function Ma(){this.id="",this.name="",this.joints=[],this.links=[]}function Na(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function Oa(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function Pa(){this.joint="",this.transforms=[],this.links=[]}function Qa(a){var b=a.getAttribute("id");return void 0!=f[b]?f[b]:(f[b]=new wa(b).parse(a),f[b])}function Sa(a){for(var b=Va(a),c=[],d=0,e=b.length;d<e;d++)c.push("true"===b[d]||"1"===b[d]);return c}function Ta(a){for(var b=Va(a),c=[],d=0,e=b.length;d<e;d++)c.push(parseFloat(b[d]));return c}function Ua(a){for(var b=Va(a),c=[],d=0,e=b.length;d<e;d++)c.push(parseInt(b[d],10));return c}function Va(a){return a.length>0?Wa(a).split(/\s+/):[]}function Wa(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}function Ya(a,b,c){return a.hasAttribute(b)?parseInt(a.getAttribute(b),10):c}function _a(a,b){var c=new THREE.ImageLoader;c.load(b,function(b){a.image=b,a.needsUpdate=!0})}function ab(a,b){a.doubleSided=!1;var c=b.querySelectorAll("extra double_sided")[0];c&&c&&1===parseInt(c.textContent,10)&&(a.doubleSided=!0)}function bb(){if(x.convertUpAxis!==!0||z===x.upAxis)A=null;else switch(z){case"X":A="Y"===x.upAxis?"XtoY":"XtoZ";break;case"Y":A="X"===x.upAxis?"YtoX":"YtoZ";break;case"Z":A="X"===x.upAxis?"ZtoX":"ZtoY"}}function cb(a,b){if(x.convertUpAxis===!0&&z!==x.upAxis)switch(A){case"XtoY":var c=a[0];a[0]=b*a[1],a[1]=c;break;case"XtoZ":var c=a[2];a[2]=a[1],a[1]=a[0],a[0]=c;break;case"YtoX":var c=a[0];a[0]=a[1],a[1]=b*c;break;case"YtoZ":var c=a[1];a[1]=b*a[2],a[2]=c;break;case"ZtoX":var c=a[0];a[0]=a[1],a[1]=a[2],a[2]=c;break;case"ZtoY":var c=a[1];a[1]=a[2],a[2]=b*c}}function db(a,b){if(x.convertUpAxis!==!0||z===x.upAxis)return b;switch(a){case"X":b="XtoY"===A?b*-1:b;break;case"Y":b="YtoZ"===A||"YtoX"===A?b*-1:b;break;case"Z":b="ZtoY"===A?b*-1:b}return b}function eb(a,b){var c=[a[b],a[b+1],a[b+2]];return cb(c,-1),new THREE.Vector3(c[0],c[1],c[2])}function fb(a){if(x.convertUpAxis){var b=[a[0],a[4],a[8]];cb(b,-1),a[0]=b[0],a[4]=b[1],a[8]=b[2],b=[a[1],a[5],a[9]],cb(b,-1),a[1]=b[0],a[5]=b[1],a[9]=b[2],b=[a[2],a[6],a[10]],cb(b,-1),a[2]=b[0],a[6]=b[1],a[10]=b[2],b=[a[0],a[1],a[2]],cb(b,-1),a[0]=b[0],a[1]=b[1],a[2]=b[2],b=[a[4],a[5],a[6]],cb(b,-1),a[4]=b[0],a[5]=b[1],a[6]=b[2],b=[a[8],a[9],a[10]],cb(b,-1),a[8]=b[0],a[9]=b[1],a[10]=b[2],b=[a[3],a[7],a[11]],cb(b,-1),a[3]=b[0],a[7]=b[1],a[11]=b[2]}return(new THREE.Matrix4).set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15])}function gb(a){if(a>-1&&a<3){var b=["X","Y","Z"],c={X:0,Y:1,Z:2};a=hb(b[a]),a=c[a]}return a}function hb(a){if(x.convertUpAxis)switch(a){case"X":switch(A){case"XtoY":case"XtoZ":case"YtoX":a="Y";break;case"ZtoX":a="Z"}break;case"Y":switch(A){case"XtoY":case"YtoX":case"ZtoX":a="X";break;case"XtoZ":case"YtoZ":case"ZtoY":a="Z"}break;case"Z":switch(A){case"XtoZ":a="X";break;case"YtoZ":case"ZtoX":case"ZtoY":a="Y"}}return a}var c,d,o,p,q,r,s,t,u,a=null,b=null,e=null,f={},g={},h={},i={},j={},k={},l={},m={},n={},w=THREE.SmoothShading,x={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},y=1,z="Y",A=null;return da.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];"init_from"===c.nodeName&&(this.init_from=c.textContent)}return this},ea.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type="none";for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"skin":this.skin=(new ga).parse(c),this.type=c.nodeName;break;case"morph":this.morph=(new fa).parse(c),this.type=c.nodeName}}return this},fa.prototype.parse=function(a){var d,b={},c=[];for(this.method=a.getAttribute("method"),this.source=a.getAttribute("source").replace(/^#/,""),d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];if(1==e.nodeType)switch(e.nodeName){case"source":var f=(new wa).parse(e);b[f.id]=f;break;case"targets":c=this.parseInputs(e);break;default:console.log(e.nodeName)}}for(d=0;d<c.length;d++){var g=c[d],f=b[g.source];switch(g.semantic){case"MORPH_TARGET":this.targets=f.read();break;case"MORPH_WEIGHT":this.weights=f.read()}}return this},fa.prototype.parseInputs=function(a){for(var b=[],c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":b.push((new va).parse(d))}}return b},ga.prototype.parse=function(a){var c,d,b={};this.source=a.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var e=0;e<a.childNodes.length;e++){var f=a.childNodes[e];if(1==f.nodeType)switch(f.nodeName){case"bind_shape_matrix":var g=Ta(f.textContent);this.bindShapeMatrix=fb(g);break;case"source":var h=(new wa).parse(f);b[h.id]=h;break;case"joints":c=f;break;case"vertex_weights":d=f;break;default:console.log(f.nodeName)}}return this.parseJoints(c,b),this.parseWeights(d,b),this},ga.prototype.parseJoints=function(a,b){for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":var e=(new va).parse(d),f=b[e.source];"JOINT"===e.semantic?this.joints=f.read():"INV_BIND_MATRIX"===e.semantic&&(this.invBindMatrices=f.read())}}},ga.prototype.parseWeights=function(a,b){for(var c,d,e=[],f=0;f<a.childNodes.length;f++){var g=a.childNodes[f];if(1==g.nodeType)switch(g.nodeName){case"input":e.push((new va).parse(g));break;case"v":c=Ua(g.textContent);break;case"vcount":d=Ua(g.textContent)}}for(var h=0,f=0;f<d.length;f++){for(var i=d[f],j=[],k=0;k<i;k++){for(var l={},m=0;m<e.length;m++){var n=e[m],o=c[h+n.offset];switch(n.semantic){case"JOINT":l.joint=o;break;case"WEIGHT":l.weight=b[n.source].data[o]}}j.push(l),h+=e.length}for(var k=0;k<j.length;k++)j[k].index=f;this.weights.push(j)}},ha.prototype.getChildById=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},ha.prototype.getChildBySid=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},ha.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.nodes=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"node":this.nodes.push((new ia).parse(c))}}return this},ia.prototype.getChannelForTransform=function(a){for(var b=0;b<this.channels.length;b++){var i,j,c=this.channels[b],d=c.target.split("/"),f=(d.shift(),d.shift()),g=f.indexOf(".")>=0,h=f.indexOf("(")>=0;if(g)d=f.split("."),f=d.shift(),j=d.shift();else if(h){i=f.split("("),f=i.shift();for(var k=0;k<i.length;k++)i[k]=parseInt(i[k].replace(/\)/,""));
}if(f===a)return c.info={sid:f,dotSyntax:g,arrSyntax:h,arrIndices:i},c}return null},ia.prototype.getChildById=function(a,b){if(this.id===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},ia.prototype.getChildBySid=function(a,b){if(this.sid===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},ia.prototype.getTransformBySid=function(a){for(var b=0;b<this.transforms.length;b++)if(this.transforms[b].sid===a)return this.transforms[b];return null},ia.prototype.parse=function(a){var b;this.id=a.getAttribute("id"),this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.type=a.getAttribute("type"),this.layer=a.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"node":this.nodes.push((new ia).parse(d));break;case"instance_camera":this.cameras.push((new Ja).parse(d));break;case"instance_controller":this.controllers.push((new ka).parse(d));break;case"instance_geometry":this.geometries.push((new ma).parse(d));break;case"instance_light":this.lights.push((new La).parse(d));break;case"instance_node":b=d.getAttribute("url").replace(/^#/,"");var e=V(b);e&&this.nodes.push((new ia).parse(e));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new ja).parse(d));break;case"extra":break;default:console.log(d.nodeName)}}return this.channels=W(this),Z(this),this.updateMatrix(),this},ia.prototype.updateMatrix=function(){this.matrix.identity();for(var a=0;a<this.transforms.length;a++)this.transforms[a].apply(this.matrix)},ja.prototype.parse=function(a){return this.sid=a.getAttribute("sid"),this.type=a.nodeName,this.data=Ta(a.textContent),this.convert(),this},ja.prototype.convert=function(){switch(this.type){case"matrix":this.obj=fb(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":cb(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":cb(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},ja.prototype.apply=function(){var a=new THREE.Matrix4;return function(b){switch(this.type){case"matrix":b.multiply(this.obj);break;case"translate":b.multiply(a.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":b.multiply(a.makeRotationAxis(this.obj,this.angle));break;case"scale":b.scale(this.obj)}}}(),ja.prototype.update=function(a,b){var c=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(b)if(1===b.length)switch(b[0]){case 0:this.obj.n11=a[0],this.obj.n21=a[1],this.obj.n31=a[2],this.obj.n41=a[3];break;case 1:this.obj.n12=a[0],this.obj.n22=a[1],this.obj.n32=a[2],this.obj.n42=a[3];break;case 2:this.obj.n13=a[0],this.obj.n23=a[1],this.obj.n33=a[2],this.obj.n43=a[3];break;case 3:this.obj.n14=a[0],this.obj.n24=a[1],this.obj.n34=a[2],this.obj.n44=a[3]}else if(2===b.length){var d="n"+(b[0]+1)+(b[1]+1);this.obj[d]=a}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(a);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;case"ANGLE":this.angle=THREE.Math.degToRad(a);break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2],this.angle=THREE.Math.degToRad(a[3])}}},ka.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1===c.nodeType)switch(c.nodeName){case"skeleton":this.skeleton.push(c.textContent.replace(/^#/,""));break;case"bind_material":for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new la).parse(f))}break;case"extra":}}return this},la.prototype.parse=function(a){return this.symbol=a.getAttribute("symbol"),this.target=a.getAttribute("target").replace(/^#/,""),this},ma.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType&&"bind_material"===c.nodeName){for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new la).parse(f))}break}}return this},na.prototype.parse=function(a){this.id=a.getAttribute("id"),ab(this,a);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"mesh":this.mesh=new oa(this).parse(c);break;case"extra":}}return this},oa.prototype.parse=function(a){this.primitives=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"source":Qa(c);break;case"vertices":this.vertices=(new ua).parse(c);break;case"linestrips":this.primitives.push((new ra).parse(c));break;case"triangles":this.primitives.push((new sa).parse(c));break;case"polygons":this.primitives.push((new pa).parse(c));break;case"polylist":this.primitives.push((new qa).parse(c))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var d=f[this.vertices.input.POSITION.source].data,b=0;b<d.length;b+=3)this.geometry3js.vertices.push(eb(d,b).clone());for(var b=0;b<this.primitives.length;b++){var e=this.primitives[b];e.setVertices(this.vertices),this.handlePrimitive(e,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},oa.prototype.handlePrimitive=function(a,b){if(a instanceof ra)return void(b.isLineStrip=!0);var c,d,h,i,j,k,l,e=a.p,g=a.inputs,m=0,n=3,o=0,p=[];for(c=0;c<g.length;c++){h=g[c];var q=h.offset+1;switch(o=o<q?q:o,h.semantic){case"TEXCOORD":p.push(h.set)}}for(var r=0;r<e.length;++r)for(var s=e[r],t=0;t<s.length;){var u=[],v=[],w=null,y=[];for(n=a.vcount?a.vcount.length?a.vcount[m++]:a.vcount:s.length/o,c=0;c<n;c++)for(d=0;d<g.length;d++)switch(h=g[d],k=f[h.source],i=s[t+c*o+h.offset],l=k.accessor.params.length,j=i*l,h.semantic){case"VERTEX":u.push(i);break;case"NORMAL":v.push(eb(k.data,j));break;case"TEXCOORD":w=w||{},void 0===w[h.set]&&(w[h.set]=[]),w[h.set].push(new THREE.Vector2(k.data[j],k.data[j+1]));break;case"COLOR":y.push((new THREE.Color).setRGB(k.data[j],k.data[j+1],k.data[j+2]))}if(0===v.length)if(h=this.vertices.input.NORMAL){k=f[h.source],l=k.accessor.params.length;for(var z=0,A=u.length;z<A;z++)v.push(eb(k.data,u[z]*l))}else b.calcNormals=!0;if(!w&&(w={},h=this.vertices.input.TEXCOORD)){p.push(h.set),k=f[h.source],l=k.accessor.params.length;for(var z=0,A=u.length;z<A;z++)j=u[z]*l,void 0===w[h.set]&&(w[h.set]=[]),w[h.set].push(new THREE.Vector2(k.data[j],1-k.data[j+1]))}if(0===y.length&&(h=this.vertices.input.COLOR)){k=f[h.source],l=k.accessor.params.length;for(var z=0,A=u.length;z<A;z++)j=u[z]*l,y.push((new THREE.Color).setRGB(k.data[j],k.data[j+1],k.data[j+2]))}var D,E,B=null,C=[];if(3===n)C.push(new THREE.Face3(u[0],u[1],u[2],v,y.length?y:new THREE.Color));else if(4===n)C.push(new THREE.Face3(u[0],u[1],u[3],v.length?[v[0].clone(),v[1].clone(),v[3].clone()]:[],y.length?[y[0],y[1],y[3]]:new THREE.Color)),C.push(new THREE.Face3(u[1],u[2],u[3],v.length?[v[1].clone(),v[2].clone(),v[3].clone()]:[],y.length?[y[1],y[2],y[3]]:new THREE.Color));else if(n>4&&x.subdivideFaces){var F=y.length?y:new THREE.Color;for(d=1;d<n-1;)C.push(new THREE.Face3(u[0],u[d],u[d+1],v.length?[v[0].clone(),v[d++].clone(),v[d].clone()]:[],F))}if(C.length)for(var z=0,A=C.length;z<A;z++)for(B=C[z],B.daeMaterial=a.material,b.faces.push(B),d=0;d<p.length;d++)D=w[p[d]],E=n>4?[D[0],D[z+1],D[z+2]]:4===n?0===z?[D[0],D[1],D[3]]:[D[1].clone(),D[2],D[3].clone()]:[D[0],D[1],D[2]],void 0===b.faceVertexUvs[d]&&(b.faceVertexUvs[d]=[]),b.faceVertexUvs[d].push(E);else console.log("dropped face with vcount "+n+" for geometry with id: "+b.id);t+=o*n}},pa.prototype.setVertices=function(a){for(var b=0;b<this.inputs.length;b++)this.inputs[b].source===a.id&&(this.inputs[b].source=a.input.POSITION.source)},pa.prototype.parse=function(a){this.material=a.getAttribute("material"),this.count=Ya(a,"count",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"input":this.inputs.push((new va).parse(a.childNodes[b]));break;case"vcount":this.vcount=Ua(c.textContent);break;case"p":this.p.push(Ua(c.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},qa.prototype=Object.create(pa.prototype),qa.prototype.constructor=qa,ra.prototype=Object.create(pa.prototype),ra.prototype.constructor=ra,sa.prototype=Object.create(pa.prototype),sa.prototype.constructor=sa,ta.prototype.parse=function(a){this.params=[],this.source=a.getAttribute("source"),this.count=Ya(a,"count",0),this.stride=Ya(a,"stride",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if("param"===c.nodeName){var d={};d.name=c.getAttribute("name"),d.type=c.getAttribute("type"),this.params.push(d)}}return this},ua.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++)if("input"===a.childNodes[b].nodeName){var c=(new va).parse(a.childNodes[b]);this.input[c.semantic]=c}return this},va.prototype.parse=function(a){return this.semantic=a.getAttribute("semantic"),this.source=a.getAttribute("source").replace(/^#/,""),this.set=Ya(a,"set",-1),this.offset=Ya(a,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},wa.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"bool_array":this.data=Sa(c.textContent),this.type=c.nodeName;break;case"float_array":this.data=Ta(c.textContent),this.type=c.nodeName;break;case"int_array":this.data=Ua(c.textContent),this.type=c.nodeName;break;case"IDREF_array":case"Name_array":this.data=Va(c.textContent),this.type=c.nodeName;break;case"technique_common":for(var d=0;d<c.childNodes.length;d++)if("accessor"===c.childNodes[d].nodeName){this.accessor=(new ta).parse(c.childNodes[d]);break}}}return this},wa.prototype.read=function(){var a=[],b=this.accessor.params[0];switch(b.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var c=0;c<this.data.length;c+=16){var d=this.data.slice(c,c+16),e=fb(d);a.push(e)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+b.type+".")}return a},xa.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++)if("instance_effect"===a.childNodes[b].nodeName){this.instance_effect=(new Da).parse(a.childNodes[b]);break}return this},ya.prototype.isColor=function(){return null===this.texture},ya.prototype.isTexture=function(){return null!=this.texture},ya.prototype.parse=function(a){"transparent"===a.nodeName&&(this.opaque=a.getAttribute("opaque"));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"color":var d=Ta(c.textContent);this.color=new THREE.Color,this.color.setRGB(d[0],d[1],d[2]),this.color.a=d[3];break;case"texture":this.texture=c.getAttribute("texture"),this.texcoord=c.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(c)}}return this},ya.prototype.parseTexture=function(a){if(!a.childNodes)return this;a.childNodes[1]&&"extra"===a.childNodes[1].nodeName&&(a=a.childNodes[1],a.childNodes[1]&&"technique"===a.childNodes[1].nodeName&&(a=a.childNodes[1]));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[c.nodeName]=parseFloat(c.textContent);break;case"wrapU":case"wrapV":"TRUE"===c.textContent.toUpperCase()?this.texOpts[c.nodeName]=1:this.texOpts[c.nodeName]=parseInt(c.textContent);break;default:this.texOpts[c.nodeName]=c.textContent}}return this},za.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[c.nodeName]=(new ya).parse(c);break;case"bump":var d=c.getAttribute("bumptype");d?"heightfield"===d.toLowerCase()?this.bump=(new ya).parse(c):"normalmap"===d.toLowerCase()?this.normal=(new ya).parse(c):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+d+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new ya).parse(c)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new ya).parse(c));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var e=c.querySelectorAll("float");e.length>0&&(this[c.nodeName]=parseFloat(e[0].textContent))}}return this.create(),this},za.prototype.create=function(){var a={},b=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var d=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);d>0&&(b=!0,a.transparent=!0,a.opacity=1-d)}var e={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var f in this)switch(f){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var h=this[f];if(h instanceof ya)if(h.isTexture()){var i=h.texture,j=this.effect.sampler[i];if(void 0!==j&&void 0!==j.source){var k=this.effect.surface[j.source];if(void 0!==k){var l=g[k.init_from];if(l){var n,m=s+l.init_from,o=THREE.Loader.Handlers.get(m);null!==o?n=o.load(m):(n=new THREE.Texture,_a(n,m)),n.wrapS=h.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.wrapT=h.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.offset.x=h.texOpts.offsetU,n.offset.y=h.texOpts.offsetV,n.repeat.x=h.texOpts.repeatU,n.repeat.y=h.texOpts.repeatV,a[e[f]]=n,"emission"===f&&(a.emissive=16777215)}}}}else"diffuse"!==f&&b||("emission"===f?a.emissive=h.color.getHex():a[f]=h.color.getHex());break;case"shininess":a[f]=this[f];break;case"reflectivity":a[f]=this[f],a[f]>0&&(a.envMap=x.defaultEnvMap),a.combine=THREE.MixOperation;break;case"index_of_refraction":a.refractionRatio=this[f],1!==this[f]&&(a.envMap=x.defaultEnvMap);break;case"transparency":}switch(a.shading=w,a.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==a.diffuse&&(a.color=a.diffuse,delete a.diffuse),this.type){case"constant":void 0!=a.emissive&&(a.color=a.emissive),this.material=new THREE.MeshBasicMaterial(a);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(a);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(a)}return this.material},Aa.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"init_from":this.init_from=c.textContent;break;case"format":this.format=c.textContent;break;default:console.log("unhandled Surface prop: "+c.nodeName)}}return this},Ba.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"source":this.source=c.textContent;break;case"minfilter":this.minfilter=c.textContent;break;case"magfilter":this.magfilter=c.textContent;break;case"mipfilter":this.mipfilter=c.textContent;break;case"wrap_s":this.wrap_s=c.textContent;break;case"wrap_t":this.wrap_t=c.textContent;break;default:console.log("unhandled Sampler2D prop: "+c.nodeName)}}return this},Ca.prototype.create=function(){if(null===this.shader)return null},Ca.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),ab(this,a),this.shader=null;for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(c))}}return this},Ca.prototype.parseNewparam=function(a){for(var b=a.getAttribute("sid"),c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"surface":this.surface[b]=new Aa(this).parse(d);break;case"sampler2D":this.sampler[b]=new Ba(this).parse(d);break;case"extra":break;default:console.log(d.nodeName)}}},Ca.prototype.parseProfileCOMMON=function(a){for(var b,c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"profile_COMMON":this.parseProfileCOMMON(d);break;case"technique":b=d;break;case"newparam":this.parseNewparam(d);break;case"image":var e=(new da).parse(d);g[e.id]=e;break;case"extra":break;default:console.log(d.nodeName)}}return b},Ca.prototype.parseTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new za(c.nodeName,this).parse(c);break;case"extra":this.parseExtra(c)}}},Ca.prototype.parseExtra=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique":this.parseExtraTechnique(c)}}},Ca.prototype.parseExtraTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"bump":this.shader.parse(a)}}},Da.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},Ea.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.source={};for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"animation":var d=(new Ea).parse(c);for(var e in d.source)this.source[e]=d.source[e];for(var f=0;f<d.channel.length;f++)this.channel.push(d.channel[f]),this.sampler.push(d.sampler[f]);break;case"source":var e=(new wa).parse(c);this.source[e.id]=e;break;case"sampler":this.sampler.push(new Ga(this).parse(c));break;case"channel":this.channel.push(new Fa(this).parse(c))}}return this},Fa.prototype.parse=function(a){this.source=a.getAttribute("source").replace(/^#/,""),this.target=a.getAttribute("target");var b=this.target.split("/"),d=(b.shift(),b.shift()),e=d.indexOf(".")>=0,f=d.indexOf("(")>=0;if(e)b=d.split("."),this.sid=b.shift(),this.member=b.shift();else if(f){var g=d.split("(");this.sid=g.shift();for(var h=0;h<g.length;h++)g[h]=parseInt(g[h].replace(/\)/,""));this.arrIndices=g}else this.sid=d;return this.fullSid=d,this.dotSyntax=e,this.arrSyntax=f,this},Ga.prototype.parse=function(a){this.id=a.getAttribute("id"),this.inputs=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"input":this.inputs.push((new va).parse(c))}}return this},Ga.prototype.create=function(){for(var a=0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.animation.source[b.source];switch(b.semantic){case"INPUT":this.input=c.read();break;case"OUTPUT":this.output=c.read(),this.strideOut=c.accessor.stride;break;case"INTERPOLATION":this.interpolation=c.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(b.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var a=0;a<this.input.length;a++)this.startTime=Math.min(this.startTime,this.input[a]),this.endTime=Math.max(this.endTime,this.input[a]);this.duration=this.endTime-this.startTime}},Ga.prototype.getData=function(a,b,c){var d;if("matrix"===a&&16===this.strideOut)d=this.output[b];else if(this.strideOut>1){d=[],b*=this.strideOut;for(var e=0;e<this.strideOut;++e)d[e]=this.output[b+e];if(3===this.strideOut)switch(a){case"rotate":case"translate":cb(d,-1);break;case"scale":cb(d,1)}else 4===this.strideOut&&"matrix"===a&&cb(d,-1)}else d=this.output[b],c&&"translate"===a&&(d=db(c,d));return d},Ha.prototype.addTarget=function(a,b,c,d){this.targets.push({sid:a,member:c,transform:b,data:d})},Ha.prototype.apply=function(a){for(var b=0;b<this.targets.length;++b){var c=this.targets[b];a&&c.sid!==a||c.transform.update(c.data,c.member)}},Ha.prototype.getTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return this.targets[b];return null},Ha.prototype.hasTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return!0;return!1},Ha.prototype.interpolate=function(a,b){for(var c=0,d=this.targets.length;c<d;c++){var g,e=this.targets[c],f=a.getTarget(e.sid);if("matrix"!==e.transform.type&&f){var h=(b-this.time)/(a.time-this.time),i=f.data,j=e.data;if(h<0&&(h=0),h>1&&(h=1),j.length){g=[];for(var k=0;k<j.length;++k)g[k]=j[k]+(i[k]-j[k])*h}else g=j+(i-j)*h}else g=e.data;e.transform.update(g,e.member)}},Ia.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"optics":this.parseOptics(c)}}return this},Ia.prototype.parseOptics=function(a){for(var b=0;b<a.childNodes.length;b++)if("technique_common"===a.childNodes[b].nodeName)for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++)if(this.technique=c.childNodes[d].nodeName,"perspective"===this.technique)for(var e=c.childNodes[d],f=0;f<e.childNodes.length;f++){var g=e.childNodes[f];switch(g.nodeName){case"yfov":this.yfov=g.textContent;break;case"xfov":this.xfov=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}else if("orthographic"===this.technique)for(var h=c.childNodes[d],f=0;f<h.childNodes.length;f++){var g=h.childNodes[f];switch(g.nodeName){case"xmag":this.xmag=g.textContent;break;case"ymag":this.ymag=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}return this},Ja.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},Ka.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c);break;case"technique":this.parseTechnique(c)}}return this},Ka.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++)switch(a.childNodes[b].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=a.childNodes[b].nodeName;for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];switch(e.nodeName){case"color":var f=Ta(e.textContent);this.color=new THREE.Color(0),this.color.setRGB(f[0],f[1],f[2]),this.color.a=f[3];break;case"falloff_angle":this.falloff_angle=parseFloat(e.textContent);break;case"quadratic_attenuation":var g=parseFloat(e.textContent);this.distance=g?Math.sqrt(1/g):0}}}return this},Ka.prototype.parseTechnique=function(a){this.profile=a.getAttribute("profile");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"intensity":this.intensity=parseFloat(c.textContent)}}return this},La.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},Ma.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.joints=[],this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c)}}return this},Ma.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(a.childNodes[b].nodeName){case"joint":this.joints.push((new Na).parse(c));break;case"link":this.links.push((new Oa).parse(c))}}return this},Na.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var b=a.querySelector("axis"),c=Ta(b.textContent);this.axis=eb(c,0);var d=a.querySelector("limits min")?parseFloat(a.querySelector("limits min").textContent):-360,e=a.querySelector("limits max")?parseFloat(a.querySelector("limits max").textContent):360;this.limits={min:d,max:e};for(var f=["prismatic","revolute"],g=0;g<f.length;g++){var h=f[g],i=a.querySelector(h);i&&(this.type=h)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},Oa.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.transforms=[],this.attachments=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"attachment_full":this.attachments.push((new Pa).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new ja).parse(c))}}return this},Pa.prototype.parse=function(a){this.joint=a.getAttribute("joint").split("/").pop(),this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"link":this.links.push((new Oa).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new ja).parse(c))}}return this},{load:B,parse:C,setPreferredShading:D,applySkin:R,geometries:j,options:x}};var global=window;!function(a,b){"object"==typeof exports?b(module.exports):"function"==typeof define&&define.amd?define([],function(){return b(a)}):b(a)}(this,function(a){"use strict";var b=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","animations","scenes"],c=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(a){this._rootDescription=a},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(a){var b=new RegExp("^"+window.location.protocol,"i");return!!a.match(b)}},resolvePathIfNeeded:{value:function(a){if(this._isAbsolutePath(a))return a;var b=/^data:/;return b.test(a)?a:this.baseURL+a}},_resolvePathsForCategories:{value:function(a){a.forEach(function(a){var b=this.json[a];if(b){var c=Object.keys(b);c.forEach(function(a){var c=b[a];c.uri=this.resolvePathIfNeeded(c.uri)},this)}},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(a){this._json!==a&&(this._json=a,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(a,b){var c=null,d=b;return c=this.rootDescription[d],c?c?c[a]:null:(console.log("ERROR:CANNOT find expected category named:"+d),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),this._state.categoryIndex!==-1&&(this._state.categoryState.index=0,!0)}},_stepToNextDescription:{enumerable:!1,value:function(){var a=this._state.categoryState,b=a.keys;return b?(a.index++,a.keys=null,a.index>=b.length&&this._stepToNextCategory()):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(a){return!!this.rootDescription[a]}},_handleState:{value:function(){for(var a={buffers:this.handleBuffer,bufferViews:this.handleBufferView,shaders:this.handleShader,programs:this.handleProgram,techniques:this.handleTechnique,materials:this.handleMaterial,meshes:this.handleMesh,cameras:this.handleCamera,lights:this.handleLight,nodes:this.handleNode,scenes:this.handleScene,images:this.handleImage,animations:this.handleAnimation,accessors:this.handleAccessor,skins:this.handleSkin,samplers:this.handleSampler,textures:this.handleTexture,videos:this.handleVideo,extensions:this.handleExtension},c=!0;this._state.categoryIndex!==-1;){var d=b[this._state.categoryIndex],e=this._state.categoryState,f=e.keys;if(f||(e.keys=f=Object.keys(this.rootDescription[d]),!f||0!=f.length)){var g=d,h=f[e.index],i=this.getEntryDescription(h,g);if(i){if(a[g]&&a[g].call(this,h,i,this._state.userInfo)===!1){c=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+h),c=!1;break}}else this._stepToNextDescription()}this.handleLoadCompleted&&this.handleLoadCompleted(c)}},_loadJSONIfNeeded:{enumerable:!0,value:function(a){var b=this;if(this._json)a&&a(this.json);else{var c=this._path,d=c.lastIndexOf("/");this.baseURL=0!==d?c.substring(0,d+1):"";var e=new XMLHttpRequest;e.open("GET",c,!0),e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(b.json=JSON.parse(e.responseText),a&&a(b.json))},e.send(null)}}},_buildLoader:{value:function(a){function c(c){b.rootDescription=c,a&&a(this)}var b=this;this._loadJSONIfNeeded(c)}},_state:{value:null,writable:!0},_getEntryType:{value:function(a){for(var c=b,d=0;d<c.length;d++){var e=this.rootDescription[c[d]];if(e)return c[d]}return null}},getNextCategoryIndex:{value:function(a){for(var c=a;c<b.length;c++)if(this.hasCategory(b[c]))return c;return-1}},load:{enumerable:!0,value:function(a,b){var c=this;this._buildLoader(function(e){var f=c.getNextCategoryIndex.call(c,0);f!==-1&&(c._state={userInfo:a,options:b,categoryIndex:f,categoryState:{index:"0"}},c._handleState())})}},initWithPath:{value:function(a){return this._path=a,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return"undefined"==typeof this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(a,b){return this.json=a,this.baseURL=b,b||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}});return a&&(a.glTFParser=c),c}),THREE.glTFLoader=function(){this.meshesRequested=0,this.meshesLoaded=0,this.pendingMeshes=[],this.animationsRequested=0,this.animationsLoaded=0,this.animations=[],this.shadersRequested=0,this.shadersLoaded=0,this.shaders={},this.loadRequests=[],THREE.glTFShaders.removeAll(),THREE.Loader.call(this)},THREE.glTFLoader.prototype=new THREE.Loader,THREE.glTFLoader.prototype.constructor=THREE.glTFLoader,THREE.glTFLoader.prototype.load=function(url,callback){function RgbArraytoHex(a){if(!a)return 4294967295;var b=Math.floor(255*a[0]),c=Math.floor(255*a[1]),d=Math.floor(255*a[2]),e=255,f=(e<<24)+(b<<16)+(c<<8)+d;return f}function componentsPerElementForGLType(a){switch(a){case"SCALAR":nElements=1;break;case"VEC2":nElements=2;break;case"VEC3":nElements=3;break;case"VEC4":nElements=4;break;case"MAT2":nElements=4;break;case"MAT3":nElements=9;break;case"MAT4":nElements=16}return nElements}function replaceShaderDefinitions(shader,material){var program=material.params.program,shaderParams=material.params.technique.parameters,shaderAttributes=material.params.technique.attributes,params={};for(var attribute in material.params.attributes){var pname=shaderAttributes[attribute],shaderParam=shaderParams[pname],semantic=shaderParam.semantic;semantic&&(params[attribute]=shaderParam)}var s=shader,r="";for(var pname in params){var param=params[pname],semantic=param.semantic;switch(r=eval("/"+pname+"/g"),semantic){case"POSITION":s=s.replace(r,"position");break;case"NORMAL":s=s.replace(r,"normal");break;case"TEXCOORD_0":s=s.replace(r,"uv");break;case"WEIGHT":s=s.replace(r,"skinWeight");break;case"JOINT":s=s.replace(r,"skinIndex")}}return s}function replaceShaderSemantics(a){var b=theLoader.shaders[a.params.vertexShader];b&&(b=replaceShaderDefinitions(b,a),theLoader.shaders[a.params.vertexShader]=b)}function createShaderMaterial(a){replaceShaderSemantics(a);
var b=theLoader.shaders[a.params.fragmentShader];if(!b)return console.log("ERROR: Missing fragment shader definition:",a.params.fragmentShader),new THREE.MeshPhongMaterial;var c=theLoader.shaders[a.params.vertexShader];if(!c)return console.log("ERROR: Missing vertex shader definition:",a.params.vertexShader),new THREE.MeshPhongMaterial;var d=THREE.UniformsUtils.clone(a.params.uniforms);for(uniform in a.params.uniforms){var e=a.params.uniforms[uniform],f=d[uniform];"t"==f.type&&(f.value=e.value)}var g=new THREE.RawShaderMaterial({fragmentShader:b,vertexShader:c,uniforms:d,transparent:a.params.transparent});return g}function LoadTexture(a){function e(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function f(a,b){for(var c=e(a,b),d=new ArrayBuffer(c.length),f=new Uint8Array(d),g=0;g<c.length;g++)f[g]=c.charCodeAt(g);return d}function g(a,b){b="undefined"!=typeof b?b:"";var c=a[1],d=!!a[2],g=a[3];switch(b){case"":case"text":return e(d,g);case"ArrayBuffer":return f(d,g);case"blob":var h=f(d,g);return new Blob([h],{type:c});case"document":var i=new DOMParser;return i.parseFromString(e(d,g),c);case"json":return JSON.parse(e(d,g));default:throw"Unhandled responseType: "+b}}if(!a)return null;var c=function(a,b,c){var d=new Image;d.onload=function(){b(d)},"undefined"!=typeof c&&(d.onerror=c),d.src=a},h=/^data:(.*?)(;base64)?,(.*)$/,i=h.exec(a);if(null!==i){var j=new THREE.Texture,k=g(i,"blob"),l=window.URL.createObjectURL(k);return c(l,function(a){j.image=a,j.needsUpdate=!0}),j}return(new THREE.TextureLoader).load(a)}function CreateTexture(a,b){var c=null,d=null;if(b){var e=b;if(e){var f=a.getEntry(e);if(f){var g=a.getEntry(f.description.source);g&&(c=g.description.uri);var h=a.getEntry(f.description.sampler);h&&(d=h.description)}}}var e=LoadTexture(c);return e&&d&&(d.wrapS==WebGLRenderingContext.REPEAT&&(e.wrapS=THREE.RepeatWrapping),d.wrapT==WebGLRenderingContext.REPEAT&&(e.wrapT=THREE.RepeatWrapping),d.magFilter==WebGLRenderingContext.LINEAR&&(e.magFilter=THREE.LinearFilter)),e}var theLoader=this,ClassicGeometry=function(){this.geometry=new THREE.BufferGeometry,this.totalAttributes=0,this.loadedAttributes=0,this.indicesLoaded=!1,this.finished=!1,this.onload=null,this.uvs=null,this.indexArray=null};ClassicGeometry.prototype.constructor=ClassicGeometry,ClassicGeometry.prototype.buildBufferGeometry=function(){var a=this.geometry;a.setIndex(new THREE.BufferAttribute(this.indexArray,1));var b={start:0,index:0,count:this.indexArray.length};a.groups.push(b),a.computeBoundingSphere()},ClassicGeometry.prototype.checkFinished=function(){this.indexArray&&this.loadedAttributes===this.totalAttributes&&(this.buildBufferGeometry(),this.finished=!0,this.onload&&this.onload())};var IndicesDelegate=function(){};IndicesDelegate.prototype.handleError=function(a,b){console.log("ERROR(IndicesDelegate):"+a+":"+b)},IndicesDelegate.prototype.convert=function(a,b){return new Uint16Array(a,0,b.indices.count)},IndicesDelegate.prototype.resourceAvailable=function(a,b){var c=b.geometry;return c.indexArray=a,c.checkFinished(),!0};var indicesDelegate=new IndicesDelegate,IndicesContext=function(a,b){this.indices=a,this.geometry=b},VertexAttributeDelegate=function(){};VertexAttributeDelegate.prototype.handleError=function(a,b){console.log("ERROR(VertexAttributeDelegate):"+a+":"+b)},VertexAttributeDelegate.prototype.convert=function(a,b){return a},VertexAttributeDelegate.prototype.bufferResourceAvailable=function(a,b){var f,g,i,c=b.geometry,d=b.attribute,e=b.semantic;if("POSITION"==e)f=new Float32Array(a,0,d.count*componentsPerElementForGLType(d.type)),c.geometry.addAttribute("position",new THREE.BufferAttribute(f,3));else if("NORMAL"==e)i=componentsPerElementForGLType(d.type),f=new Float32Array(a,0,d.count*i),c.geometry.addAttribute("normal",new THREE.BufferAttribute(f,3));else if("TEXCOORD_0"==e||"TEXCOORD"==e){for(i=componentsPerElementForGLType(d.type),f=new Float32Array(a,0,d.count*i),g=0;g<f.length/2;g++)f[2*g+1]=1-f[2*g+1];c.geometry.addAttribute("uv",new THREE.BufferAttribute(f,i))}else"WEIGHT"==e?(i=componentsPerElementForGLType(d.type),f=new Float32Array(a,0,d.count*i),c.geometry.addAttribute("skinWeight",new THREE.BufferAttribute(f,i))):"JOINT"==e&&(i=componentsPerElementForGLType(d.type),f=new Float32Array(a,0,d.count*i),c.geometry.addAttribute("skinIndex",new THREE.BufferAttribute(f,i)))},VertexAttributeDelegate.prototype.resourceAvailable=function(a,b){this.bufferResourceAvailable(a,b);var c=b.geometry;return c.loadedAttributes++,c.checkFinished(),!0};var vertexAttributeDelegate=new VertexAttributeDelegate,VertexAttributeContext=function(a,b,c){this.attribute=a,this.semantic=b,this.geometry=c},Mesh=function(){this.primitives=[],this.materialsPending=[],this.loadedGeometry=0,this.onCompleteCallbacks=[]};Mesh.prototype.addPrimitive=function(a,b){var c=this;a.onload=function(){c.loadedGeometry++,c.checkComplete()},this.primitives.push({geometry:a,material:b,mesh:null})},Mesh.prototype.onComplete=function(a){this.onCompleteCallbacks.push(a)},Mesh.prototype.checkComplete=function(){var a=this;this.onCompleteCallbacks.length&&this.primitives.length==this.loadedGeometry&&(this.onCompleteCallbacks.forEach(function(b){b(a)}),this.onCompleteCallbacks=[])},Mesh.prototype.attachToNode=function(a){var b=this;this.primitives.forEach(function(c){var d=c.material,e=d.params;if(d instanceof THREE.Material||(d=createShaderMaterial(d)),!b.skin){var f=new THREE.Mesh(c.geometry.geometry,d);if(f.castShadow=!0,a.add(f),d instanceof THREE.ShaderMaterial){var g=new THREE.glTFShader(d,e,f,theLoader.rootObj);THREE.glTFShaders.add(g)}}})};var Material=function(a){this.params=a},AnimationParameterDelegate=function(){};AnimationParameterDelegate.prototype.handleError=function(a,b){console.log("ERROR(AnimationParameterDelegate):"+a+":"+b)},AnimationParameterDelegate.prototype.convert=function(a,b){var c=b.parameter,d=null;switch(c.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":d=new Float32Array(a,0,c.count*componentsPerElementForGLType(c.type))}return d},AnimationParameterDelegate.prototype.resourceAvailable=function(a,b){var c=b.animation,d=b.parameter;return d.data=a,c.handleParameterLoaded(d),!0};var animationParameterDelegate=new AnimationParameterDelegate,AnimationParameterContext=function(a,b){this.parameter=a,this.animation=b},Animation=function(){this.totalParameters=0,this.loadedParameters=0,this.parameters={},this.finishedLoading=!1,this.onload=null};Animation.prototype.constructor=Animation,Animation.prototype.handleParameterLoaded=function(a){this.parameters[a.name]=a,this.loadedParameters++,this.checkFinished()},Animation.prototype.checkFinished=function(){this.loadedParameters===this.totalParameters&&(this.finishedLoading=!0,this.onload&&this.onload())};var InverseBindMatricesDelegate=function(){};InverseBindMatricesDelegate.prototype.handleError=function(a,b){console.log("ERROR(InverseBindMatricesDelegate):"+a+":"+b)},InverseBindMatricesDelegate.prototype.convert=function(a,b){var c=b.parameter,d=null;switch(c.type){case"MAT4":d=new Float32Array(a,0,c.count*componentsPerElementForGLType(c.type))}return d},InverseBindMatricesDelegate.prototype.resourceAvailable=function(a,b){var c=b.skin;return c.inverseBindMatrices=a,!0};var inverseBindMatricesDelegate=new InverseBindMatricesDelegate,InverseBindMatricesContext=function(a,b){this.parameter=a,this.skin=b},ShaderDelegate=function(){};ShaderDelegate.prototype.handleError=function(a,b){console.log("ERROR(ShaderDelegate):"+a+":"+b)},ShaderDelegate.prototype.convert=function(a,b){return a},ShaderDelegate.prototype.resourceAvailable=function(a,b){return theLoader.shadersLoaded++,theLoader.shaders[b.id]=a,!0};var shaderDelegate=new ShaderDelegate,ShaderContext=function(a,b){this.id=a,this.uri=b},ResourceEntry=function(a,b,c){this.entryID=a,this.object=b,this.description=c},Resources=function(){this._entries={}};Resources.prototype.setEntry=function(a,b,c){return a?(this._entries[a]&&console.warn("entry["+a+"] is being overwritten"),void(this._entries[a]=new ResourceEntry(a,b,c))):void console.error("No EntryID provided, cannot store",c)},Resources.prototype.getEntry=function(a){return this._entries[a]},Resources.prototype.clearEntries=function(){this._entries={}},LoadDelegate=function(){},LoadDelegate.prototype.loadCompleted=function(a,b){a.call(Window,b)};var ThreeGLTFLoader=Object.create(glTFParser,{load:{enumerable:!0,value:function(a,b){this.resources=new Resources,this.cameras=[],this.lights=[],this.animations=[],this.joints={},THREE.GLTFLoaderUtils.init(),glTFParser.load.call(this,a,b)}},cameras:{enumerable:!0,writable:!0,value:[]},lights:{enumerable:!0,writable:!0,value:[]},animations:{enumerable:!0,writable:!0,value:[]},handleBuffer:{value:function(a,b,c){return this.resources.setEntry(a,null,b),b.type="ArrayBuffer",!0}},handleBufferView:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d=this.resources.getEntry(b.buffer);b.type="ArrayBufferView";var e=this.resources.getEntry(a);return e.buffer=d,!0}},handleShader:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d={id:a,uri:b.uri},e=new ShaderContext(a,b.uri);return theLoader.shadersRequested++,THREE.GLTFLoaderUtils.getFile(d,shaderDelegate,e),!0}},handleProgram:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},handleTechnique:{value:function(a,b,c){return b.refCount=0,this.resources.setEntry(a,null,b),!0}},createShaderParams:{value:function(a,b,c,d,e){var f=this.resources.getEntry(d);if(c.uniforms={},c.attributes={},c.program=f,c.technique=e,f){c.fragmentShader=f.description.fragmentShader,c.vertexShader=f.description.vertexShader;for(var g in e.uniforms){var n,o,h=e.uniforms[g],i=e.parameters[h],j=i.type,k=i.count,l=b[h],m="";switch(j){case WebGLRenderingContext.FLOAT:if(m="f",n=i.value,"transparency"==h){var p=!0,q=p?l:1-l;n=q,c.transparent=!0}break;case WebGLRenderingContext.FLOAT_VEC2:if(m="v2",n=new THREE.Vector2,i&&i.value){var r=i.value;n.fromArray(r)}l&&n.fromArray(l);break;case WebGLRenderingContext.FLOAT_VEC3:if(m="v3",n=new THREE.Vector3,i&&i.value){var s=i.value;n.fromArray(s)}l&&n.fromArray(l);break;case WebGLRenderingContext.FLOAT_VEC4:if(m="v4",n=new THREE.Vector4,i&&i.value){var t=i.value;n.fromArray(t)}l&&n.fromArray(l);break;case WebGLRenderingContext.FLOAT_MAT2:console.log("Warning: FLOAT_MAT2");break;case WebGLRenderingContext.FLOAT_MAT3:if(m="m3",n=new THREE.Matrix3,i&&i.value){var u=i.value;n.fromArray(u)}l&&n.fromArray(l);break;case WebGLRenderingContext.FLOAT_MAT4:if(void 0!==k){m="m4v",n=new Array(k);for(var v=0;v<k;v++)n[v]=new THREE.Matrix4;if(o=k,i&&i.value){var w=i.value;n.fromArray(w)}l&&n.fromArray(l)}else{if(m="m4",n=new THREE.Matrix4,i&&i.value){var x=i.value;n.fromArray(x)}l&&n.fromArray(l)}break;case WebGLRenderingContext.SAMPLER_2D:m="t",n=l?CreateTexture(this.resources,l):null;break;default:throw new Error("Unknown shader uniform param type: "+j+" - "+theLoader.idx[j])}var y={type:m,value:n,length:o};c.uniforms[g]=y}for(var z in e.attributes){var h=e.attributes[z],A=e.parameters[h],B=A.type,C=A.semantic,D={type:B,semantic:C};c.attributes[z]=D}}}},threeJSMaterialType:{value:function(a,b,c){var g,d=b.extensions,e=d?d.KHR_materials_common:null,f=null;if(e){switch(e.technique){case"BLINN":case"PHONG":f=THREE.MeshPhongMaterial;break;case"LAMBERT":f=THREE.MeshLambertMaterial;break;case"CONSTANT":default:f=THREE.MeshBasicMaterial}e.doubleSided&&(c.side=THREE.DoubleSide),e.transparent&&(c.transparent=!0),g={};for(prop in e.values)g[prop]=e.values[prop]}else{var h=b.technique?this.resources.getEntry(b.technique):null;g=b.values;var i=h.description;++i.refCount>1;var j=i.program;this.createShaderParams(a,g,c,j,i);var k=!0;k&&(f=Material)}g.diffuse&&"string"==typeof g.diffuse&&(c.map=CreateTexture(this.resources,g.diffuse)),g.reflective&&"string"==typeof g.reflective&&(c.envMap=CreateTexture(this.resources,g.reflective));var l=g.shininesss||g.shininess;l&&(l=l);var m=null;c.map||(m=g.diffuse);var n=1;if(g.hasOwnProperty("transparency")){var o=!0;n=o?g.transparency:1-g.transparency}return c.color=RgbArraytoHex(m),c.opacity=n,c.transparent=n<1,c.map&&c.map.sourceFile.toLowerCase().indexOf(".png")!=-1&&(c.transparent=!0),void 0!==l&&(c.shininess=Math.max(l,1e-4)),delete c.ambient,void 0!==g.ambient&&"string"!=typeof g.ambient,void 0!==g.emission&&(c.emissive=RgbArraytoHex(g.emission)),void 0!==g.specular&&(c.specular=RgbArraytoHex(g.specular)),f}},handleMaterial:{value:function(a,b,c){var d={},e=this.threeJSMaterialType(a,b,d),f=new e(d);return this.resources.setEntry(a,f,b),!0}},handleMesh:{value:function(a,b,c){var d=new Mesh;this.resources.setEntry(a,d,b);var e=b.primitives;if(!e)return console.log("MISSING_PRIMITIVES for mesh:"+a),!1;for(var f=0;f<e.length;f++){var g=e[f];if(g.mode===WebGLRenderingContext.TRIANGLES){var h=new ClassicGeometry,i=this.resources.getEntry(g.material);d.addPrimitive(h,i.object);var j=Object.keys(g.attributes);j.forEach(function(a){h.totalAttributes++},this);var k=this.resources.getEntry(g.indices),l=this.resources.getEntry(k.description.bufferView),m={bufferView:l,byteOffset:k.description.byteOffset,count:k.description.count,id:k.entryID,componentType:k.description.componentType,type:k.description.type},n=new IndicesContext(m,h),o={indicesObject:m,indicesDelegate:indicesDelegate,indicesContext:n};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.indicesObject,a.indicesDelegate,a.indicesContext);b&&a.indicesDelegate.resourceAvailable(b,a.indicesContext)},o),j.forEach(function(a){var c,d=g.attributes[a],e=this.resources.getEntry(d);if(e){c=e.object,c.id=d;var f=this.resources.getEntry(c.bufferView)}else{c=b.attributes[d],c.id=d,this.resources.setEntry(d,c,c);var f=this.resources.getEntry(c.bufferView);e=this.resources.getEntry(d)}var i={bufferView:f,byteOffset:c.byteOffset,byteStride:c.byteStride,count:c.count,max:c.max,min:c.min,componentType:c.componentType,type:c.type,id:d},j=new VertexAttributeContext(i,a,h),k={attributeObject:i,vertexAttributeDelegate:vertexAttributeDelegate,attribContext:j};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.attributeObject,a.vertexAttributeDelegate,a.attribContext);b&&a.vertexAttributeDelegate.resourceAvailable(b,a.attribContext)},k)},this)}}return!0}},handleCamera:{value:function(a,b,c){var d;if("perspective"==b.type){var e=b.perspective.znear,f=b.perspective.zfar,g=b.perspective.yfov,h=b.perspective.xfov,i=b.perspective.aspect_ratio;i||(i=1),void 0===h&&g&&(h=g*i),void 0===g&&h&&(g=h/i),h&&(h=THREE.Math.radToDeg(h),d=new THREE.PerspectiveCamera(h,i,e,f))}else d=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e,f);return d&&this.resources.setEntry(a,d,b),!0}},handleLight:{value:function(a,b,c){var d=null,e=b.type;if(e&&b[e]){var f=b[e],g=RgbArraytoHex(f.color);switch(e){case"directional":d=new THREE.DirectionalLight(g),d.position.set(0,0,1);break;case"point":d=new THREE.PointLight(g);break;case"spot ":d=new THREE.SpotLight(g),d.position.set(0,0,1);break;case"ambient":d=new THREE.AmbientLight(g)}}return d&&this.resources.setEntry(a,d,b),!0}},addPendingMesh:{value:function(a,b){theLoader.pendingMeshes.push({mesh:a,node:b})}},handleNode:{value:function(a,b,c){var d=null;b.jointName?(d=new THREE.Bone,d.jointName=b.jointName,this.joints[b.jointName]=a):d=new THREE.Object3D,d.name=b.name,d.glTFID=a,d.glTF=b,this.resources.setEntry(a,d,b);var e=b.matrix;if(e)d.matrixAutoUpdate=!1,d.applyMatrix((new THREE.Matrix4).set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]));else{var f=b.translation,g=b.rotation,h=b.scale,i=f?new THREE.Vector3(f[0],f[1],f[2]):new THREE.Vector3,j=g?new THREE.Quaternion(g[0],g[1],g[2],g[3]):new THREE.Quaternion,k=h?new THREE.Vector3(h[0],h[1],h[2]):new THREE.Vector3(1,1,1),l=new THREE.Matrix4;l.compose(i,j,k),d.matrixAutoUpdate=!1,d.applyMatrix(l)}var m=this;if(b.meshes){b.meshInstances={};var n;b.skin&&(n=this.resources.getEntry(b.skin)),b.meshes.forEach(function(a){meshEntry=this.resources.getEntry(a),theLoader.meshesRequested++,meshEntry.object.onComplete(function(c){m.addPendingMesh(c,d),b.meshInstances[a]=meshEntry.object,n&&(c.skin=n,b.instanceSkin=n.object),theLoader.meshesLoaded++,theLoader.checkComplete()})},this)}if(b.camera){var o=this.resources.getEntry(b.camera);o&&(d.add(o.object),this.cameras.push(o.object))}if(b.extensions&&b.extensions.KHR_materials_common&&b.extensions.KHR_materials_common.light){var p=b.extensions.KHR_materials_common.light,q=this.resources.getEntry(p);q&&(d.add(q.object),this.lights.push(q.object))}return!0}},handleExtension:{value:function(a,b,c){switch(a){case"KHR_materials_common":var d=b.lights;for(lightID in d){var e=d[lightID];this.handleLight(lightID,e)}}return!0}},buildNodeHirerachy:{value:function(a,b){var c=this.resources.getEntry(a),d=c.object;b.add(d);var e=c.description.children;return e&&e.forEach(function(a){this.buildNodeHirerachy(a,d)},this),d}},buildSkin:{value:function(a){var b=a.glTF,c=b.instanceSkin,d=b.skeletons;c&&d.forEach(function(d){var e=this.resources.getEntry(d);if(e){var f=e.object;a.add(f);var g=!0;for(meshID in b.meshInstances){var h=b.meshInstances[meshID],i=null;h.primitives.forEach(function(b){var e=b.material,f=e.params;e instanceof THREE.Material||(e=createShaderMaterial(e)),i=new THREE.SkinnedMesh(b.geometry.geometry,e,!1);b.geometry.geometry;if(i&&g){e.skinning=!0;var o,k=c.jointNames,l=[],m=[],n=[],p=k.length;for(o=0;o<p;o++){var q=k[o],r=this.joints[q],s=this.resources.getEntry(r).object;if(s){s.skin=i,l.push(s),m.push(s);var t=c.inverseBindMatrices,u=(new THREE.Matrix4).set(t[16*o+0],t[16*o+4],t[16*o+8],t[16*o+12],t[16*o+1],t[16*o+5],t[16*o+9],t[16*o+13],t[16*o+2],t[16*o+6],t[16*o+10],t[16*o+14],t[16*o+3],t[16*o+7],t[16*o+11],t[16*o+15]);n.push(u)}else console.log("WARNING: jointName:"+q+" cannot be found in skeleton:"+d)}i.bind(new THREE.Skeleton(m,n,!1),c.bindShapeMatrix)}if(i&&(i.castShadow=!0,a.add(i),e instanceof THREE.ShaderMaterial)){f.joints=l;var v=new THREE.glTFShader(e,f,i,theLoader.rootObj);THREE.glTFShaders.add(v)}},this)}}},this)}},buildSkins:{value:function(a){a.glTF&&a.glTF.instanceSkin&&this.buildSkin(a);var b=a.children;b&&b.forEach(function(a){this.buildSkins(a)},this)}},createMeshAnimations:{value:function(a){this.buildSkins(a)}},handleScene:{value:function(a,b,c){return b.nodes?(b.nodes.forEach(function(a){this.buildNodeHirerachy(a,c.rootObj)},this),this.delegate&&this.delegate.loadCompleted(c.callback,c.rootObj),theLoader.loadAllAssets(),!0):(console.log("ERROR: invalid file required nodes property is missing from scene"),!1)}},handleImage:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},addNodeAnimationChannel:{value:function(a,b,c){this.nodeAnimationChannels||(this.nodeAnimationChannels={}),this.nodeAnimationChannels[a]||(this.nodeAnimationChannels[a]=[]),this.nodeAnimationChannels[a].push(c)}},createAnimations:{value:function(){for(var a in this.nodeAnimationChannels){var b=this.nodeAnimationChannels[a],e=(b.length,new THREE.glTFAnimation(b));e.name="animation_"+a,this.animations.push(e)}}},buildAnimation:{value:function(a){var c,b=[],d=a.channels.length;for(c=0;c<d;c++){var e=a.channels[c],f=a.samplers[e.sampler];if(f){var g=a.parameters[f.input];if(g&&g.data){var h=a.parameters[f.output];if(h&&h.data){var i=e.target,j=this.resources.getEntry(i.id);if(j){var k=i.path,l={keys:g.data,values:h.data,count:g.count,target:j.object,path:k,type:f.interpolation};this.addNodeAnimationChannel(i.id,e,l),b.push(l)}}}}}}},handleAnimation:{value:function(a,b,c){theLoader.animationsRequested++;var e=new Animation;e.name=a,e.onload=function(){theLoader.animationsLoaded++,theLoader.animations.push(e),theLoader.checkComplete()},e.channels=b.channels,e.samplers=b.samplers,this.resources.setEntry(a,e,b);var f=b.parameters;if(!f)return console.log("MISSING_PARAMETERS for animation:"+a),!1;var g=Object.keys(f);g.forEach(function(a){e.totalParameters++},this);var g=Object.keys(f);return g.forEach(function(a){var b=f[a],c=this.resources.getEntry(b);c=c.object;var d=this.resources.getEntry(c.bufferView),g={bufferView:d,byteOffset:c.byteOffset,count:c.count,componentType:c.componentType,type:c.type,id:c.bufferView,name:a},h=new AnimationParameterContext(g,e),i={paramObject:g,animationParameterDelegate:animationParameterDelegate,paramContext:h};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.paramObject,a.animationParameterDelegate,a.paramContext);b&&a.animationParameterDelegate.resourceAvailable(b,a.paramContext)},i)},this),!0}},handleAccessor:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleSkin:{value:function(a,b,c){var d={},e=b.bindShapeMatrix;d.bindShapeMatrix=(new THREE.Matrix4).set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]),d.jointNames=b.jointNames;var f=this.resources.getEntry(b.inverseBindMatrices);f=f.description,d.inverseBindMatricesDescription=f,d.inverseBindMatricesDescription.id=b.inverseBindMatrices;var g=this.resources.getEntry(f.bufferView),h={bufferView:g,byteOffset:f.byteOffset,count:f.count,componentType:f.componentType,type:f.type,id:f.bufferView,name:d.inverseBindMatricesDescription.id},i=new InverseBindMatricesContext(h,d),j={paramObject:h,inverseBindMatricesDelegate:inverseBindMatricesDelegate,context:i};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.paramObject,a.inverseBindMatricesDelegate,a.context);b&&a.inverseBindMatricesDelegate.resourceAvailable(b,a.context)},j);var k=this.resources.getEntry(d.inverseBindMatricesDescription.bufferView);return d.inverseBindMatricesDescription.bufferView=k.object,this.resources.setEntry(a,d,b),!0}},handleSampler:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleTexture:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},handleError:{value:function(a){throw new Error(a)}},_delegate:{value:new LoadDelegate,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(a){this._delegate=a}}}),Context=function(a,b){this.rootObj=a,this.callback=b},rootObj=new THREE.Object3D,self=this,loader=Object.create(ThreeGLTFLoader);return loader.initWithPath(url),loader.load(new Context(rootObj,function(a){}),null),this.loader=loader,this.callback=callback,this.rootObj=rootObj,rootObj},THREE.glTFLoader.prototype.scheduleLoad=function(a,b){this.loadRequests.push({fn:a,data:b})},THREE.glTFLoader.prototype.loadAllAssets=function(){for(var a=0,b=this.loadRequests.length;a<b;a++){var c=this.loadRequests[a];c.fn(c.data)}},THREE.glTFLoader.prototype.callLoadedCallback=function(){var a={scene:this.rootObj,cameras:this.loader.cameras,animations:this.loader.animations,shaders:this.loader.shaders};this.callback(a)},THREE.glTFLoader.prototype.checkComplete=function(){if(this.meshesLoaded==this.meshesRequested&&this.shadersLoaded==this.shadersRequested&&this.animationsLoaded==this.animationsRequested){for(var a=0;a<this.pendingMeshes.length;a++){var b=this.pendingMeshes[a];b.mesh.attachToNode(b.node)}for(var a=0;a<this.animationsLoaded;a++){var c=this.animations[a];this.loader.buildAnimation(c)}this.loader.createAnimations(),this.loader.createMeshAnimations(this.rootObj),THREE.glTFShaders.bindShaderParameters(this.rootObj),this.callLoadedCallback()}},THREE.GLTFLoaderUtils=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(a){return!!this._resources[a]}},_storeResource:{enumerable:!1,value:function(a,b){return a?(this._containsResource[a]&&console.log("WARNING: resource:"+a+" is already stored, overriding"),void(this._resources[a]=b)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(a){return this._resources[a]}},_loadStream:{value:function(a,b,c){function e(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function f(a,b){for(var c=e(a,b),d=new ArrayBuffer(c.length),f=new Uint8Array(d),g=0;g<c.length;g++)f[g]=c.charCodeAt(g);return d}function g(a,b){b="undefined"!=typeof b?b:"";var c=a[1],d=!!a[2],g=a[3];switch(b){case"":case"text":return e(d,g);case"ArrayBuffer":return f(d,g);case"blob":var h=f(d,g);return new Blob([h],{type:c});case"document":var i=new DOMParser;return i.parseFromString(e(d,g),c);case"json":return JSON.parse(e(d,g));default:throw"Unhandled responseType: "+b}}var d=/^data:(.*?)(;base64)?,(.*)$/,h=d.exec(a);if(null!==h)return void c.streamAvailable(a,g(h,b));if(!b)return void c.handleError(THREE.GLTFLoaderUtils.INVALID_TYPE,null);if(!a)return void c.handleError(THREE.GLTFLoaderUtils.INVALID_PATH);var j=new XMLHttpRequest;j.open("GET",a,!0),j.responseType=b===this.ARRAY_BUFFER?"arraybuffer":"text",j.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),j.onload=function(b){200==j.status||206==j.status?c.streamAvailable(a,j.response):c.handleError(THREE.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},j.send(null)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(a){var b=this._resourcesStatus[a.id];b?this._resourcesStatus[a.id]++:this._resourcesStatus[a.id]=1;var c=this._streamsStatus[a.uri];if(c&&"loading"===c.status)return void c.requests.push(a);this._streamsStatus[a.uri]={status:"loading",requests:[a]};var d=this,e={};e.streamAvailable=function(a,b){var c=d._streamsStatus[a],e=c.requests;e.forEach(function(a){var c=b.slice(a.range[0],a.range[1]),e=a.delegate.convert(c,a.ctx);d._storeResource(a.id,e),a.delegate.resourceAvailable(e,a.ctx),--d._resourcesStatus[a.id]},this),delete d._streamsStatus[a]},e.handleError=function(b,c){a.delegate.handleError(b,c)},this._loadStream(a.uri,a.type,e)}},_elementSizeForGLType:{value:function(a,b){var c=0;switch(b){case"SCALAR":c=1;break;case"VEC2":c=2;break;case"VEC3":c=3;break;case"VEC4":c=4;break;case"MAT2":c=4;break;case"MAT3":c=9;break;case"MAT4":c=16}switch(a){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*c;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(a,b,c){var d=a.bufferView,e=d.buffer,f=a.byteOffset+d.description.byteOffset,g=[f,this._elementSizeForGLType(a.componentType,a.type)*a.count+f];this._handleRequest({id:a.id,range:g,type:e.description.type,uri:e.description.uri,delegate:b,ctx:c},null)}},getBuffer:{value:function(a,b,c){this._getResource(a.id);return this._handleWrappedBufferViewResourceLoading(a,b,c),null}},getFile:{value:function(a,b,c){return a.delegate=b,a.ctx=c,this._handleRequest({id:a.id,uri:a.uri,range:[0],type:"text",delegate:b,ctx:c},null),null}}}),THREE.glTFAnimator=function(){var a=[];return{add:function(b){a.push(b)},remove:function(b){var c=a.indexOf(b);c!==-1&&a.splice(c,1)},update:function(){for(i=0;i<a.length;i++)a[i].update()}}}(),THREE.glTFAnimation=function(a){this.running=!1,this.loop=!1,this.duration=0,this.startTime=0,this.interps=[],a&&this.createInterpolators(a)},THREE.glTFAnimation.prototype.createInterpolators=function(a){var b,c=a.length;for(b=0;b<c;b++){var d=new THREE.glTFInterpolator(a[b]);this.interps.push(d),this.duration=Math.max(this.duration,d.duration)}},THREE.glTFAnimation.prototype.play=function(){this.running||(this.startTime=Date.now(),this.running=!0,THREE.glTFAnimator.add(this))},THREE.glTFAnimation.prototype.stop=function(){this.running=!1,THREE.glTFAnimator.remove(this)},THREE.glTFAnimation.prototype.update=function(){if(this.running){var a=Date.now(),b=(a-this.startTime)/1e3,c=b%this.duration,d=Math.floor(b/this.duration);if(d>=1&&!this.loop){this.running=!1;var e,f=this.interps.length;for(e=0;e<f;e++)this.interps[e].interp(this.duration);return void this.stop()}var e,f=this.interps.length;for(e=0;e<f;e++)this.interps[e].interp(c)}},THREE.glTFInterpolator=function(a){this.keys=a.keys,this.values=a.values,this.count=a.count,this.type=a.type,this.path=a.path,this.isRot=!1;var b=a.target;switch(b.updateMatrix(),b.matrixAutoUpdate=!0,this.targetNode=b,a.path){case"translation":this.target=b.position,this.originalValue=b.position.clone();break;case"rotation":this.target=b.quaternion,this.originalValue=b.quaternion.clone(),this.isRot=!0;break;case"scale":this.target=b.scale,this.originalValue=b.scale.clone()}this.duration=this.keys[this.count-1],this.vec1=new THREE.Vector3,this.vec2=new THREE.Vector3,this.vec3=new THREE.Vector3,this.quat1=new THREE.Quaternion,this.quat2=new THREE.Quaternion,this.quat3=new THREE.Quaternion},THREE.glTFInterpolator.prototype.interp=function(a){var b;if(a==this.keys[0])this.isRot?this.quat3.set(this.values[0],this.values[1],this.values[2],this.values[3]):this.vec3.set(this.values[0],this.values[1],this.values[2]);else if(a<this.keys[0])this.isRot?(this.quat1.set(this.originalValue.x,this.originalValue.y,this.originalValue.z,this.originalValue.w),this.quat2.set(this.values[0],this.values[1],this.values[2],this.values[3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,a/this.keys[0])):(this.vec3.set(this.originalValue.x,this.originalValue.y,this.originalValue.z),this.vec2.set(this.values[0],this.values[1],this.values[2]),this.vec3.lerp(this.vec2,a/this.keys[0]));else if(a>=this.keys[this.count-1])this.isRot?this.quat3.set(this.values[4*(this.count-1)],this.values[4*(this.count-1)+1],this.values[4*(this.count-1)+2],this.values[4*(this.count-1)+3]):this.vec3.set(this.values[3*(this.count-1)],this.values[3*(this.count-1)+1],this.values[3*(this.count-1)+2]);else for(b=0;b<this.count-1;b++){var d=this.keys[b],e=this.keys[b+1];a>=d&&a<=e&&(this.isRot?(this.quat1.set(this.values[4*b],this.values[4*b+1],this.values[4*b+2],this.values[4*b+3]),this.quat2.set(this.values[4*(b+1)],this.values[4*(b+1)+1],this.values[4*(b+1)+2],this.values[4*(b+1)+3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,(a-d)/(e-d))):(this.vec3.set(this.values[3*b],this.values[3*b+1],this.values[3*b+2]),this.vec2.set(this.values[3*(b+1)],this.values[3*(b+1)+1],this.values[3*(b+1)+2]),this.vec3.lerp(this.vec2,(a-d)/(e-d))))}this.target&&this.copyValue(this.target)},THREE.glTFInterpolator.prototype.copyValue=function(a){this.isRot?a.copy(this.quat3):a.copy(this.vec3)},THREE.glTFShaders=function(){var a=[];return{add:function(b){a.push(b)},remove:function(b){var c=a.indexOf(b);c!==-1&&a.splice(c,1)},removeAll:function(b){a=[]},bindShaderParameters:function(b){for(i=0;i<a.length;i++)a[i].bindParameters(b)},update:function(b,c){for(i=0;i<a.length;i++)a[i].update(b,c)}}}(),THREE.glTFShader=function(a,b,c,d){this.material=a,this.parameters=b.technique.parameters,this.uniforms=b.technique.uniforms,this.joints=b.joints,this.object=c,this.semantics={},this.m4=new THREE.Matrix4},THREE.glTFShader.prototype.bindParameters=function(a){function b(a,b){a.glTFID==e.node&&(b.sourceObject=a)}for(var c in this.uniforms){var d=this.uniforms[c],e=this.parameters[d];if(e.semantic){var f={semantic:e.semantic,uniform:this.material.uniforms[c]};e.node?a.traverse(function(a){b(a,f)}):f.sourceObject=this.object,this.semantics[d]=f}}},THREE.glTFShader.prototype.update=function(a,b){a.updateMatrixWorld(),b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld);for(var c in this.semantics){var d=this.semantics[c];if(d)switch(d.semantic){case"MODELVIEW":var e=d.uniform.value;e.multiplyMatrices(b.matrixWorldInverse,d.sourceObject.matrixWorld);break;
case"MODELVIEWINVERSETRANSPOSE":var f=d.uniform.value;this.m4.multiplyMatrices(b.matrixWorldInverse,d.sourceObject.matrixWorld),f.getNormalMatrix(this.m4);break;case"PROJECTION":var e=d.uniform.value;e.copy(b.projectionMatrix);break;case"JOINTMATRIX":for(var g=d.uniform.value,h=0;h<g.length;h++)g[h].getInverse(d.sourceObject.matrixWorld).multiply(this.joints[h].matrixWorld).multiply(this.object.skeleton.boneInverses[h]);break;default:throw new Error("Unhandled shader semantic"+d)}}},THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(a,b){function D(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function E(a){return String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)}function F(a,b,c,d){for(var e=c*d*4,f=new Uint8Array(a,b,e),g=new Uint8Array(e),h=0,i=0,j=0;j<d;j++)for(var k=0;k<c;k++){var l=f[i];i++;var m=f[i];i++;var n=f[i];i++;var o=f[i];i++,g[h]=n,h++,g[h]=m,h++,g[h]=l,h++,g[h]=o,h++}return g}var c={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},d=542327876,j=131072,p=512,q=1024,r=2048,s=4096,t=8192,u=16384,v=32768,z=4,G=D("DXT1"),H=D("DXT3"),I=D("DXT5"),J=D("ETC1"),K=31,L=0,M=1,N=2,O=3,P=4,Q=7,R=20,S=21,T=22,U=23,V=24,W=25,X=26,Z=28,aa=new Int32Array(a,0,K);if(aa[L]!==d)return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),c;if(!aa[R]&z)return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),c;var ba,ca=aa[S],da=!1;switch(ca){case G:ba=8,c.format=THREE.RGB_S3TC_DXT1_Format;break;case H:ba=16,c.format=THREE.RGBA_S3TC_DXT3_Format;break;case I:ba=16,c.format=THREE.RGBA_S3TC_DXT5_Format;break;case J:ba=8,c.format=THREE.RGB_ETC1_Format;break;default:if(!(32===aa[T]&&16711680&aa[U]&&65280&aa[V]&&255&aa[W]&&4278190080&aa[X]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",E(ca)),c;da=!0,ba=64,c.format=THREE.RGBAFormat}c.mipmapCount=1,aa[N]&j&&b!==!1&&(c.mipmapCount=Math.max(1,aa[Q]));var ea=aa[Z];if(c.isCubemap=!!(ea&p),c.isCubemap&&(!(ea&q)||!(ea&r)||!(ea&s)||!(ea&t)||!(ea&u)||!(ea&v)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),c;c.width=aa[P],c.height=aa[O];for(var fa=aa[M]+4,ga=c.isCubemap?6:1,ha=0;ha<ga;ha++)for(var ia=c.width,ja=c.height,ka=0;ka<c.mipmapCount;ka++){if(da)var la=F(a,fa,ia,ja),ma=la.length;else var ma=Math.max(4,ia)/4*Math.max(4,ja)/4*ba,la=new Uint8Array(a,fa,ma);var na={data:la,width:ia,height:ja};c.mipmaps.push(na),fa+=ma,ia=Math.max(ia>>1,1),ja=Math.max(ja>>1,1)}return c},THREE.TGALoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.TGALoader.prototype.load=function(a,b,c,d){var e=this,f=new THREE.Texture,g=new THREE.XHRLoader(this.manager);return g.setResponseType("arraybuffer"),g.load(a,function(a){f.image=e.parse(a),f.needsUpdate=!0,void 0!==b&&b(f)},c,d),f},THREE.TGALoader.prototype.parse=function(a){function r(a){switch(a.image_type){case c:case f:(a.colormap_length>256||24!==a.colormap_size||1!==a.colormap_type)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case d:case e:case g:case h:a.colormap_type&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case b:console.error("THREE.TGALoader.parse.tgaCheckHeader: No data");default:console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid type " '+a.image_type+'"')}(a.width<=0||a.height<=0)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid image size"),8!==a.pixel_size&&16!==a.pixel_size&&24!==a.pixel_size&&32!==a.pixel_size&&console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid pixel size "'+a.pixel_size+'"')}function v(a,b,c,d,e){var f,g,h,i;if(g=c.pixel_size>>3,h=c.width*c.height*g,b&&(i=e.subarray(d,d+=c.colormap_length*(c.colormap_size>>3))),a){f=new Uint8Array(h);for(var j,k,l,m=0,n=new Uint8Array(g);m<h;)if(j=e[d++],k=(127&j)+1,128&j){for(l=0;l<g;++l)n[l]=e[d++];for(l=0;l<k;++l)f.set(n,m+l*g);m+=g*k}else{for(k*=g,l=0;l<k;++l)f[m+l]=e[d++];m+=k}}else f=e.subarray(d,d+=b?c.width*c.height:h);return{pixel_data:f,palettes:i}}function w(a,b,c,d,e,f,g,h,i){var k,m,n,j=i,l=0,o=q.width;for(n=b;n!==d;n+=c)for(m=e;m!==g;m+=f,l++)k=h[l],a[4*(m+o*n)+3]=255,a[4*(m+o*n)+2]=j[3*k+0],a[4*(m+o*n)+1]=j[3*k+1],a[4*(m+o*n)+0]=j[3*k+2];return a}function x(a,b,c,d,e,f,g,h){var i,k,l,j=0,m=q.width;for(l=b;l!==d;l+=c)for(k=e;k!==g;k+=f,j+=2)i=h[j+0]+(h[j+1]<<8),a[4*(k+m*l)+0]=(31744&i)>>7,a[4*(k+m*l)+1]=(992&i)>>2,a[4*(k+m*l)+2]=(31&i)>>3,a[4*(k+m*l)+3]=32768&i?0:255;return a}function y(a,b,c,d,e,f,g,h){var j,k,i=0,l=q.width;for(k=b;k!==d;k+=c)for(j=e;j!==g;j+=f,i+=3)a[4*(j+l*k)+3]=255,a[4*(j+l*k)+2]=h[i+0],a[4*(j+l*k)+1]=h[i+1],a[4*(j+l*k)+0]=h[i+2];return a}function z(a,b,c,d,e,f,g,h){var j,k,i=0,l=q.width;for(k=b;k!==d;k+=c)for(j=e;j!==g;j+=f,i+=4)a[4*(j+l*k)+2]=h[i+0],a[4*(j+l*k)+1]=h[i+1],a[4*(j+l*k)+0]=h[i+2],a[4*(j+l*k)+3]=h[i+3];return a}function A(a,b,c,d,e,f,g,h){var i,k,l,j=0,m=q.width;for(l=b;l!==d;l+=c)for(k=e;k!==g;k+=f,j++)i=h[j],a[4*(k+m*l)+0]=i,a[4*(k+m*l)+1]=i,a[4*(k+m*l)+2]=i,a[4*(k+m*l)+3]=255;return a}function B(a,b,c,d,e,f,g,h){var j,k,i=0,l=q.width;for(k=b;k!==d;k+=c)for(j=e;j!==g;j+=f,i+=2)a[4*(j+l*k)+0]=h[i+0],a[4*(j+l*k)+1]=h[i+0],a[4*(j+l*k)+2]=h[i+0],a[4*(j+l*k)+3]=h[i+1];return a}function C(a,b,c,d,e){var f,g,h,o,p,r;switch((q.flags&i)>>j){default:case m:f=0,h=1,p=b,g=0,o=1,r=c;break;case k:f=0,h=1,p=b,g=c-1,o=-1,r=-1;break;case n:f=b-1,h=-1,p=-1,g=0,o=1,r=c;break;case l:f=b-1,h=-1,p=-1,g=c-1,o=-1,r=-1}if(u)switch(q.pixel_size){case 8:A(a,g,o,r,f,h,p,d);break;case 16:B(a,g,o,r,f,h,p,d);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}else switch(q.pixel_size){case 8:w(a,g,o,r,f,h,p,d,e);break;case 16:x(a,g,o,r,f,h,p,d);break;case 24:y(a,g,o,r,f,h,p,d);break;case 32:z(a,g,o,r,f,h,p,d);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}return a}var b=0,c=1,d=2,e=3,f=9,g=10,h=11,i=48,j=4,k=0,l=1,m=2,n=3;a.length<19&&console.error("THREE.TGALoader.parse: Not enough data to contain header.");var o=new Uint8Array(a),p=0,q={id_length:o[p++],colormap_type:o[p++],image_type:o[p++],colormap_index:o[p++]|o[p++]<<8,colormap_length:o[p++]|o[p++]<<8,colormap_size:o[p++],origin:[o[p++]|o[p++]<<8,o[p++]|o[p++]<<8],width:o[p++]|o[p++]<<8,height:o[p++]|o[p++]<<8,pixel_size:o[p++],flags:o[p++]};r(q),q.id_length+p>a.length&&console.error("THREE.TGALoader.parse: No data"),p+=q.id_length;var s=!1,t=!1,u=!1;switch(q.image_type){case f:s=!0,t=!0;break;case c:t=!0;break;case g:s=!0;break;case d:break;case h:s=!0,u=!0;break;case e:u=!0}var D=document.createElement("canvas");D.width=q.width,D.height=q.height;var E=D.getContext("2d"),F=E.createImageData(q.width,q.height),G=v(s,t,q,p,o);C(F.data,q.width,q.height,G.pixel_data,G.palettes);return E.putImageData(F,0,0),D};