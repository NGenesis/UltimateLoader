var UltimateLoader=UltimateLoader||{};!function(a){"use strict";function h(a,b){c.push([a,b])}function i(){if(d>c.length-1)return c=[],void(d=0);var a=c[d];d++,k(a)}function j(){0==d&&i()}function k(a){var b=a[0],c=a[1],d=l(b);switch(d.url=b,d.callback=c,null!=a[2]&&(d.i=a[2]),d.ext){case"obj":m(d);break;case"json":n(d);break;case"dae":o(d);break;case"gltf":p(d);break;case"fbx":r(d);break;case"png":q(d);break;case"jpg":q(d);break;case"jpeg":q(d);break;default:console.log("UltimateLoader: File extension -"+d.ext+"- not recognized! Object -"+d.name+"- did not load."),i()}}function l(a){var b=a.slice(0,a.lastIndexOf("/")+1);""===b&&null===b||(g=b);var c=a.substr(a.lastIndexOf("/")+1),d=c.split("."),e={name:d[0],ext:d[d.length-1].toLowerCase(),baseUrl:b};return e}function m(a){var b=a.name+".obj",c=a.name+".mtl",d=new THREE.MTLLoader;d.setPath(a.baseUrl),d.setBaseUrl(a.baseUrl),d.setCrossOrigin=f,d.load(c,function(c){c.preload();var d=new THREE.OBJLoader;d.setMaterials(c),d.setPath(a.baseUrl),d.setCrossOrigin=f,d.load(b,function(b){b.traverse(function(a){a instanceof THREE.Mesh&&(a.material.side=THREE.DoubleSide)}),a.object=b,u(a)},s,t)})}function n(a){var b=new THREE.ObjectLoader;b.load(a.url,function(b){a.object=b,u(a)},s,t)}function o(a){var b=new THREE.ColladaLoader;b.load(a.url,function(b){var c=b.scene;a.object=c,u(a)},s,t)}function p(a){var b=new THREE.glTFLoader;b.load(a.url,function(b){var c=b.scene;a.object=c,u(a)},s,t)}function q(b){var c=new THREE.TextureLoader;c.load(b.url,function(c){var d=c.image.naturalHeight/c.image.naturalWidth*a.imageSize,e=new THREE.PlaneGeometry(a.imageSize,d,a.imageSize),f=new THREE.MeshBasicMaterial({map:c,side:THREE.DoubleSide}),g=new THREE.Mesh(e,f);b.object=g,u(b)},s,t)}function r(a){var b=new THREE.FBXLoader;b.load(a.url,function(b){console.log(b),a.object=b,u(a)},s,t)}function s(a){}function t(a){}function u(c){b[c.name]=c.object,null!=c.i?c.callback(c):c.callback(c.object),a.queue&&i(),console.log("UltimateLoader: Object "+c.name+" loaded!")}var b={},c=[],d=0,f="anonymous",g="";a.queue=!1,a.imageSize=32,a.load=function(b,c){if(a.queue)h(b,c),j();else{var d=[b,c];k(d)}},a.multiload=function(b,c){for(var d=[],e=0,f=function(a){d[a.i]=a.object,e++,e==b.length&&c(d)},g=0;g<b.length;g++)if(a.queue)h(b[g],f,g),j();else{var i=[b[g],f,g];k(i)}j()}}(UltimateLoader),THREE.MTLLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.MTLLoader.prototype={constructor:THREE.MTLLoader,load:function(a,b,c,d){var e=this,f=new THREE.XHRLoader(this.manager);f.setPath(this.path),f.load(a,function(a){b(e.parse(a))},c,d)},setPath:function(a){this.path=a},setBaseUrl:function(a){this.baseUrl=a},setCrossOrigin:function(a){this.crossOrigin=a},setMaterialOptions:function(a){this.materialOptions=a},parse:function(a){for(var b=a.split("\n"),c={},d=/\s+/,e={},f=0;f<b.length;f++){var g=b[f];if(g=g.trim(),0!==g.length&&"#"!==g.charAt(0)){var h=g.indexOf(" "),i=h>=0?g.substring(0,h):g;i=i.toLowerCase();var j=h>=0?g.substring(h+1):"";if(j=j.trim(),"newmtl"===i)c={name:j},e[j]=c;else if(c)if("ka"===i||"kd"===i||"ks"===i){var k=j.split(d,3);c[i]=[parseFloat(k[0]),parseFloat(k[1]),parseFloat(k[2])]}else c[i]=j}}var l=new THREE.MTLLoader.MaterialCreator(this.baseUrl,this.materialOptions);return l.setCrossOrigin(this.crossOrigin),l.setManager(this.manager),l.setMaterials(e),l}},THREE.MTLLoader.MaterialCreator=function(a,b){this.baseUrl=a,this.options=b,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping},THREE.MTLLoader.MaterialCreator.prototype={constructor:THREE.MTLLoader.MaterialCreator,setCrossOrigin:function(a){this.crossOrigin=a},setManager:function(a){this.manager=a},setMaterials:function(a){this.materialsInfo=this.convert(a),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(a){if(!this.options)return a;var b={};for(var c in a){var d=a[c],e={};b[c]=e;for(var f in d){var g=!0,h=d[f],i=f.toLowerCase();switch(i){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(h=[h[0]/255,h[1]/255,h[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===h[0]&&0===h[1]&&0===h[1]&&(g=!1)}g&&(e[i]=h)}}return b},preload:function(){for(var a in this.materialsInfo)this.create(a)},getIndex:function(a){return this.nameLookup[a]},getAsArray:function(){var a=0;for(var b in this.materialsInfo)this.materialsArray[a]=this.create(b),this.nameLookup[b]=a,a++;return this.materialsArray},create:function(a){return void 0===this.materials[a]&&this.createMaterial_(a),this.materials[a]},createMaterial_:function(a){var b=this.materialsInfo[a],c={name:a,side:this.side};for(var d in b){var e=b[d];if(""!==e)switch(d.toLowerCase()){case"kd":c.color=(new THREE.Color).fromArray(e);break;case"ks":c.specular=(new THREE.Color).fromArray(e);break;case"map_kd":c.map=this.loadTexture(this.baseUrl+e),c.map.wrapS=this.wrap,c.map.wrapT=this.wrap;break;case"ns":c.shininess=parseFloat(e);break;case"d":e<1&&(c.opacity=e,c.transparent=!0);break;case"Tr":e>0&&(c.opacity=1-e,c.transparent=!0);break;case"map_bump":case"bump":if(c.bumpMap)break;c.bumpMap=this.loadTexture(this.baseUrl+e),c.bumpMap.wrapS=this.wrap,c.bumpMap.wrapT=this.wrap}}return this.materials[a]=new THREE.MeshPhongMaterial(c),this.materials[a]},loadTexture:function(a,b,c,d,e){var f,g=THREE.Loader.Handlers.get(a),h=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;return null===g&&(g=new THREE.TextureLoader(h)),g.setCrossOrigin&&g.setCrossOrigin(this.crossOrigin),f=g.load(a,c,d,e),void 0!==b&&(f.mapping=b),f}},THREE.EventDispatcher.prototype.apply(THREE.MTLLoader.prototype),THREE.OBJLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager,this.materials=null},THREE.OBJLoader.prototype={constructor:THREE.OBJLoader,load:function(a,b,c,d){var e=this,f=new THREE.XHRLoader(e.manager);f.setPath(this.path),f.load(a,function(a){b(e.parse(a))},c,d)},setPath:function(a){this.path=a},setMaterials:function(a){this.materials=a},parse:function(a){function b(a){var b={vertices:[],normals:[],uvs:[]},c={name:"",smooth:!0};j={name:a,geometry:b,material:c},k.push(j)}function c(a){var b=parseInt(a);return 3*(b>=0?b-1:b+m.length/3)}function d(a){var b=parseInt(a);return 3*(b>=0?b-1:b+n.length/3)}function e(a){var b=parseInt(a);return 2*(b>=0?b-1:b+o.length/2)}function f(a,b,c){j.geometry.vertices.push(m[a],m[a+1],m[a+2],m[b],m[b+1],m[b+2],m[c],m[c+1],m[c+2])}function g(a,b,c){j.geometry.normals.push(n[a],n[a+1],n[a+2],n[b],n[b+1],n[b+2],n[c],n[c+1],n[c+2])}function h(a,b,c){j.geometry.uvs.push(o[a],o[a+1],o[b],o[b+1],o[c],o[c+1])}function i(a,b,i,j,k,l,m,n,o,p,q,r){var s,t=c(a),u=c(b),v=c(i);void 0===j?f(t,u,v):(s=c(j),f(t,u,s),f(u,v,s)),void 0!==k&&(t=e(k),u=e(l),v=e(m),void 0===j?h(t,u,v):(s=e(n),h(t,u,s),h(u,v,s))),void 0!==o&&(t=d(o),u=d(p),v=d(q),void 0===j?g(t,u,v):(s=d(r),g(t,u,s),g(u,v,s)))}console.time("OBJLoader");var j,k=[],l=!1,m=[],n=[],o=[];b("");for(var p=/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,q=/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,r=/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,s=/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,t=/^f\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)))?/,u=/^f\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)\/(-?\d+)))?/,v=/^f\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))(?:\s+((-?\d+)\/\/(-?\d+)))?/,w=/^[og]\s+(.+)/,x=/^s\s+(\d+|on|off)/,y=a.split("\n"),z=0;z<y.length;z++){var A=y[z];A=A.trim();var B;if(0!==A.length&&"#"!==A.charAt(0))if(null!==(B=p.exec(A)))m.push(parseFloat(B[1]),parseFloat(B[2]),parseFloat(B[3]));else if(null!==(B=q.exec(A)))n.push(parseFloat(B[1]),parseFloat(B[2]),parseFloat(B[3]));else if(null!==(B=r.exec(A)))o.push(parseFloat(B[1]),parseFloat(B[2]));else if(null!==(B=s.exec(A)))i(B[1],B[2],B[3],B[4]);else if(null!==(B=t.exec(A)))i(B[2],B[5],B[8],B[11],B[3],B[6],B[9],B[12]);else if(null!==(B=u.exec(A)))i(B[2],B[6],B[10],B[14],B[3],B[7],B[11],B[15],B[4],B[8],B[12],B[16]);else if(null!==(B=v.exec(A)))i(B[2],B[5],B[8],B[11],void 0,void 0,void 0,void 0,B[3],B[6],B[9],B[12]);else if(null!==(B=w.exec(A))){var C=B[1].trim();l===!1?(l=!0,j.name=C):b(C)}else if(/^usemtl /.test(A))j.material.name=A.substring(7).trim();else if(/^mtllib /.test(A));else{if(null===(B=x.exec(A)))throw new Error("Unexpected line: "+A);j.material.smooth="1"===B[1]||"on"===B[1]}}for(var D=new THREE.Group,z=0,E=k.length;z<E;z++){j=k[z];var F=j.geometry,G=new THREE.BufferGeometry;G.addAttribute("position",new THREE.BufferAttribute(new Float32Array(F.vertices),3)),F.normals.length>0?G.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(F.normals),3)):G.computeVertexNormals(),F.uvs.length>0&&G.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(F.uvs),2));var H;null!==this.materials&&(H=this.materials.create(j.material.name)),H||(H=new THREE.MeshPhongMaterial,H.name=j.material.name),H.shading=j.material.smooth?THREE.SmoothShading:THREE.FlatShading;var I=new THREE.Mesh(G,H);I.name=j.name,D.add(I)}return console.timeEnd("OBJLoader"),D}},THREE.ColladaLoader=function(){function a(a,c,d,e){var f=0;if(document.implementation&&document.implementation.createDocument){var g=new XMLHttpRequest;g.onreadystatechange=function(){4===g.readyState?0!==g.status&&200!==g.status||(g.response?(Ma=c,b(g.response,void 0,a)):e?e():console.error("ColladaLoader: Empty or non-existing file ("+a+")")):3===g.readyState&&d&&(0===f&&(f=g.getResponseHeader("Content-Length")),d({total:f,loaded:g.responseText.length}))},g.open("GET",a,!0),g.send(null)}else alert("Don't know how to parse XML!")}function b(a,b,c){if(Ka=(new DOMParser).parseFromString(a,"text/xml"),b=b||Ma,void 0!==c){var i=c.split("/");i.pop(),Ha=(i.length<1?".":i.join("/"))+"/"}d(),ua(),Oa=e("library_images image",A,"image"),Sa=e("library_materials material",U,"material"),Ta=e("library_effects effect",Z,"effect"),Ra=e("library_geometries geometry",K,"geometry"),Ua=e("library_cameras camera",da,"camera"),Va=e("library_lights light",fa,"light"),Qa=e("library_controllers controller",B,"controller"),Pa=e("library_animations animation",_,"animation"),Fa=e("library_visual_scenes visual_scene",E,"visual_scene"),Ga=e("library_kinematics_models kinematics_model",ha,"kinematics_model"),Ia=[],Ja=[],Ba=f(),La=new THREE.Group;for(var j=0;j<Ba.nodes.length;j++)La.add(r(Ba.nodes[j]));La.scale.multiplyScalar(Ya),h(),Ca=g(),q();var k={scene:La,morphs:Ia,skins:Ja,animations:Da,kinematics:Ea,dae:{images:Oa,materials:Sa,cameras:Ua,lights:Va,effects:Ta,geometries:Ra,controllers:Qa,animations:Pa,visualScenes:Fa,visualScene:Ba,scene:Ba,kinematicsModels:Ga,kinematicsModel:Ca}};return b&&b(k),k}function c(a){Wa=a}function d(){var a=Ka.querySelectorAll("asset"),b=a[0];if(b&&b.childNodes)for(var c=0;c<b.childNodes.length;c++){var d=b.childNodes[c];switch(d.nodeName){case"unit":var e=d.getAttribute("meter");e&&(Ya=parseFloat(e));break;case"up_axis":Za=d.textContent.charAt(0)}}}function e(a,b,c){for(var d=Ka.querySelectorAll(a),e={},f=0,g=d.length,h=0;h<g;h++){var i=d[h],j=(new b).parse(i);j.id&&0!==j.id.length||(j.id=c+f++),e[j.id]=j}return e}function f(){var a=Ka.querySelectorAll("scene instance_visual_scene")[0];if(a){var b=a.getAttribute("url").replace(/^#/,"");return Fa[b.length>0?b:"visual_scene0"]}return null}function g(){var a=Ka.querySelectorAll("instance_kinematics_model")[0];if(a){var b=a.getAttribute("url").replace(/^#/,"");return Ga[b.length>0?b:"kinematics_model0"]}return null}function h(){Da=[],i(La)}function i(a){var b=Ba.getChildById(a.colladaId,!0),c=null;if(b&&b.keys){c={fps:60,hierarchy:[{node:b,keys:b.keys,sids:b.sids}],node:a,name:"animation_"+a.name,length:0},Da.push(c);for(var d=0,e=b.keys.length;d<e;d++)c.length=Math.max(c.length,b.keys[d].time)}else c={hierarchy:[{keys:[],sids:[]}]};for(var d=0,e=a.children.length;d<e;d++)for(var f=i(a.children[d]),g=0,h=f.hierarchy.length;g<h;g++)c.hierarchy.push({keys:[],sids:[]});return c}function j(){var a,b=1e6,c=-b,d=0;for(var e in Pa){var f=Pa[e];a=a||f.id;for(var g=0;g<f.sampler.length;g++){var h=f.sampler[g];h.create(),b=Math.min(b,h.startTime),c=Math.max(c,h.endTime),d=Math.max(d,h.input.length)}}return{start:b,end:c,frames:d,ID:a}}function k(a,b){var c=b instanceof H?Qa[b.url]:b;if(!c||!c.morph)return void console.log("could not find morph controller!");for(var d=c.morph,e=0;e<d.targets.length;e++){var f=d.targets[e],g=Ra[f];if(g.mesh&&g.mesh.primitives&&g.mesh.primitives.length){var h=g.mesh.primitives[0].geometry;h.vertices.length===a.vertices.length&&a.morphTargets.push({name:"target_1",vertices:h.vertices})}}a.morphTargets.push({name:"target_Z",vertices:a.vertices})}function l(a,b,c,d){if(a.world=a.world||new THREE.Matrix4,a.localworld=a.localworld||new THREE.Matrix4,a.world.copy(a.matrix),a.localworld.copy(a.matrix),a.channels&&a.channels.length){var e=a.channels[0],f=e.sampler.output[c];f instanceof THREE.Matrix4&&(a.world.copy(f),a.localworld.copy(f),0===c&&a.matrix.copy(f))}d&&a.world.multiplyMatrices(d,a.world),b.push(a);for(var g=0;g<a.nodes.length;g++)l(a.nodes[g],b,c,a.world)}function m(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=-1;if("JOINT"==d.type){for(var f=0;f<b.joints.length;f++)if(d.sid===b.joints[f]){e=f;break}if(e>=0){var g=b.invBindMatrices[e];d.invBindMatrix=g,d.skinningMatrix=new THREE.Matrix4,d.skinningMatrix.multiplyMatrices(d.world,g),d.animatrix=new THREE.Matrix4,d.animatrix.copy(d.localworld),d.weights=[];for(var f=0;f<b.weights.length;f++)for(var h=0;h<b.weights[f].length;h++){var i=b.weights[f][h];i.joint===e&&d.weights.push(i)}}else console.warn("ColladaLoader: Could not find joint '"+d.sid+"'."),d.skinningMatrix=new THREE.Matrix4,d.weights=[]}}}function n(a){var b=[],c=function(a,b,d){var e={};e.name=b.sid,e.parent=a,e.matrix=b.matrix;var f=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];e.matrix.decompose(f[0],f[1],f[2]),e.pos=[f[0].x,f[0].y,f[0].z],e.scl=[f[2].x,f[2].y,f[2].z],e.rotq=[f[1].x,f[1].y,f[1].z,f[1].w],d.push(e);for(var g in b.nodes)c(b.sid,b.nodes[g],d)};return c(-1,a,b),b}function o(a,b,c){var d=[];l(b,d,-1),m(d,c.skin);for(var e=new THREE.Vector3,f=[],g=0;g<a.vertices.length;g++)f.push(new THREE.Vector3);for(g=0;g<d.length;g++)if("JOINT"==d[g].type)for(var h=0;h<d[g].weights.length;h++){var i=d[g].weights[h],j=i.index,k=i.weight,n=a.vertices[j],o=f[j];e.x=n.x,e.y=n.y,e.z=n.z,e.applyMatrix4(d[g].skinningMatrix),o.x+=e.x*k,o.y+=e.y*k,o.z+=e.z*k}for(var g=0;g<a.vertices.length;g++)a.vertices[g]=f[g]}function p(a,b,c){var d=Qa[b.url];if(c=void 0!==c?c:40,!d||!d.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!b.skeleton||!b.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var e=j(),f=Ba.getChildById(b.skeleton[0],!0)||Ba.getChildBySid(b.skeleton[0],!0),g=n(f),h=d.skin.joints,i=[],k=0;k<h.length;k++)for(var p=0;p<g.length;p++)g[p].name===h[k]&&(i[k]=g[p]);for(var k=0;k<i.length;k++)for(var p=0;p<i.length;p++)i[k].parent===i[p].name&&(i[k].parent=p);var k,p,q;for(new THREE.Vector3,k=0;k<a.vertices.length;k++)a.vertices[k].applyMatrix4(d.skin.bindShapeMatrix);for(var r=[],s=[],t=d.skin.weights,k=0;k<t.length;k++){var u=new THREE.Vector4(t[k][0]?t[k][0].joint:0,t[k][1]?t[k][1].joint:0,t[k][2]?t[k][2].joint:0,t[k][3]?t[k][3].joint:0),q=new THREE.Vector4(t[k][0]?t[k][0].weight:0,t[k][1]?t[k][1].weight:0,t[k][2]?t[k][2].weight:0,t[k][3]?t[k][3].weight:0);r.push(u),s.push(q)}a.skinIndices=r,a.skinWeights=s,a.bones=i;for(var v={name:e.ID,fps:30,length:e.frames/30,hierarchy:[]},p=0;p<i.length;p++)v.hierarchy.push({parent:i[p].parent,name:i[p].name,keys:[]});for(console.log("ColladaLoader:",e.ID+" has "+i.length+" bones."),o(a,f,d),c=0;c<e.frames;c++){var w=[];l(f,w,c),m(w,d.skin);for(var k=0;k<w.length;k++)for(var p=0;p<v.hierarchy.length;p++)if(v.hierarchy[p].name===w[k].sid){var x={};x.time=c/30,x.matrix=w[k].animatrix,0===c&&(w[k].matrix=x.matrix);var y=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];x.matrix.decompose(y[0],y[1],y[2]),x.pos=[y[0].x,y[0].y,y[0].z],x.scl=[y[2].x,y[2].y,y[2].z],x.rot=y[1],v.hierarchy[p].keys.push(x)}a.animation=v}}function q(){if(Ca&&0===Ca.joints.length)return void(Ea=void 0);var a={},b=function(b,c){var d=c.getAttribute("id"),e=Ba.getChildById(d,!0),f=Ca.joints[b];La.traverse(function(c){c.colladaId==d&&(a[b]={node:c,transforms:e.transforms,joint:f,position:f.zeroPosition})})};Ea={joints:Ca&&Ca.joints,getJointValue:function(b){var c=a[b];return c?c.position:void console.log("getJointValue: joint "+b+" doesn't exist")},setJointValue:function(b,c){var e=a[b];if(e){var f=e.joint;if(c>f.limits.max||c<f.limits.min)console.log("setJointValue: joint "+b+" value "+c+" outside of limits (min: "+f.limits.min+", max: "+f.limits.max+")");else if(f.static)console.log("setJointValue: joint "+b+" is static");else{var g=e.node,h=f.axis,i=e.transforms,j=new THREE.Matrix4;for(d=0;d<i.length;d++){var k=i[d];if(k.sid&&k.sid.indexOf("joint"+b)!==-1)switch(f.type){case"revolute":j.multiply(l.makeRotationAxis(h,THREE.Math.degToRad(c)));break;case"prismatic":j.multiply(l.makeTranslation(h.x*c,h.y*c,h.z*c));break;default:console.warn("setJointValue: unknown joint type: "+f.type)}else{var l=new THREE.Matrix4;switch(k.type){case"matrix":j.multiply(k.obj);break;case"translate":j.multiply(l.makeTranslation(k.obj.x,k.obj.y,k.obj.z));break;case"rotate":j.multiply(l.makeRotationAxis(k.obj,k.angle))}}}var m=j.elements,n=Array.prototype.slice.call(m),o=[n[0],n[4],n[8],n[12],n[1],n[5],n[9],n[13],n[2],n[6],n[10],n[14],n[3],n[7],n[11],n[15]];g.matrix.set.apply(g.matrix,o),g.matrix.decompose(g.position,g.quaternion,g.scale)}}else console.log("setJointValue: joint "+b+" doesn't exist")}};var c=Ka.querySelector("scene instance_kinematics_scene");if(c)for(var d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];if(1==e.nodeType)switch(e.nodeName){case"bind_joint_axis":var f=e.getAttribute("target").split("/").pop(),g=e.querySelector("axis param").textContent,h=parseInt(g.split("joint").pop().split(".")[0]),i=Ka.querySelector('[sid="'+f+'"]');if(i){var j=i.parentElement;b(h,j)}}}}function r(a,b){var c,d,e,f,g=new THREE.Object3D,h=!1;for(e=0;e<a.controllers.length;e++){var i=Qa[a.controllers[e].url];switch(i.type){case"skin":if(Ra[i.skin.source]){var j=new J;j.url=i.skin.source,j.instance_material=a.controllers[e].instance_material,a.geometries.push(j),h=!0,c=a.controllers[e]}else if(Qa[i.skin.source]){var l=Qa[i.skin.source];if(d=l,l.morph&&Ra[l.morph.source]){var j=new J;j.url=l.morph.source,j.instance_material=a.controllers[e].instance_material,a.geometries.push(j)}}break;case"morph":if(Ra[i.morph.source]){var j=new J;j.url=i.morph.source,j.instance_material=a.controllers[e].instance_material,a.geometries.push(j),d=a.controllers[e]}console.log("ColladaLoader: Morph-controller partially supported.")}}var m={};for(e=0;e<a.geometries.length;e++){var n,o=a.geometries[e],q=o.instance_material,s=Ra[o.url],t={},u=[],v=0;if(s){if(!s.mesh||!s.mesh.primitives)continue;if(0===g.name.length&&(g.name=s.id),q)for(f=0;f<q.length;f++){var w=q[f],x=Sa[w.target],y=x.instance_effect.url,z=Ta[y].shader,A=z.material;if(s.doubleSided){if(!(w.symbol in m)){var B=A.clone();B.side=THREE.DoubleSide,m[w.symbol]=B}A=m[w.symbol]}A.opacity=A.opacity?A.opacity:1,t[w.symbol]=v,u.push(A),n=A,n.name=null===x.name||""===x.name?x.id:x.name,v++}var C,D=n||new THREE.MeshLambertMaterial({color:14540253,side:s.doubleSided?THREE.DoubleSide:THREE.FrontSide}),E=s.mesh.geometry3js;v>1&&(D=new THREE.MultiMaterial(u)),void 0!==c?(p(E,c),E.morphTargets.length>0?(D.morphTargets=!0,D.skinning=!1):(D.morphTargets=!1,D.skinning=!0),C=new THREE.SkinnedMesh(E,D,!1),C.name="skin_"+Ja.length,Ja.push(C)):void 0!==d?(k(E,d),D.morphTargets=!0,C=new THREE.Mesh(E,D),C.name="morph_"+Ia.length,Ia.push(C)):C=E.isLineStrip===!0?new THREE.Line(E):new THREE.Mesh(E,D),g.add(C)}}for(e=0;e<a.cameras.length;e++){var F=a.cameras[e],G=Ua[F.url],H=new THREE.PerspectiveCamera(G.yfov,parseFloat(G.aspect_ratio),parseFloat(G.znear),parseFloat(G.zfar));g.add(H)}for(e=0;e<a.lights.length;e++){var I=null,K=a.lights[e],L=Va[K.url];if(L&&L.technique){var M=L.color.getHex(),N=L.intensity,O=L.distance,P=L.falloff_angle;switch(L.technique){case"directional":I=new THREE.DirectionalLight(M,N,O),I.position.set(0,0,1);break;case"point":I=new THREE.PointLight(M,N,O);break;case"spot":I=new THREE.SpotLight(M,N,O,P),I.position.set(0,0,1);break;case"ambient":I=new THREE.AmbientLight(M)}}I&&g.add(I)}if(g.name=a.name||a.id||"",g.colladaId=a.id||"",g.layer=a.layer||"",g.matrix=a.matrix,g.matrix.decompose(g.position,g.quaternion,g.scale),Xa.centerGeometry&&g.geometry){var Q=g.geometry.center();Q.multiply(g.scale),Q.applyQuaternion(g.quaternion),g.position.sub(Q)}for(e=0;e<a.nodes.length;e++)g.add(r(a.nodes[e],a));return g}function s(a){for(var b=Ka.querySelectorAll("library_nodes node"),c=0;c<b.length;c++){var d=b[c].attributes.getNamedItem("id");if(d&&d.value===a)return b[c]}}function t(a){var b=[],c=1e6,d=-1e6;for(var e in Pa)for(var f=Pa[e],g=0;g<f.channel.length;g++){var h=f.channel[g],i=f.sampler[g],e=h.target.split("/")[0];e==a.id&&(i.create(),h.sampler=i,c=Math.min(c,i.startTime),d=Math.max(d,i.endTime),b.push(h))}return b.length&&(a.startTime=c,a.endTime=d),b}function u(a){if(a.channels&&a.channels.length){for(var b=[],c=[],d=0,e=a.channels.length;d<e;d++){var f,g=a.channels[d],h=g.fullSid,i=g.sampler,j=i.input,k=a.getTransformBySid(g.sid);if(g.arrIndices){f=[];for(var l=0,m=g.arrIndices.length;l<m;l++)f[l]=za(g.arrIndices[l])}else f=Aa(g.member);if(k){c.indexOf(h)===-1&&c.push(h);for(var l=0,m=j.length;l<m;l++){var n=j[l],o=i.getData(k.type,l,f),p=v(b,n);if(!p){p=new ca(n);var q=w(b,n);b.splice(q===-1?b.length:q,0,p)}p.addTarget(h,k,f,o)}}else console.log('Could not find transform "'+g.sid+'" in node '+a.id)}for(var d=0;d<c.length;d++)for(var r=c[d],l=0;l<b.length;l++){var p=b[l];p.hasTarget(r)||x(b,p,l,r)}a.keys=b,a.sids=c}}function v(a,b){for(var c=null,d=0,e=a.length;d<e&&null===c;d++){var f=a[d];if(f.time===b)c=f;else if(f.time>b)break}return c}function w(a,b){for(var c=-1,d=0,e=a.length;d<e&&c===-1;d++){var f=a[d];f.time>=b&&(c=d)}return c}function x(a,b,c,d){var e=z(a,d,c?c-1:0),f=y(a,d,c+1);if(e&&f){var g,h=(b.time-e.time)/(f.time-e.time),i=e.getTarget(d),j=f.getTarget(d).data,k=i.data;if("matrix"===i.type)g=k;else if(k.length){g=[];for(var l=0;l<k.length;++l)g[l]=k[l]+(j[l]-k[l])*h}else g=k+(j-k)*h;b.addTarget(d,i.transform,i.member,g)}}function y(a,b,c){for(;c<a.length;c++){var d=a[c];if(d.hasTarget(b))return d}return null}function z(a,b,c){for(c=c>=0?c:c+a.length;c>=0;c--){var d=a[c];if(d.hasTarget(b))return d}return null}function A(){this.id="",this.init_from=""}function B(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function C(){this.method=null,this.source=null,this.targets=null,this.weights=null}function D(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function E(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function F(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function G(){this.sid="",this.type="",this.data=[],this.obj=null}function H(){this.url="",this.skeleton=[],this.instance_material=[]}function I(){this.symbol="",this.target=""}function J(){this.url="",this.instance_material=[]}function K(){this.id="",this.mesh=null}function L(a){this.geometry=a.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function M(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function N(){M.call(this),this.vcount=[]}function O(){M.call(this),this.vcount=1}function P(){M.call(this),this.vcount=3}function Q(){this.source="",this.count=0,this.stride=0,this.params=[]}function R(){this.input={}}function S(){this.semantic="",this.offset=0,this.source="",this.set=0}function T(a){this.id=a,this.type=null}function U(){this.id="",this.name="",this.instance_effect=null}function V(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function W(a,b){this.type=a,this.effect=b,this.material=null}function X(a){this.effect=a,this.init_from=null,this.format=null}function Y(a){this.effect=a,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Z(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function $(){this.url=""}function _(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function aa(a){this.animation=a,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function ba(a){this.id="",this.animation=a,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ca(a){this.targets=[],this.time=a}function da(){this.id="",this.name="",this.technique=""}function ea(){this.url=""}function fa(){this.id="",this.name="",this.technique=""}function ga(){this.url=""}function ha(){this.id="",this.name="",this.joints=[],this.links=[]}function ia(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function ja(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function ka(){this.joint="",this.transforms=[],this.links=[]}function la(a){var b=a.getAttribute("id");return void 0!=Na[b]?Na[b]:(Na[b]=new T(b).parse(a),Na[b])}function ma(a){for(var b=pa(a),c=[],d=0,e=b.length;d<e;d++)c.push("true"===b[d]||"1"===b[d]);return c}function na(a){for(var b=pa(a),c=[],d=0,e=b.length;d<e;d++)c.push(parseFloat(b[d]));return c}function oa(a){for(var b=pa(a),c=[],d=0,e=b.length;d<e;d++)c.push(parseInt(b[d],10));return c}function pa(a){return a.length>0?qa(a).split(/\s+/):[]}function qa(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}function ra(a,b,c){return a.hasAttribute(b)?parseInt(a.getAttribute(b),10):c}function sa(a,b){var c=new THREE.ImageLoader;c.load(b,function(b){a.image=b,a.needsUpdate=!0})}function ta(a,b){a.doubleSided=!1;var c=b.querySelectorAll("extra double_sided")[0];c&&c&&1===parseInt(c.textContent,10)&&(a.doubleSided=!0)}function ua(){if(Xa.convertUpAxis!==!0||Za===Xa.upAxis)$a=null;else switch(Za){case"X":$a="Y"===Xa.upAxis?"XtoY":"XtoZ";break;case"Y":$a="X"===Xa.upAxis?"YtoX":"YtoZ";break;case"Z":$a="X"===Xa.upAxis?"ZtoX":"ZtoY"}}function va(a,b){if(Xa.convertUpAxis===!0&&Za!==Xa.upAxis)switch($a){case"XtoY":var c=a[0];a[0]=b*a[1],a[1]=c;break;case"XtoZ":var c=a[2];a[2]=a[1],a[1]=a[0],a[0]=c;break;case"YtoX":var c=a[0];a[0]=a[1],a[1]=b*c;break;case"YtoZ":var c=a[1];a[1]=b*a[2],a[2]=c;break;case"ZtoX":var c=a[0];a[0]=a[1],a[1]=a[2],a[2]=c;break;case"ZtoY":var c=a[1];a[1]=a[2],a[2]=b*c}}function wa(a,b){if(Xa.convertUpAxis!==!0||Za===Xa.upAxis)return b;switch(a){case"X":b="XtoY"===$a?b*-1:b;break;case"Y":b="YtoZ"===$a||"YtoX"===$a?b*-1:b;break;case"Z":b="ZtoY"===$a?b*-1:b}return b}function xa(a,b){var c=[a[b],a[b+1],a[b+2]];return va(c,-1),new THREE.Vector3(c[0],c[1],c[2])}function ya(a){if(Xa.convertUpAxis){var b=[a[0],a[4],a[8]];va(b,-1),a[0]=b[0],a[4]=b[1],a[8]=b[2],b=[a[1],a[5],a[9]],va(b,-1),a[1]=b[0],a[5]=b[1],a[9]=b[2],b=[a[2],a[6],a[10]],va(b,-1),a[2]=b[0],a[6]=b[1],a[10]=b[2],b=[a[0],a[1],a[2]],va(b,-1),a[0]=b[0],a[1]=b[1],a[2]=b[2],b=[a[4],a[5],a[6]],va(b,-1),a[4]=b[0],a[5]=b[1],a[6]=b[2],b=[a[8],a[9],a[10]],va(b,-1),a[8]=b[0],a[9]=b[1],a[10]=b[2],b=[a[3],a[7],a[11]],va(b,-1),a[3]=b[0],a[7]=b[1],a[11]=b[2]}return(new THREE.Matrix4).set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15])}function za(a){if(a>-1&&a<3){var b=["X","Y","Z"],c={X:0,Y:1,Z:2};a=Aa(b[a]),a=c[a]}return a}function Aa(a){if(Xa.convertUpAxis)switch(a){case"X":switch($a){case"XtoY":case"XtoZ":case"YtoX":a="Y";break;case"ZtoX":a="Z"}break;case"Y":switch($a){case"XtoY":case"YtoX":case"ZtoX":a="X";break;case"XtoZ":case"YtoZ":case"ZtoY":a="Z"}break;case"Z":switch($a){case"XtoZ":a="X";break;case"YtoZ":case"ZtoX":case"ZtoY":a="Y"}}return a}var Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka=null,La=null,Ma=null,Na={},Oa={},Pa={},Qa={},Ra={},Sa={},Ta={},Ua={},Va={},Wa=THREE.SmoothShading,Xa={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Ya=1,Za="Y",$a=null;return A.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];"init_from"===c.nodeName&&(this.init_from=c.textContent)}return this},B.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type="none";for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"skin":this.skin=(new D).parse(c),this.type=c.nodeName;break;case"morph":this.morph=(new C).parse(c),this.type=c.nodeName}}return this},C.prototype.parse=function(a){var b,c={},d=[];for(this.method=a.getAttribute("method"),this.source=a.getAttribute("source").replace(/^#/,""),b=0;b<a.childNodes.length;b++){var e=a.childNodes[b];if(1==e.nodeType)switch(e.nodeName){case"source":var f=(new T).parse(e);c[f.id]=f;break;case"targets":d=this.parseInputs(e);break;default:console.log(e.nodeName)}}for(b=0;b<d.length;b++){var g=d[b],f=c[g.source];switch(g.semantic){case"MORPH_TARGET":this.targets=f.read();break;case"MORPH_WEIGHT":this.weights=f.read()}}return this},C.prototype.parseInputs=function(a){for(var b=[],c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":b.push((new S).parse(d))}}return b},D.prototype.parse=function(a){var b,c,d={};this.source=a.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var e=0;e<a.childNodes.length;e++){var f=a.childNodes[e];if(1==f.nodeType)switch(f.nodeName){case"bind_shape_matrix":var g=na(f.textContent);this.bindShapeMatrix=ya(g);break;case"source":var h=(new T).parse(f);d[h.id]=h;break;case"joints":b=f;break;case"vertex_weights":c=f;break;default:console.log(f.nodeName)}}return this.parseJoints(b,d),this.parseWeights(c,d),this},D.prototype.parseJoints=function(a,b){for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":var e=(new S).parse(d),f=b[e.source];"JOINT"===e.semantic?this.joints=f.read():"INV_BIND_MATRIX"===e.semantic&&(this.invBindMatrices=f.read())}}},D.prototype.parseWeights=function(a,b){for(var c,d,e=[],f=0;f<a.childNodes.length;f++){var g=a.childNodes[f];if(1==g.nodeType)switch(g.nodeName){case"input":e.push((new S).parse(g));break;case"v":c=oa(g.textContent);break;case"vcount":d=oa(g.textContent)}}for(var h=0,f=0;f<d.length;f++){for(var i=d[f],j=[],k=0;k<i;k++){for(var l={},m=0;m<e.length;m++){var n=e[m],o=c[h+n.offset];switch(n.semantic){case"JOINT":l.joint=o;break;case"WEIGHT":l.weight=b[n.source].data[o]}}j.push(l),h+=e.length}for(var k=0;k<j.length;k++)j[k].index=f;this.weights.push(j)}},E.prototype.getChildById=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},E.prototype.getChildBySid=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},E.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.nodes=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"node":this.nodes.push((new F).parse(c))}}return this;
},F.prototype.getChannelForTransform=function(a){for(var b=0;b<this.channels.length;b++){var c,d,e=this.channels[b],f=e.target.split("/"),g=(f.shift(),f.shift()),h=g.indexOf(".")>=0,i=g.indexOf("(")>=0;if(h)f=g.split("."),g=f.shift(),d=f.shift();else if(i){c=g.split("("),g=c.shift();for(var j=0;j<c.length;j++)c[j]=parseInt(c[j].replace(/\)/,""))}if(g===a)return e.info={sid:g,dotSyntax:h,arrSyntax:i,arrIndices:c},e}return null},F.prototype.getChildById=function(a,b){if(this.id===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},F.prototype.getChildBySid=function(a,b){if(this.sid===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},F.prototype.getTransformBySid=function(a){for(var b=0;b<this.transforms.length;b++)if(this.transforms[b].sid===a)return this.transforms[b];return null},F.prototype.parse=function(a){var b;this.id=a.getAttribute("id"),this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.type=a.getAttribute("type"),this.layer=a.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"node":this.nodes.push((new F).parse(d));break;case"instance_camera":this.cameras.push((new ea).parse(d));break;case"instance_controller":this.controllers.push((new H).parse(d));break;case"instance_geometry":this.geometries.push((new J).parse(d));break;case"instance_light":this.lights.push((new ga).parse(d));break;case"instance_node":b=d.getAttribute("url").replace(/^#/,"");var e=s(b);e&&this.nodes.push((new F).parse(e));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new G).parse(d));break;case"extra":break;default:console.log(d.nodeName)}}return this.channels=t(this),u(this),this.updateMatrix(),this},F.prototype.updateMatrix=function(){this.matrix.identity();for(var a=0;a<this.transforms.length;a++)this.transforms[a].apply(this.matrix)},G.prototype.parse=function(a){return this.sid=a.getAttribute("sid"),this.type=a.nodeName,this.data=na(a.textContent),this.convert(),this},G.prototype.convert=function(){switch(this.type){case"matrix":this.obj=ya(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":va(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":va(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},G.prototype.apply=function(){var a=new THREE.Matrix4;return function(b){switch(this.type){case"matrix":b.multiply(this.obj);break;case"translate":b.multiply(a.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":b.multiply(a.makeRotationAxis(this.obj,this.angle));break;case"scale":b.scale(this.obj)}}}(),G.prototype.update=function(a,b){var c=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(b)if(1===b.length)switch(b[0]){case 0:this.obj.n11=a[0],this.obj.n21=a[1],this.obj.n31=a[2],this.obj.n41=a[3];break;case 1:this.obj.n12=a[0],this.obj.n22=a[1],this.obj.n32=a[2],this.obj.n42=a[3];break;case 2:this.obj.n13=a[0],this.obj.n23=a[1],this.obj.n33=a[2],this.obj.n43=a[3];break;case 3:this.obj.n14=a[0],this.obj.n24=a[1],this.obj.n34=a[2],this.obj.n44=a[3]}else if(2===b.length){var d="n"+(b[0]+1)+(b[1]+1);this.obj[d]=a}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(a);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;case"ANGLE":this.angle=THREE.Math.degToRad(a);break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2],this.angle=THREE.Math.degToRad(a[3])}}},H.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1===c.nodeType)switch(c.nodeName){case"skeleton":this.skeleton.push(c.textContent.replace(/^#/,""));break;case"bind_material":for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new I).parse(f))}break;case"extra":}}return this},I.prototype.parse=function(a){return this.symbol=a.getAttribute("symbol"),this.target=a.getAttribute("target").replace(/^#/,""),this},J.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType&&"bind_material"===c.nodeName){for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new I).parse(f))}break}}return this},K.prototype.parse=function(a){this.id=a.getAttribute("id"),ta(this,a);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"mesh":this.mesh=new L(this).parse(c);break;case"extra":}}return this},L.prototype.parse=function(a){this.primitives=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"source":la(c);break;case"vertices":this.vertices=(new R).parse(c);break;case"linestrips":this.primitives.push((new O).parse(c));break;case"triangles":this.primitives.push((new P).parse(c));break;case"polygons":this.primitives.push((new M).parse(c));break;case"polylist":this.primitives.push((new N).parse(c))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var d=Na[this.vertices.input.POSITION.source].data,b=0;b<d.length;b+=3)this.geometry3js.vertices.push(xa(d,b).clone());for(var b=0;b<this.primitives.length;b++){var e=this.primitives[b];e.setVertices(this.vertices),this.handlePrimitive(e,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},L.prototype.handlePrimitive=function(a,b){if(a instanceof O)return void(b.isLineStrip=!0);var c,d,e,f,g,h,i,j=a.p,k=a.inputs,l=0,m=3,n=0,o=[];for(c=0;c<k.length;c++){e=k[c];var p=e.offset+1;switch(n=n<p?p:n,e.semantic){case"TEXCOORD":o.push(e.set)}}for(var q=0;q<j.length;++q)for(var r=j[q],s=0;s<r.length;){var t=[],u=[],v=null,w=[];for(m=a.vcount?a.vcount.length?a.vcount[l++]:a.vcount:r.length/n,c=0;c<m;c++)for(d=0;d<k.length;d++)switch(e=k[d],h=Na[e.source],f=r[s+c*n+e.offset],i=h.accessor.params.length,g=f*i,e.semantic){case"VERTEX":t.push(f);break;case"NORMAL":u.push(xa(h.data,g));break;case"TEXCOORD":v=v||{},void 0===v[e.set]&&(v[e.set]=[]),v[e.set].push(new THREE.Vector2(h.data[g],h.data[g+1]));break;case"COLOR":w.push((new THREE.Color).setRGB(h.data[g],h.data[g+1],h.data[g+2]))}if(0===u.length)if(e=this.vertices.input.NORMAL){h=Na[e.source],i=h.accessor.params.length;for(var x=0,y=t.length;x<y;x++)u.push(xa(h.data,t[x]*i))}else b.calcNormals=!0;if(!v&&(v={},e=this.vertices.input.TEXCOORD)){o.push(e.set),h=Na[e.source],i=h.accessor.params.length;for(var x=0,y=t.length;x<y;x++)g=t[x]*i,void 0===v[e.set]&&(v[e.set]=[]),v[e.set].push(new THREE.Vector2(h.data[g],1-h.data[g+1]))}if(0===w.length&&(e=this.vertices.input.COLOR)){h=Na[e.source],i=h.accessor.params.length;for(var x=0,y=t.length;x<y;x++)g=t[x]*i,w.push((new THREE.Color).setRGB(h.data[g],h.data[g+1],h.data[g+2]))}var z,A,B=null,C=[];if(3===m)C.push(new THREE.Face3(t[0],t[1],t[2],u,w.length?w:new THREE.Color));else if(4===m)C.push(new THREE.Face3(t[0],t[1],t[3],u.length?[u[0].clone(),u[1].clone(),u[3].clone()]:[],w.length?[w[0],w[1],w[3]]:new THREE.Color)),C.push(new THREE.Face3(t[1],t[2],t[3],u.length?[u[1].clone(),u[2].clone(),u[3].clone()]:[],w.length?[w[1],w[2],w[3]]:new THREE.Color));else if(m>4&&Xa.subdivideFaces){var D=w.length?w:new THREE.Color;for(d=1;d<m-1;)C.push(new THREE.Face3(t[0],t[d],t[d+1],u.length?[u[0].clone(),u[d++].clone(),u[d].clone()]:[],D))}if(C.length)for(var x=0,y=C.length;x<y;x++)for(B=C[x],B.daeMaterial=a.material,b.faces.push(B),d=0;d<o.length;d++)z=v[o[d]],A=m>4?[z[0],z[x+1],z[x+2]]:4===m?0===x?[z[0],z[1],z[3]]:[z[1].clone(),z[2],z[3].clone()]:[z[0],z[1],z[2]],void 0===b.faceVertexUvs[d]&&(b.faceVertexUvs[d]=[]),b.faceVertexUvs[d].push(A);else console.log("dropped face with vcount "+m+" for geometry with id: "+b.id);s+=n*m}},M.prototype.setVertices=function(a){for(var b=0;b<this.inputs.length;b++)this.inputs[b].source===a.id&&(this.inputs[b].source=a.input.POSITION.source)},M.prototype.parse=function(a){this.material=a.getAttribute("material"),this.count=ra(a,"count",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"input":this.inputs.push((new S).parse(a.childNodes[b]));break;case"vcount":this.vcount=oa(c.textContent);break;case"p":this.p.push(oa(c.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},N.prototype=Object.create(M.prototype),N.prototype.constructor=N,O.prototype=Object.create(M.prototype),O.prototype.constructor=O,P.prototype=Object.create(M.prototype),P.prototype.constructor=P,Q.prototype.parse=function(a){this.params=[],this.source=a.getAttribute("source"),this.count=ra(a,"count",0),this.stride=ra(a,"stride",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if("param"===c.nodeName){var d={};d.name=c.getAttribute("name"),d.type=c.getAttribute("type"),this.params.push(d)}}return this},R.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++)if("input"===a.childNodes[b].nodeName){var c=(new S).parse(a.childNodes[b]);this.input[c.semantic]=c}return this},S.prototype.parse=function(a){return this.semantic=a.getAttribute("semantic"),this.source=a.getAttribute("source").replace(/^#/,""),this.set=ra(a,"set",-1),this.offset=ra(a,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},T.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"bool_array":this.data=ma(c.textContent),this.type=c.nodeName;break;case"float_array":this.data=na(c.textContent),this.type=c.nodeName;break;case"int_array":this.data=oa(c.textContent),this.type=c.nodeName;break;case"IDREF_array":case"Name_array":this.data=pa(c.textContent),this.type=c.nodeName;break;case"technique_common":for(var d=0;d<c.childNodes.length;d++)if("accessor"===c.childNodes[d].nodeName){this.accessor=(new Q).parse(c.childNodes[d]);break}}}return this},T.prototype.read=function(){var a=[],b=this.accessor.params[0];switch(b.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var c=0;c<this.data.length;c+=16){var d=this.data.slice(c,c+16),e=ya(d);a.push(e)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+b.type+".")}return a},U.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++)if("instance_effect"===a.childNodes[b].nodeName){this.instance_effect=(new $).parse(a.childNodes[b]);break}return this},V.prototype.isColor=function(){return null===this.texture},V.prototype.isTexture=function(){return null!=this.texture},V.prototype.parse=function(a){"transparent"===a.nodeName&&(this.opaque=a.getAttribute("opaque"));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"color":var d=na(c.textContent);this.color=new THREE.Color,this.color.setRGB(d[0],d[1],d[2]),this.color.a=d[3];break;case"texture":this.texture=c.getAttribute("texture"),this.texcoord=c.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(c)}}return this},V.prototype.parseTexture=function(a){if(!a.childNodes)return this;a.childNodes[1]&&"extra"===a.childNodes[1].nodeName&&(a=a.childNodes[1],a.childNodes[1]&&"technique"===a.childNodes[1].nodeName&&(a=a.childNodes[1]));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[c.nodeName]=parseFloat(c.textContent);break;case"wrapU":case"wrapV":"TRUE"===c.textContent.toUpperCase()?this.texOpts[c.nodeName]=1:this.texOpts[c.nodeName]=parseInt(c.textContent);break;default:this.texOpts[c.nodeName]=c.textContent}}return this},W.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[c.nodeName]=(new V).parse(c);break;case"bump":var d=c.getAttribute("bumptype");d?"heightfield"===d.toLowerCase()?this.bump=(new V).parse(c):"normalmap"===d.toLowerCase()?this.normal=(new V).parse(c):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+d+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new V).parse(c)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new V).parse(c));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var e=c.querySelectorAll("float");e.length>0&&(this[c.nodeName]=parseFloat(e[0].textContent))}}return this.create(),this},W.prototype.create=function(){var a={},b=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var c=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);c>0&&(b=!0,a.transparent=!0,a.opacity=1-c)}var d={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var e in this)switch(e){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var f=this[e];if(f instanceof V)if(f.isTexture()){var g=f.texture,h=this.effect.sampler[g];if(void 0!==h&&void 0!==h.source){var i=this.effect.surface[h.source];if(void 0!==i){var j=Oa[i.init_from];if(j){var k,l=Ha+j.init_from,m=THREE.Loader.Handlers.get(l);null!==m?k=m.load(l):(k=new THREE.Texture,sa(k,l)),k.wrapS=f.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,k.wrapT=f.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,k.offset.x=f.texOpts.offsetU,k.offset.y=f.texOpts.offsetV,k.repeat.x=f.texOpts.repeatU,k.repeat.y=f.texOpts.repeatV,a[d[e]]=k,"emission"===e&&(a.emissive=16777215)}}}}else"diffuse"!==e&&b||("emission"===e?a.emissive=f.color.getHex():a[e]=f.color.getHex());break;case"shininess":a[e]=this[e];break;case"reflectivity":a[e]=this[e],a[e]>0&&(a.envMap=Xa.defaultEnvMap),a.combine=THREE.MixOperation;break;case"index_of_refraction":a.refractionRatio=this[e],1!==this[e]&&(a.envMap=Xa.defaultEnvMap);break;case"transparency":}switch(a.shading=Wa,a.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==a.diffuse&&(a.color=a.diffuse,delete a.diffuse),this.type){case"constant":void 0!=a.emissive&&(a.color=a.emissive),this.material=new THREE.MeshBasicMaterial(a);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(a);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(a)}return this.material},X.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"init_from":this.init_from=c.textContent;break;case"format":this.format=c.textContent;break;default:console.log("unhandled Surface prop: "+c.nodeName)}}return this},Y.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"source":this.source=c.textContent;break;case"minfilter":this.minfilter=c.textContent;break;case"magfilter":this.magfilter=c.textContent;break;case"mipfilter":this.mipfilter=c.textContent;break;case"wrap_s":this.wrap_s=c.textContent;break;case"wrap_t":this.wrap_t=c.textContent;break;default:console.log("unhandled Sampler2D prop: "+c.nodeName)}}return this},Z.prototype.create=function(){if(null===this.shader)return null},Z.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),ta(this,a),this.shader=null;for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(c))}}return this},Z.prototype.parseNewparam=function(a){for(var b=a.getAttribute("sid"),c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"surface":this.surface[b]=new X(this).parse(d);break;case"sampler2D":this.sampler[b]=new Y(this).parse(d);break;case"extra":break;default:console.log(d.nodeName)}}},Z.prototype.parseProfileCOMMON=function(a){for(var b,c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"profile_COMMON":this.parseProfileCOMMON(d);break;case"technique":b=d;break;case"newparam":this.parseNewparam(d);break;case"image":var e=(new A).parse(d);Oa[e.id]=e;break;case"extra":break;default:console.log(d.nodeName)}}return b},Z.prototype.parseTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new W(c.nodeName,this).parse(c);break;case"extra":this.parseExtra(c)}}},Z.prototype.parseExtra=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique":this.parseExtraTechnique(c)}}},Z.prototype.parseExtraTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"bump":this.shader.parse(a)}}},$.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},_.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.source={};for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"animation":var d=(new _).parse(c);for(var e in d.source)this.source[e]=d.source[e];for(var f=0;f<d.channel.length;f++)this.channel.push(d.channel[f]),this.sampler.push(d.sampler[f]);break;case"source":var e=(new T).parse(c);this.source[e.id]=e;break;case"sampler":this.sampler.push(new ba(this).parse(c));break;case"channel":this.channel.push(new aa(this).parse(c))}}return this},aa.prototype.parse=function(a){this.source=a.getAttribute("source").replace(/^#/,""),this.target=a.getAttribute("target");var b=this.target.split("/"),c=(b.shift(),b.shift()),d=c.indexOf(".")>=0,e=c.indexOf("(")>=0;if(d)b=c.split("."),this.sid=b.shift(),this.member=b.shift();else if(e){var f=c.split("(");this.sid=f.shift();for(var g=0;g<f.length;g++)f[g]=parseInt(f[g].replace(/\)/,""));this.arrIndices=f}else this.sid=c;return this.fullSid=c,this.dotSyntax=d,this.arrSyntax=e,this},ba.prototype.parse=function(a){this.id=a.getAttribute("id"),this.inputs=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"input":this.inputs.push((new S).parse(c))}}return this},ba.prototype.create=function(){for(var a=0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.animation.source[b.source];switch(b.semantic){case"INPUT":this.input=c.read();break;case"OUTPUT":this.output=c.read(),this.strideOut=c.accessor.stride;break;case"INTERPOLATION":this.interpolation=c.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(b.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var a=0;a<this.input.length;a++)this.startTime=Math.min(this.startTime,this.input[a]),this.endTime=Math.max(this.endTime,this.input[a]);this.duration=this.endTime-this.startTime}},ba.prototype.getData=function(a,b,c){var d;if("matrix"===a&&16===this.strideOut)d=this.output[b];else if(this.strideOut>1){d=[],b*=this.strideOut;for(var e=0;e<this.strideOut;++e)d[e]=this.output[b+e];if(3===this.strideOut)switch(a){case"rotate":case"translate":va(d,-1);break;case"scale":va(d,1)}else 4===this.strideOut&&"matrix"===a&&va(d,-1)}else d=this.output[b],c&&"translate"===a&&(d=wa(c,d));return d},ca.prototype.addTarget=function(a,b,c,d){this.targets.push({sid:a,member:c,transform:b,data:d})},ca.prototype.apply=function(a){for(var b=0;b<this.targets.length;++b){var c=this.targets[b];a&&c.sid!==a||c.transform.update(c.data,c.member)}},ca.prototype.getTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return this.targets[b];return null},ca.prototype.hasTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return!0;return!1},ca.prototype.interpolate=function(a,b){for(var c=0,d=this.targets.length;c<d;c++){var e,f=this.targets[c],g=a.getTarget(f.sid);if("matrix"!==f.transform.type&&g){var h=(b-this.time)/(a.time-this.time),i=g.data,j=f.data;if(h<0&&(h=0),h>1&&(h=1),j.length){e=[];for(var k=0;k<j.length;++k)e[k]=j[k]+(i[k]-j[k])*h}else e=j+(i-j)*h}else e=f.data;f.transform.update(e,f.member)}},da.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"optics":this.parseOptics(c)}}return this},da.prototype.parseOptics=function(a){for(var b=0;b<a.childNodes.length;b++)if("technique_common"===a.childNodes[b].nodeName)for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++)if(this.technique=c.childNodes[d].nodeName,"perspective"===this.technique)for(var e=c.childNodes[d],f=0;f<e.childNodes.length;f++){var g=e.childNodes[f];switch(g.nodeName){case"yfov":this.yfov=g.textContent;break;case"xfov":this.xfov=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}else if("orthographic"===this.technique)for(var h=c.childNodes[d],f=0;f<h.childNodes.length;f++){var g=h.childNodes[f];switch(g.nodeName){case"xmag":this.xmag=g.textContent;break;case"ymag":this.ymag=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}return this},ea.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},fa.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c);break;case"technique":this.parseTechnique(c)}}return this},fa.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++)switch(a.childNodes[b].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=a.childNodes[b].nodeName;for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];switch(e.nodeName){case"color":var f=na(e.textContent);this.color=new THREE.Color(0),this.color.setRGB(f[0],f[1],f[2]),this.color.a=f[3];break;case"falloff_angle":this.falloff_angle=parseFloat(e.textContent);break;case"quadratic_attenuation":var g=parseFloat(e.textContent);this.distance=g?Math.sqrt(1/g):0}}}return this},fa.prototype.parseTechnique=function(a){this.profile=a.getAttribute("profile");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"intensity":this.intensity=parseFloat(c.textContent)}}return this},ga.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},ha.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.joints=[],this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c)}}return this},ha.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(a.childNodes[b].nodeName){case"joint":this.joints.push((new ia).parse(c));break;case"link":this.links.push((new ja).parse(c))}}return this},ia.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var b=a.querySelector("axis"),c=na(b.textContent);this.axis=xa(c,0);var d=a.querySelector("limits min")?parseFloat(a.querySelector("limits min").textContent):-360,e=a.querySelector("limits max")?parseFloat(a.querySelector("limits max").textContent):360;this.limits={min:d,max:e};for(var f=["prismatic","revolute"],g=0;g<f.length;g++){var h=f[g],i=a.querySelector(h);i&&(this.type=h)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},ja.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.transforms=[],this.attachments=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"attachment_full":this.attachments.push((new ka).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new G).parse(c))}}return this},ka.prototype.parse=function(a){this.joint=a.getAttribute("joint").split("/").pop(),this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"link":this.links.push((new ja).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new G).parse(c))}}return this},{load:a,parse:b,setPreferredShading:c,applySkin:p,geometries:Ra,options:Xa}};var global=window;!function(a,b){"object"==typeof exports?b(module.exports):"function"==typeof define&&define.amd?define([],function(){return b(a)}):b(a)}(this,function(a){"use strict";var b=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","animations","scenes"],c=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(a){this._rootDescription=a},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(a){var b=new RegExp("^"+window.location.protocol,"i");return!!a.match(b)}},resolvePathIfNeeded:{value:function(a){if(this._isAbsolutePath(a))return a;var b=/^data:/;return b.test(a)?a:this.baseURL+a}},_resolvePathsForCategories:{value:function(a){a.forEach(function(a){var b=this.json[a];if(b){var c=Object.keys(b);c.forEach(function(a){var c=b[a];c.uri=this.resolvePathIfNeeded(c.uri)},this)}},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(a){this._json!==a&&(this._json=a,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(a,b){var c=null,d=b;return c=this.rootDescription[d],c?c?c[a]:null:(console.log("ERROR:CANNOT find expected category named:"+d),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),this._state.categoryIndex!==-1&&(this._state.categoryState.index=0,!0)}},_stepToNextDescription:{enumerable:!1,value:function(){var a=this._state.categoryState,b=a.keys;return b?(a.index++,a.keys=null,a.index>=b.length&&this._stepToNextCategory()):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(a){return!!this.rootDescription[a]}},_handleState:{value:function(){for(var a={buffers:this.handleBuffer,bufferViews:this.handleBufferView,shaders:this.handleShader,programs:this.handleProgram,techniques:this.handleTechnique,materials:this.handleMaterial,meshes:this.handleMesh,cameras:this.handleCamera,lights:this.handleLight,nodes:this.handleNode,scenes:this.handleScene,images:this.handleImage,animations:this.handleAnimation,accessors:this.handleAccessor,skins:this.handleSkin,samplers:this.handleSampler,textures:this.handleTexture,videos:this.handleVideo,extensions:this.handleExtension},c=!0;this._state.categoryIndex!==-1;){var d=b[this._state.categoryIndex],e=this._state.categoryState,f=e.keys;if(f||(e.keys=f=Object.keys(this.rootDescription[d]),!f||0!=f.length)){var g=d,h=f[e.index],i=this.getEntryDescription(h,g);if(i){if(a[g]&&a[g].call(this,h,i,this._state.userInfo)===!1){c=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+h),c=!1;break}}else this._stepToNextDescription()}this.handleLoadCompleted&&this.handleLoadCompleted(c)}},_loadJSONIfNeeded:{enumerable:!0,value:function(a){var b=this;if(this._json)a&&a(this.json);else{var c=this._path,d=c.lastIndexOf("/");this.baseURL=0!==d?c.substring(0,d+1):"";var e=new XMLHttpRequest;e.open("GET",c,!0),e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(b.json=JSON.parse(e.responseText),a&&a(b.json))},e.send(null)}}},_buildLoader:{value:function(a){function b(b){c.rootDescription=b,a&&a(this)}var c=this;this._loadJSONIfNeeded(b)}},_state:{value:null,writable:!0},_getEntryType:{value:function(a){for(var c=b,d=0;d<c.length;d++){var e=this.rootDescription[c[d]];if(e)return c[d]}return null}},getNextCategoryIndex:{value:function(a){for(var c=a;c<b.length;c++)if(this.hasCategory(b[c]))return c;return-1}},load:{enumerable:!0,value:function(a,b){var c=this;this._buildLoader(function(d){var e=c.getNextCategoryIndex.call(c,0);e!==-1&&(c._state={userInfo:a,options:b,categoryIndex:e,categoryState:{index:"0"}},c._handleState())})}},initWithPath:{value:function(a){return this._path=a,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return"undefined"==typeof this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(a,b){return this.json=a,this.baseURL=b,b||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}});return a&&(a.glTFParser=c),c}),THREE.glTFLoader=function(){this.meshesRequested=0,this.meshesLoaded=0,this.pendingMeshes=[],this.animationsRequested=0,this.animationsLoaded=0,this.animations=[],this.shadersRequested=0,this.shadersLoaded=0,this.shaders={},this.loadRequests=[],THREE.glTFShaders.removeAll(),THREE.Loader.call(this)},THREE.glTFLoader.prototype=new THREE.Loader,THREE.glTFLoader.prototype.constructor=THREE.glTFLoader,THREE.glTFLoader.prototype.load=function(url,callback){function RgbArraytoHex(a){if(!a)return 4294967295;var b=Math.floor(255*a[0]),c=Math.floor(255*a[1]),d=Math.floor(255*a[2]),e=255,f=(e<<24)+(b<<16)+(c<<8)+d;return f}function componentsPerElementForGLType(a){switch(a){case"SCALAR":nElements=1;break;case"VEC2":nElements=2;break;case"VEC3":nElements=3;break;case"VEC4":nElements=4;break;case"MAT2":nElements=4;break;case"MAT3":nElements=9;break;case"MAT4":nElements=16}return nElements}function replaceShaderDefinitions(shader,material){var program=material.params.program,shaderParams=material.params.technique.parameters,shaderAttributes=material.params.technique.attributes,params={};for(var attribute in material.params.attributes){var pname=shaderAttributes[attribute],shaderParam=shaderParams[pname],semantic=shaderParam.semantic;semantic&&(params[attribute]=shaderParam)}var s=shader,r="";for(var pname in params){var param=params[pname],semantic=param.semantic;switch(r=eval("/"+pname+"/g"),semantic){case"POSITION":s=s.replace(r,"position");break;case"NORMAL":s=s.replace(r,"normal");break;case"TEXCOORD_0":s=s.replace(r,"uv");break;case"WEIGHT":s=s.replace(r,"skinWeight");
break;case"JOINT":s=s.replace(r,"skinIndex")}}return s}function replaceShaderSemantics(a){var b=theLoader.shaders[a.params.vertexShader];b&&(b=replaceShaderDefinitions(b,a),theLoader.shaders[a.params.vertexShader]=b)}function createShaderMaterial(a){replaceShaderSemantics(a);var b=theLoader.shaders[a.params.fragmentShader];if(!b)return console.log("ERROR: Missing fragment shader definition:",a.params.fragmentShader),new THREE.MeshPhongMaterial;var c=theLoader.shaders[a.params.vertexShader];if(!c)return console.log("ERROR: Missing vertex shader definition:",a.params.vertexShader),new THREE.MeshPhongMaterial;var d=THREE.UniformsUtils.clone(a.params.uniforms);for(uniform in a.params.uniforms){var e=a.params.uniforms[uniform],f=d[uniform];"t"==f.type&&(f.value=e.value)}var g=new THREE.RawShaderMaterial({fragmentShader:b,vertexShader:c,uniforms:d,transparent:a.params.transparent});return g}function LoadTexture(a){function b(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function c(a,c){for(var d=b(a,c),e=new ArrayBuffer(d.length),f=new Uint8Array(e),g=0;g<d.length;g++)f[g]=d.charCodeAt(g);return e}function d(a,d){d="undefined"!=typeof d?d:"";var e=a[1],f=!!a[2],g=a[3];switch(d){case"":case"text":return b(f,g);case"ArrayBuffer":return c(f,g);case"blob":var h=c(f,g);return new Blob([h],{type:e});case"document":var i=new DOMParser;return i.parseFromString(b(f,g),e);case"json":return JSON.parse(b(f,g));default:throw"Unhandled responseType: "+d}}if(!a)return null;var e=function(a,b,c){var d=new Image;d.onload=function(){b(d)},"undefined"!=typeof c&&(d.onerror=c),d.src=a},f=/^data:(.*?)(;base64)?,(.*)$/,g=f.exec(a);if(null!==g){var h=new THREE.Texture,i=d(g,"blob"),j=window.URL.createObjectURL(i);return e(j,function(a){h.image=a,h.needsUpdate=!0}),h}return(new THREE.TextureLoader).load(a)}function CreateTexture(a,b){var c=null,d=null;if(b){var e=b;if(e){var f=a.getEntry(e);if(f){var g=a.getEntry(f.description.source);g&&(c=g.description.uri);var h=a.getEntry(f.description.sampler);h&&(d=h.description)}}}var e=LoadTexture(c);return e&&d&&(d.wrapS==WebGLRenderingContext.REPEAT&&(e.wrapS=THREE.RepeatWrapping),d.wrapT==WebGLRenderingContext.REPEAT&&(e.wrapT=THREE.RepeatWrapping),d.magFilter==WebGLRenderingContext.LINEAR&&(e.magFilter=THREE.LinearFilter)),e}var theLoader=this,ClassicGeometry=function(){this.geometry=new THREE.BufferGeometry,this.totalAttributes=0,this.loadedAttributes=0,this.indicesLoaded=!1,this.finished=!1,this.onload=null,this.uvs=null,this.indexArray=null};ClassicGeometry.prototype.constructor=ClassicGeometry,ClassicGeometry.prototype.buildBufferGeometry=function(){var a=this.geometry;a.setIndex(new THREE.BufferAttribute(this.indexArray,1));var b={start:0,index:0,count:this.indexArray.length};a.groups.push(b),a.computeBoundingSphere()},ClassicGeometry.prototype.checkFinished=function(){this.indexArray&&this.loadedAttributes===this.totalAttributes&&(this.buildBufferGeometry(),this.finished=!0,this.onload&&this.onload())};var IndicesDelegate=function(){};IndicesDelegate.prototype.handleError=function(a,b){console.log("ERROR(IndicesDelegate):"+a+":"+b)},IndicesDelegate.prototype.convert=function(a,b){return new Uint16Array(a,0,b.indices.count)},IndicesDelegate.prototype.resourceAvailable=function(a,b){var c=b.geometry;return c.indexArray=a,c.checkFinished(),!0};var indicesDelegate=new IndicesDelegate,IndicesContext=function(a,b){this.indices=a,this.geometry=b},VertexAttributeDelegate=function(){};VertexAttributeDelegate.prototype.handleError=function(a,b){console.log("ERROR(VertexAttributeDelegate):"+a+":"+b)},VertexAttributeDelegate.prototype.convert=function(a,b){return a},VertexAttributeDelegate.prototype.bufferResourceAvailable=function(a,b){var c,d,e,f=b.geometry,g=b.attribute,h=b.semantic;if("POSITION"==h)c=new Float32Array(a,0,g.count*componentsPerElementForGLType(g.type)),f.geometry.addAttribute("position",new THREE.BufferAttribute(c,3));else if("NORMAL"==h)e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),f.geometry.addAttribute("normal",new THREE.BufferAttribute(c,3));else if("TEXCOORD_0"==h||"TEXCOORD"==h){for(e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),d=0;d<c.length/2;d++)c[2*d+1]=1-c[2*d+1];f.geometry.addAttribute("uv",new THREE.BufferAttribute(c,e))}else"WEIGHT"==h?(e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),f.geometry.addAttribute("skinWeight",new THREE.BufferAttribute(c,e))):"JOINT"==h&&(e=componentsPerElementForGLType(g.type),c=new Float32Array(a,0,g.count*e),f.geometry.addAttribute("skinIndex",new THREE.BufferAttribute(c,e)))},VertexAttributeDelegate.prototype.resourceAvailable=function(a,b){this.bufferResourceAvailable(a,b);var c=b.geometry;return c.loadedAttributes++,c.checkFinished(),!0};var vertexAttributeDelegate=new VertexAttributeDelegate,VertexAttributeContext=function(a,b,c){this.attribute=a,this.semantic=b,this.geometry=c},Mesh=function(){this.primitives=[],this.materialsPending=[],this.loadedGeometry=0,this.onCompleteCallbacks=[]};Mesh.prototype.addPrimitive=function(a,b){var c=this;a.onload=function(){c.loadedGeometry++,c.checkComplete()},this.primitives.push({geometry:a,material:b,mesh:null})},Mesh.prototype.onComplete=function(a){this.onCompleteCallbacks.push(a)},Mesh.prototype.checkComplete=function(){var a=this;this.onCompleteCallbacks.length&&this.primitives.length==this.loadedGeometry&&(this.onCompleteCallbacks.forEach(function(b){b(a)}),this.onCompleteCallbacks=[])},Mesh.prototype.attachToNode=function(a){var b=this;this.primitives.forEach(function(c){var d=c.material,e=d.params;if(d instanceof THREE.Material||(d=createShaderMaterial(d)),!b.skin){var f=new THREE.Mesh(c.geometry.geometry,d);if(f.castShadow=!0,a.add(f),d instanceof THREE.ShaderMaterial){var g=new THREE.glTFShader(d,e,f,theLoader.rootObj);THREE.glTFShaders.add(g)}}})};var Material=function(a){this.params=a},AnimationParameterDelegate=function(){};AnimationParameterDelegate.prototype.handleError=function(a,b){console.log("ERROR(AnimationParameterDelegate):"+a+":"+b)},AnimationParameterDelegate.prototype.convert=function(a,b){var c=b.parameter,d=null;switch(c.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":d=new Float32Array(a,0,c.count*componentsPerElementForGLType(c.type))}return d},AnimationParameterDelegate.prototype.resourceAvailable=function(a,b){var c=b.animation,d=b.parameter;return d.data=a,c.handleParameterLoaded(d),!0};var animationParameterDelegate=new AnimationParameterDelegate,AnimationParameterContext=function(a,b){this.parameter=a,this.animation=b},Animation=function(){this.totalParameters=0,this.loadedParameters=0,this.parameters={},this.finishedLoading=!1,this.onload=null};Animation.prototype.constructor=Animation,Animation.prototype.handleParameterLoaded=function(a){this.parameters[a.name]=a,this.loadedParameters++,this.checkFinished()},Animation.prototype.checkFinished=function(){this.loadedParameters===this.totalParameters&&(this.finishedLoading=!0,this.onload&&this.onload())};var InverseBindMatricesDelegate=function(){};InverseBindMatricesDelegate.prototype.handleError=function(a,b){console.log("ERROR(InverseBindMatricesDelegate):"+a+":"+b)},InverseBindMatricesDelegate.prototype.convert=function(a,b){var c=b.parameter,d=null;switch(c.type){case"MAT4":d=new Float32Array(a,0,c.count*componentsPerElementForGLType(c.type))}return d},InverseBindMatricesDelegate.prototype.resourceAvailable=function(a,b){var c=b.skin;return c.inverseBindMatrices=a,!0};var inverseBindMatricesDelegate=new InverseBindMatricesDelegate,InverseBindMatricesContext=function(a,b){this.parameter=a,this.skin=b},ShaderDelegate=function(){};ShaderDelegate.prototype.handleError=function(a,b){console.log("ERROR(ShaderDelegate):"+a+":"+b)},ShaderDelegate.prototype.convert=function(a,b){return a},ShaderDelegate.prototype.resourceAvailable=function(a,b){return theLoader.shadersLoaded++,theLoader.shaders[b.id]=a,!0};var shaderDelegate=new ShaderDelegate,ShaderContext=function(a,b){this.id=a,this.uri=b},ResourceEntry=function(a,b,c){this.entryID=a,this.object=b,this.description=c},Resources=function(){this._entries={}};Resources.prototype.setEntry=function(a,b,c){return a?(this._entries[a]&&console.warn("entry["+a+"] is being overwritten"),void(this._entries[a]=new ResourceEntry(a,b,c))):void console.error("No EntryID provided, cannot store",c)},Resources.prototype.getEntry=function(a){return this._entries[a]},Resources.prototype.clearEntries=function(){this._entries={}},LoadDelegate=function(){},LoadDelegate.prototype.loadCompleted=function(a,b){a.call(Window,b)};var ThreeGLTFLoader=Object.create(glTFParser,{load:{enumerable:!0,value:function(a,b){this.resources=new Resources,this.cameras=[],this.lights=[],this.animations=[],this.joints={},THREE.GLTFLoaderUtils.init(),glTFParser.load.call(this,a,b)}},cameras:{enumerable:!0,writable:!0,value:[]},lights:{enumerable:!0,writable:!0,value:[]},animations:{enumerable:!0,writable:!0,value:[]},handleBuffer:{value:function(a,b,c){return this.resources.setEntry(a,null,b),b.type="ArrayBuffer",!0}},handleBufferView:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d=this.resources.getEntry(b.buffer);b.type="ArrayBufferView";var e=this.resources.getEntry(a);return e.buffer=d,!0}},handleShader:{value:function(a,b,c){this.resources.setEntry(a,null,b);var d={id:a,uri:b.uri},e=new ShaderContext(a,b.uri);return theLoader.shadersRequested++,THREE.GLTFLoaderUtils.getFile(d,shaderDelegate,e),!0}},handleProgram:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},handleTechnique:{value:function(a,b,c){return b.refCount=0,this.resources.setEntry(a,null,b),!0}},createShaderParams:{value:function(a,b,c,d,e){var f=this.resources.getEntry(d);if(c.uniforms={},c.attributes={},c.program=f,c.technique=e,f){c.fragmentShader=f.description.fragmentShader,c.vertexShader=f.description.vertexShader;for(var g in e.uniforms){var h,i,j=e.uniforms[g],k=e.parameters[j],l=k.type,m=k.count,n=b[j],o="";switch(l){case WebGLRenderingContext.FLOAT:if(o="f",h=k.value,"transparency"==j){var p=!0,q=p?n:1-n;h=q,c.transparent=!0}break;case WebGLRenderingContext.FLOAT_VEC2:if(o="v2",h=new THREE.Vector2,k&&k.value){var r=k.value;h.fromArray(r)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_VEC3:if(o="v3",h=new THREE.Vector3,k&&k.value){var s=k.value;h.fromArray(s)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_VEC4:if(o="v4",h=new THREE.Vector4,k&&k.value){var t=k.value;h.fromArray(t)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_MAT2:console.log("Warning: FLOAT_MAT2");break;case WebGLRenderingContext.FLOAT_MAT3:if(o="m3",h=new THREE.Matrix3,k&&k.value){var u=k.value;h.fromArray(u)}n&&h.fromArray(n);break;case WebGLRenderingContext.FLOAT_MAT4:if(void 0!==m){o="m4v",h=new Array(m);for(var v=0;v<m;v++)h[v]=new THREE.Matrix4;if(i=m,k&&k.value){var w=k.value;h.fromArray(w)}n&&h.fromArray(n)}else{if(o="m4",h=new THREE.Matrix4,k&&k.value){var x=k.value;h.fromArray(x)}n&&h.fromArray(n)}break;case WebGLRenderingContext.SAMPLER_2D:o="t",h=n?CreateTexture(this.resources,n):null;break;default:throw new Error("Unknown shader uniform param type: "+l+" - "+theLoader.idx[l])}var y={type:o,value:h,length:i};c.uniforms[g]=y}for(var z in e.attributes){var j=e.attributes[z],A=e.parameters[j],B=A.type,C=A.semantic,D={type:B,semantic:C};c.attributes[z]=D}}}},threeJSMaterialType:{value:function(a,b,c){var d,e=b.extensions,f=e?e.KHR_materials_common:null,g=null;if(f){switch(f.technique){case"BLINN":case"PHONG":g=THREE.MeshPhongMaterial;break;case"LAMBERT":g=THREE.MeshLambertMaterial;break;case"CONSTANT":default:g=THREE.MeshBasicMaterial}f.doubleSided&&(c.side=THREE.DoubleSide),f.transparent&&(c.transparent=!0),d={};for(prop in f.values)d[prop]=f.values[prop]}else{var h=b.technique?this.resources.getEntry(b.technique):null;d=b.values;var i=h.description;++i.refCount>1;var j=i.program;this.createShaderParams(a,d,c,j,i);var k=!0;k&&(g=Material)}d.diffuse&&"string"==typeof d.diffuse&&(c.map=CreateTexture(this.resources,d.diffuse)),d.reflective&&"string"==typeof d.reflective&&(c.envMap=CreateTexture(this.resources,d.reflective));var l=d.shininesss||d.shininess;l&&(l=l);var m=null;c.map||(m=d.diffuse);var n=1;if(d.hasOwnProperty("transparency")){var o=!0;n=o?d.transparency:1-d.transparency}return c.color=RgbArraytoHex(m),c.opacity=n,c.transparent=n<1,c.map&&c.map.sourceFile.toLowerCase().indexOf(".png")!=-1&&(c.transparent=!0),void 0!==l&&(c.shininess=Math.max(l,1e-4)),delete c.ambient,void 0!==d.ambient&&"string"!=typeof d.ambient,void 0!==d.emission&&(c.emissive=RgbArraytoHex(d.emission)),void 0!==d.specular&&(c.specular=RgbArraytoHex(d.specular)),g}},handleMaterial:{value:function(a,b,c){var d={},e=this.threeJSMaterialType(a,b,d),f=new e(d);return this.resources.setEntry(a,f,b),!0}},handleMesh:{value:function(a,b,c){var d=new Mesh;this.resources.setEntry(a,d,b);var e=b.primitives;if(!e)return console.log("MISSING_PRIMITIVES for mesh:"+a),!1;for(var f=0;f<e.length;f++){var g=e[f];if(g.mode===WebGLRenderingContext.TRIANGLES){var h=new ClassicGeometry,i=this.resources.getEntry(g.material);d.addPrimitive(h,i.object);var j=Object.keys(g.attributes);j.forEach(function(a){h.totalAttributes++},this);var k=this.resources.getEntry(g.indices),l=this.resources.getEntry(k.description.bufferView),m={bufferView:l,byteOffset:k.description.byteOffset,count:k.description.count,id:k.entryID,componentType:k.description.componentType,type:k.description.type},n=new IndicesContext(m,h),o={indicesObject:m,indicesDelegate:indicesDelegate,indicesContext:n};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.indicesObject,a.indicesDelegate,a.indicesContext);b&&a.indicesDelegate.resourceAvailable(b,a.indicesContext)},o),j.forEach(function(a){var c,d=g.attributes[a],e=this.resources.getEntry(d);if(e){c=e.object,c.id=d;var f=this.resources.getEntry(c.bufferView)}else{c=b.attributes[d],c.id=d,this.resources.setEntry(d,c,c);var f=this.resources.getEntry(c.bufferView);e=this.resources.getEntry(d)}var i={bufferView:f,byteOffset:c.byteOffset,byteStride:c.byteStride,count:c.count,max:c.max,min:c.min,componentType:c.componentType,type:c.type,id:d},j=new VertexAttributeContext(i,a,h),k={attributeObject:i,vertexAttributeDelegate:vertexAttributeDelegate,attribContext:j};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.attributeObject,a.vertexAttributeDelegate,a.attribContext);b&&a.vertexAttributeDelegate.resourceAvailable(b,a.attribContext)},k)},this)}}return!0}},handleCamera:{value:function(a,b,c){var d;if("perspective"==b.type){var e=b.perspective.znear,f=b.perspective.zfar,g=b.perspective.yfov,h=b.perspective.xfov,i=b.perspective.aspect_ratio;i||(i=1),void 0===h&&g&&(h=g*i),void 0===g&&h&&(g=h/i),h&&(h=THREE.Math.radToDeg(h),d=new THREE.PerspectiveCamera(h,i,e,f))}else d=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e,f);return d&&this.resources.setEntry(a,d,b),!0}},handleLight:{value:function(a,b,c){var d=null,e=b.type;if(e&&b[e]){var f=b[e],g=RgbArraytoHex(f.color);switch(e){case"directional":d=new THREE.DirectionalLight(g),d.position.set(0,0,1);break;case"point":d=new THREE.PointLight(g);break;case"spot ":d=new THREE.SpotLight(g),d.position.set(0,0,1);break;case"ambient":d=new THREE.AmbientLight(g)}}return d&&this.resources.setEntry(a,d,b),!0}},addPendingMesh:{value:function(a,b){theLoader.pendingMeshes.push({mesh:a,node:b})}},handleNode:{value:function(a,b,c){var d=null;b.jointName?(d=new THREE.Bone,d.jointName=b.jointName,this.joints[b.jointName]=a):d=new THREE.Object3D,d.name=b.name,d.glTFID=a,d.glTF=b,this.resources.setEntry(a,d,b);var e=b.matrix;if(e)d.matrixAutoUpdate=!1,d.applyMatrix((new THREE.Matrix4).set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]));else{var f=b.translation,g=b.rotation,h=b.scale,i=f?new THREE.Vector3(f[0],f[1],f[2]):new THREE.Vector3,j=g?new THREE.Quaternion(g[0],g[1],g[2],g[3]):new THREE.Quaternion,k=h?new THREE.Vector3(h[0],h[1],h[2]):new THREE.Vector3(1,1,1),l=new THREE.Matrix4;l.compose(i,j,k),d.matrixAutoUpdate=!1,d.applyMatrix(l)}var m=this;if(b.meshes){b.meshInstances={};var n;b.skin&&(n=this.resources.getEntry(b.skin)),b.meshes.forEach(function(a){meshEntry=this.resources.getEntry(a),theLoader.meshesRequested++,meshEntry.object.onComplete(function(c){m.addPendingMesh(c,d),b.meshInstances[a]=meshEntry.object,n&&(c.skin=n,b.instanceSkin=n.object),theLoader.meshesLoaded++,theLoader.checkComplete()})},this)}if(b.camera){var o=this.resources.getEntry(b.camera);o&&(d.add(o.object),this.cameras.push(o.object))}if(b.extensions&&b.extensions.KHR_materials_common&&b.extensions.KHR_materials_common.light){var p=b.extensions.KHR_materials_common.light,q=this.resources.getEntry(p);q&&(d.add(q.object),this.lights.push(q.object))}return!0}},handleExtension:{value:function(a,b,c){switch(a){case"KHR_materials_common":var d=b.lights;for(lightID in d){var e=d[lightID];this.handleLight(lightID,e)}}return!0}},buildNodeHirerachy:{value:function(a,b){var c=this.resources.getEntry(a),d=c.object;b.add(d);var e=c.description.children;return e&&e.forEach(function(a){this.buildNodeHirerachy(a,d)},this),d}},buildSkin:{value:function(a){var b=a.glTF,c=b.instanceSkin,d=b.skeletons;c&&d.forEach(function(d){var e=this.resources.getEntry(d);if(e){var f=e.object;a.add(f);var g=!0;for(meshID in b.meshInstances){var h=b.meshInstances[meshID],i=null;h.primitives.forEach(function(b){var e=b.material,f=e.params;if(e instanceof THREE.Material||(e=createShaderMaterial(e)),i=new THREE.SkinnedMesh(b.geometry.geometry,e,!1),b.geometry.geometry,i&&g){e.skinning=!0;var h,j=c.jointNames,k=[],l=[],m=[],n=j.length;for(h=0;h<n;h++){var o=j[h],p=this.joints[o],q=this.resources.getEntry(p).object;if(q){q.skin=i,k.push(q),l.push(q);var r=c.inverseBindMatrices,s=(new THREE.Matrix4).set(r[16*h+0],r[16*h+4],r[16*h+8],r[16*h+12],r[16*h+1],r[16*h+5],r[16*h+9],r[16*h+13],r[16*h+2],r[16*h+6],r[16*h+10],r[16*h+14],r[16*h+3],r[16*h+7],r[16*h+11],r[16*h+15]);m.push(s)}else console.log("WARNING: jointName:"+o+" cannot be found in skeleton:"+d)}i.bind(new THREE.Skeleton(l,m,!1),c.bindShapeMatrix)}if(i&&(i.castShadow=!0,a.add(i),e instanceof THREE.ShaderMaterial)){f.joints=k;var t=new THREE.glTFShader(e,f,i,theLoader.rootObj);THREE.glTFShaders.add(t)}},this)}}},this)}},buildSkins:{value:function(a){a.glTF&&a.glTF.instanceSkin&&this.buildSkin(a);var b=a.children;b&&b.forEach(function(a){this.buildSkins(a)},this)}},createMeshAnimations:{value:function(a){this.buildSkins(a)}},handleScene:{value:function(a,b,c){return b.nodes?(b.nodes.forEach(function(a){this.buildNodeHirerachy(a,c.rootObj)},this),this.delegate&&this.delegate.loadCompleted(c.callback,c.rootObj),theLoader.loadAllAssets(),!0):(console.log("ERROR: invalid file required nodes property is missing from scene"),!1)}},handleImage:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},addNodeAnimationChannel:{value:function(a,b,c){this.nodeAnimationChannels||(this.nodeAnimationChannels={}),this.nodeAnimationChannels[a]||(this.nodeAnimationChannels[a]=[]),this.nodeAnimationChannels[a].push(c)}},createAnimations:{value:function(){for(var a in this.nodeAnimationChannels){var b=this.nodeAnimationChannels[a],c=(b.length,new THREE.glTFAnimation(b));c.name="animation_"+a,this.animations.push(c)}}},buildAnimation:{value:function(a){var b,c=[],d=a.channels.length;for(b=0;b<d;b++){var e=a.channels[b],f=a.samplers[e.sampler];if(f){var g=a.parameters[f.input];if(g&&g.data){var h=a.parameters[f.output];if(h&&h.data){var i=e.target,j=this.resources.getEntry(i.id);if(j){var k=i.path,l={keys:g.data,values:h.data,count:g.count,target:j.object,path:k,type:f.interpolation};this.addNodeAnimationChannel(i.id,e,l),c.push(l)}}}}}}},handleAnimation:{value:function(a,b,c){theLoader.animationsRequested++;var d=new Animation;d.name=a,d.onload=function(){theLoader.animationsLoaded++,theLoader.animations.push(d),theLoader.checkComplete()},d.channels=b.channels,d.samplers=b.samplers,this.resources.setEntry(a,d,b);var e=b.parameters;if(!e)return console.log("MISSING_PARAMETERS for animation:"+a),!1;var f=Object.keys(e);f.forEach(function(a){d.totalParameters++},this);var f=Object.keys(e);return f.forEach(function(a){var b=e[a],c=this.resources.getEntry(b);c=c.object;var f=this.resources.getEntry(c.bufferView),g={bufferView:f,byteOffset:c.byteOffset,count:c.count,componentType:c.componentType,type:c.type,id:c.bufferView,name:a},h=new AnimationParameterContext(g,d),i={paramObject:g,animationParameterDelegate:animationParameterDelegate,paramContext:h};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.paramObject,a.animationParameterDelegate,a.paramContext);b&&a.animationParameterDelegate.resourceAvailable(b,a.paramContext)},i)},this),!0}},handleAccessor:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleSkin:{value:function(a,b,c){var d={},e=b.bindShapeMatrix;d.bindShapeMatrix=(new THREE.Matrix4).set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]),d.jointNames=b.jointNames;var f=this.resources.getEntry(b.inverseBindMatrices);f=f.description,d.inverseBindMatricesDescription=f,d.inverseBindMatricesDescription.id=b.inverseBindMatrices;var g=this.resources.getEntry(f.bufferView),h={bufferView:g,byteOffset:f.byteOffset,count:f.count,componentType:f.componentType,type:f.type,id:f.bufferView,name:d.inverseBindMatricesDescription.id},i=new InverseBindMatricesContext(h,d),j={paramObject:h,inverseBindMatricesDelegate:inverseBindMatricesDelegate,context:i};theLoader.scheduleLoad(function(a){var b=THREE.GLTFLoaderUtils.getBuffer(a.paramObject,a.inverseBindMatricesDelegate,a.context);b&&a.inverseBindMatricesDelegate.resourceAvailable(b,a.context)},j);var k=this.resources.getEntry(d.inverseBindMatricesDescription.bufferView);return d.inverseBindMatricesDescription.bufferView=k.object,this.resources.setEntry(a,d,b),!0}},handleSampler:{value:function(a,b,c){return this.resources.setEntry(a,b,b),!0}},handleTexture:{value:function(a,b,c){return this.resources.setEntry(a,null,b),!0}},handleError:{value:function(a){throw new Error(a)}},_delegate:{value:new LoadDelegate,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(a){this._delegate=a}}}),Context=function(a,b){this.rootObj=a,this.callback=b},rootObj=new THREE.Object3D,self=this,loader=Object.create(ThreeGLTFLoader);return loader.initWithPath(url),loader.load(new Context(rootObj,function(a){}),null),this.loader=loader,this.callback=callback,this.rootObj=rootObj,rootObj},THREE.glTFLoader.prototype.scheduleLoad=function(a,b){this.loadRequests.push({fn:a,data:b})},THREE.glTFLoader.prototype.loadAllAssets=function(){for(var a=0,b=this.loadRequests.length;a<b;a++){var c=this.loadRequests[a];c.fn(c.data)}},THREE.glTFLoader.prototype.callLoadedCallback=function(){var a={scene:this.rootObj,cameras:this.loader.cameras,animations:this.loader.animations,shaders:this.loader.shaders};this.callback(a)},THREE.glTFLoader.prototype.checkComplete=function(){if(this.meshesLoaded==this.meshesRequested&&this.shadersLoaded==this.shadersRequested&&this.animationsLoaded==this.animationsRequested){for(var a=0;a<this.pendingMeshes.length;a++){var b=this.pendingMeshes[a];b.mesh.attachToNode(b.node)}for(var a=0;a<this.animationsLoaded;a++){var c=this.animations[a];this.loader.buildAnimation(c)}this.loader.createAnimations(),this.loader.createMeshAnimations(this.rootObj),THREE.glTFShaders.bindShaderParameters(this.rootObj),this.callLoadedCallback()}},THREE.GLTFLoaderUtils=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(a){return!!this._resources[a]}},_storeResource:{enumerable:!1,value:function(a,b){return a?(this._containsResource[a]&&console.log("WARNING: resource:"+a+" is already stored, overriding"),void(this._resources[a]=b)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(a){return this._resources[a]}},_loadStream:{value:function(a,b,c){function d(a,b){var c=decodeURIComponent(b);return a?atob(c):c}function e(a,b){for(var c=d(a,b),e=new ArrayBuffer(c.length),f=new Uint8Array(e),g=0;g<c.length;g++)f[g]=c.charCodeAt(g);return e}function f(a,b){b="undefined"!=typeof b?b:"";var c=a[1],f=!!a[2],g=a[3];switch(b){case"":case"text":return d(f,g);case"ArrayBuffer":return e(f,g);case"blob":var h=e(f,g);return new Blob([h],{type:c});case"document":var i=new DOMParser;return i.parseFromString(d(f,g),c);case"json":return JSON.parse(d(f,g));default:throw"Unhandled responseType: "+b}}var g=/^data:(.*?)(;base64)?,(.*)$/,h=g.exec(a);if(null!==h)return void c.streamAvailable(a,f(h,b));if(!b)return void c.handleError(THREE.GLTFLoaderUtils.INVALID_TYPE,null);if(!a)return void c.handleError(THREE.GLTFLoaderUtils.INVALID_PATH);var i=new XMLHttpRequest;i.open("GET",a,!0),i.responseType=b===this.ARRAY_BUFFER?"arraybuffer":"text",i.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),i.onload=function(b){200==i.status||206==i.status?c.streamAvailable(a,i.response):c.handleError(THREE.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},i.send(null)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(a){var b=this._resourcesStatus[a.id];b?this._resourcesStatus[a.id]++:this._resourcesStatus[a.id]=1;var c=this._streamsStatus[a.uri];if(c&&"loading"===c.status)return void c.requests.push(a);this._streamsStatus[a.uri]={status:"loading",requests:[a]};var d=this,e={};e.streamAvailable=function(a,b){var c=d._streamsStatus[a],e=c.requests;e.forEach(function(a){var c=b.slice(a.range[0],a.range[1]),e=a.delegate.convert(c,a.ctx);d._storeResource(a.id,e),a.delegate.resourceAvailable(e,a.ctx),--d._resourcesStatus[a.id]},this),delete d._streamsStatus[a]},e.handleError=function(b,c){a.delegate.handleError(b,c)},this._loadStream(a.uri,a.type,e)}},_elementSizeForGLType:{value:function(a,b){var c=0;switch(b){case"SCALAR":c=1;break;case"VEC2":c=2;break;case"VEC3":c=3;break;case"VEC4":c=4;break;case"MAT2":c=4;break;case"MAT3":c=9;break;case"MAT4":c=16}switch(a){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*c;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*c;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(a,b,c){var d=a.bufferView,e=d.buffer,f=a.byteOffset+d.description.byteOffset,g=[f,this._elementSizeForGLType(a.componentType,a.type)*a.count+f];this._handleRequest({id:a.id,range:g,type:e.description.type,uri:e.description.uri,delegate:b,ctx:c},null)}},getBuffer:{value:function(a,b,c){return this._getResource(a.id),this._handleWrappedBufferViewResourceLoading(a,b,c),null}},getFile:{value:function(a,b,c){return a.delegate=b,a.ctx=c,this._handleRequest({id:a.id,uri:a.uri,range:[0],type:"text",delegate:b,ctx:c},null),null}}}),THREE.glTFAnimator=function(){var a=[];return{add:function(b){a.push(b)},remove:function(b){var c=a.indexOf(b);c!==-1&&a.splice(c,1)},update:function(){for(i=0;i<a.length;i++)a[i].update()}}}(),THREE.glTFAnimation=function(a){this.running=!1,this.loop=!1,this.duration=0,this.startTime=0,this.interps=[],a&&this.createInterpolators(a)},THREE.glTFAnimation.prototype.createInterpolators=function(a){var b,c=a.length;for(b=0;b<c;b++){var d=new THREE.glTFInterpolator(a[b]);this.interps.push(d),this.duration=Math.max(this.duration,d.duration)}},THREE.glTFAnimation.prototype.play=function(){this.running||(this.startTime=Date.now(),this.running=!0,THREE.glTFAnimator.add(this))},THREE.glTFAnimation.prototype.stop=function(){this.running=!1,THREE.glTFAnimator.remove(this)},THREE.glTFAnimation.prototype.update=function(){if(this.running){var a=Date.now(),b=(a-this.startTime)/1e3,c=b%this.duration,d=Math.floor(b/this.duration);if(d>=1&&!this.loop){this.running=!1;var e,f=this.interps.length;for(e=0;e<f;e++)this.interps[e].interp(this.duration);return void this.stop()}var e,f=this.interps.length;for(e=0;e<f;e++)this.interps[e].interp(c)}},THREE.glTFInterpolator=function(a){this.keys=a.keys,this.values=a.values,this.count=a.count,this.type=a.type,this.path=a.path,this.isRot=!1;var b=a.target;switch(b.updateMatrix(),b.matrixAutoUpdate=!0,this.targetNode=b,a.path){case"translation":this.target=b.position,this.originalValue=b.position.clone();break;case"rotation":this.target=b.quaternion,this.originalValue=b.quaternion.clone(),this.isRot=!0;break;case"scale":this.target=b.scale,this.originalValue=b.scale.clone()}this.duration=this.keys[this.count-1],this.vec1=new THREE.Vector3,this.vec2=new THREE.Vector3,this.vec3=new THREE.Vector3,this.quat1=new THREE.Quaternion,this.quat2=new THREE.Quaternion,this.quat3=new THREE.Quaternion},THREE.glTFInterpolator.prototype.interp=function(a){var b;if(a==this.keys[0])this.isRot?this.quat3.set(this.values[0],this.values[1],this.values[2],this.values[3]):this.vec3.set(this.values[0],this.values[1],this.values[2]);else if(a<this.keys[0])this.isRot?(this.quat1.set(this.originalValue.x,this.originalValue.y,this.originalValue.z,this.originalValue.w),this.quat2.set(this.values[0],this.values[1],this.values[2],this.values[3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,a/this.keys[0])):(this.vec3.set(this.originalValue.x,this.originalValue.y,this.originalValue.z),this.vec2.set(this.values[0],this.values[1],this.values[2]),this.vec3.lerp(this.vec2,a/this.keys[0]));else if(a>=this.keys[this.count-1])this.isRot?this.quat3.set(this.values[4*(this.count-1)],this.values[4*(this.count-1)+1],this.values[4*(this.count-1)+2],this.values[4*(this.count-1)+3]):this.vec3.set(this.values[3*(this.count-1)],this.values[3*(this.count-1)+1],this.values[3*(this.count-1)+2]);else for(b=0;b<this.count-1;b++){var c=this.keys[b],d=this.keys[b+1];a>=c&&a<=d&&(this.isRot?(this.quat1.set(this.values[4*b],this.values[4*b+1],this.values[4*b+2],this.values[4*b+3]),this.quat2.set(this.values[4*(b+1)],this.values[4*(b+1)+1],this.values[4*(b+1)+2],this.values[4*(b+1)+3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,(a-c)/(d-c))):(this.vec3.set(this.values[3*b],this.values[3*b+1],this.values[3*b+2]),this.vec2.set(this.values[3*(b+1)],this.values[3*(b+1)+1],this.values[3*(b+1)+2]),this.vec3.lerp(this.vec2,(a-c)/(d-c))))}this.target&&this.copyValue(this.target)},THREE.glTFInterpolator.prototype.copyValue=function(a){this.isRot?a.copy(this.quat3):a.copy(this.vec3)},THREE.glTFShaders=function(){var a=[];return{add:function(b){a.push(b)},remove:function(b){var c=a.indexOf(b);c!==-1&&a.splice(c,1)},removeAll:function(b){a=[]},bindShaderParameters:function(b){for(i=0;i<a.length;i++)a[i].bindParameters(b)},update:function(b,c){for(i=0;i<a.length;i++)a[i].update(b,c)}}}(),THREE.glTFShader=function(a,b,c,d){this.material=a,this.parameters=b.technique.parameters,this.uniforms=b.technique.uniforms,this.joints=b.joints,this.object=c,this.semantics={},this.m4=new THREE.Matrix4},THREE.glTFShader.prototype.bindParameters=function(a){function b(a,b){a.glTFID==e.node&&(b.sourceObject=a)}for(var c in this.uniforms){var d=this.uniforms[c],e=this.parameters[d];if(e.semantic){var f={semantic:e.semantic,uniform:this.material.uniforms[c]};e.node?a.traverse(function(a){b(a,f)}):f.sourceObject=this.object,this.semantics[d]=f}}},THREE.glTFShader.prototype.update=function(a,b){
a.updateMatrixWorld(),b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld);for(var c in this.semantics){var d=this.semantics[c];if(d)switch(d.semantic){case"MODELVIEW":var e=d.uniform.value;e.multiplyMatrices(b.matrixWorldInverse,d.sourceObject.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var f=d.uniform.value;this.m4.multiplyMatrices(b.matrixWorldInverse,d.sourceObject.matrixWorld),f.getNormalMatrix(this.m4);break;case"PROJECTION":var e=d.uniform.value;e.copy(b.projectionMatrix);break;case"JOINTMATRIX":for(var g=d.uniform.value,h=0;h<g.length;h++)g[h].getInverse(d.sourceObject.matrixWorld).multiply(this.joints[h].matrixWorld).multiply(this.object.skeleton.boneInverses[h]);break;default:throw new Error("Unhandled shader semantic"+d)}}};