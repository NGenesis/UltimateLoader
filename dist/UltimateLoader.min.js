 var UltimateLoader=UltimateLoader||{};!function(e){"use strict";function a(e,a){E.push([e,a])}function n(){if(g>E.length-1)return E=[],void(g=0);var e=E[g];g++,o(e)}function t(){0==g&&n()}function o(e){var a=e[0],t=e[1],o=r(a);switch(o.url=a,o.callback=t,null!=e[2]&&(o.i=e[2]),o.ext){case"obj":l(o);break;case"json":c(o);break;case"dae":i(o);break;case"gltf":u(o);break;case"fbx":d(o);break;case"png":s(o);break;case"jpg":s(o);break;case"jpeg":s(o);break;default:console.log("UltimateLoader: File extension -"+o.ext+"- not recognized! Object -"+o.name+"- did not load."),n()}}function r(e){var a=e.slice(0,e.lastIndexOf("/")+1);""===a&&null===a||(T=a);var n=e.substr(e.lastIndexOf("/")+1),t=n.split("."),o={name:t[0],ext:t[t.length-1].toLowerCase(),baseUrl:a};return o}function l(e){var a=e.name+".obj",n=e.name+".mtl",t=new THREE.MTLLoader;t.setPath(e.baseUrl),t.setTexturePath?t.setTexturePath(e.baseUrl):t.setBaseUrl(e.baseUrl),t.setCrossOrigin(m),t.load(n,function(n){n.preload();var t=new THREE.OBJLoader;t.setMaterials(n),t.setPath(e.baseUrl),t.load(a,function(a){a.traverse(function(e){e instanceof THREE.Mesh&&(e.material.side=THREE.DoubleSide)}),e.object=a,v(e)},f,b)})}function c(e){var a=new THREE.ObjectLoader;a.load(e.url,function(a){e.object=a,v(e)},f,b)}function i(e){var a=new THREE.ColladaLoader;a.load(e.url,function(a){var n=a.scene;e.object=n,v(e)},f,b)}function u(e){var a=new THREE.glTFLoader;a.load(e.url,function(a){var n=a.scene;e.object=n,v(e)},f,b)}function s(e){var a=new THREE.TextureLoader;a.load(e.url,function(a){e.object=a,v(e)},f,b)}function d(e){var a=new THREE.FBXLoader;a.load(e.url,function(a){e.object=a,v(e)},f,b())}function f(e){}function b(e){console.log("There was an error loading your object")}function v(a){j[a.name]=a.object,null!=a.i?a.callback(a):a.callback(a.object),e.queue&&n(),console.log("UltimateLoader: Object "+a.name+" loaded!")}var j={},E=[],g=0,m="anonymous",T="";e.queue=!1,e.imageSize=32,e.load=function(n,r){if(e.queue)a(n,r),t();else{var l=[n,r];o(l)}},e.multiload=function(n,r){for(var l=[],c=0,i=function(e){l[e.i]=e.object,c++,c==n.length&&r(l)},u=0;u<n.length;u++)if(e.queue)a(n[u],i,u),t();else{var s=[n[u],i,u];o(s)}t()}}(UltimateLoader);
THREE.MTLLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.MTLLoader.prototype={constructor:THREE.MTLLoader,load:function(e,t,r,i){var s=this,a=new THREE.XHRLoader(this.manager);a.setPath(this.path),a.load(e,function(e){t(s.parse(e))},r,i)},setPath:function(e){this.path=e},setBaseUrl:function(e){this.baseUrl=e},setCrossOrigin:function(e){this.crossOrigin=e},setMaterialOptions:function(e){this.materialOptions=e},parse:function(e){for(var t=e.split("\n"),r={},i=/\s+/,s={},a=0;a<t.length;a++){var n=t[a];if(n=n.trim(),0!==n.length&&"#"!==n.charAt(0)){var o=n.indexOf(" "),h=o>=0?n.substring(0,o):n;h=h.toLowerCase();var c=o>=0?n.substring(o+1):"";if(c=c.trim(),"newmtl"===h)r={name:c},s[c]=r;else if(r)if("ka"===h||"kd"===h||"ks"===h){var l=c.split(i,3);r[h]=[parseFloat(l[0]),parseFloat(l[1]),parseFloat(l[2])]}else r[h]=c}}var u=new THREE.MTLLoader.MaterialCreator(this.baseUrl,this.materialOptions);return u.setCrossOrigin(this.crossOrigin),u.setManager(this.manager),u.setMaterials(s),u}},THREE.MTLLoader.MaterialCreator=function(e,t){this.baseUrl=e,this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping},THREE.MTLLoader.MaterialCreator.prototype={constructor:THREE.MTLLoader.MaterialCreator,setCrossOrigin:function(e){this.crossOrigin=e},setManager:function(e){this.manager=e},setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t={};for(var r in e){var i=e[r],s={};t[r]=s;for(var a in i){var n=!0,o=i[a],h=a.toLowerCase();switch(h){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(o=[o[0]/255,o[1]/255,o[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===o[0]&&0===o[1]&&0===o[1]&&(n=!1)}n&&(s[h]=o)}}return t},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e=0;for(var t in this.materialsInfo)this.materialsArray[e]=this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var t=this.materialsInfo[e],r={name:e,side:this.side};for(var i in t){var s=t[i];if(""!==s)switch(i.toLowerCase()){case"kd":r.color=(new THREE.Color).fromArray(s);break;case"ks":r.specular=(new THREE.Color).fromArray(s);break;case"map_kd":r.map=this.loadTexture(this.baseUrl+s),r.map.wrapS=this.wrap,r.map.wrapT=this.wrap;break;case"ns":r.shininess=parseFloat(s);break;case"d":s<1&&(r.opacity=s,r.transparent=!0);break;case"Tr":s>0&&(r.opacity=1-s,r.transparent=!0);break;case"map_bump":case"bump":if(r.bumpMap)break;r.bumpMap=this.loadTexture(this.baseUrl+s),r.bumpMap.wrapS=this.wrap,r.bumpMap.wrapT=this.wrap}}return this.materials[e]=new THREE.MeshPhongMaterial(r),this.materials[e]},loadTexture:function(e,t,r,i,s){var a,n=THREE.Loader.Handlers.get(e),o=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;return null===n&&(n=new THREE.TextureLoader(o)),n.setCrossOrigin&&n.setCrossOrigin(this.crossOrigin),a=n.load(e,r,i,s),void 0!==t&&(a.mapping=t),a}},THREE.EventDispatcher.prototype.apply(THREE.MTLLoader.prototype),THREE.OBJLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.materials=null},THREE.OBJLoader.prototype={constructor:THREE.OBJLoader,load:function(e,t,r,i){var s=this,a=new THREE.XHRLoader(s.manager);a.setPath(this.path),a.load(e,function(e){t(s.parse(e))},r,i)},setPath:function(e){this.path=e},setMaterials:function(e){this.materials=e},parse:function(e){function t(e){var t={vertices:[],normals:[],uvs:[]},r={name:"",smooth:!0};c={name:e,geometry:t,material:r},l.push(c)}function r(e){var t=parseInt(e);return 3*(t>=0?t-1:t+d.length/3)}function i(e){var t=parseInt(e);return 3*(t>=0?t-1:t+p.length/3)}function s(e){var t=parseInt(e);return 2*(t>=0?t-1:t+f.length/2)}function a(e,t,r){c.geometry.vertices.push(d[e],d[e+1],d[e+2],d[t],d[t+1],d[t+2],d[r],d[r+1],d[r+2])}function n(e,t,r){c.geometry.normals.push(p[e],p[e+1],p[e+2],p[t],p[t+1],p[t+2],p[r],p[r+1],p[r+2])}function o(e,t,r){c.geometry.uvs.push(f[e],f[e+1],f[t],f[t+1],f[r],f[r+1])}function h(e,t,h,c,l,u,d,p,f,m,v,g){var y,E=r(e),b=r(t),T=r(h);void 0===c?a(E,b,T):(y=r(c),a(E,b,y),a(b,T,y)),void 0!==l&&(E=s(l),b=s(u),T=s(d),void 0===c?o(E,b,T):(y=s(p),o(E,b,y),o(b,T,y))),void 0!==f&&(E=i(f),b=i(m),T=i(v),void 0===c?n(E,b,T):(y=i(g),n(E,b,y),n(b,T,y)))}console.time("OBJLoader");var c,l=[],u=!1,d=[],p=[],f=[];t("");for(var m=/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,v=/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,g=/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,y=/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,E=/^f\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)))?/,b=/^f\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))\s+((-?\d+)\/(-?\d+)\/(-?\d+))(?:\s+((-?\d+)\/(-?\d+)\/(-?\d+)))?/,T=/^f\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))\s+((-?\d+)\/\/(-?\d+))(?:\s+((-?\d+)\/\/(-?\d+)))?/,w=/^[og]\s+(.+)/,x=/^s\s+(\d+|on|off)/,_=e.split("\n"),R=0;R<_.length;R++){var N=_[R];N=N.trim();var k;if(0!==N.length&&"#"!==N.charAt(0))if(null!==(k=m.exec(N)))d.push(parseFloat(k[1]),parseFloat(k[2]),parseFloat(k[3]));else if(null!==(k=v.exec(N)))p.push(parseFloat(k[1]),parseFloat(k[2]),parseFloat(k[3]));else if(null!==(k=g.exec(N)))f.push(parseFloat(k[1]),parseFloat(k[2]));else if(null!==(k=y.exec(N)))h(k[1],k[2],k[3],k[4]);else if(null!==(k=E.exec(N)))h(k[2],k[5],k[8],k[11],k[3],k[6],k[9],k[12]);else if(null!==(k=b.exec(N)))h(k[2],k[6],k[10],k[14],k[3],k[7],k[11],k[15],k[4],k[8],k[12],k[16]);else if(null!==(k=T.exec(N)))h(k[2],k[5],k[8],k[11],void 0,void 0,void 0,void 0,k[3],k[6],k[9],k[12]);else if(null!==(k=w.exec(N))){var A=k[1].trim();u===!1?(u=!0,c.name=A):t(A)}else if(/^usemtl /.test(N))c.material.name=N.substring(7).trim();else if(/^mtllib /.test(N));else{if(null===(k=x.exec(N)))throw new Error("Unexpected line: "+N);c.material.smooth="1"===k[1]||"on"===k[1]}}for(var H=new THREE.Group,R=0,C=l.length;R<C;R++){c=l[R];var L=c.geometry,I=new THREE.BufferGeometry;I.addAttribute("position",new THREE.BufferAttribute(new Float32Array(L.vertices),3)),L.normals.length>0?I.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(L.normals),3)):I.computeVertexNormals(),L.uvs.length>0&&I.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(L.uvs),2));var M;null!==this.materials&&(M=this.materials.create(c.material.name)),M||(M=new THREE.MeshPhongMaterial,M.name=c.material.name),M.shading=c.material.smooth?THREE.SmoothShading:THREE.FlatShading;var S=new THREE.Mesh(I,M);S.name=c.name,H.add(S)}return console.timeEnd("OBJLoader"),H}},THREE.ColladaLoader=function(){function e(e,r,i,s){var a=0;if(document.implementation&&document.implementation.createDocument){var n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState?0!==n.status&&200!==n.status||(n.response?(Pe=r,t(n.response,void 0,e)):s?s():console.error("ColladaLoader: Empty or non-existing file ("+e+")")):3===n.readyState&&i&&(0===a&&(a=n.getResponseHeader("Content-Length")),i({total:a,loaded:n.responseText.length}))},n.open("GET",e,!0),n.send(null)}else alert("Don't know how to parse XML!")}function t(e,t,r){if(De=(new DOMParser).parseFromString(e,"text/xml"),t=t||Pe,void 0!==r){var h=r.split("/");h.pop(),Me=(h.length<1?".":h.join("/"))+"/"}i(),be(),je=s("library_images image",N,"image"),qe=s("library_materials material",z,"material"),Xe=s("library_effects effect",Q,"effect"),Ue=s("library_geometries geometry",D,"geometry"),ze=s("library_cameras camera",ie,"camera"),We=s("library_lights light",ae,"light"),Ge=s("library_controllers controller",k,"controller"),Ve=s("library_animations animation",K,"animation"),Le=s("library_visual_scenes visual_scene",C,"visual_scene"),Ie=s("library_kinematics_models kinematics_model",oe,"kinematics_model"),Se=[],Oe=[],ke=a(),Fe=new THREE.Group;for(var c=0;c<ke.nodes.length;c++)Fe.add(g(ke.nodes[c]));Fe.scale.multiplyScalar(Je),o(),Ae=n(),v();var l={scene:Fe,morphs:Se,skins:Oe,animations:He,kinematics:Ce,dae:{images:je,materials:qe,cameras:ze,lights:We,effects:Xe,geometries:Ue,controllers:Ge,animations:Ve,visualScenes:Le,visualScene:ke,scene:ke,kinematicsModels:Ie,kinematicsModel:Ae}};return t&&t(l),l}function r(e){Ye=e}function i(){var e=De.querySelectorAll("asset"),t=e[0];if(t&&t.childNodes)for(var r=0;r<t.childNodes.length;r++){var i=t.childNodes[r];switch(i.nodeName){case"unit":var s=i.getAttribute("meter");s&&(Je=parseFloat(s));break;case"up_axis":Qe=i.textContent.charAt(0)}}}function s(e,t,r){for(var i=De.querySelectorAll(e),s={},a=0,n=i.length,o=0;o<n;o++){var h=i[o],c=(new t).parse(h);c.id&&0!==c.id.length||(c.id=r+a++),s[c.id]=c}return s}function a(){var e=De.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Le[t.length>0?t:"visual_scene0"]}return null}function n(){var e=De.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return Ie[t.length>0?t:"kinematics_model0"]}return null}function o(){He=[],h(Fe)}function h(e){var t=ke.getChildById(e.colladaId,!0),r=null;if(t&&t.keys){r={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},He.push(r);for(var i=0,s=t.keys.length;i<s;i++)r.length=Math.max(r.length,t.keys[i].time)}else r={hierarchy:[{keys:[],sids:[]}]};for(var i=0,s=e.children.length;i<s;i++)for(var a=h(e.children[i]),n=0,o=a.hierarchy.length;n<o;n++)r.hierarchy.push({keys:[],sids:[]});return r}function c(){var e,t=1e6,r=-t,i=0;for(var s in Ve){var a=Ve[s];e=e||a.id;for(var n=0;n<a.sampler.length;n++){var o=a.sampler[n];o.create(),t=Math.min(t,o.startTime),r=Math.max(r,o.endTime),i=Math.max(i,o.input.length)}}return{start:t,end:r,frames:i,ID:e}}function l(e,t){var r=t instanceof M?Ge[t.url]:t;if(!r||!r.morph)return void console.log("could not find morph controller!");for(var i=r.morph,s=0;s<i.targets.length;s++){var a=i.targets[s],n=Ue[a];if(n.mesh&&n.mesh.primitives&&n.mesh.primitives.length){var o=n.mesh.primitives[0].geometry;o.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:o.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function u(e,t,r,i){if(e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var s=e.channels[0],a=s.sampler.output[r];a instanceof THREE.Matrix4&&(e.world.copy(a),e.localworld.copy(a),0===r&&e.matrix.copy(a))}i&&e.world.multiplyMatrices(i,e.world),t.push(e);for(var n=0;n<e.nodes.length;n++)u(e.nodes[n],t,r,e.world)}function d(e,t){for(var r=0;r<e.length;r++){var i=e[r],s=-1;if("JOINT"==i.type){for(var a=0;a<t.joints.length;a++)if(i.sid===t.joints[a]){s=a;break}if(s>=0){var n=t.invBindMatrices[s];i.invBindMatrix=n,i.skinningMatrix=new THREE.Matrix4,i.skinningMatrix.multiplyMatrices(i.world,n),i.animatrix=new THREE.Matrix4,i.animatrix.copy(i.localworld),i.weights=[];for(var a=0;a<t.weights.length;a++)for(var o=0;o<t.weights[a].length;o++){var h=t.weights[a][o];h.joint===s&&i.weights.push(h)}}else console.warn("ColladaLoader: Could not find joint '"+i.sid+"'."),i.skinningMatrix=new THREE.Matrix4,i.weights=[]}}}function p(e){var t=[],r=function(e,t,i){var s={};s.name=t.sid,s.parent=e,s.matrix=t.matrix;var a=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];s.matrix.decompose(a[0],a[1],a[2]),s.pos=[a[0].x,a[0].y,a[0].z],s.scl=[a[2].x,a[2].y,a[2].z],s.rotq=[a[1].x,a[1].y,a[1].z,a[1].w],i.push(s);for(var n in t.nodes)r(t.sid,t.nodes[n],i)};return r(-1,e,t),t}function f(e,t,r){var i=[];u(t,i,-1),d(i,r.skin);for(var s=new THREE.Vector3,a=[],n=0;n<e.vertices.length;n++)a.push(new THREE.Vector3);for(n=0;n<i.length;n++)if("JOINT"==i[n].type)for(var o=0;o<i[n].weights.length;o++){var h=i[n].weights[o],c=h.index,l=h.weight,p=e.vertices[c],f=a[c];s.x=p.x,s.y=p.y,s.z=p.z,s.applyMatrix4(i[n].skinningMatrix),f.x+=s.x*l,f.y+=s.y*l,f.z+=s.z*l}for(var n=0;n<e.vertices.length;n++)e.vertices[n]=a[n]}function m(e,t,r){var i=Ge[t.url];if(r=void 0!==r?r:40,!i||!i.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!t.skeleton||!t.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var s=c(),a=ke.getChildById(t.skeleton[0],!0)||ke.getChildBySid(t.skeleton[0],!0),n=p(a),o=i.skin.joints,h=[],l=0;l<o.length;l++)for(var m=0;m<n.length;m++)n[m].name===o[l]&&(h[l]=n[m]);for(var l=0;l<h.length;l++)for(var m=0;m<h.length;m++)h[l].parent===h[m].name&&(h[l].parent=m);var l,m,v;new THREE.Vector3;for(l=0;l<e.vertices.length;l++)e.vertices[l].applyMatrix4(i.skin.bindShapeMatrix);for(var g=[],y=[],E=i.skin.weights,l=0;l<E.length;l++){var b=new THREE.Vector4(E[l][0]?E[l][0].joint:0,E[l][1]?E[l][1].joint:0,E[l][2]?E[l][2].joint:0,E[l][3]?E[l][3].joint:0),v=new THREE.Vector4(E[l][0]?E[l][0].weight:0,E[l][1]?E[l][1].weight:0,E[l][2]?E[l][2].weight:0,E[l][3]?E[l][3].weight:0);g.push(b),y.push(v)}e.skinIndices=g,e.skinWeights=y,e.bones=h;for(var T={name:s.ID,fps:30,length:s.frames/30,hierarchy:[]},m=0;m<h.length;m++)T.hierarchy.push({parent:h[m].parent,name:h[m].name,keys:[]});for(console.log("ColladaLoader:",s.ID+" has "+h.length+" bones."),f(e,a,i),r=0;r<s.frames;r++){var w=[];u(a,w,r),d(w,i.skin);for(var l=0;l<w.length;l++)for(var m=0;m<T.hierarchy.length;m++)if(T.hierarchy[m].name===w[l].sid){var x={};x.time=r/30,x.matrix=w[l].animatrix,0===r&&(w[l].matrix=x.matrix);var _=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];x.matrix.decompose(_[0],_[1],_[2]),x.pos=[_[0].x,_[0].y,_[0].z],x.scl=[_[2].x,_[2].y,_[2].z],x.rot=_[1],T.hierarchy[m].keys.push(x)}e.animation=T}}function v(){if(Ae&&0===Ae.joints.length)return void(Ce=void 0);var e={},t=function(t,r){var i=r.getAttribute("id"),s=ke.getChildById(i,!0),a=Ae.joints[t];Fe.traverse(function(r){r.colladaId==i&&(e[t]={node:r,transforms:s.transforms,joint:a,position:a.zeroPosition})})};Ce={joints:Ae&&Ae.joints,getJointValue:function(t){var r=e[t];return r?r.position:void console.log("getJointValue: joint "+t+" doesn't exist")},setJointValue:function(t,r){var s=e[t];if(s){var a=s.joint;if(r>a.limits.max||r<a.limits.min)console.log("setJointValue: joint "+t+" value "+r+" outside of limits (min: "+a.limits.min+", max: "+a.limits.max+")");else if(a.static)console.log("setJointValue: joint "+t+" is static");else{var n=s.node,o=a.axis,h=s.transforms,c=new THREE.Matrix4;for(i=0;i<h.length;i++){var l=h[i];if(l.sid&&l.sid.indexOf("joint"+t)!==-1)switch(a.type){case"revolute":c.multiply(u.makeRotationAxis(o,THREE.Math.degToRad(r)));break;case"prismatic":c.multiply(u.makeTranslation(o.x*r,o.y*r,o.z*r));break;default:console.warn("setJointValue: unknown joint type: "+a.type)}else{var u=new THREE.Matrix4;switch(l.type){case"matrix":c.multiply(l.obj);break;case"translate":c.multiply(u.makeTranslation(l.obj.x,l.obj.y,l.obj.z));break;case"rotate":c.multiply(u.makeRotationAxis(l.obj,l.angle))}}}var d=c.elements,p=Array.prototype.slice.call(d),f=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];n.matrix.set.apply(n.matrix,f),n.matrix.decompose(n.position,n.quaternion,n.scale)}}else console.log("setJointValue: joint "+t+" doesn't exist")}};var r=De.querySelector("scene instance_kinematics_scene");if(r)for(var i=0;i<r.childNodes.length;i++){var s=r.childNodes[i];if(1==s.nodeType)switch(s.nodeName){case"bind_joint_axis":var a=s.getAttribute("target").split("/").pop(),n=s.querySelector("axis param").textContent,o=parseInt(n.split("joint").pop().split(".")[0]),h=De.querySelector('[sid="'+a+'"]');if(h){var c=h.parentElement;t(o,c)}}}}function g(e,t){var r,i,s,a,n=new THREE.Object3D,o=!1;for(s=0;s<e.controllers.length;s++){var h=Ge[e.controllers[s].url];switch(h.type){case"skin":if(Ue[h.skin.source]){var c=new O;c.url=h.skin.source,c.instance_material=e.controllers[s].instance_material,e.geometries.push(c),o=!0,r=e.controllers[s]}else if(Ge[h.skin.source]){var u=Ge[h.skin.source];if(i=u,u.morph&&Ue[u.morph.source]){var c=new O;c.url=u.morph.source,c.instance_material=e.controllers[s].instance_material,e.geometries.push(c)}}break;case"morph":if(Ue[h.morph.source]){var c=new O;c.url=h.morph.source,c.instance_material=e.controllers[s].instance_material,e.geometries.push(c),i=e.controllers[s]}console.log("ColladaLoader: Morph-controller partially supported.")}}var d={};for(s=0;s<e.geometries.length;s++){var p,f=e.geometries[s],v=f.instance_material,y=Ue[f.url],E={},b=[],T=0;if(y){if(!y.mesh||!y.mesh.primitives)continue;if(0===n.name.length&&(n.name=y.id),v)for(a=0;a<v.length;a++){var w=v[a],x=qe[w.target],_=x.instance_effect.url,R=Xe[_].shader,N=R.material;if(y.doubleSided){if(!(w.symbol in d)){var k=N.clone();k.side=THREE.DoubleSide,d[w.symbol]=k}N=d[w.symbol]}N.opacity=N.opacity?N.opacity:1,E[w.symbol]=T,b.push(N),p=N,p.name=null===x.name||""===x.name?x.id:x.name,T++}var A,H=p||new THREE.MeshLambertMaterial({color:14540253,side:y.doubleSided?THREE.DoubleSide:THREE.FrontSide}),C=y.mesh.geometry3js;T>1&&(H=new THREE.MultiMaterial(b)),void 0!==r?(m(C,r),C.morphTargets.length>0?(H.morphTargets=!0,H.skinning=!1):(H.morphTargets=!1,H.skinning=!0),A=new THREE.SkinnedMesh(C,H,(!1)),A.name="skin_"+Oe.length,Oe.push(A)):void 0!==i?(l(C,i),H.morphTargets=!0,A=new THREE.Mesh(C,H),A.name="morph_"+Se.length,Se.push(A)):A=C.isLineStrip===!0?new THREE.Line(C):new THREE.Mesh(C,H),n.add(A)}}for(s=0;s<e.cameras.length;s++){var L=e.cameras[s],I=ze[L.url],M=new THREE.PerspectiveCamera(I.yfov,parseFloat(I.aspect_ratio),parseFloat(I.znear),parseFloat(I.zfar));n.add(M)}for(s=0;s<e.lights.length;s++){var S=null,D=e.lights[s],F=We[D.url];if(F&&F.technique){var P=F.color.getHex(),B=F.intensity,j=F.distance,V=F.falloff_angle;switch(F.technique){case"directional":S=new THREE.DirectionalLight(P,B,j),S.position.set(0,0,1);break;case"point":S=new THREE.PointLight(P,B,j);break;case"spot":S=new THREE.SpotLight(P,B,j,V),S.position.set(0,0,1);break;case"ambient":S=new THREE.AmbientLight(P)}}S&&n.add(S)}if(n.name=e.name||e.id||"",n.colladaId=e.id||"",n.layer=e.layer||"",n.matrix=e.matrix,n.matrix.decompose(n.position,n.quaternion,n.scale),Ze.centerGeometry&&n.geometry){var G=n.geometry.center();G.multiply(n.scale),G.applyQuaternion(n.quaternion),n.position.sub(G)}for(s=0;s<e.nodes.length;s++)n.add(g(e.nodes[s],e));return n}function y(e){for(var t=De.querySelectorAll("library_nodes node"),r=0;r<t.length;r++){var i=t[r].attributes.getNamedItem("id");if(i&&i.value===e)return t[r]}}function E(e){var t=[],r=1e6,i=-1e6;for(var s in Ve)for(var a=Ve[s],n=0;n<a.channel.length;n++){var o=a.channel[n],h=a.sampler[n],s=o.target.split("/")[0];s==e.id&&(h.create(),o.sampler=h,r=Math.min(r,h.startTime),i=Math.max(i,h.endTime),t.push(o))}return t.length&&(e.startTime=r,e.endTime=i),t}function b(e){if(e.channels&&e.channels.length){for(var t=[],r=[],i=0,s=e.channels.length;i<s;i++){var a,n=e.channels[i],o=n.fullSid,h=n.sampler,c=h.input,l=e.getTransformBySid(n.sid);if(n.arrIndices){a=[];for(var u=0,d=n.arrIndices.length;u<d;u++)a[u]=Re(n.arrIndices[u])}else a=Ne(n.member);if(l){r.indexOf(o)===-1&&r.push(o);for(var u=0,d=c.length;u<d;u++){var p=c[u],f=h.getData(l.type,u,a),m=T(t,p);if(!m){m=new re(p);var v=w(t,p);t.splice(v===-1?t.length:v,0,m)}m.addTarget(o,l,a,f)}}else console.log('Could not find transform "'+n.sid+'" in node '+e.id)}for(var i=0;i<r.length;i++)for(var g=r[i],u=0;u<t.length;u++){var m=t[u];m.hasTarget(g)||x(t,m,u,g)}e.keys=t,e.sids=r}}function T(e,t){for(var r=null,i=0,s=e.length;i<s&&null===r;i++){var a=e[i];if(a.time===t)r=a;else if(a.time>t)break}return r}function w(e,t){for(var r=-1,i=0,s=e.length;i<s&&r===-1;i++){var a=e[i];a.time>=t&&(r=i)}return r}function x(e,t,r,i){var s=R(e,i,r?r-1:0),a=_(e,i,r+1);if(s&&a){var n,o=(t.time-s.time)/(a.time-s.time),h=s.getTarget(i),c=a.getTarget(i).data,l=h.data;if("matrix"===h.type)n=l;else if(l.length){n=[];for(var u=0;u<l.length;++u)n[u]=l[u]+(c[u]-l[u])*o}else n=l+(c-l)*o;t.addTarget(i,h.transform,h.member,n)}}function _(e,t,r){for(;r<e.length;r++){var i=e[r];if(i.hasTarget(t))return i}return null}function R(e,t,r){for(r=r>=0?r:r+e.length;r>=0;r--){var i=e[r];if(i.hasTarget(t))return i}return null}function N(){this.id="",this.init_from=""}function k(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function A(){this.method=null,this.source=null,this.targets=null,this.weights=null}function H(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function C(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function L(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function I(){this.sid="",this.type="",this.data=[],this.obj=null}function M(){this.url="",this.skeleton=[],this.instance_material=[]}function S(){this.symbol="",this.target=""}function O(){this.url="",this.instance_material=[]}function D(){this.id="",this.mesh=null}function F(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function P(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function B(){P.call(this),this.vcount=[]}function j(){P.call(this),this.vcount=1}function V(){P.call(this),this.vcount=3}function G(){this.source="",this.count=0,this.stride=0,this.params=[]}function U(){this.input={}}function q(){this.semantic="",this.offset=0,this.source="",this.set=0}function X(e){this.id=e,this.type=null}function z(){this.id="",this.name="",this.instance_effect=null}function W(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function Y(e,t){this.type=e,this.effect=t,this.material=null}function Z(e){this.effect=e,this.init_from=null,this.format=null}function J(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Q(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function $(){this.url=""}function K(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ee(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function te(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function re(e){this.targets=[],this.time=e}function ie(){this.id="",this.name="",this.technique=""}function se(){this.url=""}function ae(){this.id="",this.name="",this.technique=""}function ne(){this.url=""}function oe(){this.id="",this.name="",this.joints=[],this.links=[]}function he(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function ce(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function le(){this.joint="",this.transforms=[],this.links=[]}function ue(e){var t=e.getAttribute("id");return void 0!=Be[t]?Be[t]:(Be[t]=new X(t).parse(e),Be[t])}function de(e){for(var t=me(e),r=[],i=0,s=t.length;i<s;i++)r.push("true"===t[i]||"1"===t[i]);return r}function pe(e){for(var t=me(e),r=[],i=0,s=t.length;i<s;i++)r.push(parseFloat(t[i]));return r}function fe(e){for(var t=me(e),r=[],i=0,s=t.length;i<s;i++)r.push(parseInt(t[i],10));return r}function me(e){return e.length>0?ve(e).split(/\s+/):[]}function ve(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function ge(e,t,r){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):r}function ye(e,t){var r=new THREE.ImageLoader;r.load(t,function(t){e.image=t,e.needsUpdate=!0})}function Ee(e,t){e.doubleSided=!1;var r=t.querySelectorAll("extra double_sided")[0];r&&r&&1===parseInt(r.textContent,10)&&(e.doubleSided=!0)}function be(){if(Ze.convertUpAxis!==!0||Qe===Ze.upAxis)$e=null;else switch(Qe){case"X":$e="Y"===Ze.upAxis?"XtoY":"XtoZ";break;case"Y":$e="X"===Ze.upAxis?"YtoX":"YtoZ";break;case"Z":$e="X"===Ze.upAxis?"ZtoX":"ZtoY"}}function Te(e,t){if(Ze.convertUpAxis===!0&&Qe!==Ze.upAxis)switch($e){case"XtoY":var r=e[0];e[0]=t*e[1],e[1]=r;break;case"XtoZ":var r=e[2];e[2]=e[1],e[1]=e[0],e[0]=r;break;case"YtoX":var r=e[0];e[0]=e[1],e[1]=t*r;break;case"YtoZ":var r=e[1];e[1]=t*e[2],e[2]=r;break;case"ZtoX":var r=e[0];e[0]=e[1],e[1]=e[2],e[2]=r;break;case"ZtoY":var r=e[1];e[1]=e[2],e[2]=t*r}}function we(e,t){if(Ze.convertUpAxis!==!0||Qe===Ze.upAxis)return t;switch(e){case"X":t="XtoY"===$e?t*-1:t;break;case"Y":t="YtoZ"===$e||"YtoX"===$e?t*-1:t;break;case"Z":t="ZtoY"===$e?t*-1:t}return t}function xe(e,t){var r=[e[t],e[t+1],e[t+2]];return Te(r,-1),new THREE.Vector3(r[0],r[1],r[2])}function _e(e){if(Ze.convertUpAxis){var t=[e[0],e[4],e[8]];Te(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],Te(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],Te(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],Te(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],Te(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],Te(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],Te(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Re(e){if(e>-1&&e<3){var t=["X","Y","Z"],r={X:0,Y:1,Z:2};e=Ne(t[e]),e=r[e]}return e}function Ne(e){if(Ze.convertUpAxis)switch(e){case"X":switch($e){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch($e){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch($e){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var ke,Ae,He,Ce,Le,Ie,Me,Se,Oe,De=null,Fe=null,Pe=null,Be={},je={},Ve={},Ge={},Ue={},qe={},Xe={},ze={},We={},Ye=THREE.SmoothShading,Ze={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},Je=1,Qe="Y",$e=null;return N.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];"init_from"===r.nodeName&&(this.init_from=r.textContent)}return this},k.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"skin":this.skin=(new H).parse(r),this.type=r.nodeName;break;case"morph":this.morph=(new A).parse(r),this.type=r.nodeName}}return this},A.prototype.parse=function(e){var t,r={},i=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),t=0;t<e.childNodes.length;t++){var s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"source":var a=(new X).parse(s);r[a.id]=a;break;case"targets":i=this.parseInputs(s);break;default:console.log(s.nodeName)}}for(t=0;t<i.length;t++){var n=i[t],a=r[n.source];switch(n.semantic){case"MORPH_TARGET":this.targets=a.read();break;case"MORPH_WEIGHT":this.weights=a.read()}}return this},A.prototype.parseInputs=function(e){for(var t=[],r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"input":t.push((new q).parse(i))}}return t},H.prototype.parse=function(e){var t,r,i={};this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var s=0;s<e.childNodes.length;s++){var a=e.childNodes[s];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var n=pe(a.textContent);this.bindShapeMatrix=_e(n);break;case"source":var o=(new X).parse(a);i[o.id]=o;break;case"joints":t=a;break;case"vertex_weights":r=a;break;default:console.log(a.nodeName)}}return this.parseJoints(t,i),this.parseWeights(r,i),this},H.prototype.parseJoints=function(e,t){for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"input":var s=(new q).parse(i),a=t[s.source];"JOINT"===s.semantic?this.joints=a.read():"INV_BIND_MATRIX"===s.semantic&&(this.invBindMatrices=a.read())}}},H.prototype.parseWeights=function(e,t){for(var r,i,s=[],a=0;a<e.childNodes.length;a++){var n=e.childNodes[a];if(1==n.nodeType)switch(n.nodeName){case"input":s.push((new q).parse(n));break;case"v":r=fe(n.textContent);break;case"vcount":i=fe(n.textContent)}}for(var o=0,a=0;a<i.length;a++){for(var h=i[a],c=[],l=0;l<h;l++){for(var u={},d=0;d<s.length;d++){var p=s[d],f=r[o+p.offset];switch(p.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[p.source].data[f]}}c.push(u),o+=s.length}for(var l=0;l<c.length;l++)c[l].index=a;this.weights.push(c)}},C.prototype.getChildById=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i)return i}return null},C.prototype.getChildBySid=function(e,t){for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i)return i}return null},C.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"node":this.nodes.push((new L).parse(r))}}return this},L.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var r,i,s=this.channels[t],a=s.target.split("/"),n=(a.shift(),a.shift()),o=n.indexOf(".")>=0,h=n.indexOf("(")>=0;if(o)a=n.split("."),n=a.shift(),i=a.shift();else if(h){r=n.split("("),n=r.shift();for(var c=0;c<r.length;c++)r[c]=parseInt(r[c].replace(/\)/,""))}if(n===e)return s.info={sid:n,dotSyntax:o,arrSyntax:h,arrIndices:r},s}return null},L.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildById(e,t);if(i)return i}return null},L.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var r=0;r<this.nodes.length;r++){var i=this.nodes[r].getChildBySid(e,t);if(i)return i}return null},L.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},L.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new L).parse(i));break;case"instance_camera":this.cameras.push((new se).parse(i));break;case"instance_controller":this.controllers.push((new M).parse(i));break;case"instance_geometry":this.geometries.push((new O).parse(i));break;case"instance_light":this.lights.push((new ne).parse(i));break;case"instance_node":t=i.getAttribute("url").replace(/^#/,"");var s=y(t);s&&this.nodes.push((new L).parse(s));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new I).parse(i));break;case"extra":break;default:console.log(i.nodeName)}}return this.channels=E(this),b(this),this.updateMatrix(),this},L.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},I.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=pe(e.textContent),
this.convert(),this},I.prototype.convert=function(){switch(this.type){case"matrix":this.obj=_e(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":Te(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Te(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},I.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),I.prototype.update=function(e,t){var r=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var i="n"+(t[0]+1)+(t[1]+1);this.obj[i]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=r[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},M.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1===r.nodeType)switch(r.nodeName){case"skeleton":this.skeleton.push(r.textContent.replace(/^#/,""));break;case"bind_material":for(var i=r.querySelectorAll("instance_material"),s=0;s<i.length;s++){var a=i[s];this.instance_material.push((new S).parse(a))}break;case"extra":}}return this},S.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},O.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType&&"bind_material"===r.nodeName){for(var i=r.querySelectorAll("instance_material"),s=0;s<i.length;s++){var a=i[s];this.instance_material.push((new S).parse(a))}break}}return this},D.prototype.parse=function(e){this.id=e.getAttribute("id"),Ee(this,e);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"mesh":this.mesh=new F(this).parse(r);break;case"extra":}}return this},F.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"source":ue(r);break;case"vertices":this.vertices=(new U).parse(r);break;case"linestrips":this.primitives.push((new j).parse(r));break;case"triangles":this.primitives.push((new V).parse(r));break;case"polygons":this.primitives.push((new P).parse(r));break;case"polylist":this.primitives.push((new B).parse(r))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var i=Be[this.vertices.input.POSITION.source].data,t=0;t<i.length;t+=3)this.geometry3js.vertices.push(xe(i,t).clone());for(var t=0;t<this.primitives.length;t++){var s=this.primitives[t];s.setVertices(this.vertices),this.handlePrimitive(s,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},F.prototype.handlePrimitive=function(e,t){if(e instanceof j)return void(t.isLineStrip=!0);var r,i,s,a,n,o,h,c=e.p,l=e.inputs,u=0,d=3,p=0,f=[];for(r=0;r<l.length;r++){s=l[r];var m=s.offset+1;switch(p=p<m?m:p,s.semantic){case"TEXCOORD":f.push(s.set)}}for(var v=0;v<c.length;++v)for(var g=c[v],y=0;y<g.length;){var E=[],b=[],T=null,w=[];for(d=e.vcount?e.vcount.length?e.vcount[u++]:e.vcount:g.length/p,r=0;r<d;r++)for(i=0;i<l.length;i++)switch(s=l[i],o=Be[s.source],a=g[y+r*p+s.offset],h=o.accessor.params.length,n=a*h,s.semantic){case"VERTEX":E.push(a);break;case"NORMAL":b.push(xe(o.data,n));break;case"TEXCOORD":T=T||{},void 0===T[s.set]&&(T[s.set]=[]),T[s.set].push(new THREE.Vector2(o.data[n],o.data[n+1]));break;case"COLOR":w.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}if(0===b.length)if(s=this.vertices.input.NORMAL){o=Be[s.source],h=o.accessor.params.length;for(var x=0,_=E.length;x<_;x++)b.push(xe(o.data,E[x]*h))}else t.calcNormals=!0;if(!T&&(T={},s=this.vertices.input.TEXCOORD)){f.push(s.set),o=Be[s.source],h=o.accessor.params.length;for(var x=0,_=E.length;x<_;x++)n=E[x]*h,void 0===T[s.set]&&(T[s.set]=[]),T[s.set].push(new THREE.Vector2(o.data[n],1-o.data[n+1]))}if(0===w.length&&(s=this.vertices.input.COLOR)){o=Be[s.source],h=o.accessor.params.length;for(var x=0,_=E.length;x<_;x++)n=E[x]*h,w.push((new THREE.Color).setRGB(o.data[n],o.data[n+1],o.data[n+2]))}var R,N,k=null,A=[];if(3===d)A.push(new THREE.Face3(E[0],E[1],E[2],b,w.length?w:new THREE.Color));else if(4===d)A.push(new THREE.Face3(E[0],E[1],E[3],b.length?[b[0].clone(),b[1].clone(),b[3].clone()]:[],w.length?[w[0],w[1],w[3]]:new THREE.Color)),A.push(new THREE.Face3(E[1],E[2],E[3],b.length?[b[1].clone(),b[2].clone(),b[3].clone()]:[],w.length?[w[1],w[2],w[3]]:new THREE.Color));else if(d>4&&Ze.subdivideFaces){var H=w.length?w:new THREE.Color;for(i=1;i<d-1;)A.push(new THREE.Face3(E[0],E[i],E[i+1],b.length?[b[0].clone(),b[i++].clone(),b[i].clone()]:[],H))}if(A.length)for(var x=0,_=A.length;x<_;x++)for(k=A[x],k.daeMaterial=e.material,t.faces.push(k),i=0;i<f.length;i++)R=T[f[i]],N=d>4?[R[0],R[x+1],R[x+2]]:4===d?0===x?[R[0],R[1],R[3]]:[R[1].clone(),R[2],R[3].clone()]:[R[0],R[1],R[2]],void 0===t.faceVertexUvs[i]&&(t.faceVertexUvs[i]=[]),t.faceVertexUvs[i].push(N);else console.log("dropped face with vcount "+d+" for geometry with id: "+t.id);y+=p*d}},P.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},P.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=ge(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"input":this.inputs.push((new q).parse(e.childNodes[t]));break;case"vcount":this.vcount=fe(r.textContent);break;case"p":this.p.push(fe(r.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},B.prototype=Object.create(P.prototype),B.prototype.constructor=B,j.prototype=Object.create(P.prototype),j.prototype.constructor=j,V.prototype=Object.create(P.prototype),V.prototype.constructor=V,G.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=ge(e,"count",0),this.stride=ge(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if("param"===r.nodeName){var i={};i.name=r.getAttribute("name"),i.type=r.getAttribute("type"),this.params.push(i)}}return this},U.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var r=(new q).parse(e.childNodes[t]);this.input[r.semantic]=r}return this},q.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=ge(e,"set",-1),this.offset=ge(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},X.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"bool_array":this.data=de(r.textContent),this.type=r.nodeName;break;case"float_array":this.data=pe(r.textContent),this.type=r.nodeName;break;case"int_array":this.data=fe(r.textContent),this.type=r.nodeName;break;case"IDREF_array":case"Name_array":this.data=me(r.textContent),this.type=r.nodeName;break;case"technique_common":for(var i=0;i<r.childNodes.length;i++)if("accessor"===r.childNodes[i].nodeName){this.accessor=(new G).parse(r.childNodes[i]);break}}}return this},X.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var r=0;r<this.data.length;r+=16){var i=this.data.slice(r,r+16),s=_e(i);e.push(s)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},z.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new $).parse(e.childNodes[t]);break}return this},W.prototype.isColor=function(){return null===this.texture},W.prototype.isTexture=function(){return null!=this.texture},W.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"color":var i=pe(r.textContent);this.color=new THREE.Color,this.color.setRGB(i[0],i[1],i[2]),this.color.a=i[3];break;case"texture":this.texture=r.getAttribute("texture"),this.texcoord=r.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(r)}}return this},W.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1],e.childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[r.nodeName]=parseFloat(r.textContent);break;case"wrapU":case"wrapV":"TRUE"===r.textContent.toUpperCase()?this.texOpts[r.nodeName]=1:this.texOpts[r.nodeName]=parseInt(r.textContent);break;default:this.texOpts[r.nodeName]=r.textContent}}return this},Y.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[r.nodeName]=(new W).parse(r);break;case"bump":var i=r.getAttribute("bumptype");i?"heightfield"===i.toLowerCase()?this.bump=(new W).parse(r):"normalmap"===i.toLowerCase()?this.normal=(new W).parse(r):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+i+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new W).parse(r)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new W).parse(r));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var s=r.querySelectorAll("float");s.length>0&&(this[r.nodeName]=parseFloat(s[0].textContent))}}return this.create(),this},Y.prototype.create=function(){var e={},t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var r=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);r>0&&(t=!0,e.transparent=!0,e.opacity=1-r)}var i={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var s in this)switch(s){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var a=this[s];if(a instanceof W)if(a.isTexture()){var n=a.texture,o=this.effect.sampler[n];if(void 0!==o&&void 0!==o.source){var h=this.effect.surface[o.source];if(void 0!==h){var c=je[h.init_from];if(c){var l,u=Me+c.init_from,d=THREE.Loader.Handlers.get(u);null!==d?l=d.load(u):(l=new THREE.Texture,ye(l,u)),l.wrapS=a.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.wrapT=a.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.offset.x=a.texOpts.offsetU,l.offset.y=a.texOpts.offsetV,l.repeat.x=a.texOpts.repeatU,l.repeat.y=a.texOpts.repeatV,e[i[s]]=l,"emission"===s&&(e.emissive=16777215)}}}}else"diffuse"!==s&&t||("emission"===s?e.emissive=a.color.getHex():e[s]=a.color.getHex());break;case"shininess":e[s]=this[s];break;case"reflectivity":e[s]=this[s],e[s]>0&&(e.envMap=Ze.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[s],1!==this[s]&&(e.envMap=Ze.defaultEnvMap);break;case"transparency":}switch(e.shading=Ye,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},Z.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"init_from":this.init_from=r.textContent;break;case"format":this.format=r.textContent;break;default:console.log("unhandled Surface prop: "+r.nodeName)}}return this},J.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"source":this.source=r.textContent;break;case"minfilter":this.minfilter=r.textContent;break;case"magfilter":this.magfilter=r.textContent;break;case"mipfilter":this.mipfilter=r.textContent;break;case"wrap_s":this.wrap_s=r.textContent;break;case"wrap_t":this.wrap_t=r.textContent;break;default:console.log("unhandled Sampler2D prop: "+r.nodeName)}}return this},Q.prototype.create=function(){if(null===this.shader)return null},Q.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),Ee(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(r))}}return this},Q.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"surface":this.surface[t]=new Z(this).parse(i);break;case"sampler2D":this.sampler[t]=new J(this).parse(i);break;case"extra":break;default:console.log(i.nodeName)}}},Q.prototype.parseProfileCOMMON=function(e){for(var t,r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseProfileCOMMON(i);break;case"technique":t=i;break;case"newparam":this.parseNewparam(i);break;case"image":var s=(new N).parse(i);je[s.id]=s;break;case"extra":break;default:console.log(i.nodeName)}}return t},Q.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new Y(r.nodeName,this).parse(r);break;case"extra":this.parseExtra(r)}}},Q.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique":this.parseExtraTechnique(r)}}},Q.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"bump":this.shader.parse(e)}}},$.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},K.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"animation":var i=(new K).parse(r);for(var s in i.source)this.source[s]=i.source[s];for(var a=0;a<i.channel.length;a++)this.channel.push(i.channel[a]),this.sampler.push(i.sampler[a]);break;case"source":var s=(new X).parse(r);this.source[s.id]=s;break;case"sampler":this.sampler.push(new te(this).parse(r));break;case"channel":this.channel.push(new ee(this).parse(r))}}return this},ee.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),r=(t.shift(),t.shift()),i=r.indexOf(".")>=0,s=r.indexOf("(")>=0;if(i)t=r.split("."),this.sid=t.shift(),this.member=t.shift();else if(s){var a=r.split("(");this.sid=a.shift();for(var n=0;n<a.length;n++)a[n]=parseInt(a[n].replace(/\)/,""));this.arrIndices=a}else this.sid=r;return this.fullSid=r,this.dotSyntax=i,this.arrSyntax=s,this},te.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"input":this.inputs.push((new q).parse(r))}}return this},te.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],r=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=r.read();break;case"OUTPUT":this.output=r.read(),this.strideOut=r.accessor.stride;break;case"INTERPOLATION":this.interpolation=r.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},te.prototype.getData=function(e,t,r){var i;if("matrix"===e&&16===this.strideOut)i=this.output[t];else if(this.strideOut>1){i=[],t*=this.strideOut;for(var s=0;s<this.strideOut;++s)i[s]=this.output[t+s];if(3===this.strideOut)switch(e){case"rotate":case"translate":Te(i,-1);break;case"scale":Te(i,1)}else 4===this.strideOut&&"matrix"===e&&Te(i,-1)}else i=this.output[t],r&&"translate"===e&&(i=we(r,i));return i},re.prototype.addTarget=function(e,t,r,i){this.targets.push({sid:e,member:r,transform:t,data:i})},re.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var r=this.targets[t];e&&r.sid!==e||r.transform.update(r.data,r.member)}},re.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},re.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},re.prototype.interpolate=function(e,t){for(var r=0,i=this.targets.length;r<i;r++){var s,a=this.targets[r],n=e.getTarget(a.sid);if("matrix"!==a.transform.type&&n){var o=(t-this.time)/(e.time-this.time),h=n.data,c=a.data;if(o<0&&(o=0),o>1&&(o=1),c.length){s=[];for(var l=0;l<c.length;++l)s[l]=c[l]+(h[l]-c[l])*o}else s=c+(h-c)*o}else s=a.data;a.transform.update(s,a.member)}},ie.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"optics":this.parseOptics(r)}}return this},ie.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var r=e.childNodes[t],i=0;i<r.childNodes.length;i++)if(this.technique=r.childNodes[i].nodeName,"perspective"===this.technique)for(var s=r.childNodes[i],a=0;a<s.childNodes.length;a++){var n=s.childNodes[a];switch(n.nodeName){case"yfov":this.yfov=n.textContent;break;case"xfov":this.xfov=n.textContent;break;case"znear":this.znear=n.textContent;break;case"zfar":this.zfar=n.textContent;break;case"aspect_ratio":this.aspect_ratio=n.textContent}}else if("orthographic"===this.technique)for(var o=r.childNodes[i],a=0;a<o.childNodes.length;a++){var n=o.childNodes[a];switch(n.nodeName){case"xmag":this.xmag=n.textContent;break;case"ymag":this.ymag=n.textContent;break;case"znear":this.znear=n.textContent;break;case"zfar":this.zfar=n.textContent;break;case"aspect_ratio":this.aspect_ratio=n.textContent}}return this},se.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ae.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r);break;case"technique":this.parseTechnique(r)}}return this},ae.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var r=e.childNodes[t],i=0;i<r.childNodes.length;i++){var s=r.childNodes[i];switch(s.nodeName){case"color":var a=pe(s.textContent);this.color=new THREE.Color(0),this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"falloff_angle":this.falloff_angle=parseFloat(s.textContent);break;case"quadratic_attenuation":var n=parseFloat(s.textContent);this.distance=n?Math.sqrt(1/n):0}}}return this},ae.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];switch(r.nodeName){case"intensity":this.intensity=parseFloat(r.textContent)}}return this},ne.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},oe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"technique_common":this.parseCommon(r)}}return this},oe.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new he).parse(r));break;case"link":this.links.push((new ce).parse(r))}}return this},he.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),r=pe(t.textContent);this.axis=xe(r,0);var i=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,s=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:i,max:s};for(var a=["prismatic","revolute"],n=0;n<a.length;n++){var o=a[n],h=e.querySelector(o);h&&(this.type=o)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},ce.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"attachment_full":this.attachments.push((new le).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new I).parse(r))}}return this},le.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var r=e.childNodes[t];if(1==r.nodeType)switch(r.nodeName){case"link":this.links.push((new ce).parse(r));break;case"rotate":case"translate":case"matrix":this.transforms.push((new I).parse(r))}}return this},{load:e,parse:t,setPreferredShading:r,applySkin:m,geometries:Ue,options:Ze}};var global=window;!function(e,t){"object"==typeof exports?t(module.exports):"function"==typeof define&&define.amd?define([],function(){return t(e)}):t(e)}(this,function(e){"use strict";var t=["extensions","buffers","bufferViews","images","videos","samplers","textures","shaders","programs","techniques","materials","accessors","meshes","cameras","lights","skins","nodes","animations","scenes"],r=Object.create(Object.prototype,{_rootDescription:{value:null,writable:!0},rootDescription:{set:function(e){this._rootDescription=e},get:function(){return this._rootDescription}},baseURL:{value:null,writable:!0},_isAbsolutePath:{value:function(e){var t=new RegExp("^"+window.location.protocol,"i");return!!e.match(t)}},resolvePathIfNeeded:{value:function(e){if(this._isAbsolutePath(e))return e;var t=/^data:/;return t.test(e)?e:this.baseURL+e}},_resolvePathsForCategories:{value:function(e){e.forEach(function(e){var t=this.json[e];if(t){var r=Object.keys(t);r.forEach(function(e){var r=t[e];r.uri=this.resolvePathIfNeeded(r.uri)},this)}},this)}},_json:{value:null,writable:!0},json:{enumerable:!0,get:function(){return this._json},set:function(e){this._json!==e&&(this._json=e,this._resolvePathsForCategories(["buffers","shaders","images","videos"]))}},_path:{value:null,writable:!0},getEntryDescription:{value:function(e,t){var r=null,i=t;return r=this.rootDescription[i],r?r?r[e]:null:(console.log("ERROR:CANNOT find expected category named:"+i),null)}},_stepToNextCategory:{value:function(){return this._state.categoryIndex=this.getNextCategoryIndex(this._state.categoryIndex+1),this._state.categoryIndex!==-1&&(this._state.categoryState.index=0,!0)}},_stepToNextDescription:{enumerable:!1,value:function(){var e=this._state.categoryState,t=e.keys;return t?(e.index++,e.keys=null,e.index>=t.length&&this._stepToNextCategory()):(console.log("INCONSISTENCY ERROR"),!1)}},hasCategory:{value:function(e){return!!this.rootDescription[e]}},_handleState:{value:function(){for(var e={buffers:this.handleBuffer,bufferViews:this.handleBufferView,shaders:this.handleShader,programs:this.handleProgram,techniques:this.handleTechnique,materials:this.handleMaterial,meshes:this.handleMesh,cameras:this.handleCamera,lights:this.handleLight,nodes:this.handleNode,scenes:this.handleScene,images:this.handleImage,animations:this.handleAnimation,accessors:this.handleAccessor,skins:this.handleSkin,samplers:this.handleSampler,textures:this.handleTexture,videos:this.handleVideo,extensions:this.handleExtension},r=!0;this._state.categoryIndex!==-1;){var i=t[this._state.categoryIndex],s=this._state.categoryState,a=s.keys;if(a||(s.keys=a=Object.keys(this.rootDescription[i]),!a||0!=a.length)){var n=i,o=a[s.index],h=this.getEntryDescription(o,n);if(h){if(e[n]&&e[n].call(this,o,h,this._state.userInfo)===!1){r=!1;break}this._stepToNextDescription()}else if(this.handleError){this.handleError("INCONSISTENCY ERROR: no description found for entry "+o),r=!1;break}}else this._stepToNextDescription()}this.handleLoadCompleted&&this.handleLoadCompleted(r)}},_loadJSONIfNeeded:{enumerable:!0,value:function(e){var t=this;if(this._json)e&&e(this.json);else{var r=this._path,i=r.lastIndexOf("/");this.baseURL=0!==i?r.substring(0,i+1):"";var s=new XMLHttpRequest;s.open("GET",r,!0),s.onreadystatechange=function(){4==s.readyState&&200==s.status&&(t.json=JSON.parse(s.responseText),e&&e(t.json))},s.send(null)}}},_buildLoader:{value:function(e){function t(t){r.rootDescription=t,e&&e(this)}var r=this;this._loadJSONIfNeeded(t)}},_state:{value:null,writable:!0},_getEntryType:{value:function(e){for(var r=t,i=0;i<r.length;i++){var s=this.rootDescription[r[i]];if(s)return r[i]}return null}},getNextCategoryIndex:{value:function(e){for(var r=e;r<t.length;r++)if(this.hasCategory(t[r]))return r;return-1}},load:{enumerable:!0,value:function(e,t){var r=this;this._buildLoader(function(i){var s=r.getNextCategoryIndex.call(r,0);s!==-1&&(r._state={userInfo:e,options:t,categoryIndex:s,categoryState:{index:"0"}},r._handleState())})}},initWithPath:{value:function(e){return this._path=e,this._json=null,this}},_knownURLs:{writable:!0,value:{}},loaderContext:{value:function(){return"undefined"==typeof this._knownURLs[this._path]&&(this._knownURLs[this._path]=Object.keys(this._knownURLs).length),"__"+this._knownURLs[this._path]}},initWithJSON:{value:function(e,t){return this.json=e,this.baseURL=t,t||console.log("WARNING: no base URL passed to Reader:initWithJSON"),this}}});return e&&(e.glTFParser=r),r}),THREE.glTFLoader=function(){this.meshesRequested=0,this.meshesLoaded=0,this.pendingMeshes=[],this.animationsRequested=0,this.animationsLoaded=0,this.animations=[],this.shadersRequested=0,this.shadersLoaded=0,this.shaders={},this.loadRequests=[],THREE.glTFShaders.removeAll(),THREE.Loader.call(this)},THREE.glTFLoader.prototype=new THREE.Loader,THREE.glTFLoader.prototype.constructor=THREE.glTFLoader,THREE.glTFLoader.prototype.load=function(url,callback){function RgbArraytoHex(e){if(!e)return 4294967295;var t=Math.floor(255*e[0]),r=Math.floor(255*e[1]),i=Math.floor(255*e[2]),s=255,a=(s<<24)+(t<<16)+(r<<8)+i;return a}function componentsPerElementForGLType(e){switch(e){case"SCALAR":nElements=1;break;case"VEC2":nElements=2;break;case"VEC3":nElements=3;break;case"VEC4":nElements=4;break;case"MAT2":nElements=4;break;case"MAT3":nElements=9;break;case"MAT4":nElements=16}return nElements}function replaceShaderDefinitions(shader,material){var program=material.params.program,shaderParams=material.params.technique.parameters,shaderAttributes=material.params.technique.attributes,params={};for(var attribute in material.params.attributes){var pname=shaderAttributes[attribute],shaderParam=shaderParams[pname],semantic=shaderParam.semantic;semantic&&(params[attribute]=shaderParam)}var s=shader,r="";for(var pname in params){var param=params[pname],semantic=param.semantic;switch(r=eval("/"+pname+"/g"),semantic){case"POSITION":s=s.replace(r,"position");break;case"NORMAL":s=s.replace(r,"normal");break;case"TEXCOORD_0":s=s.replace(r,"uv");break;case"WEIGHT":s=s.replace(r,"skinWeight");break;case"JOINT":s=s.replace(r,"skinIndex")}}return s}function replaceShaderSemantics(e){var t=theLoader.shaders[e.params.vertexShader];t&&(t=replaceShaderDefinitions(t,e),theLoader.shaders[e.params.vertexShader]=t)}function createShaderMaterial(e){replaceShaderSemantics(e);var t=theLoader.shaders[e.params.fragmentShader];if(!t)return console.log("ERROR: Missing fragment shader definition:",e.params.fragmentShader),new THREE.MeshPhongMaterial;var r=theLoader.shaders[e.params.vertexShader];if(!r)return console.log("ERROR: Missing vertex shader definition:",e.params.vertexShader),new THREE.MeshPhongMaterial;var i=THREE.UniformsUtils.clone(e.params.uniforms);for(uniform in e.params.uniforms){var s=e.params.uniforms[uniform],a=i[uniform];"t"==a.type&&(a.value=s.value)}var n=new THREE.RawShaderMaterial({fragmentShader:t,vertexShader:r,uniforms:i,transparent:e.params.transparent});return n}function LoadTexture(e){function t(e,t){var r=decodeURIComponent(t);return e?atob(r):r}function r(e,r){for(var i=t(e,r),s=new ArrayBuffer(i.length),a=new Uint8Array(s),n=0;n<i.length;n++)a[n]=i.charCodeAt(n);return s}function i(e,i){i="undefined"!=typeof i?i:"";var s=e[1],a=!!e[2],n=e[3];switch(i){case"":case"text":return t(a,n);case"ArrayBuffer":return r(a,n);case"blob":var o=r(a,n);return new Blob([o],{type:s});case"document":var h=new DOMParser;return h.parseFromString(t(a,n),s);case"json":return JSON.parse(t(a,n));default:throw"Unhandled responseType: "+i}}if(!e)return null;var s=function(e,t,r){var i=new Image;i.onload=function(){t(i)},"undefined"!=typeof r&&(i.onerror=r),i.src=e},a=/^data:(.*?)(;base64)?,(.*)$/,n=a.exec(e);if(null!==n){var o=new THREE.Texture,h=i(n,"blob"),c=window.URL.createObjectURL(h);return s(c,function(e){o.image=e,o.needsUpdate=!0}),o}return(new THREE.TextureLoader).load(e)}function CreateTexture(e,t){var r=null,i=null;if(t){var s=t;if(s){var a=e.getEntry(s);if(a){var n=e.getEntry(a.description.source);n&&(r=n.description.uri);var o=e.getEntry(a.description.sampler);o&&(i=o.description)}}}var s=LoadTexture(r);return s&&i&&(i.wrapS==WebGLRenderingContext.REPEAT&&(s.wrapS=THREE.RepeatWrapping),i.wrapT==WebGLRenderingContext.REPEAT&&(s.wrapT=THREE.RepeatWrapping),i.magFilter==WebGLRenderingContext.LINEAR&&(s.magFilter=THREE.LinearFilter)),s}var theLoader=this,ClassicGeometry=function(){
this.geometry=new THREE.BufferGeometry,this.totalAttributes=0,this.loadedAttributes=0,this.indicesLoaded=!1,this.finished=!1,this.onload=null,this.uvs=null,this.indexArray=null};ClassicGeometry.prototype.constructor=ClassicGeometry,ClassicGeometry.prototype.buildBufferGeometry=function(){var e=this.geometry;e.setIndex(new THREE.BufferAttribute(this.indexArray,1));var t={start:0,index:0,count:this.indexArray.length};e.groups.push(t),e.computeBoundingSphere()},ClassicGeometry.prototype.checkFinished=function(){this.indexArray&&this.loadedAttributes===this.totalAttributes&&(this.buildBufferGeometry(),this.finished=!0,this.onload&&this.onload())};var IndicesDelegate=function(){};IndicesDelegate.prototype.handleError=function(e,t){console.log("ERROR(IndicesDelegate):"+e+":"+t)},IndicesDelegate.prototype.convert=function(e,t){return new Uint16Array(e,0,t.indices.count)},IndicesDelegate.prototype.resourceAvailable=function(e,t){var r=t.geometry;return r.indexArray=e,r.checkFinished(),!0};var indicesDelegate=new IndicesDelegate,IndicesContext=function(e,t){this.indices=e,this.geometry=t},VertexAttributeDelegate=function(){};VertexAttributeDelegate.prototype.handleError=function(e,t){console.log("ERROR(VertexAttributeDelegate):"+e+":"+t)},VertexAttributeDelegate.prototype.convert=function(e,t){return e},VertexAttributeDelegate.prototype.bufferResourceAvailable=function(e,t){var r,i,s,a=t.geometry,n=t.attribute,o=t.semantic;if("POSITION"==o)r=new Float32Array(e,0,n.count*componentsPerElementForGLType(n.type)),a.geometry.addAttribute("position",new THREE.BufferAttribute(r,3));else if("NORMAL"==o)s=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*s),a.geometry.addAttribute("normal",new THREE.BufferAttribute(r,3));else if("TEXCOORD_0"==o||"TEXCOORD"==o){for(s=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*s),i=0;i<r.length/2;i++)r[2*i+1]=1-r[2*i+1];a.geometry.addAttribute("uv",new THREE.BufferAttribute(r,s))}else"WEIGHT"==o?(s=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*s),a.geometry.addAttribute("skinWeight",new THREE.BufferAttribute(r,s))):"JOINT"==o&&(s=componentsPerElementForGLType(n.type),r=new Float32Array(e,0,n.count*s),a.geometry.addAttribute("skinIndex",new THREE.BufferAttribute(r,s)))},VertexAttributeDelegate.prototype.resourceAvailable=function(e,t){this.bufferResourceAvailable(e,t);var r=t.geometry;return r.loadedAttributes++,r.checkFinished(),!0};var vertexAttributeDelegate=new VertexAttributeDelegate,VertexAttributeContext=function(e,t,r){this.attribute=e,this.semantic=t,this.geometry=r},Mesh=function(){this.primitives=[],this.materialsPending=[],this.loadedGeometry=0,this.onCompleteCallbacks=[]};Mesh.prototype.addPrimitive=function(e,t){var r=this;e.onload=function(){r.loadedGeometry++,r.checkComplete()},this.primitives.push({geometry:e,material:t,mesh:null})},Mesh.prototype.onComplete=function(e){this.onCompleteCallbacks.push(e)},Mesh.prototype.checkComplete=function(){var e=this;this.onCompleteCallbacks.length&&this.primitives.length==this.loadedGeometry&&(this.onCompleteCallbacks.forEach(function(t){t(e)}),this.onCompleteCallbacks=[])},Mesh.prototype.attachToNode=function(e){var t=this;this.primitives.forEach(function(r){var i=r.material,s=i.params;if(i instanceof THREE.Material||(i=createShaderMaterial(i)),!t.skin){var a=new THREE.Mesh(r.geometry.geometry,i);if(a.castShadow=!0,e.add(a),i instanceof THREE.ShaderMaterial){var n=new THREE.glTFShader(i,s,a,theLoader.rootObj);THREE.glTFShaders.add(n)}}})};var Material=function(e){this.params=e},AnimationParameterDelegate=function(){};AnimationParameterDelegate.prototype.handleError=function(e,t){console.log("ERROR(AnimationParameterDelegate):"+e+":"+t)},AnimationParameterDelegate.prototype.convert=function(e,t){var r=t.parameter,i=null;switch(r.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":i=new Float32Array(e,0,r.count*componentsPerElementForGLType(r.type))}return i},AnimationParameterDelegate.prototype.resourceAvailable=function(e,t){var r=t.animation,i=t.parameter;return i.data=e,r.handleParameterLoaded(i),!0};var animationParameterDelegate=new AnimationParameterDelegate,AnimationParameterContext=function(e,t){this.parameter=e,this.animation=t},Animation=function(){this.totalParameters=0,this.loadedParameters=0,this.parameters={},this.finishedLoading=!1,this.onload=null};Animation.prototype.constructor=Animation,Animation.prototype.handleParameterLoaded=function(e){this.parameters[e.name]=e,this.loadedParameters++,this.checkFinished()},Animation.prototype.checkFinished=function(){this.loadedParameters===this.totalParameters&&(this.finishedLoading=!0,this.onload&&this.onload())};var InverseBindMatricesDelegate=function(){};InverseBindMatricesDelegate.prototype.handleError=function(e,t){console.log("ERROR(InverseBindMatricesDelegate):"+e+":"+t)},InverseBindMatricesDelegate.prototype.convert=function(e,t){var r=t.parameter,i=null;switch(r.type){case"MAT4":i=new Float32Array(e,0,r.count*componentsPerElementForGLType(r.type))}return i},InverseBindMatricesDelegate.prototype.resourceAvailable=function(e,t){var r=t.skin;return r.inverseBindMatrices=e,!0};var inverseBindMatricesDelegate=new InverseBindMatricesDelegate,InverseBindMatricesContext=function(e,t){this.parameter=e,this.skin=t},ShaderDelegate=function(){};ShaderDelegate.prototype.handleError=function(e,t){console.log("ERROR(ShaderDelegate):"+e+":"+t)},ShaderDelegate.prototype.convert=function(e,t){return e},ShaderDelegate.prototype.resourceAvailable=function(e,t){return theLoader.shadersLoaded++,theLoader.shaders[t.id]=e,!0};var shaderDelegate=new ShaderDelegate,ShaderContext=function(e,t){this.id=e,this.uri=t},ResourceEntry=function(e,t,r){this.entryID=e,this.object=t,this.description=r},Resources=function(){this._entries={}};Resources.prototype.setEntry=function(e,t,r){return e?(this._entries[e]&&console.warn("entry["+e+"] is being overwritten"),void(this._entries[e]=new ResourceEntry(e,t,r))):void console.error("No EntryID provided, cannot store",r)},Resources.prototype.getEntry=function(e){return this._entries[e]},Resources.prototype.clearEntries=function(){this._entries={}},LoadDelegate=function(){},LoadDelegate.prototype.loadCompleted=function(e,t){e.call(Window,t)};var ThreeGLTFLoader=Object.create(glTFParser,{load:{enumerable:!0,value:function(e,t){this.resources=new Resources,this.cameras=[],this.lights=[],this.animations=[],this.joints={},THREE.GLTFLoaderUtils.init(),glTFParser.load.call(this,e,t)}},cameras:{enumerable:!0,writable:!0,value:[]},lights:{enumerable:!0,writable:!0,value:[]},animations:{enumerable:!0,writable:!0,value:[]},handleBuffer:{value:function(e,t,r){return this.resources.setEntry(e,null,t),t.type="ArrayBuffer",!0}},handleBufferView:{value:function(e,t,r){this.resources.setEntry(e,null,t);var i=this.resources.getEntry(t.buffer);t.type="ArrayBufferView";var s=this.resources.getEntry(e);return s.buffer=i,!0}},handleShader:{value:function(e,t,r){this.resources.setEntry(e,null,t);var i={id:e,uri:t.uri},s=new ShaderContext(e,t.uri);return theLoader.shadersRequested++,THREE.GLTFLoaderUtils.getFile(i,shaderDelegate,s),!0}},handleProgram:{value:function(e,t,r){return this.resources.setEntry(e,null,t),!0}},handleTechnique:{value:function(e,t,r){return t.refCount=0,this.resources.setEntry(e,null,t),!0}},createShaderParams:{value:function(e,t,r,i,s){var a=this.resources.getEntry(i);if(r.uniforms={},r.attributes={},r.program=a,r.technique=s,a){r.fragmentShader=a.description.fragmentShader,r.vertexShader=a.description.vertexShader;for(var n in s.uniforms){var o,h,c=s.uniforms[n],l=s.parameters[c],u=l.type,d=l.count,p=t[c],f="";switch(u){case WebGLRenderingContext.FLOAT:if(f="f",o=l.value,"transparency"==c){var m=!0,v=m?p:1-p;o=v,r.transparent=!0}break;case WebGLRenderingContext.FLOAT_VEC2:if(f="v2",o=new THREE.Vector2,l&&l.value){var g=l.value;o.fromArray(g)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_VEC3:if(f="v3",o=new THREE.Vector3,l&&l.value){var y=l.value;o.fromArray(y)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_VEC4:if(f="v4",o=new THREE.Vector4,l&&l.value){var E=l.value;o.fromArray(E)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_MAT2:console.log("Warning: FLOAT_MAT2");break;case WebGLRenderingContext.FLOAT_MAT3:if(f="m3",o=new THREE.Matrix3,l&&l.value){var b=l.value;o.fromArray(b)}p&&o.fromArray(p);break;case WebGLRenderingContext.FLOAT_MAT4:if(void 0!==d){f="m4v",o=new Array(d);for(var T=0;T<d;T++)o[T]=new THREE.Matrix4;if(h=d,l&&l.value){var w=l.value;o.fromArray(w)}p&&o.fromArray(p)}else{if(f="m4",o=new THREE.Matrix4,l&&l.value){var x=l.value;o.fromArray(x)}p&&o.fromArray(p)}break;case WebGLRenderingContext.SAMPLER_2D:f="t",o=p?CreateTexture(this.resources,p):null;break;default:throw new Error("Unknown shader uniform param type: "+u+" - "+theLoader.idx[u])}var _={type:f,value:o,length:h};r.uniforms[n]=_}for(var R in s.attributes){var c=s.attributes[R],N=s.parameters[c],k=N.type,A=N.semantic,H={type:k,semantic:A};r.attributes[R]=H}}}},threeJSMaterialType:{value:function(e,t,r){var i,s=t.extensions,a=s?s.KHR_materials_common:null,n=null;if(a){switch(a.technique){case"BLINN":case"PHONG":n=THREE.MeshPhongMaterial;break;case"LAMBERT":n=THREE.MeshLambertMaterial;break;case"CONSTANT":default:n=THREE.MeshBasicMaterial}a.doubleSided&&(r.side=THREE.DoubleSide),a.transparent&&(r.transparent=!0),i={};for(prop in a.values)i[prop]=a.values[prop]}else{var o=t.technique?this.resources.getEntry(t.technique):null;i=t.values;var h=o.description;++h.refCount>1;var c=h.program;this.createShaderParams(e,i,r,c,h);var l=!0;l&&(n=Material)}i.diffuse&&"string"==typeof i.diffuse&&(r.map=CreateTexture(this.resources,i.diffuse)),i.reflective&&"string"==typeof i.reflective&&(r.envMap=CreateTexture(this.resources,i.reflective));var u=i.shininesss||i.shininess;u&&(u=u);var d=null;r.map||(d=i.diffuse);var p=1;if(i.hasOwnProperty("transparency")){var f=!0;p=f?i.transparency:1-i.transparency}return r.color=RgbArraytoHex(d),r.opacity=p,r.transparent=p<1,r.map&&r.map.sourceFile.toLowerCase().indexOf(".png")!=-1&&(r.transparent=!0),void 0!==u&&(r.shininess=Math.max(u,1e-4)),delete r.ambient,void 0!==i.ambient&&"string"!=typeof i.ambient,void 0!==i.emission&&(r.emissive=RgbArraytoHex(i.emission)),void 0!==i.specular&&(r.specular=RgbArraytoHex(i.specular)),n}},handleMaterial:{value:function(e,t,r){var i={},s=this.threeJSMaterialType(e,t,i),a=new s(i);return this.resources.setEntry(e,a,t),!0}},handleMesh:{value:function(e,t,r){var i=new Mesh;this.resources.setEntry(e,i,t);var s=t.primitives;if(!s)return console.log("MISSING_PRIMITIVES for mesh:"+e),!1;for(var a=0;a<s.length;a++){var n=s[a];if(n.mode===WebGLRenderingContext.TRIANGLES){var o=new ClassicGeometry,h=this.resources.getEntry(n.material);i.addPrimitive(o,h.object);var c=Object.keys(n.attributes);c.forEach(function(e){o.totalAttributes++},this);var l=this.resources.getEntry(n.indices),u=this.resources.getEntry(l.description.bufferView),d={bufferView:u,byteOffset:l.description.byteOffset,count:l.description.count,id:l.entryID,componentType:l.description.componentType,type:l.description.type},p=new IndicesContext(d,o),f={indicesObject:d,indicesDelegate:indicesDelegate,indicesContext:p};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.indicesObject,e.indicesDelegate,e.indicesContext);t&&e.indicesDelegate.resourceAvailable(t,e.indicesContext)},f),c.forEach(function(e){var r,i=n.attributes[e],s=this.resources.getEntry(i);if(s){r=s.object,r.id=i;var a=this.resources.getEntry(r.bufferView)}else{r=t.attributes[i],r.id=i,this.resources.setEntry(i,r,r);var a=this.resources.getEntry(r.bufferView);s=this.resources.getEntry(i)}var h={bufferView:a,byteOffset:r.byteOffset,byteStride:r.byteStride,count:r.count,max:r.max,min:r.min,componentType:r.componentType,type:r.type,id:i},c=new VertexAttributeContext(h,e,o),l={attributeObject:h,vertexAttributeDelegate:vertexAttributeDelegate,attribContext:c};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.attributeObject,e.vertexAttributeDelegate,e.attribContext);t&&e.vertexAttributeDelegate.resourceAvailable(t,e.attribContext)},l)},this)}}return!0}},handleCamera:{value:function(e,t,r){var i;if("perspective"==t.type){var s=t.perspective.znear,a=t.perspective.zfar,n=t.perspective.yfov,o=t.perspective.xfov,h=t.perspective.aspect_ratio;h||(h=1),void 0===o&&n&&(o=n*h),void 0===n&&o&&(n=o/h),o&&(o=THREE.Math.radToDeg(o),i=new THREE.PerspectiveCamera(o,h,s,a))}else i=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,s,a);return i&&this.resources.setEntry(e,i,t),!0}},handleLight:{value:function(e,t,r){var i=null,s=t.type;if(s&&t[s]){var a=t[s],n=RgbArraytoHex(a.color);switch(s){case"directional":i=new THREE.DirectionalLight(n),i.position.set(0,0,1);break;case"point":i=new THREE.PointLight(n);break;case"spot ":i=new THREE.SpotLight(n),i.position.set(0,0,1);break;case"ambient":i=new THREE.AmbientLight(n)}}return i&&this.resources.setEntry(e,i,t),!0}},addPendingMesh:{value:function(e,t){theLoader.pendingMeshes.push({mesh:e,node:t})}},handleNode:{value:function(e,t,r){var i=null;t.jointName?(i=new THREE.Bone,i.jointName=t.jointName,this.joints[t.jointName]=e):i=new THREE.Object3D,i.name=t.name,i.glTFID=e,i.glTF=t,this.resources.setEntry(e,i,t);var s=t.matrix;if(s)i.matrixAutoUpdate=!1,i.applyMatrix((new THREE.Matrix4).set(s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14],s[3],s[7],s[11],s[15]));else{var a=t.translation,n=t.rotation,o=t.scale,h=a?new THREE.Vector3(a[0],a[1],a[2]):new THREE.Vector3,c=n?new THREE.Quaternion(n[0],n[1],n[2],n[3]):new THREE.Quaternion,l=o?new THREE.Vector3(o[0],o[1],o[2]):new THREE.Vector3(1,1,1),u=new THREE.Matrix4;u.compose(h,c,l),i.matrixAutoUpdate=!1,i.applyMatrix(u)}var d=this;if(t.meshes){t.meshInstances={};var p;t.skin&&(p=this.resources.getEntry(t.skin)),t.meshes.forEach(function(e){meshEntry=this.resources.getEntry(e),theLoader.meshesRequested++,meshEntry.object.onComplete(function(r){d.addPendingMesh(r,i),t.meshInstances[e]=meshEntry.object,p&&(r.skin=p,t.instanceSkin=p.object),theLoader.meshesLoaded++,theLoader.checkComplete()})},this)}if(t.camera){var f=this.resources.getEntry(t.camera);f&&(i.add(f.object),this.cameras.push(f.object))}if(t.extensions&&t.extensions.KHR_materials_common&&t.extensions.KHR_materials_common.light){var m=t.extensions.KHR_materials_common.light,v=this.resources.getEntry(m);v&&(i.add(v.object),this.lights.push(v.object))}return!0}},handleExtension:{value:function(e,t,r){switch(e){case"KHR_materials_common":var i=t.lights;for(lightID in i){var s=i[lightID];this.handleLight(lightID,s)}}return!0}},buildNodeHirerachy:{value:function(e,t){var r=this.resources.getEntry(e),i=r.object;t.add(i);var s=r.description.children;return s&&s.forEach(function(e){this.buildNodeHirerachy(e,i)},this),i}},buildSkin:{value:function(e){var t=e.glTF,r=t.instanceSkin,i=t.skeletons;r&&i.forEach(function(i){var s=this.resources.getEntry(i);if(s){var a=s.object;e.add(a);var n=!0;for(meshID in t.meshInstances){var o=t.meshInstances[meshID],h=null;o.primitives.forEach(function(t){var s=t.material,a=s.params;s instanceof THREE.Material||(s=createShaderMaterial(s)),h=new THREE.SkinnedMesh(t.geometry.geometry,s,(!1));t.geometry.geometry;if(h&&n){s.skinning=!0;var o,c=r.jointNames,l=[],u=[],d=[],p=c.length;for(o=0;o<p;o++){var f=c[o],m=this.joints[f],v=this.resources.getEntry(m).object;if(v){v.skin=h,l.push(v),u.push(v);var g=r.inverseBindMatrices,y=(new THREE.Matrix4).set(g[16*o+0],g[16*o+4],g[16*o+8],g[16*o+12],g[16*o+1],g[16*o+5],g[16*o+9],g[16*o+13],g[16*o+2],g[16*o+6],g[16*o+10],g[16*o+14],g[16*o+3],g[16*o+7],g[16*o+11],g[16*o+15]);d.push(y)}else console.log("WARNING: jointName:"+f+" cannot be found in skeleton:"+i)}h.bind(new THREE.Skeleton(u,d,(!1)),r.bindShapeMatrix)}if(h&&(h.castShadow=!0,e.add(h),s instanceof THREE.ShaderMaterial)){a.joints=l;var E=new THREE.glTFShader(s,a,h,theLoader.rootObj);THREE.glTFShaders.add(E)}},this)}}},this)}},buildSkins:{value:function(e){e.glTF&&e.glTF.instanceSkin&&this.buildSkin(e);var t=e.children;t&&t.forEach(function(e){this.buildSkins(e)},this)}},createMeshAnimations:{value:function(e){this.buildSkins(e)}},handleScene:{value:function(e,t,r){return t.nodes?(t.nodes.forEach(function(e){this.buildNodeHirerachy(e,r.rootObj)},this),this.delegate&&this.delegate.loadCompleted(r.callback,r.rootObj),theLoader.loadAllAssets(),!0):(console.log("ERROR: invalid file required nodes property is missing from scene"),!1)}},handleImage:{value:function(e,t,r){return this.resources.setEntry(e,null,t),!0}},addNodeAnimationChannel:{value:function(e,t,r){this.nodeAnimationChannels||(this.nodeAnimationChannels={}),this.nodeAnimationChannels[e]||(this.nodeAnimationChannels[e]=[]),this.nodeAnimationChannels[e].push(r)}},createAnimations:{value:function(){for(var e in this.nodeAnimationChannels){var t=this.nodeAnimationChannels[e],r=(t.length,new THREE.glTFAnimation(t));r.name="animation_"+e,this.animations.push(r)}}},buildAnimation:{value:function(e){var t,r=[],i=e.channels.length;for(t=0;t<i;t++){var s=e.channels[t],a=e.samplers[s.sampler];if(a){var n=e.parameters[a.input];if(n&&n.data){var o=e.parameters[a.output];if(o&&o.data){var h=s.target,c=this.resources.getEntry(h.id);if(c){var l=h.path,u={keys:n.data,values:o.data,count:n.count,target:c.object,path:l,type:a.interpolation};this.addNodeAnimationChannel(h.id,s,u),r.push(u)}}}}}}},handleAnimation:{value:function(e,t,r){theLoader.animationsRequested++;var i=new Animation;i.name=e,i.onload=function(){theLoader.animationsLoaded++,theLoader.animations.push(i),theLoader.checkComplete()},i.channels=t.channels,i.samplers=t.samplers,this.resources.setEntry(e,i,t);var s=t.parameters;if(!s)return console.log("MISSING_PARAMETERS for animation:"+e),!1;var a=Object.keys(s);a.forEach(function(e){i.totalParameters++},this);var a=Object.keys(s);return a.forEach(function(e){var t=s[e],r=this.resources.getEntry(t);r=r.object;var a=this.resources.getEntry(r.bufferView),n={bufferView:a,byteOffset:r.byteOffset,count:r.count,componentType:r.componentType,type:r.type,id:r.bufferView,name:e},o=new AnimationParameterContext(n,i),h={paramObject:n,animationParameterDelegate:animationParameterDelegate,paramContext:o};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.paramObject,e.animationParameterDelegate,e.paramContext);t&&e.animationParameterDelegate.resourceAvailable(t,e.paramContext)},h)},this),!0}},handleAccessor:{value:function(e,t,r){return this.resources.setEntry(e,t,t),!0}},handleSkin:{value:function(e,t,r){var i={},s=t.bindShapeMatrix;i.bindShapeMatrix=(new THREE.Matrix4).set(s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14],s[3],s[7],s[11],s[15]),i.jointNames=t.jointNames;var a=this.resources.getEntry(t.inverseBindMatrices);a=a.description,i.inverseBindMatricesDescription=a,i.inverseBindMatricesDescription.id=t.inverseBindMatrices;var n=this.resources.getEntry(a.bufferView),o={bufferView:n,byteOffset:a.byteOffset,count:a.count,componentType:a.componentType,type:a.type,id:a.bufferView,name:i.inverseBindMatricesDescription.id},h=new InverseBindMatricesContext(o,i),c={paramObject:o,inverseBindMatricesDelegate:inverseBindMatricesDelegate,context:h};theLoader.scheduleLoad(function(e){var t=THREE.GLTFLoaderUtils.getBuffer(e.paramObject,e.inverseBindMatricesDelegate,e.context);t&&e.inverseBindMatricesDelegate.resourceAvailable(t,e.context)},c);var l=this.resources.getEntry(i.inverseBindMatricesDescription.bufferView);return i.inverseBindMatricesDescription.bufferView=l.object,this.resources.setEntry(e,i,t),!0}},handleSampler:{value:function(e,t,r){return this.resources.setEntry(e,t,t),!0}},handleTexture:{value:function(e,t,r){return this.resources.setEntry(e,null,t),!0}},handleError:{value:function(e){throw new Error(e)}},_delegate:{value:new LoadDelegate,writable:!0},delegate:{enumerable:!0,get:function(){return this._delegate},set:function(e){this._delegate=e}}}),Context=function(e,t){this.rootObj=e,this.callback=t},rootObj=new THREE.Object3D,self=this,loader=Object.create(ThreeGLTFLoader);return loader.initWithPath(url),loader.load(new Context(rootObj,function(e){}),null),this.loader=loader,this.callback=callback,this.rootObj=rootObj,rootObj},THREE.glTFLoader.prototype.scheduleLoad=function(e,t){this.loadRequests.push({fn:e,data:t})},THREE.glTFLoader.prototype.loadAllAssets=function(){for(var e=0,t=this.loadRequests.length;e<t;e++){var r=this.loadRequests[e];r.fn(r.data)}},THREE.glTFLoader.prototype.callLoadedCallback=function(){var e={scene:this.rootObj,cameras:this.loader.cameras,animations:this.loader.animations,shaders:this.loader.shaders};this.callback(e)},THREE.glTFLoader.prototype.checkComplete=function(){if(this.meshesLoaded==this.meshesRequested&&this.shadersLoaded==this.shadersRequested&&this.animationsLoaded==this.animationsRequested){for(var e=0;e<this.pendingMeshes.length;e++){var t=this.pendingMeshes[e];t.mesh.attachToNode(t.node)}for(var e=0;e<this.animationsLoaded;e++){var r=this.animations[e];this.loader.buildAnimation(r)}this.loader.createAnimations(),this.loader.createMeshAnimations(this.rootObj),THREE.glTFShaders.bindShaderParameters(this.rootObj),this.callLoadedCallback()}},THREE.GLTFLoaderUtils=Object.create(Object,{MISSING_DESCRIPTION:{value:"MISSING_DESCRIPTION"},INVALID_PATH:{value:"INVALID_PATH"},INVALID_TYPE:{value:"INVALID_TYPE"},XMLHTTPREQUEST_STATUS_ERROR:{value:"XMLHTTPREQUEST_STATUS_ERROR"},NOT_FOUND:{value:"NOT_FOUND"},ARRAY_BUFFER:{value:"ArrayBuffer"},_streams:{value:{},writable:!0},_streamsStatus:{value:{},writable:!0},_resources:{value:{},writable:!0},_resourcesStatus:{value:{},writable:!0},init:{value:function(){this._streams={},this._streamsStatus={},this._resources={},this._resourcesStatus={}}},_containsResource:{enumerable:!1,value:function(e){return!!this._resources[e]}},_storeResource:{enumerable:!1,value:function(e,t){return e?(this._containsResource[e]&&console.log("WARNING: resource:"+e+" is already stored, overriding"),void(this._resources[e]=t)):void console.log("ERROR: entry does not contain id, cannot store")}},_getResource:{enumerable:!1,value:function(e){return this._resources[e]}},_loadStream:{value:function(e,t,r){function i(e,t){var r=decodeURIComponent(t);return e?atob(r):r}function s(e,t){for(var r=i(e,t),s=new ArrayBuffer(r.length),a=new Uint8Array(s),n=0;n<r.length;n++)a[n]=r.charCodeAt(n);return s}function a(e,t){t="undefined"!=typeof t?t:"";var r=e[1],a=!!e[2],n=e[3];switch(t){case"":case"text":return i(a,n);case"ArrayBuffer":return s(a,n);case"blob":var o=s(a,n);return new Blob([o],{type:r});case"document":var h=new DOMParser;return h.parseFromString(i(a,n),r);case"json":return JSON.parse(i(a,n));default:throw"Unhandled responseType: "+t}}var n=/^data:(.*?)(;base64)?,(.*)$/,o=n.exec(e);if(null!==o)return void r.streamAvailable(e,a(o,t));if(!t)return void r.handleError(THREE.GLTFLoaderUtils.INVALID_TYPE,null);if(!e)return void r.handleError(THREE.GLTFLoaderUtils.INVALID_PATH);var h=new XMLHttpRequest;h.open("GET",e,!0),h.responseType=t===this.ARRAY_BUFFER?"arraybuffer":"text",h.setRequestHeader("If-Modified-Since","Sat, 01 Jan 1970 00:00:00 GMT"),h.onload=function(t){200==h.status||206==h.status?r.streamAvailable(e,h.response):r.handleError(THREE.GLTFLoaderUtils.XMLHTTPREQUEST_STATUS_ERROR,this.status)},h.send(null)}},send:{value:0,writable:!0},requested:{value:0,writable:!0},_handleRequest:{value:function(e){var t=this._resourcesStatus[e.id];t?this._resourcesStatus[e.id]++:this._resourcesStatus[e.id]=1;var r=this._streamsStatus[e.uri];if(r&&"loading"===r.status)return void r.requests.push(e);this._streamsStatus[e.uri]={status:"loading",requests:[e]};var i=this,s={};s.streamAvailable=function(e,t){var r=i._streamsStatus[e],s=r.requests;s.forEach(function(e){var r=t.slice(e.range[0],e.range[1]),s=e.delegate.convert(r,e.ctx);i._storeResource(e.id,s),e.delegate.resourceAvailable(s,e.ctx),--i._resourcesStatus[e.id]},this),delete i._streamsStatus[e]},s.handleError=function(t,r){e.delegate.handleError(t,r)},this._loadStream(e.uri,e.type,s)}},_elementSizeForGLType:{value:function(e,t){var r=0;switch(t){case"SCALAR":r=1;break;case"VEC2":r=2;break;case"VEC3":r=3;break;case"VEC4":r=4;break;case"MAT2":r=4;break;case"MAT3":r=9;break;case"MAT4":r=16}switch(e){case WebGLRenderingContext.FLOAT:return Float32Array.BYTES_PER_ELEMENT*r;case WebGLRenderingContext.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT*r;case WebGLRenderingContext.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT*r;default:return null}}},_handleWrappedBufferViewResourceLoading:{value:function(e,t,r){var i=e.bufferView,s=i.buffer,a=e.byteOffset+i.description.byteOffset,n=[a,this._elementSizeForGLType(e.componentType,e.type)*e.count+a];this._handleRequest({id:e.id,range:n,type:s.description.type,uri:s.description.uri,delegate:t,ctx:r},null)}},getBuffer:{value:function(e,t,r){this._getResource(e.id);return this._handleWrappedBufferViewResourceLoading(e,t,r),null}},getFile:{value:function(e,t,r){return e.delegate=t,e.ctx=r,this._handleRequest({id:e.id,uri:e.uri,range:[0],type:"text",delegate:t,ctx:r},null),null}}}),THREE.glTFAnimator=function(){var e=[];return{add:function(t){e.push(t)},remove:function(t){var r=e.indexOf(t);r!==-1&&e.splice(r,1)},update:function(){for(i=0;i<e.length;i++)e[i].update()}}}(),THREE.glTFAnimation=function(e){this.running=!1,this.loop=!1,this.duration=0,this.startTime=0,this.interps=[],e&&this.createInterpolators(e)},THREE.glTFAnimation.prototype.createInterpolators=function(e){var t,r=e.length;for(t=0;t<r;t++){var i=new THREE.glTFInterpolator(e[t]);this.interps.push(i),this.duration=Math.max(this.duration,i.duration)}},THREE.glTFAnimation.prototype.play=function(){this.running||(this.startTime=Date.now(),this.running=!0,THREE.glTFAnimator.add(this))},THREE.glTFAnimation.prototype.stop=function(){this.running=!1,THREE.glTFAnimator.remove(this)},THREE.glTFAnimation.prototype.update=function(){if(this.running){var e=Date.now(),t=(e-this.startTime)/1e3,r=t%this.duration,i=Math.floor(t/this.duration);if(i>=1&&!this.loop){this.running=!1;var s,a=this.interps.length;for(s=0;s<a;s++)this.interps[s].interp(this.duration);return void this.stop()}var s,a=this.interps.length;for(s=0;s<a;s++)this.interps[s].interp(r)}},THREE.glTFInterpolator=function(e){this.keys=e.keys,this.values=e.values,this.count=e.count,this.type=e.type,this.path=e.path,this.isRot=!1;var t=e.target;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,this.targetNode=t,e.path){case"translation":this.target=t.position,this.originalValue=t.position.clone();break;case"rotation":this.target=t.quaternion,this.originalValue=t.quaternion.clone(),this.isRot=!0;break;case"scale":this.target=t.scale,this.originalValue=t.scale.clone()}this.duration=this.keys[this.count-1],this.vec1=new THREE.Vector3,this.vec2=new THREE.Vector3,this.vec3=new THREE.Vector3,this.quat1=new THREE.Quaternion,this.quat2=new THREE.Quaternion,this.quat3=new THREE.Quaternion},THREE.glTFInterpolator.prototype.interp=function(e){var t;if(e==this.keys[0])this.isRot?this.quat3.set(this.values[0],this.values[1],this.values[2],this.values[3]):this.vec3.set(this.values[0],this.values[1],this.values[2]);else if(e<this.keys[0])this.isRot?(this.quat1.set(this.originalValue.x,this.originalValue.y,this.originalValue.z,this.originalValue.w),this.quat2.set(this.values[0],this.values[1],this.values[2],this.values[3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,e/this.keys[0])):(this.vec3.set(this.originalValue.x,this.originalValue.y,this.originalValue.z),this.vec2.set(this.values[0],this.values[1],this.values[2]),this.vec3.lerp(this.vec2,e/this.keys[0]));else if(e>=this.keys[this.count-1])this.isRot?this.quat3.set(this.values[4*(this.count-1)],this.values[4*(this.count-1)+1],this.values[4*(this.count-1)+2],this.values[4*(this.count-1)+3]):this.vec3.set(this.values[3*(this.count-1)],this.values[3*(this.count-1)+1],this.values[3*(this.count-1)+2]);else for(t=0;t<this.count-1;t++){var r=this.keys[t],i=this.keys[t+1];e>=r&&e<=i&&(this.isRot?(this.quat1.set(this.values[4*t],this.values[4*t+1],this.values[4*t+2],this.values[4*t+3]),this.quat2.set(this.values[4*(t+1)],this.values[4*(t+1)+1],this.values[4*(t+1)+2],this.values[4*(t+1)+3]),THREE.Quaternion.slerp(this.quat1,this.quat2,this.quat3,(e-r)/(i-r))):(this.vec3.set(this.values[3*t],this.values[3*t+1],this.values[3*t+2]),this.vec2.set(this.values[3*(t+1)],this.values[3*(t+1)+1],this.values[3*(t+1)+2]),this.vec3.lerp(this.vec2,(e-r)/(i-r))))}this.target&&this.copyValue(this.target)},THREE.glTFInterpolator.prototype.copyValue=function(e){this.isRot?e.copy(this.quat3):e.copy(this.vec3)},THREE.glTFShaders=function(){var e=[];return{add:function(t){e.push(t)},remove:function(t){var r=e.indexOf(t);r!==-1&&e.splice(r,1)},removeAll:function(t){e=[]},bindShaderParameters:function(t){for(i=0;i<e.length;i++)e[i].bindParameters(t)},update:function(t,r){for(i=0;i<e.length;i++)e[i].update(t,r)}}}(),THREE.glTFShader=function(e,t,r,i){this.material=e,this.parameters=t.technique.parameters,this.uniforms=t.technique.uniforms,this.joints=t.joints,this.object=r,this.semantics={},this.m4=new THREE.Matrix4},THREE.glTFShader.prototype.bindParameters=function(e){function t(e,t){e.glTFID==s.node&&(t.sourceObject=e)}for(var r in this.uniforms){var i=this.uniforms[r],s=this.parameters[i];if(s.semantic){var a={semantic:s.semantic,uniform:this.material.uniforms[r]};s.node?e.traverse(function(e){t(e,a)}):a.sourceObject=this.object,this.semantics[i]=a}}},THREE.glTFShader.prototype.update=function(e,t){e.updateMatrixWorld(),t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld);for(var r in this.semantics){var i=this.semantics[r];if(i)switch(i.semantic){case"MODELVIEW":var s=i.uniform.value;s.multiplyMatrices(t.matrixWorldInverse,i.sourceObject.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var a=i.uniform.value;this.m4.multiplyMatrices(t.matrixWorldInverse,i.sourceObject.matrixWorld),a.getNormalMatrix(this.m4);break;case"PROJECTION":var s=i.uniform.value;s.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var n=i.uniform.value,o=0;o<n.length;o++)n[o].getInverse(i.sourceObject.matrixWorld).multiply(this.joints[o].matrixWorld).multiply(this.object.skeleton.boneInverses[o]);break;default:throw new Error("Unhandled shader semantic"+i)}}},THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(e,t){function r(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function i(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}function s(e,t,r,i){for(var s=r*i*4,a=new Uint8Array(e,t,s),n=new Uint8Array(s),o=0,h=0,c=0;c<i;c++)for(var l=0;l<r;l++){var u=a[h];h++;var d=a[h];h++;var p=a[h];h++;var f=a[h];h++,n[o]=p,o++,n[o]=d,o++,n[o]=u,o++,n[o]=f,o++}return n}var a={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},n=542327876,o=131072,h=512,c=1024,l=2048,u=4096,d=8192,p=16384,f=32768,m=4,v=r("DXT1"),g=r("DXT3"),y=r("DXT5"),E=r("ETC1"),b=31,T=0,w=1,x=2,_=3,R=4,N=7,k=20,A=21,H=22,C=23,L=24,I=25,M=26,S=28,O=new Int32Array(e,0,b);if(O[T]!==n)return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),a;if(!O[k]&m)return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),a;var D,F=O[A],P=!1;switch(F){case v:D=8,a.format=THREE.RGB_S3TC_DXT1_Format;break;case g:D=16,a.format=THREE.RGBA_S3TC_DXT3_Format;break;case y:D=16,a.format=THREE.RGBA_S3TC_DXT5_Format;break;case E:D=8,a.format=THREE.RGB_ETC1_Format;break;default:if(!(32===O[H]&&16711680&O[C]&&65280&O[L]&&255&O[I]&&4278190080&O[M]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",i(F)),a;P=!0,D=64,a.format=THREE.RGBAFormat;
}a.mipmapCount=1,O[x]&o&&t!==!1&&(a.mipmapCount=Math.max(1,O[N]));var B=O[S];if(a.isCubemap=!!(B&h),a.isCubemap&&(!(B&c)||!(B&l)||!(B&u)||!(B&d)||!(B&p)||!(B&f)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),a;a.width=O[R],a.height=O[_];for(var j=O[w]+4,V=a.isCubemap?6:1,G=0;G<V;G++)for(var U=a.width,q=a.height,X=0;X<a.mipmapCount;X++){if(P)var z=s(e,j,U,q),W=z.length;else var W=Math.max(4,U)/4*Math.max(4,q)/4*D,z=new Uint8Array(e,j,W);var Y={data:z,width:U,height:q};a.mipmaps.push(Y),j+=W,U=Math.max(U>>1,1),q=Math.max(q>>1,1)}return a},THREE.TGALoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.TGALoader.prototype.load=function(e,t,r,i){var s=this,a=new THREE.Texture,n=new THREE.XHRLoader(this.manager);return n.setResponseType("arraybuffer"),n.load(e,function(e){a.image=s.parse(e),a.needsUpdate=!0,void 0!==t&&t(a)},r,i),a},THREE.TGALoader.prototype.parse=function(e){function t(e){switch(e.image_type){case u:case f:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case d:case p:case m:case v:e.colormap_type&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case l:console.error("THREE.TGALoader.parse.tgaCheckHeader: No data");default:console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid type " '+e.image_type+'"')}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid image size"),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid pixel size "'+e.pixel_size+'"')}function r(e,t,r,i,s){var a,n,o,h;if(n=r.pixel_size>>3,o=r.width*r.height*n,t&&(h=s.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),e){a=new Uint8Array(o);for(var c,l,u,d=0,p=new Uint8Array(n);d<o;)if(c=s[i++],l=(127&c)+1,128&c){for(u=0;u<n;++u)p[u]=s[i++];for(u=0;u<l;++u)a.set(p,d+u*n);d+=n*l}else{for(l*=n,u=0;u<l;++u)a[d+u]=s[i++];d+=l}}else a=s.subarray(i,i+=t?r.width*r.height:o);return{pixel_data:a,palettes:h}}function i(e,t,r,i,s,a,n,o,h){var c,l,u,d=h,p=0,f=R.width;for(u=t;u!==i;u+=r)for(l=s;l!==n;l+=a,p++)c=o[p],e[4*(l+f*u)+3]=255,e[4*(l+f*u)+2]=d[3*c+0],e[4*(l+f*u)+1]=d[3*c+1],e[4*(l+f*u)+0]=d[3*c+2];return e}function s(e,t,r,i,s,a,n,o){var h,c,l,u=0,d=R.width;for(l=t;l!==i;l+=r)for(c=s;c!==n;c+=a,u+=2)h=o[u+0]+(o[u+1]<<8),e[4*(c+d*l)+0]=(31744&h)>>7,e[4*(c+d*l)+1]=(992&h)>>2,e[4*(c+d*l)+2]=(31&h)>>3,e[4*(c+d*l)+3]=32768&h?0:255;return e}function a(e,t,r,i,s,a,n,o){var h,c,l=0,u=R.width;for(c=t;c!==i;c+=r)for(h=s;h!==n;h+=a,l+=3)e[4*(h+u*c)+3]=255,e[4*(h+u*c)+2]=o[l+0],e[4*(h+u*c)+1]=o[l+1],e[4*(h+u*c)+0]=o[l+2];return e}function n(e,t,r,i,s,a,n,o){var h,c,l=0,u=R.width;for(c=t;c!==i;c+=r)for(h=s;h!==n;h+=a,l+=4)e[4*(h+u*c)+2]=o[l+0],e[4*(h+u*c)+1]=o[l+1],e[4*(h+u*c)+0]=o[l+2],e[4*(h+u*c)+3]=o[l+3];return e}function o(e,t,r,i,s,a,n,o){var h,c,l,u=0,d=R.width;for(l=t;l!==i;l+=r)for(c=s;c!==n;c+=a,u++)h=o[u],e[4*(c+d*l)+0]=h,e[4*(c+d*l)+1]=h,e[4*(c+d*l)+2]=h,e[4*(c+d*l)+3]=255;return e}function h(e,t,r,i,s,a,n,o){var h,c,l=0,u=R.width;for(c=t;c!==i;c+=r)for(h=s;h!==n;h+=a,l+=2)e[4*(h+u*c)+0]=o[l+0],e[4*(h+u*c)+1]=o[l+0],e[4*(h+u*c)+2]=o[l+0],e[4*(h+u*c)+3]=o[l+1];return e}function c(e,t,r,c,l){var u,d,p,f,m,v;switch((R.flags&g)>>y){default:case T:u=0,p=1,m=t,d=0,f=1,v=r;break;case E:u=0,p=1,m=t,d=r-1,f=-1,v=-1;break;case w:u=t-1,p=-1,m=-1,d=0,f=1,v=r;break;case b:u=t-1,p=-1,m=-1,d=r-1,f=-1,v=-1}if(A)switch(R.pixel_size){case 8:o(e,d,f,v,u,p,m,c);break;case 16:h(e,d,f,v,u,p,m,c);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}else switch(R.pixel_size){case 8:i(e,d,f,v,u,p,m,c,l);break;case 16:s(e,d,f,v,u,p,m,c);break;case 24:a(e,d,f,v,u,p,m,c);break;case 32:n(e,d,f,v,u,p,m,c);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}return e}var l=0,u=1,d=2,p=3,f=9,m=10,v=11,g=48,y=4,E=0,b=1,T=2,w=3;e.length<19&&console.error("THREE.TGALoader.parse: Not enough data to contain header.");var x=new Uint8Array(e),_=0,R={id_length:x[_++],colormap_type:x[_++],image_type:x[_++],colormap_index:x[_++]|x[_++]<<8,colormap_length:x[_++]|x[_++]<<8,colormap_size:x[_++],origin:[x[_++]|x[_++]<<8,x[_++]|x[_++]<<8],width:x[_++]|x[_++]<<8,height:x[_++]|x[_++]<<8,pixel_size:x[_++],flags:x[_++]};t(R),R.id_length+_>e.length&&console.error("THREE.TGALoader.parse: No data"),_+=R.id_length;var N=!1,k=!1,A=!1;switch(R.image_type){case f:N=!0,k=!0;break;case u:k=!0;break;case m:N=!0;break;case d:break;case v:N=!0,A=!0;break;case p:A=!0}var H=document.createElement("canvas");H.width=R.width,H.height=R.height;var C=H.getContext("2d"),L=C.createImageData(R.width,R.height),I=r(N,k,R,_,x);c(L.data,R.width,R.height,I.pixel_data,I.palettes);return C.putImageData(L,0,0),H},function(){function e(){}function t(){}function r(){}function i(){this.skinIndices=[],this.skinWeights=[],this.matrices=[]}function s(){this.hierarchy=[]}function a(){this.node=null,this.name=null,this.id=null,this.vertices=[],this.indices=[],this.normals=[],this.uvs=[],this.colors=[],this.bones=[],this.skins=null}function n(){this.uv=null,this.map=null,this.ref=null,this.node=null,this.index=null}function o(){this.normal=null,this.map=null,this.ref=null,this.node=null,this.index=null}function h(){this.color=null,this.map=null,this.ref=null,this.node=null,this.index=null}function c(){this.version=null,this.id=null,this.internalId=null,this.times=null,this.values=null,this.attrFlag=null,this.attrData=null}function l(){this.id=null,this.attr=null,this.attrX=!1,this.attrY=!1,this.attrZ=!1,this.internalId=null,this.containerInternalId=null,this.containerBoneId=null,this.curveIdx=null,this.curves=[]}function u(){this.curves={},this.length=0,this.fps=30,this.frames=0}function d(){this.textures=[],this.perGeoMap={}}function p(){this.fileName="",this.name="",this.id=null,this.parentIds=[]}function f(e,t,r){var i=[];if(t)for(var s=0;s<t.length;++s)for(var a=0;a<r;++a)i.push(e[t[s]*r+a]);return i}function m(e,t,r){for(var i={},s=[],a=0,n=0;n<t.length;++n)if(!(t[n]in i)){i[t[n]]={};for(var o=0;o<r;++o)i[t[n]][o]=e[n*r+o];a=a<t[n]?t[n]:a}try{for(n=0;n<=a;n++)for(var h=0;h<r;h++)s.push(i[n][h])}catch(e){}return s}THREE.FBXLoader=function(e){THREE.Loader.call(this),this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.textureLoader=null,this.textureBasePath=null},THREE.FBXLoader.prototype=Object.create(THREE.Loader.prototype),THREE.FBXLoader.prototype.constructor=THREE.FBXLoader,THREE.FBXLoader.prototype.load=function(e,t,r,i){var s=this,a=new THREE.XHRLoader(s.manager);a.load(e,function(r){s.isFbxFormatASCII(r)?s.isFbxVersionSupported(r)?(s.textureBasePath=s.extractUrlBase(e),t(s.parse(r))):console.warn("FBXLoader: !!! FBX Version below 7 not supported !!!"):console.warn("FBXLoader: !!! FBX Binary format not supported !!!")},r,i)},THREE.FBXLoader.prototype.setCrossOrigin=function(e){this.crossOrigin=e},THREE.FBXLoader.prototype.isFbxFormatASCII=function(e){CORRECT=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];for(var t=0,r=function(r){var i=e[r-1];return e=e.slice(t+r),t++,i},i=0;i<CORRECT.length;++i)if(num=r(1),num==CORRECT[i])return!1;return!0},THREE.FBXLoader.prototype.isFbxVersionSupported=function(e){var t=/FBXVersion: (\d+)/;if(match=e.match(t),match){var r=parseInt(match[1]);return console.log("FBXLoader: FBX version "+r),r>=7e3}return!1},THREE.FBXLoader.prototype.parse=function(e){var r=this;console.time("FBXLoader"),console.time("FBXLoader: TextParser");var a=(new t).parse(e);console.timeEnd("FBXLoader: TextParser"),console.time("FBXLoader: ObjectParser"),r.hierarchy=(new s).parseHierarchy(a),r.weights=(new i).parse(a,r.hierarchy),r.animations=(new u).parse(a,r.hierarchy),console.timeEnd("FBXLoader: ObjectParser"),console.time("FBXLoader: GeometryParser"),geometries=this.parseGeometries(a),console.timeEnd("FBXLoader: GeometryParser");for(var n=new THREE.Group,o=0;o<geometries.length;++o)void 0!==geometries[o]&&n.add(geometries[o]);return console.timeEnd("FBXLoader"),n},THREE.FBXLoader.prototype.parseGeometries=function(e){if(!("Geometry"in e.Objects.subNodes))return[];var t=0;for(var r in e.Objects.subNodes.Geometry)r.match(/^\d+$/)&&t++;var i=[];if(t>0){for(r in e.Objects.subNodes.Geometry)if("Mesh"===e.Objects.subNodes.Geometry[r].attrType)for(var s=this.parseGeometry(e.Objects.subNodes.Geometry[r],e),a=0;a<s.length;a++)i.push(s[a])}else for(var s=this.parseGeometry(e.Objects.subNodes.Geometry,e),a=0;a<s.length;a++)i.push(s[a]);return i},THREE.FBXLoader.prototype.parseGeometry=function(e,t){geo=(new a).parse(e),geo.addBones(this.hierarchy.hierarchy),console.log(geo);var r=[];return r.push(this.makeGeometry(geo)),r},THREE.FBXLoader.prototype.makeGeometry=function(e){var t=new THREE.BufferGeometry;t.name=e.name,t.addAttribute("position",new THREE.BufferAttribute(new Float32Array(e.vertices),3)),void 0!==e.normals&&e.normals.length>0&&t.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(e.normals),3)),void 0!==e.uvs&&e.uvs.length>0&&t.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.uvs),2)),void 0!==e.colors&&e.colors.length>0&&t.addAttribute("color",new THREE.BufferAttribute(new Float32Array(e.colors),3)),void 0!==e.indices&&e.indices.length>65535?t.setIndex(new THREE.BufferAttribute(new Uint32Array(e.indices),1)):void 0!==e.indices&&t.setIndex(new THREE.BufferAttribute(new Uint16Array(e.indices),1)),t.verticesNeedUpdate=!0,t.computeBoundingSphere(),t.computeBoundingBox();var r,i=!1;void 0!==i&&i.length>0&&i&&(null===this.textureLoader&&(this.textureLoader=new THREE.TextureLoader),r=this.textureLoader.load(i));var s;s=void 0!==r?new THREE.MeshBasicMaterial({alphaMap:r,map:r,transparent:!0,side:THREE.DoubleSide,vertexColors:THREE.VertexColors}):new THREE.MeshBasicMaterial({side:THREE.DoubleSide,vertexColors:THREE.VertexColors}),t=(new THREE.Geometry).fromBufferGeometry(t),t.bones=e.bones,t.skinIndices=this.weights.skinIndices,t.skinWeights=this.weights.skinWeights;var a=null;return void 0===e.bones||void 0===e.skins||void 0===this.animations||0===this.animations.length?a=new THREE.Mesh(t,s):(s.skinning=!0,a=new THREE.SkinnedMesh(t,s),this.addAnimation(a,this.weights.matrices,this.animations)),a},THREE.FBXLoader.prototype.addAnimation=function(e,t,r){for(var i={name:"animationtest",fps:30,length:r.length,hierarchy:[]},s=0;s<e.geometry.bones.length;++s){var a=e.geometry.bones[s].name;a=a.replace(/.*:/,""),i.hierarchy.push({parent:e.geometry.bones[s].parent,name:a,keys:[]})}var n=function(e,t){if(void 0===e)return!1;var r;switch(t){case"S":if(void 0===e.S)return!1;r=e.S;break;case"R":if(void 0===e.R)return!1;r=e.R;break;case"T":if(void 0===e.T)return!1;r=e.T}return void 0!==r.curves.x&&(void 0!==r.curves.y&&void 0!==r.curves.z)},o=function(e,t){var r=h(e.curves.x,t),i=h(e.curves.y,t),s=h(e.curves.z,t);return r&&i&&s},h=function(e,t){var r=e.values[t];return void 0!==r},c=function(e,t){var i={};if(i.time=frame/r.fps,i.pos=t.pos,i.rot=t.rotq,i.scl=t.scl,void 0===e)return i;try{if(n(e,"T")&&o(e.T,frame)){var s=new THREE.Vector3(e.T.curves.x.values[frame],e.T.curves.y.values[frame],e.T.curves.z.values[frame]);i.pos=[s.x,s.y,s.z]}else delete i.pos;if(n(e,"R")&&o(e.R,frame)){var a=degToRad(e.R.curves.x.values[frame]),h=degToRad(e.R.curves.y.values[frame]),c=degToRad(e.R.curves.z.values[frame]),l=new THREE.Vector3(a,h,c),u=quatFromVec(l.x,l.y,l.z);i.rot=[u.x,u.y,u.z,u.w]}else delete i.rot;if(n(e,"S")&&o(e.S,frame)){var d=new THREE.Vector3(e.S.curves.x.values[frame],e.S.curves.y.values[frame],e.S.curves.z.values[frame]);i.scl=[d.x,d.y,d.z]}else delete i.scl}catch(e){console.log(t),console.log(e)}return i},l=e.geometry.bones;for(frame=0;frame<r.frames;frame++)for(s=0;s<l.length;s++)for(var u=l[s],d=r.curves[s],p=0;p<i.hierarchy.length;p++)i.hierarchy[p].name===u.name&&i.hierarchy[p].keys.push(c(d,u));void 0===e.geometry.animations&&(e.geometry.animations=[]),e.geometry.animations.push(THREE.AnimationClip.parseAnimation(i,e.geometry.bones))},THREE.FBXLoader.prototype.parseMaterials=function(e){if(!("Material"in e.subNodes))return[];var t=0;for(var r in e.subNodes.Materials)r.match(/^\d+$/)&&t++;var i=[];if(t>0)for(r in e.subNodes.Material)i.push(parseMaterial(e.subNodes.Material[r]));else i.push(parseMaterial(e.subNodes.Material));return i},THREE.FBXLoader.prototype.parseMaterial=function(e){},THREE.FBXLoader.prototype.loadFile=function(e,t,r,i,s){var a=new THREE.FileLoader(this.manager);a.setResponseType(s);var n=a.load(e,function(e){t(e)},r,i);return n},THREE.FBXLoader.prototype.loadFileAsBuffer=function(e,t,r,i){this.loadFile(e,onLoad,r,i,"arraybuffer")},THREE.FBXLoader.prototype.loadFileAsText=function(e,t,r,i){this.loadFile(e,t,r,i,"text")},e.prototype.add=function(e,t){this[e]=t},e.prototype.searchConnectionParent=function(e){if(void 0===this.__cache_search_connection_parent&&(this.__cache_search_connection_parent=[]),void 0!==this.__cache_search_connection_parent[e])return this.__cache_search_connection_parent[e];this.__cache_search_connection_parent[e]=[];for(var t=this.Connections.properties.connections,r=[],i=0;i<t.length;++i)if(t[i][0]==e){var s=0===t[i][1]?-1:t[i][1];r.push(s)}return r.length>0?(this.__cache_search_connection_parent[e]=this.__cache_search_connection_parent[e].concat(r),r):(this.__cache_search_connection_parent[e]=[-1],[-1])},e.prototype.searchConnectionChildren=function(e){if(void 0===this.__cache_search_connection_children&&(this.__cache_search_connection_children=[]),void 0!==this.__cache_search_connection_children[e])return this.__cache_search_connection_children[e];this.__cache_search_connection_children[e]=[];for(var t=this.Connections.properties.connections,r=[],i=0;i<t.length;++i)t[i][1]==e&&r.push(0===t[i][0]?-1:t[i][0]);return r.length>0?(this.__cache_search_connection_children[e]=this.__cache_search_connection_children[e].concat(r),r):(this.__cache_search_connection_children[e]=[-1],[-1])},e.prototype.searchConnectionType=function(e,t){var r=e+","+t;if(void 0===this.__cache_search_connection_type&&(this.__cache_search_connection_type=""),void 0!==this.__cache_search_connection_type[r])return this.__cache_search_connection_type[r];this.__cache_search_connection_type[r]="";for(var i=this.Connections.properties.connections,s=0;s<i.length;++s)if(i[s][0]==e&&i[s][1]==t)return this.__cache_search_connection_type[r]=i[s][2],i[s][2];return this.__cache_search_connection_type[e]=null,null},t.prototype={getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(e){this.nodeStack.push(e),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(e,t){this.currentProp=e,this.currentPropName=t},parse:function(t){this.currentIndent=0,this.allNodes=new e,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var r=t.split("\n");for(var i in r){var s=r[i];if(!s.match(/^[\s\t]*;/)&&!s.match(/^[\s\t]*$/)){var a=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):(.*){","");if(match=s.match(a),match){var n=match[1].trim().replace(/^"/,"").replace(/"$/,""),o=match[2].split(",").map(function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")});this.parseNodeBegin(s,n,o||null)}else{var h=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)");if(match=s.match(h),match){var c=match[1].replace(/^"/,"").replace(/"$/,"").trim(),l=match[2].replace(/^"/,"").replace(/"$/,"").trim();this.parseNodeProperty(s,c,l)}else{var u=new RegExp("^\\t{"+(this.currentIndent-1)+"}}");s.match(u)?this.nodeEnd():s.match(/^[^\s\t}]/)&&this.parseNodePropertyContinued(s)}}}}return this.allNodes},parseNodeBegin:function(e,t,r){var i={name:t,properties:{},subNodes:{}},s=this.parseNodeAttr(r),a=this.getCurrentNode();if(0===this.currentIndent)this.allNodes.add(t,i);else if(t in a.subNodes){var n=a.subNodes[t];this.isFlattenNode(a.subNodes[t])&&(""===s.id?(a.subNodes[t]=[],a.subNodes[t].push(n)):(a.subNodes[t]={},a.subNodes[t][n.id]=n)),""===s.id?a.subNodes[t].push(i):a.subNodes[t][s.id]=i}else a.subNodes[t]=i;r&&(i.id=s.id,i.attrName=s.name,i.attrType=s.type),this.pushStack(i)},parseNodeAttr:function(e){var t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));var r,i;return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:r||"",type:i||""}},parseNodeProperty:function(e,t,r){var i=this.getCurrentNode(),s=i.name;if(void 0!==s){var a=s.match(/Properties(\d)+/);if(a)return void this.parseNodeSpecialProperty(e,t,r)}if("C"==t){var n=r.split(",").slice(1),o=parseInt(n[0]),h=parseInt(n[1]),c=r.split(",").slice(3);t="connections",r=[o,h],r=r.concat(c),void 0===i.properties[t]&&(i.properties[t]=[])}if("Node"==t){var l=parseInt(r);i.properties.id=l,i.id=l}t in i.properties?Array.isArray(i.properties[t])?i.properties[t].push(r):i.properties[t]+=r:Array.isArray(i.properties[t])?i.properties[t].push(r):i.properties[t]=r,this.setCurrentProp(i.properties,t)},parseNodePropertyContinued:function(e){this.currentProp[this.currentPropName]+=e},parseNodeSpecialProperty:function(e,t,r){var i=r.split('",').map(function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")}),s=i[0],a=i[1],n=i[2],o=i[3],h=i[4];switch(a){case"int":h=parseInt(h);break;case"double":h=parseFloat(h);break;case"ColorRGB":case"Vector3D":var c=h.split(",");h=new THREE.Vector3(c[0],c[1],c[2])}this.getPrevNode().properties[s]={type:a,type2:n,flag:o,value:h},this.setCurrentProp(this.getPrevNode().properties,s)},nodeEnd:function(e){this.popStack()},isFlattenNode:function(e){return"subNodes"in e&&"properties"in e}},r.prototype={},i.prototype.parseCluster=function(e,t,r){var i=e.searchConnectionParent(t),s=toInt(r.subNodes.Indexes.properties.a.split(",")),a=toFloat(r.subNodes.Weights.properties.a.split(",")),n=toMat44(toFloat(r.subNodes.Transform.properties.a.split(","))),o=toMat44(toFloat(r.subNodes.TransformLink.properties.a.split(",")));return{parent:i,id:parseInt(t),indices:s,weights:a,transform:n,transformlink:o,linkMode:r.properties.Mode}},i.prototype.parse=function(e,t){this.skinIndices=[],this.skinWeights=[],this.matrices=[];var r=e.Objects.subNodes.Deformer,i={};for(var s in r)if("Cluster"===r[s].attrType){if(!("Indexes"in r[s].subNodes))continue;var a=this.parseCluster(e,s,r[s]),n=e.searchConnectionChildren(a.id)[0];i[n]=a}for(var o=[],h=t.hierarchy,c=0;c<h.length;++c){var l=h[c].internalId;if(void 0!==i[l]){var u=i[l];this.matrices.push(u.transform);for(var d=0;d<u.indices.length;++d){void 0===o[u.indices[d]]&&(o[u.indices[d]]={},o[u.indices[d]].joint=[],o[u.indices[d]].weight=[]);var p=e.searchConnectionChildren(u.id);p.length>1&&console.warn("FBXLoader: node "+u.id+" have many weight kids: "+p),o[u.indices[d]].joint.push(t.getBoneIdfromInternalId(e,p[0])),o[u.indices[d]].weight.push(u.weights[d])}}else this.matrices.push(new THREE.Matrix4)}for(var f=0;f<o.length;f++){var m=new THREE.Vector4(o[f].joint[0]?o[f].joint[0]:0,o[f].joint[1]?o[f].joint[1]:0,o[f].joint[2]?o[f].joint[2]:0,o[f].joint[3]?o[f].joint[3]:0),v=new THREE.Vector4(o[f].weight[0]?o[f].weight[0]:0,o[f].weight[1]?o[f].weight[1]:0,o[f].weight[2]?o[f].weight[2]:0,o[f].weight[3]?o[f].weight[3]:0);this.skinIndices.push(m),this.skinWeights.push(v)}return this},s.prototype.parseHierarchy=function(e){var t=e.Objects,r=t.subNodes.Model,i=[];for(var s in r)void 0!==r[s].attrType&&i.push(r[s]);this.hierarchy=[];for(var a=0;a<i.length;++a){var n=i[a],o=e.searchConnectionParent(n.id)[0],h=[0,0,0],c=[0,0,0,1],l=[1,1,1];if("Lcl_Translation"in n.properties&&(h=toFloat(n.properties.Lcl_Translation.value.split(","))),"Lcl_Rotation"in n.properties){c=toRad(toFloat(n.properties.Lcl_Rotation.value.split(",")));var u=new THREE.Quaternion;u.setFromEuler(new THREE.Euler(c[0],c[1],c[2],"ZYX")),c=[u.x,u.y,u.z,u.w]}"Lcl_Scaling"in n.properties&&(l=toFloat(n.properties.Lcl_Scaling.value.split(",")));var d=n.attrName;d=d.replace(/:/,""),d=d.replace(/_/,""),d=d.replace(/-/,""),this.hierarchy.push({parent:o,name:d,pos:h,rotq:c,scl:l,internalId:n.id})}return this.reindexParentId(),this},s.prototype.reindexParentId=function(){for(var e=0;e<this.hierarchy.length;e++)for(var t=0;t<this.hierarchy.length;++t)if(this.hierarchy[e].parent==this.hierarchy[t].internalId){this.hierarchy[e].parent=t;break}},s.prototype.restoreBindPose=function(e){var t=e.Objects.subNodes.Pose;if(void 0!==t){for(var r=t.subNodes.PoseNode,i={},s={},a=0;a<r.length;++a){var n=toMat44(r[a].subNodes.Matrix.properties.a.split(",")),o=toMat44(r[a].subNodes.Matrix.properties.a.split(","));i[r[a].id]=n,s[r[a].id]=o}for(var h=0;h<this.hierarchy.length;++h){var c=this.hierarchy[h],l=c.internalId;if(void 0!==s[l]){for(var u,d=new THREE.Vector3(0,0,0),p=new THREE.Quaternion,f=new THREE.Vector3(1,1,1),m=e.searchConnectionParent(l),v=0;v<m.length;++v)if(this.isBoneNode(m[v])){u=m[v];break}if(void 0!==u&&void 0!==i[u]){var g=new THREE.Matrix4;g.getInverse(s[u]),g.multiply(i[l]),i[l]=g}i[l].decompose(d,p,f),c.pos=[d.x,d.y,d.z],c.rotq=[p.x,p.y,p.z,p.w],c.scl=[f.x,f.y,f.z]}}}},s.prototype.searchRealId=function(e){for(var t=0;t<this.hierarchy.length;t++)if(e==this.hierarchy[t].internalId)return t;return-1},s.prototype.getByInternalId=function(e){for(var t=0;t<this.hierarchy.length;t++)if(e==this.hierarchy[t].internalId)return this.hierarchy[t];return null},s.prototype.isBoneNode=function(e){for(var t=0;t<this.hierarchy.length;++t)if(e===this.hierarchy[t].internalId)return!0;return!1},s.prototype.getBoneIdfromInternalId=function(e,t){if(void 0===e.__cache_get_boneid_from_internalid&&(e.__cache_get_boneid_from_internalid=[]),void 0!==e.__cache_get_boneid_from_internalid[t])return e.__cache_get_boneid_from_internalid[t];for(var r=0;r<this.hierarchy.length;++r)if(this.hierarchy[r].internalId==t){return e.__cache_get_boneid_from_internalid[t]=r,r}return-1},a.prototype.parse=function(e){return this.node=e,this.name=e.attrName,this.id=e.id,this.vertices=this.getVertices(),void 0===this.vertices?void console.log("FBXLoader: Geometry.parse(): pass"+this.node.id):(this.indices=this.getPolygonVertexIndices(),this.uvs=(new n).parse(this.node,this),this.normals=(new o).parse(this.node,this),this.colors=(new h).parse(this.node,this),this.getPolygonTopologyMax()>3&&(this.indices=this.convertPolyIndicesToTri(this.indices,this.getPolygonTopologyArray())),this)},a.prototype.getVertices=function(){if(this.node.__cache_vertices)return this.node.__cache_vertices;if(void 0===this.node.subNodes.Vertices)return console.warn("this.node: "+this.node.attrName+"("+this.node.id+") does not have Vertices"),this.node.__cache_vertices=void 0,null;var e=this.node.subNodes.Vertices.properties.a,t=e.split(",").map(function(e){return parseFloat(e)});return this.node.__cache_vertices=t,this.node.__cache_vertices},a.prototype.getPolygonVertexIndices=function(){if(this.node.__cache_indices&&this.node.__cache_poly_topology_max)return this.node.__cache_indices;if(void 0===this.node.subNodes)return console.error("this.node.subNodes undefined"),void console.log(this.node);if(void 0===this.node.subNodes.PolygonVertexIndex)return console.warn("this.node: "+this.node.attrName+"("+this.node.id+") does not have PolygonVertexIndex "),void(this.node.__cache_indices=void 0);for(var e=this.node.subNodes.PolygonVertexIndex.properties.a,t=e.split(","),r=1,i=null,s=[],a=0;a<t.length;++a){var n=parseInt(t[a]);n<0?(r>i&&(i=r),t[a]=n^-1,s.push(r),r=1):(t[a]=n,r++)}return null===i&&(console.warn("FBXLoader: topology N not found: "+this.node.attrName),console.warn(this.node),i=3),this.node.__cache_poly_topology_max=i,this.node.__cache_poly_topology_arr=s,this.node.__cache_indices=t,this.node.__cache_indices},a.prototype.getPolygonTopologyMax=function(){return this.node.__cache_indices&&this.node.__cache_poly_topology_max?this.node.__cache_poly_topology_max:(this.getPolygonVertexIndices(this.node),this.node.__cache_poly_topology_max)},a.prototype.getPolygonTopologyArray=function(){return this.node.__cache_indices&&this.node.__cache_poly_topology_max?this.node.__cache_poly_topology_arr:(this.getPolygonVertexIndices(this.node),this.node.__cache_poly_topology_arr)},a.prototype.convertPolyIndicesToTri=function(e,t){for(var r=[],i=0,s=0,a=0;i<e.length;){a=t[s];for(var n=0;n<=a-3;n++)r.push(e[i]),r.push(e[i+(a-2-n)]),r.push(e[i+(a-1-n)]);s++,i+=a}return r},a.prototype.addBones=function(e){this.bones=e},n.prototype.getUV=function(e){return this.node&&this.uv&&this.map&&this.ref?this.uv:this._parseText(e)},n.prototype.getMap=function(e){return this.node&&this.uv&&this.map&&this.ref?this.map:(this._parseText(e),this.map)},n.prototype.getRef=function(e){return this.node&&this.uv&&this.map&&this.ref?this.ref:(this._parseText(e),this.ref)},n.prototype.getIndex=function(e){return this.node&&this.uv&&this.map&&this.ref?this.index:(this._parseText(e),this.index)},n.prototype.getNode=function(e){return null!==this.node?this.node:(this.node=e.subNodes.LayerElementUV,this.node)},n.prototype._parseText=function(e){var t=this.getNode(e);if(void 0===t)return[];var r=0,i="";for(var s in t)s.match(/^\d+$/)&&(r++,i=s);r>0&&(console.warn("multi uv not supported"),t=t[s]),this.index=!1,t.subNodes.UVIndex&&(this.index=toInt(t.subNodes.UVIndex.properties.a.split(",")));var a=t.subNodes.UV.properties.a,n=t.properties.MappingInformationType,o=t.properties.ReferenceInformationType;return this.uv=toFloat(a.split(",")),this.map=n,this.ref=o,this.uv},n.prototype.parse=function(e,t){this.uvNode=this.getNode(e),this.uv=this.getUV(e);var r=this.getMap(e),i=this.getRef(e),s=this.getIndex(e),a=t.getPolygonTopologyArray();switch(r){case"ByPolygonVertex":switch(i){case"Direct":this.uv=this.parseUV_ByPolygonVertex_Direct(this.uv,s,a,2);break;case"IndexToDirect":this.uv=this.parseUV_ByPolygonVertex_IndexToDirect(this.uv,s)}this.uv=m(this.uv,t.getPolygonVertexIndices(e),2);break;case"ByPolygon":switch(i){case"Direct":this.uv=this.parseUV_ByPolygon_Direct();break;case"IndexToDirect":this.uv=this.parseUV_ByPolygon_IndexToDirect()}}return this.uv},n.prototype.parseUV_ByPolygonVertex_Direct=function(e,t,r,i){return parse_Data_ByPolygonVertex_Direct(e,t,r,i)},n.prototype.parseUV_ByPolygonVertex_IndexToDirect=function(e,t){return f(e,t,2)},n.prototype.parseUV_ByPolygon_Direct=function(e){return console.warn("not implemented"),e},n.prototype.parseUV_ByPolygon_IndexToDirect=function(e){return console.warn("not implemented"),e},n.prototype.parseUV_ByVertex_Direct=function(e){return console.warn("not implemented"),e},o.prototype.getNormal=function(e){return this.node&&this.normal&&this.map&&this.ref?this.normal:(this._parseText(e),this.normal)},o.prototype.getMap=function(e){return this.node&&this.normal&&this.map&&this.ref?this.map:(this._parseText(e),this.map)},o.prototype.getRef=function(e){return this.node&&this.normal&&this.map&&this.ref?this.ref:(this._parseText(e),this.ref)},o.prototype.getNode=function(e){return this.node?this.node:(this.node=e.subNodes.LayerElementNormal,this.node)},o.prototype._parseText=function(e){var t=this.getNode(e);if(void 0===t)return void console.warn("node: "+e.attrName+"("+e.id+") does not have LayerElementNormal");var r=t.properties.MappingInformationType,i=t.properties.ReferenceInformationType,s=t.subNodes.Normals.properties.a;this.normal=toFloat(s.split(",")),this.map=r,this.ref=i},o.prototype.parse=function(e,t){var r=this.getNormal(e),i=(this.getNode(e),this.getMap(e)),s=this.getRef(e),a=t.getPolygonVertexIndices(e),n=t.getPolygonTopologyArray(e);switch(i){case"ByPolygonVertex":switch(s){case"Direct":r=this.parseNormal_ByPolygonVertex_Direct(r,a,n,3);break;case"IndexToDirect":r=this.parseNormal_ByPolygonVertex_IndexToDirect()}break;case"ByPolygon":switch(s){case"Direct":r=this.parseNormal_ByPolygon_Direct();break;case"IndexToDirect":r=this.parseNormal_ByPolygon_IndexToDirect()}}return r},o.prototype.parseNormal_ByPolygonVertex_Direct=function(e,t,r,i){return parse_Data_ByPolygonVertex_Direct(e,t,r,i)},o.prototype.parseNormal_ByPolygonVertex_IndexToDirect=function(e){return console.warn("not implemented"),e},o.prototype.parseNormal_ByPolygon_Direct=function(e){return console.warn("not implemented"),e},o.prototype.parseNormal_ByPolygon_IndexToDirect=function(e){return console.warn("not implemented"),e},o.prototype.parseNormal_ByVertex_Direct=function(e){return console.warn("not implemented"),e},h.prototype.getColor=function(e){return this.node&&this.color&&this.map&&this.ref?this.color:this._parseText(e)},h.prototype.getMap=function(e){return this.node&&this.color&&this.map&&this.ref?this.map:(this._parseText(e),this.map)},h.prototype.getRef=function(e){return this.node&&this.color&&this.map&&this.ref?this.ref:(this._parseText(e),this.ref)},h.prototype.getIndex=function(e){return this.node&&this.color&&this.map&&this.ref?this.index:(this._parseText(e),this.index)},h.prototype.getNode=function(e){return null!==this.node?this.node:(this.node=e.subNodes.LayerElementColor,this.node)},h.prototype._parseText=function(e){var t=this.getNode(e);if(void 0===t)return[];var r=0,i="";for(var s in t)s.match(/^\d+$/)&&(r++,i=s);r>0&&(console.warn("multi color not supported"),t=t[s]),this.index=!1,t.subNodes.ColorIndex&&(this.index=toInt(t.subNodes.ColorIndex.properties.a.split(",")));var a=t.subNodes.Colors.properties.a,n=t.properties.MappingInformationType,o=t.properties.ReferenceInformationType;return this.color=toFloat(a.split(",")),this.map=n,this.ref=o,this.color},h.prototype.parse=function(e,t){this.colorNode=this.getNode(e),this.color=this.getColor(e);var r=this.getMap(e),i=this.getRef(e),s=this.getIndex(e),a=t.getPolygonTopologyArray();switch(r){case"ByPolygonVertex":switch(i){case"Direct":this.color=this.parseColor_ByPolygonVertex_Direct(this.color,s,a,3);break;case"IndexToDirect":this.color=this.parseColor_ByPolygonVertex_IndexToDirect(this.color,s)}this.color=m(this.color,t.getPolygonVertexIndices(e),3);break;case"ByPolygon":switch(i){case"Direct":this.color=this.parseColor_ByPolygon_Direct();break;case"IndexToDirect":this.color=this.parseColor_ByPolygon_IndexToDirect()}break;case"ByVertice":switch(i){case"Direct":this.color=this.parseColor_ByVertex_Direct(this.color,t.getPolygonVertexIndices(e),a,3);break;case"IndexToDirect":this.color=this.parseColor_ByVertex_Direct(this.color,t.getPolygonVertexIndices(e),a,3)}}return this.color},h.prototype.parseColor_ByPolygonVertex_Direct=function(e,t,r,i){return parse_Data_ByPolygonVertex_Direct(e,t,r,i)},h.prototype.parseColor_ByPolygonVertex_IndexToDirect=function(e,t){var r=[];console.log(e);for(var i=0;i<t.length;++i){var s={},a=e[4*t[i]],n=e[4*t[i]+1],o=e[4*t[i]+2],h=e[4*t[i]+3];s.r=1*(1-h)+h*a,s.g=1*(1-h)+h*n,s.b=1*(1-h)+h*o,r.push(s.r),r.push(s.g),r.push(s.b)}return r},h.prototype.parseColor_ByPolygon_Direct=function(e){return console.warn("not implemented"),e},h.prototype.parseColor_ByPolygon_IndexToDirect=function(e){return console.warn("not implemented"),e},h.prototype.parseColor_ByVertex_Direct=function(e,t,r,i){for(var s=[],a=0,n=0;n<e.length;n+=4){var o={},h=e[n],c=e[n+1],l=e[n+2],u=e[n+3];o.r=0*(1-u)+u*h,o.g=0*(1-u)+u*c,o.b=0*(1-u)+u*l,s[a]=o.r,s[a+1]=o.g,s[a+2]=o.b,a+=3}return s},c.prototype.fromNode=function(e){return this.id=e.id,this.internalId=e.id,this.times=e.subNodes.KeyTime.properties.a,this.values=e.subNodes.KeyValueFloat.properties.a,this.attrFlag=e.subNodes.KeyAttrFlags.properties.a,this.attrData=e.subNodes.KeyAttrDataFloat.properties.a,this.times=toFloat(this.times.split(",")),this.values=toFloat(this.values.split(",")),this.attrData=toFloat(this.attrData.split(",")),this.attrFlag=toInt(this.attrFlag.split(",")),this.times=this.times.map(function(e){return v(e)}),this},c.prototype.getLength=function(){return this.times[this.times.length-1]},l.prototype.fromNode=function(e,t,r){if(this.id=t.id,this.attr=t.attrName,this.internalId=t.id,!this.attr.match(/S|R|T/))return null;
for(var i in t.properties)i.match(/X/)&&(this.attrX=!0),i.match(/Y/)&&(this.attrY=!0),i.match(/Z/)&&(this.attrZ=!0);this.containerIndices=e.searchConnectionParent(this.id),this.curveIdx=e.searchConnectionChildren(this.id);for(var s=this.containerIndices.length-1;s>=0;--s){var a=r.searchRealId(this.containerIndices[s]);if(a>=0&&(this.containerBoneId=a,this.containerId=this.containerIndices[s]),a>=0)break}return this},l.prototype.setCurve=function(e){this.curves.push(e)},u.prototype.parse=function(e,t){var r=e.Objects.subNodes.AnimationCurveNode,i=e.Objects.subNodes.AnimationCurve,s=[];for(var a in r)if(a.match(/\d+/)){var n=(new l).fromNode(e,r[a],t);s.push(n)}for(var o={},h=0;h<s.length;++h)null!==s[h]&&(o[s[h].id]=s[h]);var u=[],d=0;for(a in i)if(a.match(/\d+/)){var p=(new c).fromNode(i[a]);u.push(p),d=p.getLength()?p.getLength():d;var f=e.searchConnectionParent(p.id)[0],m=e.searchConnectionType(p.id,f);m.match(/X/)&&(m="x"),m.match(/Y/)&&(m="y"),m.match(/Z/)&&(m="z"),o[f]&&(o[f].curves[m]=p)}for(var v in o){var g=o[v].containerBoneId;void 0===this.curves[g]&&(this.curves[g]={}),this.curves[g][o[v].attr]=o[v]}return this.length=d,this.frames=this.length*this.fps,this},d.prototype.add=function(e){void 0===this.textures&&(this.textures=[]),this.textures.push(e);for(var t=0;t<e.parentIds.length;++t)void 0===this.perGeoMap[e.parentIds[t]]&&(this.perGeoMap[e.parentIds[t]]=[]),this.perGeoMap[e.parentIds[t]].push(this.textures[this.textures.length-1])},d.prototype.parse=function(e,t){var r=e.Objects.subNodes.Texture,i=(new p).parse(r,e);return this.add(i),this},d.prototype.getById=function(e){return this.perGeoMap[e]},p.prototype.parse=function(e,t){return this.id=e.id,this.name=e.attrName,this.parentIds=this.searchParents(this.id,t),this},p.prototype.parseFileName=function(e){if(void 0===e)return"";var t=e.split(/[\\\/]/);return t.length>0?t[t.length-1]:e},p.prototype.searchParents=function(e,t){var r=t.searchConnectionParent(e);return r},parse_Data_ByPolygonVertex_Direct=function(e,t,r,i){for(var s=[],a=0,n=0;n<t.length;++n){s[t[n]]=[];for(var o=0;o<i;++o)s[t[n]][o]=e[a+o];a+=i}for(var h=[],c=0;c<s.length;++c)if(void 0!==s[c])for(var l=0;l<i;++l)void 0!==s[c][l]&&h.push(s[c][l]);return h};var v=function(e){return e/46186158e3};degToRad=function(e){return e*Math.PI/180},radToDeg=function(e){return 180*e/Math.PI},quatFromVec=function(e,t,r){var i=new THREE.Euler(e,t,r,"ZYX"),s=new THREE.Quaternion;return s.setFromEuler(i),s},toInt=function(e){return e.map(function(e){return parseInt(e)})},toFloat=function(e){return e.map(function(e){return parseFloat(e)})},toRad=function(e){return e.map(function(e){return degToRad(e)})},toMat44=function(e){var t=new THREE.Matrix4;return t.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]),t}}();